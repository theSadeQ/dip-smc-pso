\chapter{Double-Inverted Pendulum Dynamics}

\textbf{Understanding the Physics and Mathematics of the DIP System}

This guide derives the mathematical model of the double-inverted pendulum from first principles. You'll learn how Lagrangian mechanics produces the equations of motion, when linearization is valid, and why the system is controllable despite underactuation.



\section{Table of Contents}
\label{section:table-of-contents}

\begin{itemize}
\item [System Overview](\#system-overview)
\item [Lagrangian Derivation](\#lagrangian-derivation)
\item [Equations of Motion](\#equations-of-motion)
\item [Linearization for Control](\#linearization-for-control)
\item [Controllability Analysis](\#controllability-analysis)
\end{itemize}



\section{System Overview}
\label{section:system-overview}

\subsection{Physical Description}
\label{subsection:physical-description}

The double-inverted pendulum (DIP) consists of:
\begin{itemize}
\item \textbf{Cart} (mass \texttt{mâ‚€}): Moves horizontally on track
\item \textbf{First Pendulum} (mass \texttt{mâ‚}, length \texttt{lâ‚}): Hinged to cart
\item \textbf{Second Pendulum} (mass \texttt{mâ‚‚}, length \texttt{lâ‚‚}): Hinged to tip of first pendulum
\end{itemize}

\textbf{Control Objective}: Balance both pendulums upright (\texttt{Î¸â‚ = Î¸â‚‚ = 0}) using horizontal cart force \texttt{u}.

\textbf{Physical System Diagram}:

\begin{lstlisting}[language=mermaid]
graph TD
    subgraph "Double-Inverted Pendulum System"
        CART["Cart (mâ‚€)<br/>Position: x"] -->|Hinge| P1["First Pendulum (mâ‚, lâ‚)<br/>Angle: Î¸â‚ from vertical"]
        P1 -->|Hinge| P2["Second Pendulum (mâ‚‚, lâ‚‚)<br/>Angle: Î¸â‚‚ from vertical"]

        FORCE["Control Force u<br/>(Horizontal)"] -->|Applied to| CART

        TRACK["Frictionless Track"] -.->|Constrained| CART
    end

    style CART fill:\#ccccff
    style P1 fill:\#ffcccc
    style P2 fill:\#ccffcc
    style FORCE fill:\#ffffcc
\end{lstlisting}

\textbf{System Components}:
\begin{itemize}
\item ğŸ”µ \textbf{Cart}: Movable platform (1 DOF: position x)
\item ğŸ”´ \textbf{Pendulum 1}: First link (1 DOF: angle Î¸â‚)
\item ğŸŸ¢ \textbf{Pendulum 2}: Second link (1 DOF: angle Î¸â‚‚)
\item ğŸŸ¡ \textbf{Control}: Horizontal force u (single actuator)
\end{itemize}

\subsection{State Variables}
\label{subsection:state-variables}

\textbf{Generalized Coordinates} (3 DOF):
\begin{verbatim}
q = [x, Î¸â‚, Î¸â‚‚]áµ€
\end{verbatim}yaml

Where:
\begin{itemize}
\item \texttt{x}: Cart position (m)
\item \texttt{Î¸â‚}: First pendulum angle from vertical (rad, 0 = upright)
\item \texttt{Î¸â‚‚}: Second pendulum angle from vertical (rad, 0 = upright)
\end{itemize}

\textbf{Full State Vector} (6 dimensions):
\begin{verbatim}
state = [x, áº‹, Î¸â‚, Î¸Ì‡â‚, Î¸â‚‚, Î¸Ì‡â‚‚]áµ€
\end{verbatim}

\textbf{Control Input}:
\begin{verbatim}
u = horizontal force on cart (N)
\end{verbatim}

\textbf{State-Space Representation}:

\begin{lstlisting}[language=mermaid]
flowchart LR
    subgraph STATE["State Vector (6D)"]
        direction TB
        X["x<br/>(position)"]
        DX["áº‹<br/>(velocity)"]
        T1["Î¸â‚<br/>(angle 1)"]
        DT1["Î¸Ì‡â‚<br/>(angular vel 1)"]
        T2["Î¸â‚‚<br/>(angle 2)"]
        DT2["Î¸Ì‡â‚‚<br/>(angular vel 2)"]
    end

    CONTROL["u<br/>(force)"] --> DYNAMICS["DIP Dynamics<br/>M(q)qÌˆ + C(q,qÌ‡)qÌ‡ + G(q) = Qu"]
    STATE --> DYNAMICS
    DYNAMICS --> NEXT["Next State<br/>(Integration)"]
    NEXT --> STATE

    style CONTROL fill:\#ffffcc
    style DYNAMICS fill:\#ffcccc
    style STATE fill:\#ccffcc
\end{lstlisting}

\textbf{Dimensions}:
\begin{itemize}
\item \textbf{State space}: 6D (position + velocity for 3 coordinates)
\item \textbf{Control space}: 1D (horizontal force only)
\item \textbf{Underactuated}: 6 states, 1 control â†’ dynamic coupling essential
\end{itemize}

\subsection{Why This System is Challenging}
\label{subsection:why-this-system-is-challenging}

\textbf{Underactuated}: 3 DOF, 1 control input
\begin{itemize}
\item Cannot independently control all coordinates
\item Must use dynamic coupling
\end{itemize}

\textbf{Unstable Equilibrium}: Upright position
\begin{itemize}
\item Small perturbations â†’ pendulums fall
\item Requires active stabilization
\end{itemize}

\textbf{Nonlinear Dynamics}: Trigonometric functions
\begin{itemize}
\item Linear control design requires approximations
\item Full dynamics needed for large angles
\end{itemize}

\textbf{Coupled System}: Motion of one affects others
\begin{itemize}
\item Cart motion affects both pendulums
\item Second pendulum motion affects first
\end{itemize}



\section{Lagrangian Derivation}
\label{section:lagrangian-derivation}

\subsection{Why Lagrangian Mechanics?}
\label{subsection:why-lagrangian-mechanics}

\textbf{Newton's Laws}: Force-based approach
\begin{itemize}
\item Require constraint forces (reaction forces at joints)
\item Complex for multi-body systems
\end{itemize}

\textbf{Lagrangian Mechanics}: Energy-based approach
\begin{itemize}
\item Automatically handles constraints
\item Natural for deriving equations of motion
\item Uses \texttt{L = T - V} (kinetic - potential energy)
\end{itemize}

\textbf{Lagrangian Derivation Process}:

\begin{lstlisting}[language=mermaid]
flowchart TD
    START["System Description<br/>(Masses, lengths, constraints)"] --> KE["Compute Kinetic Energy T<br/>Â½mâ‚€áº‹Â² + Â½mâ‚(áº‹â‚Â²+Å¼â‚Â²) + Â½mâ‚‚(áº‹â‚‚Â²+Å¼â‚‚Â²)"]
    KE --> PE["Compute Potential Energy V<br/>mâ‚glâ‚cos(Î¸â‚) + mâ‚‚g[lâ‚cos(Î¸â‚)+lâ‚‚cos(Î¸â‚‚)]"]

    PE --> LAG["Form Lagrangian<br/>L = T - V"]

    LAG --> EL["Apply Euler-Lagrange<br/>d/dt(âˆ‚L/âˆ‚qÌ‡áµ¢) - âˆ‚L/âˆ‚qáµ¢ = Qáµ¢"]

    EL --> EOM["Equations of Motion<br/>M(q)qÌˆ + C(q,qÌ‡)qÌ‡ + G(q) = Qu"]

    style START fill:\#ccccff
    style LAG fill:\#ffffcc
    style EOM fill:\#ccffcc
\end{lstlisting}

\textbf{Advantages}:
\begin{itemize}
\item ğŸ”µ \textbf{Systematic}: No need to derive constraint forces
\item ğŸŸ¡ \textbf{Lagrangian} L = T - V: Single scalar function
\item ğŸŸ¢ \textbf{Result}: Configuration-dependent dynamics M(q)
\end{itemize}

\subsection{Kinetic Energy}
\label{subsection:kinetic-energy}

\textbf{Cart}:
\begin{verbatim}
Tâ‚€ = Â½mâ‚€áº‹Â²
\end{verbatim}

\textbf{First Pendulum} (center of mass at \texttt{lâ‚/2}):

Position of COM:
\begin{verbatim}
xâ‚ = x + (lâ‚/2)sin(Î¸â‚)
zâ‚ = (lâ‚/2)cos(Î¸â‚)
\end{verbatim}yaml

Velocity:
\begin{verbatim}
áº‹â‚ = áº‹ + (lâ‚/2)Î¸Ì‡â‚cos(Î¸â‚)
Å¼â‚ = -(lâ‚/2)Î¸Ì‡â‚sin(Î¸â‚)
\end{verbatim}

Kinetic energy:
\begin{verbatim}
Tâ‚ = Â½mâ‚(áº‹â‚Â² + Å¼â‚Â²) + Â½Iâ‚Î¸Ì‡â‚Â²
   = Â½mâ‚[áº‹Â² + (lâ‚/2)Â²Î¸Ì‡â‚Â² + lâ‚áº‹Î¸Ì‡â‚cos(Î¸â‚)] + Â½Iâ‚Î¸Ì‡â‚Â²
\end{verbatim}yaml

Where \texttt{Iâ‚ = (1/3)mâ‚lâ‚Â²} (inertia of rod about end)

\textbf{Second Pendulum} (center of mass at \texttt{lâ‚ + lâ‚‚/2} from cart):

Position:
\begin{verbatim}
xâ‚‚ = x + lâ‚sin(Î¸â‚) + (lâ‚‚/2)sin(Î¸â‚‚)
zâ‚‚ = lâ‚cos(Î¸â‚) + (lâ‚‚/2)cos(Î¸â‚‚)
\end{verbatim}

Velocity (chain rule):
\begin{verbatim}
áº‹â‚‚ = áº‹ + lâ‚Î¸Ì‡â‚cos(Î¸â‚) + (lâ‚‚/2)Î¸Ì‡â‚‚cos(Î¸â‚‚)
Å¼â‚‚ = -lâ‚Î¸Ì‡â‚sin(Î¸â‚) - (lâ‚‚/2)Î¸Ì‡â‚‚sin(Î¸â‚‚)
\end{verbatim}

Kinetic energy:
\begin{verbatim}
Tâ‚‚ = Â½mâ‚‚(áº‹â‚‚Â² + Å¼â‚‚Â²) + Â½Iâ‚‚Î¸Ì‡â‚‚Â²
\end{verbatim}

\textbf{Total Kinetic Energy}:
\begin{verbatim}
T = Tâ‚€ + Tâ‚ + Tâ‚‚
\end{verbatim}

\subsection{Potential Energy}
\label{subsection:potential-energy}

Choose zero at cart level:

\textbf{First Pendulum}:
\begin{verbatim}
Vâ‚ = mâ‚g(lâ‚/2)cos(Î¸â‚)
\end{verbatim}

\textbf{Second Pendulum}:
\begin{verbatim}
Vâ‚‚ = mâ‚‚g[lâ‚cos(Î¸â‚) + (lâ‚‚/2)cos(Î¸â‚‚)]
\end{verbatim}

\textbf{Total Potential Energy}:
\begin{verbatim}
V = Vâ‚ + Vâ‚‚
  = (mâ‚lâ‚/2 + mâ‚‚lâ‚)gÂ·cos(Î¸â‚) + (mâ‚‚lâ‚‚/2)gÂ·cos(Î¸â‚‚)
\end{verbatim}

\subsection{Lagrangian}
\label{subsection:lagrangian}

\begin{verbatim}
L = T - V
  = (kinetic energy) - (potential energy)
\end{verbatim}

After substitution and simplification:
\begin{verbatim}
L = Â½(mâ‚€ + mâ‚ + mâ‚‚)áº‹Â²
  + Â½(Iâ‚ + mâ‚lâ‚Â²/4 + mâ‚‚lâ‚Â²)Î¸Ì‡â‚Â²
  + Â½(Iâ‚‚ + mâ‚‚lâ‚‚Â²/4)Î¸Ì‡â‚‚Â²
  + (mâ‚lâ‚/2 + mâ‚‚lâ‚)áº‹Î¸Ì‡â‚cos(Î¸â‚)
  + (mâ‚‚lâ‚‚/2)áº‹Î¸Ì‡â‚‚cos(Î¸â‚‚)
  + (mâ‚‚lâ‚lâ‚‚/2)Î¸Ì‡â‚Î¸Ì‡â‚‚cos(Î¸â‚ - Î¸â‚‚)
  - (mâ‚lâ‚/2 + mâ‚‚lâ‚)gÂ·cos(Î¸â‚)
  - (mâ‚‚lâ‚‚/2)gÂ·cos(Î¸â‚‚)
\end{verbatim}

\textbf{Note}: This is a complex expression due to coupling terms!



\section{Equations of Motion}
\label{section:equations-of-motion}

\subsection{Euler-Lagrange Equations}
\label{subsection:euler-lagrange-equations}

For each generalized coordinate \texttt{qáµ¢}:
\begin{verbatim}
d/dt(âˆ‚L/âˆ‚qÌ‡áµ¢) - âˆ‚L/âˆ‚qáµ¢ = Qáµ¢
\end{verbatim}

Where \texttt{Qáµ¢} are generalized forces.

\textbf{For DIP}:
\begin{itemize}
\item \texttt{qâ‚ = x}: Generalized force = \texttt{u} (cart force)
\item \texttt{qâ‚‚ = Î¸â‚}: Generalized force = \texttt{0} (no direct torque)
\item \texttt{qâ‚ƒ = Î¸â‚‚}: Generalized force = \texttt{0} (no direct torque)
\end{itemize}

\subsection{Matrix Form}
\label{subsection:matrix-form}

After applying Euler-Lagrange and simplifying:

\begin{verbatim}
M(q)qÌˆ + C(q, qÌ‡)qÌ‡ + G(q) = Qu
\end{verbatim}yaml

Where:
\begin{itemize}
\item \texttt{M(q)}: \textbf{Inertia matrix} (3Ã—3, configuration-dependent)
\item \texttt{C(q, qÌ‡)}: \textbf{Coriolis/centrifugal matrix} (3Ã—3)
\item \texttt{G(q)}: \textbf{Gravitational vector} (3Ã—1)
\item \texttt{Q}: \textbf{Input matrix} (3Ã—1)
\item \texttt{u}: \textbf{Control force} (scalar)
\end{itemize}

\textbf{Inertia Matrix} (simplified):
\begin{verbatim}
M = [m_total           m_c1Â·cos(Î¸â‚)      m_c2Â·cos(Î¸â‚‚)    ]
    [m_c1Â·cos(Î¸â‚)      I_eff1            m_12Â·cos(Î¸â‚-Î¸â‚‚)]
    [m_c2Â·cos(Î¸â‚‚)      m_12Â·cos(Î¸â‚-Î¸â‚‚)   I_eff2          ]
\end{verbatim}

\textbf{Gravitational Vector}:
\begin{verbatim}
G = [    0                            ]
    [(mâ‚lâ‚/2 + mâ‚‚lâ‚)gÂ·sin(Î¸â‚)        ]
    [(mâ‚‚lâ‚‚/2)gÂ·sin(Î¸â‚‚)                ]
\end{verbatim}

\textbf{Input Matrix}:
\begin{verbatim}
Q = [1, 0, 0]áµ€
\end{verbatim}

\subsection{Properties of the Dynamics}
\label{subsection:properties-of-the-dynamics}

\textbf{1. M(q) is Symmetric and Positive Definite}
\begin{itemize}
\item Always invertible (except at singularities)
\item Energy considerations guarantee this
\end{itemize}

\textbf{2. Configuration-Dependent Inertia}
\begin{itemize}
\item \texttt{M} depends on \texttt{Î¸â‚, Î¸â‚‚} (not constant!)
\item Coupling changes with pendulum angles
\end{itemize}

\textbf{3. Coriolis Matrix is Skew-Symmetric}
\begin{itemize}
\item \texttt{á¹€ - 2C} is skew-symmetric
\item Important for energy-based control
\end{itemize}



\section{Linearization for Control}
\label{section:linearization-for-control}

\subsection{Small Angle Approximation}
\label{subsection:small-angle-approximation}

Near upright position (\texttt{Î¸â‚ â‰ˆ 0, Î¸â‚‚ â‰ˆ 0}):

\textbf{Trigonometric Approximations}:
\begin{verbatim}
sin(Î¸) â‰ˆ Î¸
cos(Î¸) â‰ˆ 1
sin(Î¸)cos(Î¸) â‰ˆ Î¸
\end{verbatim}

\textbf{Validity}:
\begin{itemize}
\item |Î¸| < 0.2 rad (â‰ˆ 11Â°): Error < 2\%
\item |Î¸| < 0.3 rad (â‰ˆ 17Â°): Error < 5\%
\item |Î¸| > 0.5 rad (â‰ˆ 29Â°): Approximation breaks down
\end{itemize}

\subsection{Simplified Dynamics}
\label{subsection:simplified-dynamics}

\textbf{Assumptions}:
\begin{enumerate}
\item Small angles: \texttt{Î¸â‚, Î¸â‚‚ â‰ª 1}
\item Small velocities: \texttt{Î¸Ì‡â‚, Î¸Ì‡â‚‚ â‰ª 1}
\item Neglect products: \texttt{Î¸áµ¢Î¸â±¼ â‰ˆ 0}
\end{enumerate}

\textbf{Result}: Linearized equations
\begin{verbatim}
M_linÂ·qÌˆ + G_linÂ·q = QÂ·u
\end{verbatim}yaml

Where:
\begin{itemize}
\item \texttt{M_lin}: Constant inertia matrix
\item \texttt{G_lin}: Constant gravitational matrix (no sin/cos)
\end{itemize}

\textbf{State-Space Form}:
\begin{verbatim}
áº‹ = Ax + Bu

A = [0   I  ]    B = [  0      ]
    [Mâ»Â¹G 0]        [Mâ»Â¹Q    ]
\end{verbatim}

\textbf{Control Design Benefits}:
\begin{itemize}
\item Linear system â†’ linear control methods (LQR, pole placement)
\item Constant matrices â†’ easier analysis
\item Superposition applies â†’ simple design
\end{itemize}

\subsection{Limitations of Linearization}
\label{subsection:limitations-of-linearization}

\textbf{Invalid for}:
\begin{enumerate}
\item \textbf{Large angles}: Swing-up control (Î¸ > 90Â°)
\item \textbf{Fast motion}: Large Î¸Ì‡ violates small velocity assumption
\item \textbf{Extreme conditions}: Actuator saturation, disturbances
\end{enumerate}

\textbf{When to Use Full Nonlinear}:
\begin{itemize}
\item Final validation
\item Hardware testing
\item Large disturbance scenarios
\item Research publications
\end{itemize}



\section{Controllability Analysis}
\label{section:controllability-analysis}

\subsection{Controllability Matrix}
\label{subsection:controllability-matrix}

\textbf{Definition}: System is controllable if we can reach any state from any initial state.

\textbf{Test}: Controllability matrix has full rank:
\begin{verbatim}
C = [B  AB  AÂ²B  ...  AâµB]
\end{verbatim}bash

For 6-state system, need rank(C) = 6.

\subsection{DIP Controllability}
\label{subsection:dip-controllability}

\textbf{Result}: DIP is controllable (rank = 6) despite underactuation!

\textbf{Why?}
\begin{itemize}
\item Cart force \texttt{u} affects cart acceleration: \texttt{áº âˆ u}
\item Cart motion couples to pendulums via inertia matrix
\item Dynamic coupling propagates control to all states
\end{itemize}

\textbf{Physical Intuition}:
\begin{itemize}
\item Move cart right â†’ first pendulum tilts left (inertia)
\item First pendulum motion â†’ affects second pendulum
\item Clever sequencing â†’ control all angles
\end{itemize}

\textbf{Proof Sketch}:
\begin{enumerate}
\item Direct effect: \texttt{u â†’ áº} (cart acceleration)
\item First-order coupling: \texttt{áº â†’ Î¸Ìˆâ‚} (first pendulum)
\item Second-order coupling: \texttt{Î¸Ìˆâ‚ â†’ Î¸Ìˆâ‚‚} (second pendulum)
\item Three integration steps â†’ reach all position states
\item Controllability matrix full rank âœ“
\end{enumerate}

\textbf{Control Propagation Diagram}:

\begin{lstlisting}[language=mermaid]
flowchart TD
    U["Control Force u"] --> CART_ACC["Cart Acceleration áº<br/>(Direct effect)"]

    CART_ACC --> INERTIA1["Inertial Coupling<br/>to Pendulum 1"]
    INERTIA1 --> P1_ACC["Î¸Ìˆâ‚<br/>(First pendulum acceleration)"]

    P1_ACC --> INERTIA2["Inertial Coupling<br/>to Pendulum 2"]
    INERTIA2 --> P2_ACC["Î¸Ìˆâ‚‚<br/>(Second pendulum acceleration)"]

    CART_ACC --> CART_VEL["âˆ« â†’ áº‹<br/>(Cart velocity)"] --> CART_POS["âˆ« â†’ x<br/>(Cart position)"]
    P1_ACC --> P1_VEL["âˆ« â†’ Î¸Ì‡â‚<br/>(Angular velocity 1)"] --> P1_POS["âˆ« â†’ Î¸â‚<br/>(Angle 1)"]
    P2_ACC --> P2_VEL["âˆ« â†’ Î¸Ì‡â‚‚<br/>(Angular velocity 2)"] --> P2_POS["âˆ« â†’ Î¸â‚‚<br/>(Angle 2)"]

    style U fill:\#ffffcc
    style CART_ACC fill:\#ccffcc
    style P1_ACC fill:\#ffcccc
    style P2_ACC fill:\#ccccff
\end{lstlisting}

\textbf{Key Insight}: Single control input reaches all 6 states via:
\begin{itemize}
\item ğŸŸ¡ \textbf{Direct} effect on cart
\item ğŸŸ¢ \textbf{Inertial coupling} to pendulum 1
\item ğŸ”´ \textbf{Secondary coupling} to pendulum 2
\item ğŸ”µ \textbf{Integration} for position control
\end{itemize}

\textbf{Controllability Matrix}:
\begin{verbatim}
rank([B  AB  AÂ²B  AÂ³B  Aâ´B  AâµB]) = 6  âœ“
\end{verbatim}

System is \textbf{fully controllable} despite underactuation!

\subsection{Observability}
\label{subsection:observability}

\textbf{State Measurement}:
\begin{itemize}
\item Typically measure: \texttt{[x, Î¸â‚, Î¸â‚‚]} (positions only)
\item Velocities: Computed from position derivatives
\end{itemize}

\textbf{Observability Test}:
\begin{verbatim}
O = [C  CA  CAÂ²  ...  CAâµ]áµ€
\end{verbatim}

Where \texttt{C = [1 0 0 0 0 0; 0 0 1 0 0 0; 0 0 0 0 1 0]} (measure positions)

\textbf{Result}: Observable (rank = 6)

\textbf{Meaning}: Can estimate full state from position measurements



\section{Summary}
\label{section:summary}

\textbf{Key Takeaways}:

\begin{enumerate}
\item \textbf{Lagrangian Derivation}: Energy method naturally handles constraints
\item \textbf{Matrix Form}: \texttt{M(q)qÌˆ + C(q,qÌ‡)qÌ‡ + G(q) = Qu} (configuration-dependent)
\item \textbf{Linearization}: Valid for |Î¸| < 15Â°, enables linear control design
\item \textbf{Controllability}: Underactuated but controllable via dynamic coupling
\item \textbf{Observability}: Full state observable from position measurements
\end{enumerate}

\textbf{Design Implications}:
\begin{itemize}
\item \textbf{Small angles}: Use simplified dynamics for fast control design
\item \textbf{Large angles}: Must use full nonlinear dynamics
\item \textbf{Control}: Exploit coupling to control all DOFs with one input
\item \textbf{Estimation}: State observer feasible from position measurements
\end{itemize}

\textbf{Next Steps}:
\begin{itemize}
\item See linearization in action: [Tutorial 01](../tutorials/tutorial-01-first-simulation.md)
\item Implement dynamics models: [Plant Models API](../api/plant-models.md)
\item Deep dive: [Dynamics Derivations](../../mathematical_foundations/dynamics_derivations.md)
\end{itemize}



\textbf{Further Reading}:
\begin{itemize}
\item Goldstein, H. (2002). \textit{Classical Mechanics}. Addison-Wesley.
\item Spong, M. W., et al. (2006). \textit{Robot Modeling and Control}. Wiley.
\item Khalil, H. K. (2002). \textit{Nonlinear Systems}. Prentice Hall.
\end{itemize}



\textbf{Last Updated}: October 2025
