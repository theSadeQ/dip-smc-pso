% ==============================================================================
% EPISODE 012: HARDWARE-IN-THE-LOOP SYSTEM
% ==============================================================================
\input{../templates/master_template.tex}
\input{../templates/tikz_components.tex}

% Episode-specific title
\renewcommand{\episodetitle}{E012: Hardware-in-the-Loop}

\begin{document}

% ==============================================================================
% TITLE PAGE
% ==============================================================================
\makeepisodetitle{E012: Hardware-in-the-Loop System}{Bridging Sim-to-Real Gap, Plant Server + Controller Client, Real-Time Constraints}{2}{15-20 minutes}

% ==============================================================================
% PAGE 1: HIL INTRODUCTION & ARCHITECTURE
% ==============================================================================
\learningobjective{Understand HIL testing methodology, sim-to-real gap, plant server/controller client architecture, real-time constraints (±1ms), and production readiness validation}

\section*{The Sim-to-Real Gap Problem}

\begin{keypoint}
\textbf{Scenario:} Controller works perfectly in simulation → Deploy to real hardware → IT FAILS!

\textbf{Why?}
\begin{itemize}
    \item \textbf{1.} Sensor noise (real encoders: ±0.1° jitter, not perfect measurements)
    \item \textbf{2.} Actuator dynamics (motors have inertia, backlash, saturation)
    \item \textbf{3.} Computational delays (real-time OS scheduling: 1-5ms latency)
    \item \textbf{4.} Model mismatches (friction, air resistance, cable stiffness)
\end{itemize}

\textbf{Solution:} Hardware-in-the-Loop (HIL) testing BEFORE building expensive hardware
\end{keypoint}

\section*{What is Hardware-in-the-Loop?}

\begin{tcolorbox}[colback=primary!5, colframe=primary, title=\faMicrochip\ HIL Testing Methodology]
\textbf{Split the System:}
\begin{itemize}
    \item \textbf{Plant (pendulum physics):} Simulated on PC in real-time
    \item \textbf{Controller (SMC algorithm):} Runs on ACTUAL target hardware (embedded system, PLC, microcontroller)
    \item \textbf{Interface:} Network socket or serial link connects them
\end{itemize}

\textbf{Controller Perspective:} Thinks it's talking to REAL pendulum hardware (via sensors/actuators)

\textbf{Reality:} Communicating with simulator over UDP
\end{tcolorbox}

\subsection*{HIL Architecture Diagram}

\begin{center}
\begin{tikzpicture}[scale=0.85]
    % Controller Hardware
    \node[block, fill=accent!20, minimum width=3cm, minimum height=2cm] (ctrl) at (0,0) {
        \textbf{Controller Hardware} \\
        \small Raspberry Pi, \\
        \small PLC, or \\
        \small Microcontroller
    };

    % Simulator PC
    \node[block, fill=secondary!20, minimum width=3cm, minimum height=2cm] (sim) at (6,0) {
        \textbf{Simulator PC} \\
        \small Windows/Linux \\
        \small Real-time simulation
    };

    % Communication arrows
    \draw[->, thick, color=primary] (ctrl.east) -- node[above, font=\small] {$u(t)$ control} (sim.west);
    \draw[->, thick, color=secondary] (sim.west) -- node[below, font=\small] {state$(t)$ sensors} (ctrl.east);

    % Labels
    \node[below=0.3cm of ctrl, font=\small, text width=3cm, align=center] {
        Computes control \\
        using real CPU, \\
        real timing, \\
        real constraints
    };

    \node[below=0.3cm of sim, font=\small, text width=3cm, align=center] {
        Simulates physics \\
        using RK4 integration, \\
        sends sensor data back \\
        (100 Hz loop)
    };
\end{tikzpicture}
\end{center}

\subsection*{Why Use HIL? Four Reasons}

\begin{multicols}{2}

\textbf{1. Risk-Free Testing}

\textbf{Without HIL:}
\begin{itemize}
    \item Flash code to microcontroller
    \item Connect to \$10,000 robot
    \item Hit "run" → CRASH!
    \item Damage: \$2,000 repair + 2 weeks downtime
\end{itemize}

\textbf{With HIL:}
\begin{itemize}
    \item Flash code to microcontroller
    \item Connect to HIL simulator (free!)
    \item Bug detected safely
    \item Fix in 5 minutes, retry instantly
\end{itemize}

\columnbreak

\textbf{2. Reproducibility}

Real hardware: wear, temperature drift, battery voltage

HIL: Same dynamics model every time

\textbf{3. Edge Case Testing}

Test dangerous scenarios impossible on real hardware:
\begin{itemize}
    \item Initial angle: 60° (would break pendulum!)
    \item Disturbance: 50N impulse (too violent)
\end{itemize}

\textbf{4. Rapid Iteration}

HIL: 100 tests in 20 minutes

Real hardware: 100 tests in 2 hours (physical resets)

\end{multicols}

% ==============================================================================
% PAGE 2: PLANT SERVER & CONTROLLER CLIENT
% ==============================================================================
\newpage

\section*{Component 1: Plant Server (Simulator PC)}

\begin{keypoint}
\textbf{Purpose:} Simulate pendulum physics in real-time (100 Hz control rate)
\end{keypoint}

\subsection*{Plant Server Loop (4 Steps)}

\begin{tcolorbox}[colback=secondary!10, colframe=secondary, title=\faServer\ Real-Time Simulation Loop]
\textbf{Step 1: Wait for Control Command}

Listen on UDP socket for controller to send force value $u(t)$

Blocking receive - waits patiently before advancing time

\textbf{Step 2: Simulate One Timestep}

Compute pendulum motion over 10 ms (dt=0.01) using RK4 integration

Apply control force $u(t)$, update state: $[\theta_1, \theta_2, \dot{\theta}_1, \dot{\theta}_2, x, \dot{x}]$

\textbf{Step 3: Send State Back}

Package angles, velocities, position → Send over UDP instantly

\textbf{Step 4: Repeat}

Does this 100 times per second (100 Hz real-time loop)
\end{tcolorbox}

\subsection*{Key Design Decisions}

\begin{warning}
\textbf{UDP vs TCP:}

\textbf{UDP:} Low-latency, connectionless - speed over reliability (chosen for HIL)

\textbf{TCP:} Reliable but adds 10-20ms latency (not acceptable for control!)

\textbf{Blocking Receive:} Server waits for controller command before advancing time (maintains causality)
\end{warning}

\section*{Component 2: Controller Client (Embedded Hardware)}

\begin{keypoint}
\textbf{Purpose:} Run actual controller code on target hardware (Raspberry Pi, PLC, microcontroller)
\end{keypoint}

\subsection*{Controller Client Loop (4 Steps)}

\begin{tcolorbox}[colback=accent!10, colframe=accent, title=\faMicrochip\ Embedded Control Loop]
\textbf{Step 1: Receive State}

Get sensor data from plant server: $[\theta_1, \theta_2, \dot{\theta}_1, \dot{\theta}_2, x, \dot{x}]$

\textbf{Step 2: Compute Control}

Run SMC algorithm: $u(t) = -K \cdot \text{sign}(s)$ (or STA, Adaptive, etc.)

Execute on REAL CPU with REAL timing constraints

\textbf{Step 3: Send Control Command}

Transmit force value $u(t)$ over UDP to plant server

\textbf{Step 4: Sleep Until Next Cycle}

Wait for next 10ms tick (100 Hz control rate)

Use real-time OS scheduler or busy-wait loop
\end{tcolorbox}

\subsection*{Real Constraints Tested in HIL}

\begin{example}
\textbf{What HIL Validates:}
\begin{itemize}
    \item \textbf{CPU performance:} Can microcontroller compute control in < 1ms?
    \item \textbf{Memory usage:} Does controller fit in 64 KB RAM?
    \item \textbf{Timing jitter:} Is control loop consistent at 100 Hz?
    \item \textbf{Network latency:} UDP roundtrip < 5ms?
    \item \textbf{Error handling:} What happens if packet drops?
\end{itemize}

\textbf{Catches:} Buffer overflows, missed deadlines, race conditions
\end{example}

% ==============================================================================
% PAGE 3: REAL-TIME CONSTRAINTS & VALIDATION
% ==============================================================================
\newpage

\section*{Real-Time Constraints: Why Timing Matters}

\begin{keypoint}
\textbf{Target:} ±1ms precision for 100 Hz control (10ms period)

\textbf{Why?} Control theory assumes periodic sampling - timing jitter destabilizes control!
\end{keypoint}

\subsection*{Timing Budget Breakdown}

\begin{tcolorbox}[colback=warning!10, colframe=warning, title=\faClock\ 10ms Control Period Budget]
\textbf{Available Time:} 10 ms total

\textbf{Allocation:}
\begin{itemize}
    \item Controller computation: 1-2 ms (SMC algorithms are fast)
    \item UDP send/receive: 1-3 ms (network latency)
    \item OS scheduling overhead: 0.5-1 ms
    \item Simulation step: 3-5 ms (RK4 integration)
    \item Safety margin: 1-2 ms (buffer for worst-case jitter)
\end{itemize}

\textbf{Total Used:} 6.5-13 ms → Target: keep under 9 ms average, 10 ms worst-case
\end{tcolorbox}

\subsection*{Deadline Monitoring}

\begin{warning}
\textbf{Missed Deadline:} Control loop takes > 10 ms → Timing violation

\textbf{Consequences:}
\begin{itemize}
    \item Phase lag in control (system becomes unstable)
    \item Chattering increases (switching frequency wrong)
    \item Performance degradation (settling time doubles)
\end{itemize}

\textbf{Detection:} Latency monitor tracks every cycle, logs violations

\textbf{Threshold:} > 5\% missed deadlines → System NOT production-ready
\end{warning}

\section*{HIL Validation Workflow}

\begin{tcolorbox}[colback=primary!5, colframe=primary, title=\faCheckSquare\ Five-Phase Validation]
\textbf{Phase 1: Unit Testing (Software Only)}

Test controller algorithms in simulation (no hardware)

Validate: Lyapunov stability, gain ranges, saturation limits

\textbf{Phase 2: HIL Integration Testing}

Deploy controller to embedded hardware

Connect to plant server via UDP

Run 10-minute test: pendulum stabilizes, no crashes

\textbf{Phase 3: Stress Testing}

Edge cases: Large initial angles, step disturbances, parameter mismatches

Monitor: Missed deadlines, memory leaks, packet drops

\textbf{Phase 4: Long-Duration Testing}

Run 24-hour continuous test

Check: Memory growth, CPU temperature, timing drift

\textbf{Phase 5: Multi-Controller Validation}

Test all 7 controllers (Classical, STA, Adaptive, Hybrid, Swing-up, Terminal, Integral)

Verify: Each meets timing constraints on target hardware
\end{tcolorbox}

% ==============================================================================
% PAGE 4: PRODUCTION READINESS & KEY TAKEAWAYS
% ==============================================================================
\newpage

\section*{Production Readiness: Thread Safety \& Memory}

\begin{keypoint}
\textbf{Status:} HIL system is PRODUCTION-READY for embedded deployment

\textbf{Evidence:} 11/11 thread safety tests passing, memory validated (10,000 sims, zero growth)
\end{keypoint}

\subsection*{Thread Safety Validation}

\begin{tcolorbox}[colback=secondary!10, colframe=secondary, title=\faShieldAlt\ 11/11 Tests Passing]
\textbf{Concurrent Operations Tested:}
\begin{itemize}
    \item Multiple controllers accessing shared config (no race conditions)
    \item Parallel PSO evaluations (no data corruption)
    \item Plant server + controller client simultaneous execution
    \item State manager with concurrent reads/writes
\end{itemize}

\textbf{Validation Method:} Thread sanitizer, race condition detector, stress tests

\textbf{Result:} 100\% pass rate (all 11 tests green)
\end{tcolorbox}

\subsection*{Memory Management}

\begin{example}
\textbf{Test:} Run 10,000 consecutive HIL simulations

\textbf{Monitor:} Memory usage every 100 simulations

\textbf{Result:} Zero growth (baseline: 45 MB, after 10k sims: 45 MB)

\textbf{Technique:} Weakref patterns prevent circular references, explicit cleanup() methods
\end{example}

\section*{Key Takeaways}

\begin{summary}
\textbf{HIL Definition:} Controller on REAL hardware, plant in REAL-TIME simulator, communicate over UDP

\textbf{Sim-to-Real Gap:} Sensor noise, actuator dynamics, delays, model mismatches (HIL bridges this!)

\textbf{Four Benefits:} (1) Risk-free testing (no hardware damage), (2) Reproducibility, (3) Edge case testing, (4) Rapid iteration

\textbf{Architecture:} Plant server (simulator PC, 100 Hz loop, RK4 integration) + Controller client (embedded hardware, SMC algorithm, real constraints)

\textbf{Real-Time Constraints:} ±1ms precision, 10ms period (100 Hz), timing budget breakdown

\textbf{Missed Deadlines:} > 10 ms → Timing violation → Phase lag, chattering, instability

\textbf{Validation Workflow:} 5 phases (unit test → HIL integration → stress test → 24-hour test → multi-controller)

\textbf{Production Readiness:} 11/11 thread safety tests passing, memory validated (10k sims, zero growth)

\textbf{UDP vs TCP:} UDP chosen for low latency (1-3 ms vs 10-20 ms TCP)

\textbf{HIL Insurance:} Catch bugs safely before deploying to expensive hardware (\$2k repair saved!)
\end{summary}

\subsection*{Quick Reference: HIL Commands}

\quickref{Run HIL Simulation}{
\begin{lstlisting}[style=python, numbers=none]
# Start plant server (Simulator PC)
python simulate.py --run-hil --port 5555

# Start controller client (Embedded hardware)
python controller_client.py --host 192.168.1.10 \
  --port 5555 --ctrl classical_smc

# Monitor timing with plot
python simulate.py --run-hil --plot
\end{lstlisting}
}

\subsection*{What's Next?}

\begin{keypoint}
\textbf{E013: Monitoring Infrastructure}

Latency tracking, deadline detection, weakly-hard constraints, real-time performance metrics

\textbf{Remember:} HIL is insurance against expensive mistakes - test dangerous scenarios safely!
\end{keypoint}

\end{document}
