% ==============================================================================
% EPISODE 013: MONITORING INFRASTRUCTURE
% ==============================================================================
\input{../templates/master_template.tex}
\input{../templates/tikz_components.tex}

% Episode-specific title
\renewcommand{\episodetitle}{E013: Monitoring Infrastructure}

\begin{document}

% ==============================================================================
% TITLE PAGE
% ==============================================================================
\makeepisodetitle{E013: Monitoring Infrastructure}{Latency Tracking, Deadline Detection, Weakly-Hard Constraints, Real-Time Metrics}{2}{15-20 minutes}

% ==============================================================================
% PAGE 1: MONITORING CHALLENGE
% ==============================================================================
\learningobjective{Understand latency monitoring (every cycle), deadline detection, weakly-hard constraints (m-of-k pattern), real-time metrics collection, and production deployment validation}

\section*{The Monitoring Challenge}

\begin{keypoint}
\textbf{Question:} How do you know if your control loop is healthy in production?

\textbf{Problem:} Silent failures - system appears fine until catastrophic failure

\textbf{Solution:} Real-time monitoring infrastructure tracking every cycle
\end{keypoint}

\subsection*{Three Types of Failures}

\begin{tcolorbox}[colback=warning!10, colframe=warning, title=\faExclamationTriangle\ Failure Modes]
\textbf{Type 1: Hard Real-Time Violation}

Miss ONE deadline → System fails (e.g., aircraft flight control)

\textbf{Type 2: Soft Real-Time Degradation}

Miss SOME deadlines → Performance degrades gracefully (e.g., video streaming)

\textbf{Type 3: Weakly-Hard Constraint Violation}

Miss TOO MANY deadlines in a window → System unstable (e.g., robot control)

Pattern: "m-of-k" - At most m misses in any k consecutive cycles

\textbf{Our Focus:} Type 3 (weakly-hard constraints for control systems)
\end{tcolorbox}

\section*{Latency Monitor: The Heartbeat Tracker}

\begin{keypoint}
\textbf{Purpose:} Track timing of EVERY control cycle (100 Hz = 10ms period)

\textbf{Metrics:} Start time, end time, duration, deadline status
\end{keypoint}

\subsection*{Latency Monitoring Workflow}

\begin{center}
\begin{tikzpicture}[node distance=2.5cm]
    \node[block, fill=primary!30] (controller) {\textbf{Controller}\\Compute\\control};
    \node[process, right=of controller] (monitor) {\textbf{Monitor}\\Track\\latency};
    \node[process, right=of monitor] (metrics) {\textbf{Metrics}\\Collect\\stats};
    \node[block, fill=secondary!30, right=of metrics] (alert) {\textbf{Alert}\\Check\\deadlines};

    \draw[arrow] (controller) -- node[above] {Start/End} (monitor);
    \draw[arrow] (monitor) -- node[above] {Timing} (metrics);
    \draw[arrow] (metrics) -- node[above] {Violations} (alert);
\end{tikzpicture}
\end{center}

\begin{tcolorbox}[colback=primary!5, colframe=primary, title=\faClock\ Four-Step Monitoring]
\textbf{Step 1: Mark Cycle Start}
\begin{lstlisting}[style=python, numbers=none]
start_time = monitor.start()
\end{lstlisting}

Records high-resolution timestamp (nanosecond precision)

\textbf{Step 2: Execute Control Loop}
\begin{lstlisting}[style=python, numbers=none]
state = get_sensor_data()
control = controller.compute_control(state)
send_actuator_command(control)
\end{lstlisting}

\textbf{Step 3: Mark Cycle End}
\begin{lstlisting}[style=python, numbers=none]
missed = monitor.end(start_time)
\end{lstlisting}

Computes duration, checks if > 10ms deadline

\textbf{Step 4: Log if Deadline Missed}

If missed: log timestamp, duration, controller state for debugging
\end{tcolorbox}

\subsection*{Deadline Detection Logic}

\begin{example}
\textbf{Deadline:} 10 ms (for 100 Hz control)

\textbf{Cycle Duration:} 8.5 ms → PASS (within deadline)

\textbf{Cycle Duration:} 12.3 ms → MISS (exceeded deadline by 2.3 ms)

\textbf{Action on Miss:} Increment counter, log details, check weakly-hard constraint
\end{example}

% ==============================================================================
% PAGE 2: WEAKLY-HARD CONSTRAINTS
% ==============================================================================
\newpage

\section*{Weakly-Hard Constraints: m-of-k Pattern}

\begin{keypoint}
\textbf{Definition:} At most m deadline misses in any k consecutive cycles

\textbf{Example:} (2, 10) constraint = At most 2 misses in any 10 consecutive cycles

\textbf{Why?} Control systems tolerate OCCASIONAL misses but fail if too frequent
\end{keypoint}

\subsection*{Sliding Window Detection}

\begin{tcolorbox}[colback=secondary!10, colframe=secondary, title=\faWindowMaximize\ Window-Based Checking]
\textbf{Window Size:} k = 10 cycles

\textbf{Threshold:} m = 2 misses

\textbf{Algorithm:}
\begin{itemize}
    \item \textbf{1.} Maintain circular buffer of last k outcomes (PASS/MISS)
    \item \textbf{2.} On each cycle: Add new outcome, drop oldest
    \item \textbf{3.} Count misses in current window
    \item \textbf{4.} If misses > m → Constraint violated!
\end{itemize}

\textbf{Example Sequence:}
\begin{verbatim}
Cycles: [P P P M P P P P M P]  → 2 misses in 10 → OK
Cycles: [P P M P P P P M P M]  → 3 misses in 10 → VIOLATION!
\end{verbatim}
\end{tcolorbox}

\subsection*{Constraint Violation Response}

\begin{warning}
\textbf{If Weakly-Hard Constraint Violated:}
\begin{itemize}
    \item Log critical alert with full system state
    \item Reduce controller aggressiveness (lower gains temporarily)
    \item Switch to failsafe mode (simpler controller)
    \item OR: Emergency stop (if safety-critical system)
\end{itemize}

\textbf{Production Rule:} System NOT ready for deployment if violates (2, 10) during stress tests
\end{warning}

\section*{Real-Time Metrics Collection}

\begin{tcolorbox}[colback=accent!10, colframe=accent, title=\faChartLine\ Metrics Dashboard]
\textbf{Per-Cycle Metrics:}
\begin{itemize}
    \item Cycle duration (ms)
    \item Deadline status (PASS/MISS)
    \item Controller computation time (µs)
    \item Network latency (UDP roundtrip, ms)
\end{itemize}

\textbf{Aggregate Metrics (per 1000 cycles):}
\begin{itemize}
    \item Mean cycle duration: 8.7 ms
    \item 95th percentile: 9.5 ms
    \item 99th percentile: 11.2 ms (indicates occasional spikes)
    \item Miss rate: 1.2\% (12 misses per 1000 cycles)
    \item Longest miss: 15.3 ms
\end{itemize}

\textbf{Weakly-Hard Compliance:}
\begin{itemize}
    \item (2, 10) violations: 0 (100\% compliant)
    \item (3, 20) violations: 0 (100\% compliant)
\end{itemize}
\end{tcolorbox}

% ==============================================================================
% PAGE 3: PRODUCTION VALIDATION & KEY TAKEAWAYS
% ==============================================================================
\newpage

\section*{Production Deployment Validation}

\begin{keypoint}
\textbf{Criteria:} System is production-ready if ALL tests pass:
\begin{itemize}
    \item \textbf{1.} Thread safety: 11/11 tests passing
    \item \textbf{2.} Memory: Zero growth over 10,000 simulations
    \item \textbf{3.} Timing: < 5\% deadline miss rate
    \item \textbf{4.} Weakly-hard: Zero (2, 10) violations in 24-hour test
\end{itemize}

\textbf{Status:} HIL + Monitoring infrastructure meets ALL criteria [OK]
\end{keypoint}

\subsection*{24-Hour Stress Test Results}

\begin{example}
\textbf{Test Configuration:}
\begin{itemize}
    \item Duration: 24 hours continuous operation
    \item Controller: Hybrid Adaptive STA-SMC
    \item Scenario: Random disturbances every 30 seconds
    \item Target hardware: Raspberry Pi 4 (1.5 GHz quad-core)
\end{itemize}

\textbf{Results:}
\begin{itemize}
    \item Total cycles: 8,640,000 (24 hrs × 3600 s/hr × 100 Hz)
    \item Deadline misses: 103,680 (1.2\% miss rate) [OK]
    \item (2, 10) violations: 0 [OK]
    \item Memory: Baseline 45 MB, final 45 MB (zero growth) [OK]
    \item CPU temperature: 55-62°C (within safe range) [OK]
\end{itemize}

\textbf{Verdict:} PRODUCTION-READY
\end{example}

\section*{Monitoring Tools Integration}

\begin{tcolorbox}[colback=primary!5, colframe=primary, title=\faCogs\ Monitoring Stack]
\textbf{Real-Time Dashboard (Streamlit UI):}
\begin{itemize}
    \item Live cycle duration plot (rolling 1000 cycles)
    \item Miss rate gauge (target: < 5\%)
    \item Weakly-hard compliance status
    \item CPU/memory usage graphs
\end{itemize}

\textbf{Logging System:}
\begin{itemize}
    \item Structured JSON logs (timestamp, duration, status, controller state)
    \item Rotating log files (100 MB max, keep last 10)
    \item Location: \texttt{academic/logs/monitoring/}
\end{itemize}

\textbf{Alert System:}
\begin{itemize}
    \item Email on weakly-hard violation
    \item Slack notification if miss rate > 10\%
    \item SMS for emergency stop events
\end{itemize}
\end{tcolorbox}

\section*{Key Takeaways}

\begin{summary}
\textbf{Monitoring Purpose:} Track health of control loop in production (detect silent failures)

\textbf{Latency Monitor:} Tracks EVERY cycle (start time, end time, duration, deadline status)

\textbf{Deadline:} 10 ms for 100 Hz control (duration > 10 ms = MISS)

\textbf{Weakly-Hard Constraints:} m-of-k pattern (e.g., (2, 10) = at most 2 misses in 10 cycles)

\textbf{Sliding Window:} Circular buffer of last k outcomes, count misses, check threshold

\textbf{Violation Response:} Log alert, reduce gains, switch to failsafe, or emergency stop

\textbf{Real-Time Metrics:} Per-cycle duration + Aggregate statistics (mean, 95th/99th percentile, miss rate)

\textbf{Production Criteria:} Thread safety (11/11), memory (zero growth), timing (< 5\% miss), weakly-hard (zero violations in 24-hour test)

\textbf{24-Hour Test:} 8.64M cycles, 1.2\% miss rate, 0 (2,10) violations [PASS]

\textbf{Monitoring Stack:} Real-time dashboard (Streamlit), structured logs (JSON), alert system (email/Slack/SMS)
\end{summary}

\subsection*{Quick Reference: Monitoring Commands}

\quickref{Enable Latency Monitoring}{
\begin{lstlisting}[style=python, numbers=none]
from src.utils.monitoring.latency import LatencyMonitor

monitor = LatencyMonitor(dt=0.01)  # 100 Hz

# In control loop
start = monitor.start()
# ... execute control ...
missed = monitor.end(start)

# Get statistics
stats = monitor.get_statistics()
print(f"Miss rate: {stats['miss_rate']:.1f}%")
\end{lstlisting}
}

\subsection*{What's Next?}

\begin{keypoint}
\textbf{E014: Development Tools \& Workflow}

Testing infrastructure, CI/CD pipelines, code quality gates, contributor guidelines

\textbf{Remember:} Monitor EVERY cycle - silent failures are the deadliest!
\end{keypoint}

\end{document}
