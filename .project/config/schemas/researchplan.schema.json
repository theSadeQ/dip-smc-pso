{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.org/researchplan.schema.json",
  "title": "ResearchPlan (core)",
  "type": "object",
  "additionalProperties": false,
  "required": ["metadata","executive_summary","phases","risks","acceptance","checklists","manifests"],
  "properties": {
    "metadata": {
      "type": "object",
      "additionalProperties": false,
      "required": ["title","version","created_at"],
      "properties": {
        "title": { "type": "string" },
        "version": { "type": "string" },
        "created_at": { "type": "string", "pattern": "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$" },
        "updated_at": { "type": "string", "pattern": "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$" },
        "tags": { "type": "array", "items": { "type": "string" } },
        "schema_version": { "type": "string" }
      }
    },
    "executive_summary": {
      "type": "object",
      "additionalProperties": false,
      "required": ["context","intended_outcomes","phases_overview"],
      "properties": {
        "context": { "type": "string" },
        "intended_outcomes": { "type": "array", "items": { "type": "string" } },
        "phases_overview": { "type": "array", "items": { "type": "string" } }
      }
    },
    "phases": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["name","goals","success_criteria","tasks","artifacts","validation_steps","execution_prompt"],
        "properties": {
          "name": { "type": "string" },
          "goals": { "type": "array", "items": { "type": "string" } },
          "success_criteria": { "type": "array", "items": { "type": "string" } },
          "tasks": {
            "type": "array",
            "items": {
              "type": "object",
              "additionalProperties": false,
              "required": ["id","title","contracts"],
              "properties": {
                "id": { "type": "string" },
                "title": { "type": "string" },
                "contracts": {
                  "type": "object",
                  "additionalProperties": false,
                  "required": ["inputs","outputs"],
                  "properties": {
                    "inputs": { "type": "object", "additionalProperties": { "$ref": "#/$defs/typespec" } },
                    "outputs": { "type": "object", "additionalProperties": { "$ref": "#/$defs/typespec" } },
                    "errors": { "type": "array", "items": { "type": "string" } },
                    "guards": {
                      "type": "object",
                      "additionalProperties": true,
                      "properties": {
                        "shape_validation": { "type": "boolean" },
                        "nan_policy": { "type": "string", "enum": ["allow","reject"] }
                      }
                    },
                    "tests": {
                      "type": "object",
                      "additionalProperties": false,
                      "required": ["selector"],
                      "properties": {
                        "selector": { "type": "string" },
                        "coverage_target": { "type": "number" }
                      }
                    },
                    "ci": {
                      "type": "object",
                      "additionalProperties": true,
                      "properties": {
                        "matrix": { "type": "array", "items": { "type": "string" } },
                        "artifacts": { "type": "string" }
                      }
                    }
                  }
                }
              }
            }
          },
          "artifacts": {
            "type": "array",
            "items": {
              "type": "object",
              "additionalProperties": false,
              "required": ["kind","name"],
              "properties": {
                "kind": { "type": "string" },
                "name": { "type": "string" },
                "location": { "type": "string" }
              }
            }
          },
          "validation_steps": {
            "type": "array",
            "items": {
              "type": "object",
              "additionalProperties": false,
              "required": ["action","expected"],
              "properties": {
                "action": { "type": "string" },
                "expected": { "type": "string" },
                "tolerance": { "type": "string" }
              }
            }
          },
          "execution_prompt": {
            "type": "object",
            "additionalProperties": false,
            "required": ["title","constraints","inputs","tasks","validation_steps","artifacts"],
            "properties": {
              "title": { "type": "string" },
              "constraints": { "type": "array", "items": { "type": "string" } },
              "inputs": { "type": "array", "items": { "type": "string" } },
              "tasks": { "type": "array", "items": { "type": "string" } },
              "validation_steps": { "type": "array", "items": { "type": "string" } },
              "artifacts": { "type": "array", "items": { "type": "string" } }
            }
          },
          "non_goals": { "type": "array", "items": { "type": "string" } },
          "anti_patterns": { "type": "array", "items": { "type": "string" } }
        }
      }
    },
    "risks": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["description","mitigation"],
        "properties": {
          "description": { "type": "string" },
          "mitigation": { "type": "string" }
        }
      }
    },
    "acceptance": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["statement"],
        "properties": {
          "statement": { "type": "string" },
          "evidence": { "type": "string" }
        }
      }
    },
    "checklists": {
      "type": "object",
      "additionalProperties": false,
      "required": ["definition_of_done","review","ops"],
      "properties": {
        "definition_of_done": { "$ref": "#/$defs/checklist" },
        "review": { "$ref": "#/$defs/checklist" },
        "ops": { "$ref": "#/$defs/checklist" }
      }
    },
    "manifests": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["name","goals","acceptance"],
        "properties": {
          "name": { "type": "string" },
          "goals": { "type": "array", "items": { "type": "string" } },
          "acceptance": { "type": "array", "items": { "type": "string" } },
          "risks": { "type": "array", "items": { "type": "string" } },
          "artifacts": { "type": "array", "items": { "type": "string" } }
        }
      }
    }
  },
  "$defs": {
    "typespec": {
      "type": "object",
      "additionalProperties": true,
      "required": ["type"],
      "properties": {
        "type": { "type": "string" },
        "description": { "type": "string" },
        "constraints": { "type": "object" }
      }
    },
    "checklist": {
      "type": "object",
      "additionalProperties": false,
      "required": ["items"],
      "properties": {
        "items": { "type": "array", "items": { "type": "string" } }
      }
    }
  }
}