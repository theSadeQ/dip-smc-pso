<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
.chartjs-container {
    margin: 1.5em auto;
    padding: 1em;
    background: #f8f9fa;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.chart-note {
    text-align: center;
    color: #6c757d;
    font-size: 0.9em;
    margin-top: 0.5em;
}
</style>
<link rel="index" title="Index" href="../../genindex.html"><link rel="search" title="Search" href="../../search.html">

    <!-- Generated with Sphinx 8.2.3 and Furo 2025.09.25 -->
        <title>Tutorial 04: Custom Controller Development Level: Advanced - DIP_SMC_PSO Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5349f25f" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=580074bf" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=8a7e329d" />
    
    


<style>
  body {
    --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">DIP_SMC_PSO Documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  <span class="sidebar-brand-text">DIP_SMC_PSO Documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">ğŸ“š Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Optimal Sliding Mode Control for a Double-Inverted Pendulum via PSO  ## How to validate a ResearchPlan JSON Run the validator locally: ```bash</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../theory_overview.html">Theory Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture.html">3. System Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plant_model.html">1.x Plant Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hil_quickstart.html">Hardware-in-the-Loop (HIL) Quickstart Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../streamlit_dashboard_guide.html">Streamlit Dashboard User Guide</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="https://github.com/theSadeQ/DIP_SMC_PSO/blob/main/docs/guides/tutorials/tutorial-04-custom-controller.md?plain=true" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div><div class="edit-this-page">
  <a class="muted-link" href="https://github.com/theSadeQ/DIP_SMC_PSO/edit/main/docs/guides/tutorials/tutorial-04-custom-controller.md" rel="edit" title="Edit this page">
    <svg><use href="#svg-pencil"></use></svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section class="tex2jax_ignore mathjax_ignore" id="tutorial-04-custom-controller-development-level-advanced">
<h1>Tutorial 04: Custom Controller Development <strong>Level:</strong> Advanced<a class="headerlink" href="#tutorial-04-custom-controller-development-level-advanced" title="Link to this heading">Â¶</a></h1>
<p><strong>Duration:</strong> 90-120 minutes
<strong>Prerequisites:</strong></p>
<ul class="contains-task-list simple">
<li><p>Completed <a class="reference internal" href="tutorial-01-first-simulation.html"><span class="std std-doc">Tutorial 01: Your First Simulation</span></a></p></li>
<li><p>Completed <a class="reference internal" href="tutorial-02-controller-comparison.html"><span class="std std-doc">Tutorial 02: Controller Comparison</span></a></p></li>
<li><p>Python programming experience</p></li>
<li><p>Understanding of SMC theory (recommended) ## Learning Objectives By the end of this tutorial, you will: - [ ] Understand the controller interface and architecture</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Implement a custom SMC variant from scratch</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Add gain validation and error handling</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Integrate your controller with the factory system</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Add configuration support in <code class="docutils literal notranslate"><span class="pre">config.yaml</span></code></p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Test and validate your custom controller</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> Optimize custom controller gains using PSO</p></li>
</ul>
<hr class="docutils" />
<section id="part-1-controller-architecture-overview-the-controller-interface-all-controllers-in-this-framework-implement-a-consistent-interface-python">
<h2>Part 1: Controller Architecture Overview ### The Controller Interface All controllers in this framework implement a <strong>consistent interface</strong>: ```python<a class="headerlink" href="#part-1-controller-architecture-overview-the-controller-interface-all-controllers-in-this-framework-implement-a-consistent-interface-python" title="Link to this heading">Â¶</a></h2>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="example-metadata">
<h1>example-metadata:<a class="headerlink" href="#example-metadata" title="Link to this heading">Â¶</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="runnable-false-class-mycustomcontroller-def-init-self-gains-max-force-kwargs-initialize-controller-with-gains-and-parameters-pass-def-compute-control-self-state-state-vars-history-compute-control-signal-for-current-state-parameters-state-np-ndarray-state-vector-x-dx-1-d1-2-d2-state-vars-dict-controller-specific-internal-state-history-dict-historical-data-for-multi-step-algorithms-returns-control-float-control-input-force-applied-to-cart-state-vars-dict-updated-internal-state-history-dict-updated-history-pass-def-initialize-history-self-dict-initialize-history-buffer-for-controller-return-def-cleanup-self-clean-up-resources-optional-pass">
<h1>runnable: false class MyCustomController: def <strong>init</strong>(self, gains, max_force, **kwargs): â€œâ€â€Initialize controller with gains and parameters.â€â€â€ pass def compute_control(self, state, state_vars, history): â€œâ€â€ Compute control signal for current state. Parameters â€”â€”â€”- state : np.ndarray State vector [x, dx, Î¸â‚, dÎ¸â‚, Î¸â‚‚, dÎ¸â‚‚] state_vars : dict Controller-specific internal state history : dict Historical data for multi-step algorithms Returns â€”â€”- control : float Control input (force applied to cart) state_vars : dict Updated internal state history : dict Updated history â€œâ€â€ pass def initialize_history(self) -&gt; dict: â€œâ€â€Initialize history buffer for controller.â€â€â€ return {} def cleanup(self): â€œâ€â€Clean up resources (optional).â€â€â€ pass<a class="headerlink" href="#runnable-false-class-mycustomcontroller-def-init-self-gains-max-force-kwargs-initialize-controller-with-gains-and-parameters-pass-def-compute-control-self-state-state-vars-history-compute-control-signal-for-current-state-parameters-state-np-ndarray-state-vector-x-dx-1-d1-2-d2-state-vars-dict-controller-specific-internal-state-history-dict-historical-data-for-multi-step-algorithms-returns-control-float-control-input-force-applied-to-cart-state-vars-dict-updated-internal-state-history-dict-updated-history-pass-def-initialize-history-self-dict-initialize-history-buffer-for-controller-return-def-cleanup-self-clean-up-resources-optional-pass" title="Link to this heading">Â¶</a></h1>
<p>``` ### Key Components <strong>1. Gains (<code class="docutils literal notranslate"><span class="pre">__init__</span></code>)</strong></p>
<ul class="simple">
<li><p>Controller-specific parameters (surface gains, switching gains, adaptation rates, etc.)</p></li>
<li><p>Must be validated for physical plausibility <strong>2. State Variables (<code class="docutils literal notranslate"><span class="pre">state_vars</span></code>)</strong></p></li>
<li><p>Controller internal state that persists between timesteps</p></li>
<li><p>Examples: adaptive gains, integral terms, filter states <strong>3. History (<code class="docutils literal notranslate"><span class="pre">history</span></code>)</strong></p></li>
<li><p>Multi-step data (previous states, controls)</p></li>
<li><p>Used for integral control, finite-difference derivatives, etc. <strong>4. Control Computation (<code class="docutils literal notranslate"><span class="pre">compute_control</span></code>)</strong></p></li>
<li><p>Core control law implementation</p></li>
<li><p>Returns control signal + updated state_vars + updated history</p></li>
</ul>
<hr class="docutils" />
<section id="part-2-implementing-a-terminal-smc-tsmc-what-is-terminal-smc-terminal-sliding-mode-control-uses-a-nonlinear-sliding-surface-with-fractional-powers-to-achieve-finite-time-convergence-faster-than-asymptotic-classical-smc-sliding-surface">
<h2>Part 2: Implementing a Terminal SMC (TSMC) ### What is Terminal SMC? <strong>Terminal Sliding Mode Control</strong> uses a <strong>nonlinear sliding surface</strong> with fractional powers to achieve <strong>finite-time convergence</strong> (faster than asymptotic). <strong>Classical SMC Sliding Surface:</strong><a class="headerlink" href="#part-2-implementing-a-terminal-smc-tsmc-what-is-terminal-smc-terminal-sliding-mode-control-uses-a-nonlinear-sliding-surface-with-fractional-powers-to-achieve-finite-time-convergence-faster-than-asymptotic-classical-smc-sliding-surface" title="Link to this heading">Â¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="n">s</span> <span class="o">=</span> <span class="n">k</span><span class="err">â‚Â·</span><span class="n">Î¸</span><span class="err">â‚</span> <span class="o">+</span> <span class="n">k</span><span class="err">â‚‚Â·</span><span class="n">dÎ¸</span><span class="err">â‚</span> <span class="o">+</span> <span class="n">Î»</span><span class="err">â‚Â·</span><span class="n">Î¸</span><span class="err">â‚‚</span> <span class="o">+</span> <span class="n">Î»</span><span class="err">â‚‚Â·</span><span class="n">dÎ¸</span><span class="err">â‚‚</span> <span class="p">(</span><span class="n">linear</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">)</span>
<span class="err">```</span> <span class="o">**</span><span class="n">Terminal</span> <span class="n">SMC</span> <span class="n">Sliding</span> <span class="n">Surface</span><span class="p">:</span><span class="o">**</span>
</pre></div>
</div>
<p>s = kâ‚Â·Î¸â‚ + kâ‚‚Â·sign(dÎ¸â‚)Â·|dÎ¸â‚|^Î± + Î»â‚Â·Î¸â‚‚ + Î»â‚‚Â·sign(dÎ¸â‚‚)Â·|dÎ¸â‚‚|^Î²
``` where <code class="docutils literal notranslate"><span class="pre">Î±,</span> <span class="pre">Î²</span> <span class="pre">âˆˆ</span> <span class="pre">(0,</span> <span class="pre">1)</span></code> (e.g., 0.5, 0.7) create the terminal attractor. <strong>Benefits:</strong></p>
<ul class="simple">
<li><p><strong>Finite-time convergence</strong> (reaches equilibrium in finite time, not just asymptotically)</p></li>
<li><p><strong>Faster response</strong> near equilibrium (stronger control when errors are small) <strong>Challenges:</strong></p></li>
<li><p><strong>Singularity avoidance</strong> (control can blow up if not handled carefully)</p></li>
<li><p><strong>More gains to tune</strong> (4 surface gains + 2 exponents) &gt; <strong>ğŸ“š Theory Background:</strong> For SMC foundations before implementing custom controllers:</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference internal" href="../theory/smc-theory.html"><span class="std std-doc">SMC Theory Guide</span></a> - Lyapunov stability, sliding surfaces, design guidelines ### Step 1: Create the Controller File Create <code class="docutils literal notranslate"><span class="pre">src/controllers/smc/terminal_smc.py</span></code>: ```python</p></li>
</ul>
</div></blockquote>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id1">
<h1>example-metadata:<a class="headerlink" href="#id1" title="Link to this heading">Â¶</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="runnable-false">
<h1>runnable: false #======================================================================================\<a class="headerlink" href="#runnable-false" title="Link to this heading">Â¶</a></h1>
<p>#======================== src/controllers/smc/terminal_smc.py ========================\<br />
#======================================================================================\ â€œâ€â€
Terminal Sliding Mode Controller for double-inverted pendulum. Implements nonlinear terminal sliding surface for finite-time convergence.
â€œâ€â€ import numpy as np
import logging
import weakref
from typing import TYPE_CHECKING, List, Tuple, Dict, Optional, Union, Sequence from â€¦utils import saturate, TerminalSMCOutput if TYPE_CHECKING: from â€¦plant.models.dynamics import DoubleInvertedPendulum logger = logging.getLogger(<strong>name</strong>) class TerminalSMC: â€œâ€â€ Terminal Sliding Mode Controller with finite-time convergence. Uses nonlinear terminal sliding surface with fractional exponents to achieve faster convergence than classical SMC. Parameters â€”â€”â€”- gains : array-like [k1, k2, Î»1, Î»2, K, Î±, Î²] - k1, k2, Î»1, Î»2: sliding surface gains (positive) - K: switching gain (positive) - Î±, Î²: terminal exponents in (0, 1) for finite-time convergence max_force : float Maximum control force (N) boundary_layer : float Boundary layer thickness for chattering reduction dynamics_model : DoubleInvertedPendulum, optional
Dynamics model for equivalent control (if None, uses robust control only)
singularity_epsilon : float, default=1e-3
Small value to avoid singularity when velocities near zero â€œâ€â€ def <strong>init</strong>( self, gains: Union[Sequence[float], np.ndarray], max_force: float, boundary_layer: float, dynamics_model: Optional[â€œDoubleInvertedPendulumâ€] = None, singularity_epsilon: float = 1e-3, switch_method: str = â€œtanhâ€, ): # Validate gain count if len(gains) != 7: raise ValueError( fâ€Terminal SMC requires 7 gains [k1,k2,Î»1,Î»2,K,Î±,Î²], got {len(gains)}â€ ) # Extract and validate gains self.k1, self.k2, self.lam1, self.lam2, self.K, self.alpha, self.beta = gains # Validate gain constraints if self.k1 &lt;= 0 or self.k2 &lt;= 0 or self.lam1 &lt;= 0 or self.lam2 &lt;= 0: raise ValueError(â€œSurface gains k1, k2, Î»1, Î»2 must be positiveâ€) if self.K &lt;= 0: raise ValueError(â€œSwitching gain K must be positiveâ€) if not (0 &lt; self.alpha &lt; 1): raise ValueError(fâ€Terminal exponent Î± must be in (0,1), got {self.alpha}â€) if not (0 &lt; self.beta &lt; 1): raise ValueError(fâ€Terminal exponent Î² must be in (0,1), got {self.beta}â€) # Store parameters self.max_force = max_force self.boundary_layer = boundary_layer self.singularity_epsilon = singularity_epsilon self.switch_method = switch_method # Store dynamics model reference (weakref to avoid circular reference) if dynamics_model is not None: self._dynamics_ref = weakref.ref(dynamics_model) else: self._dynamics_ref = lambda: None <a class="reference external" href="http://logger.info">logger.info</a>( fâ€Initialized Terminal SMC: gains={gains}, max_force={max_force}, â€œ fâ€boundary_layer={boundary_layer}â€ ) &#64;property def dyn(self): â€œâ€â€Access dynamics model via weakref.â€â€â€ if self._dynamics_ref is not None: return self._dynamics_ref() return None def compute_sliding_surface(self, state: np.ndarray) -&gt; float: â€œâ€â€ Compute terminal sliding surface. s = kâ‚Â·Î¸â‚ + kâ‚‚Â·sign(dÎ¸â‚)Â·|dÎ¸â‚|^Î± + Î»â‚Â·Î¸â‚‚ + Î»â‚‚Â·sign(dÎ¸â‚‚)Â·|dÎ¸â‚‚|^Î² Parameters â€”â€”â€”- state : np.ndarray [x, dx, Î¸â‚, dÎ¸â‚, Î¸â‚‚, dÎ¸â‚‚] Returns â€”â€”- s : float Sliding surface value â€œâ€â€ _, _, theta1, dtheta1, theta2, dtheta2 = state # Terminal terms with singularity avoidance # Add small epsilon to avoid division by zero term1 = np.sign(dtheta1) * np.abs(dtheta1 + self.singularity_epsilon) ** self.alpha term2 = np.sign(dtheta2) * np.abs(dtheta2 + self.singularity_epsilon) ** self.beta # Sliding surface s = self.k1 * theta1 + self.k2 * term1 + self.lam1 * theta2 + self.lam2 * term2 return s def switching_function(self, s: float) -&gt; float: â€œâ€â€ Continuous approximation to sign function. Parameters â€”â€”â€”- s : float Sliding surface value Returns â€”â€”- switch : float Switching function output in [-1, 1] â€œâ€â€ if self.switch_method == â€œtanhâ€: return np.tanh(s / self.boundary_layer) elif self.switch_method == â€œlinearâ€: return saturate(s / self.boundary_layer, -1.0, 1.0) else: raise ValueError(fâ€Unknown switch method: {self.switch_method}â€) def compute_control( self, state: np.ndarray, state_vars: Optional[Dict] = None, history: Optional[Dict] = None, ) -&gt; Tuple[float, Dict, Dict]: â€œâ€â€ Compute terminal SMC control law. Parameters â€”â€”â€”- state : np.ndarray State vector [x, dx, Î¸â‚, dÎ¸â‚, Î¸â‚‚, dÎ¸â‚‚] state_vars : dict, optional Controller internal state (unused for terminal SMC) history : dict, optional Historical data (unused for terminal SMC) Returns â€”â€”- control : float Control input (force) state_vars : dict Updated state variables history : dict Updated history â€œâ€â€ # Initialize if None if state_vars is None: state_vars = {} if history is None: history = self.initialize_history() # Compute sliding surface s = self.compute_sliding_surface(state) # Compute switching function switch = self.switching_function(s) # Control law: u = -KÂ·switch(s) # (Simplified: no equivalent control for tutorial simplicity) control = -self.K * switch # Saturate to max force control = saturate(control, -self.max_force, self.max_force) # Log for debugging logger.debug(fâ€Terminal SMC: s={s:.4f}, switch={switch:.4f}, u={control:.4f}â€) return control, state_vars, history def initialize_history(self) -&gt; Dict: â€œâ€â€Initialize empty history (terminal SMC is memoryless).â€â€â€ return {} def cleanup(self): â€œâ€â€Clean up resources.â€â€â€ self._dynamics_ref = None logger.debug(â€œTerminal SMC cleaned upâ€) def <strong>del</strong>(self): â€œâ€â€Destructor for automatic cleanup.â€â€â€ self.cleanup()
<code class="docutils literal notranslate"><span class="pre">###</span> <span class="pre">Step</span> <span class="pre">2:</span> <span class="pre">Create</span> <span class="pre">Output</span> <span class="pre">Dataclass</span> <span class="pre">Add</span> <span class="pre">to</span> <span class="pre">`src/utils/types/control_types.py`:</span></code>python</p>
<p>&#64;dataclass(frozen=True)
class TerminalSMCOutput: â€œâ€â€Output from Terminal SMC controller.â€â€â€ control: float sliding_surface: float switching_function: float terminal_term1: float # sign(dÎ¸â‚)Â·|dÎ¸â‚|^Î± terminal_term2: float # sign(dÎ¸â‚‚)Â·|dÎ¸â‚‚|^Î²</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="o">---</span>

<span class="c1">## Part 3: Factory Integration ### Step 1: Add to SMC Factory Edit `src/controllers/factory/smc_factory.py`: ```python</span>
<span class="c1"># example-metadata:</span>
<span class="c1"># runnable: false from ..smc.terminal_smc import TerminalSMC # Add import class SMCType(str, Enum): CLASSICAL = &quot;classical&quot; ADAPTIVE = &quot;adaptive&quot; SUPER_TWISTING = &quot;super_twisting&quot; HYBRID = &quot;hybrid&quot; TERMINAL = &quot;terminal&quot; # New controller type # Update GAIN_SPECIFICATIONS</span>
<span class="n">GAIN_SPECIFICATIONS</span> <span class="o">=</span> <span class="p">{</span> <span class="c1"># ... existing specs ... SMCType.TERMINAL: GainSpecification( controller_type=SMCType.TERMINAL, n_gains=7, gain_names=[&quot;k1&quot;, &quot;k2&quot;, &quot;lambda1&quot;, &quot;lambda2&quot;, &quot;K&quot;, &quot;alpha&quot;, &quot;beta&quot;], bounds=[(0.1, 50.0), (0.1, 50.0), (0.1, 50.0), (0.1, 50.0), (1.0, 200.0), (0.1, 0.9), (0.1, 0.9)], description=&quot;Terminal SMC with nonlinear sliding surface&quot; ),</span>
<span class="p">}</span> <span class="c1"># Update create_controller method</span>
<span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_controller</span><span class="p">(</span> <span class="n">controller_type</span><span class="p">:</span> <span class="n">SMCType</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">SMCConfig</span><span class="p">,</span> <span class="n">dynamics_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;Create SMC controller instance.&quot;&quot;&quot;</span> <span class="c1"># ... existing code ... elif controller_type == SMCType.TERMINAL: from ..smc.terminal_smc import TerminalSMC return TerminalSMC( gains=config.gains, max_force=config.max_force, boundary_layer=config.boundary_layer, dynamics_model=dynamics_model, singularity_epsilon=getattr(config, &#39;singularity_epsilon&#39;, 1e-3), switch_method=getattr(config, &#39;switch_method&#39;, &#39;tanh&#39;), ) # ... rest of code ...</span>
<span class="err">```</span> <span class="c1">### Step 2: Add Configuration Support Edit `config.yaml`: ```yaml</span>

<span class="n">controllers</span><span class="p">:</span> <span class="c1"># ... existing controllers ... terminal_smc: gains: [10.0, 8.0, 15.0, 12.0, 50.0, 0.5, 0.7] # [k1, k2, Î»1, Î»2, K, Î±, Î²] max_force: 100.0 boundary_layer: 0.01 singularity_epsilon: 0.001 # Avoid singularity switch_method: &quot;tanh&quot;</span>
</pre></div>
</div>
<hr class="docutils" />
<section id="part-4-testing-your-custom-controller-manual-testing-bash">
<h2>Part 4: Testing Your Custom Controller ### Manual Testing ```bash<a class="headerlink" href="#part-4-testing-your-custom-controller-manual-testing-bash" title="Link to this heading">Â¶</a></h2>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="test-terminal-smc-with-default-configuration">
<h1>Test terminal SMC with default configuration<a class="headerlink" href="#test-terminal-smc-with-default-configuration" title="Link to this heading">Â¶</a></h1>
<p>python <a class="reference external" href="http://simulate.py">simulate.py</a> â€“ctrl terminal_smc â€“plot</p>
<div class="highlight-**Expected notranslate"><div class="highlight"><pre><span></span>
- Simulation should complete without errors
- Plot should show state convergence
- Control signal should be bounded by max_force ### Unit Testing Create `tests/test_controllers/test_terminal_smc.py`: ```python
import pytest
import numpy as np
from src.controllers.smc.terminal_smc import TerminalSMC class TestTerminalSMC: &quot;&quot;&quot;Unit tests for Terminal SMC controller.&quot;&quot;&quot; def test_initialization_valid_gains(self): &quot;&quot;&quot;Test controller initializes with valid gains.&quot;&quot;&quot; gains = [10.0, 8.0, 15.0, 12.0, 50.0, 0.5, 0.7] controller = TerminalSMC(gains=gains, max_force=100.0, boundary_layer=0.01) assert controller.k1 == 10.0 assert controller.alpha == 0.5 assert controller.beta == 0.7 def test_initialization_invalid_gain_count(self): &quot;&quot;&quot;Test ValueError raised for wrong number of gains.&quot;&quot;&quot; gains = [10.0, 8.0, 15.0] # Only 3 gains with pytest.raises(ValueError, match=&quot;7 gains&quot;): TerminalSMC(gains=gains, max_force=100.0, boundary_layer=0.01) def test_initialization_invalid_exponents(self): &quot;&quot;&quot;Test ValueError for invalid terminal exponents.&quot;&quot;&quot; gains = [10.0, 8.0, 15.0, 12.0, 50.0, 1.5, 0.7] # Î± &gt; 1 with pytest.raises(ValueError, match=&quot;must be in&quot;): TerminalSMC(gains=gains, max_force=100.0, boundary_layer=0.01) def test_sliding_surface_computation(self): &quot;&quot;&quot;Test sliding surface calculation.&quot;&quot;&quot; gains = [10.0, 8.0, 15.0, 12.0, 50.0, 0.5, 0.7] controller = TerminalSMC(gains=gains, max_force=100.0, boundary_layer=0.01) state = np.array([0.0, 0.0, 0.1, 0.0, 0.15, 0.0]) s = controller.compute_sliding_surface(state) # s = k1Â·Î¸1 + k2Â·0 + Î»1Â·Î¸2 + Î»2Â·0 = 10*0.1 + 15*0.15 = 3.25 assert abs(s - 3.25) &lt; 0.01 def test_control_computation(self): &quot;&quot;&quot;Test control signal computation.&quot;&quot;&quot; gains = [10.0, 8.0, 15.0, 12.0, 50.0, 0.5, 0.7] controller = TerminalSMC(gains=gains, max_force=100.0, boundary_layer=0.01) state = np.array([0.0, 0.0, 0.1, 0.0, 0.15, 0.0]) control, state_vars, history = controller.compute_control(state, {}, {}) # Control should be computed and bounded assert isinstance(control, (float, np.floating)) assert abs(control) &lt;= 100.0 # max_force def test_control_saturation(self): &quot;&quot;&quot;Test control saturation at max_force.&quot;&quot;&quot; gains = [10.0, 8.0, 15.0, 12.0, 500.0, 0.5, 0.7] # Very high K controller = TerminalSMC(gains=gains, max_force=100.0, boundary_layer=0.01) state = np.array([0.0, 0.0, 0.5, 0.0, 0.6, 0.0]) # Large errors control, _, _ = controller.compute_control(state, {}, {}) # Control should saturate at max_force assert abs(control) == 100.0 def test_cleanup(self): &quot;&quot;&quot;Test resource cleanup.&quot;&quot;&quot; gains = [10.0, 8.0, 15.0, 12.0, 50.0, 0.5, 0.7] controller = TerminalSMC(gains=gains, max_force=100.0, boundary_layer=0.01) controller.cleanup() # Dynamics reference should be None after cleanup assert controller._dynamics_ref is None
``` **Run tests:**
```bash

pytest tests/test_controllers/test_terminal_smc.py -v
</pre></div>
</div>
<hr class="docutils" />
<section id="part-5-pso-optimization-of-custom-controller-configure-pso-bounds-edit-config-yaml-yaml">
<h2>Part 5: PSO Optimization of Custom Controller ### Configure PSO Bounds Edit <code class="docutils literal notranslate"><span class="pre">config.yaml</span></code>: ```yaml<a class="headerlink" href="#part-5-pso-optimization-of-custom-controller-configure-pso-bounds-edit-config-yaml-yaml" title="Link to this heading">Â¶</a></h2>
<p>pso: # Terminal SMC specific bounds terminal_smc_bounds: - [0.1, 50.0] # kâ‚ - [0.1, 50.0] # kâ‚‚ - [0.1, 50.0] # Î»â‚ - [0.1, 50.0] # Î»â‚‚ - [1.0, 200.0] # K - [0.1, 0.9] # Î± (must be in (0,1)) - [0.1, 0.9] # Î² (must be in (0,1))
<code class="docutils literal notranslate"><span class="pre">###</span> <span class="pre">Run</span> <span class="pre">PSO</span> <span class="pre">Optimization</span></code>bash</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="optimize-terminal-smc-gains">
<h1>Optimize terminal SMC gains<a class="headerlink" href="#optimize-terminal-smc-gains" title="Link to this heading">Â¶</a></h1>
<p>python <a class="reference external" href="http://simulate.py">simulate.py</a> â€“ctrl terminal_smc â€“run-pso â€“save gains_terminal_optimized.json
<code class="docutils literal notranslate"><span class="pre">###</span> <span class="pre">Compare</span> <span class="pre">with</span> <span class="pre">Classical</span> <span class="pre">SMC</span></code>bash</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="test-optimized-terminal-smc">
<h1>Test optimized terminal SMC<a class="headerlink" href="#test-optimized-terminal-smc" title="Link to this heading">Â¶</a></h1>
<p>python <a class="reference external" href="http://simulate.py">simulate.py</a> â€“load gains_terminal_optimized.json â€“plot â€“save results_terminal.json # Compare with classical SMC
python -c â€œ
import json terminal = json.load(open(â€˜results_terminal.jsonâ€™))
classical = json.load(open(â€˜results_classical.jsonâ€™)) # From previous tutorial print(â€˜Performance Comparison:â€™)
print(fâ€™Terminal SMC ISE: {terminal[â€œmetricsâ€][â€œiseâ€]:.4f}â€™)
print(fâ€™Classical SMC ISE: {classical[â€œmetricsâ€][â€œiseâ€]:.4f}â€™)
print(fâ€™Improvement: {(1 - terminal[â€œmetricsâ€][â€œiseâ€]/classical[â€œmetricsâ€][â€œiseâ€])*100:.1f}%â€™)
â€œ</p>
<div class="highlight-**Expected notranslate"><div class="highlight"><pre><span></span>
- Terminal SMC should achieve faster convergence near equilibrium
- May have similar or slightly better ISE than classical SMC
- Exponents Î±, Î² control convergence speed vs smoothness

---

## Part 6: Advanced Customization ### Adding Equivalent Control For better performance, add model-based equivalent control: ```python

# example-metadata:

# runnable: false def compute_equivalent_control(self, state: np.ndarray) -&gt; float: &quot;&quot;&quot; Compute model-based equivalent control. For terminal SMC, this requires computing: u_eq = - (LÂ·Mâ»Â¹Â·B)â»Â¹ Â· (LÂ·Mâ»Â¹Â·C + ds/dt) where s is the terminal sliding surface. &quot;&quot;&quot; if self.dyn is None: return 0.0 # No model available # Get system matrices M = self.dyn.mass_matrix(state) C = self.dyn.coriolis_centrifugal(state) B = self.dyn.control_matrix() # Compute L (gradient of sliding surface w.r.t. state) L = self.compute_surface_gradient(state) # Solve for u_eq (requires matrix operations) try: M_inv = np.linalg.inv(M) LMB = L @ M_inv @ B if abs(LMB) &lt; 1e-6: # Singularity check return 0.0 u_eq = -(1 / LMB) * (L @ M_inv @ C) return saturate(u_eq, -self.max_force, self.max_force)

    except np.linalg.LinAlgError:
        return 0.0  # Fallback to robust control only
</pre></div>
</div>
<section id="adding-state-variables-e-g-integral-term">
<h2>Adding State Variables (e.g., Integral Term)<a class="headerlink" href="#adding-state-variables-e-g-integral-term" title="Link to this heading">Â¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># example-metadata:</span>

<span class="c1"># runnable: false def __init__(self, ...): # ... existing code ... self.use_integral = True self.k_integral = 2.0 # Integral gain def compute_control(self, state, state_vars, history): # Initialize integral term if not present if &#39;integral_s&#39; not in state_vars: state_vars[&#39;integral_s&#39;] = 0.0 # Compute sliding surface s = self.compute_sliding_surface(state) # Update integral term dt = 0.01 # Get from config state_vars[&#39;integral_s&#39;] += s * dt # Control law with integral term control = -self.K * self.switching_function(s) - self.k_integral * state_vars[&#39;integral_s&#39;] # Saturate control = saturate(control, -self.max_force, self.max_force) return control, state_vars, history</span>

</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="part-7-best-practices-1-gain-validation-always-validate-gains-in-init-python">
<h2>Part 7: Best Practices ### 1. Gain Validation <strong>Always validate gains in <code class="docutils literal notranslate"><span class="pre">__init__</span></code>:</strong> ```python<a class="headerlink" href="#part-7-best-practices-1-gain-validation-always-validate-gains-in-init-python" title="Link to this heading">Â¶</a></h2>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id2">
<h1>example-metadata:<a class="headerlink" href="#id2" title="Link to this heading">Â¶</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="runnable-false-def-init-self-gains-check-count-if-len-gains-expected-count-raise-valueerror-f-expected-expected-count-gains-got-len-gains-check-bounds-if-any-g-0-for-g-in-gains-4-surface-gains-must-be-positive-raise-valueerror-surface-gains-must-be-non-negative-check-constraints-e-g-exponents-in-0-1-if-not-0-alpha-1-raise-valueerror-f-exponent-must-be-in-0-1-got-alpha">
<h1>runnable: false def <strong>init</strong>(self, gains, â€¦): # Check count if len(gains) != expected_count: raise ValueError(fâ€Expected {expected_count} gains, got {len(gains)}â€) # Check bounds if any(g &lt; 0 for g in gains[:4]): # Surface gains must be positive raise ValueError(â€œSurface gains must be non-negativeâ€) # Check constraints (e.g., exponents in (0,1)) if not (0 &lt; alpha &lt; 1): raise ValueError(fâ€Exponent Î± must be in (0,1), got {alpha}â€)<a class="headerlink" href="#runnable-false-def-init-self-gains-check-count-if-len-gains-expected-count-raise-valueerror-f-expected-expected-count-gains-got-len-gains-check-bounds-if-any-g-0-for-g-in-gains-4-surface-gains-must-be-positive-raise-valueerror-surface-gains-must-be-non-negative-check-constraints-e-g-exponents-in-0-1-if-not-0-alpha-1-raise-valueerror-f-exponent-must-be-in-0-1-got-alpha" title="Link to this heading">Â¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">###</span> <span class="pre">2.</span> <span class="pre">Numerical</span> <span class="pre">Robustness</span> <span class="pre">**Avoid</span> <span class="pre">singularities:**</span></code>python</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="bad-division-by-zero">
<h1>Bad: Division by zero<a class="headerlink" href="#bad-division-by-zero" title="Link to this heading">Â¶</a></h1>
<p>term = dtheta ** alpha # Good: Add small epsilon
term = np.sign(dtheta) * (np.abs(dtheta) + 1e-6) ** alpha
<code class="docutils literal notranslate"><span class="pre">**Matrix</span> <span class="pre">inversion</span> <span class="pre">safety:**</span></code>python
try: M_inv = np.linalg.inv(M)
except np.linalg.LinAlgError:
logger.warning(â€œSingular matrix, using robust control onlyâ€)
return 0.0  # Fallback</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="c1">## 3. Logging and Debugging</span>

<span class="err">```</span><span class="n">python</span>
<span class="c1"># example-metadata:</span>
<span class="c1"># runnable: false import logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span> <span class="k">def</span><span class="w"> </span><span class="nf">compute_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span> <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_sliding_surface</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sliding surface: s=</span><span class="si">{</span><span class="n">s</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="n">control</span> <span class="o">=</span> <span class="o">...</span> <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Control output: u=</span><span class="si">{</span><span class="n">control</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">return</span> <span class="n">control</span><span class="p">,</span> <span class="n">state_vars</span><span class="p">,</span> <span class="n">history</span>
<span class="err">```</span> <span class="c1">### 4. Memory Management ```python</span>

<span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="s2">&quot;&quot;&quot;Explicit cleanup for long-running processes.&quot;&quot;&quot;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamics_ref</span> <span class="o">=</span> <span class="kc">None</span> <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> cleaned up&quot;</span><span class="p">)</span> <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="s2">&quot;&quot;&quot;Automatic cleanup on garbage collection.&quot;&quot;&quot;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
</pre></div>
</div>
<hr class="docutils" />
<section id="part-8-exercise-implement-fast-terminal-smc-challenge-implement-fast-terminal-smc-ftsmc-which-uses-a-different-sliding-surface">
<h2>Part 8: Exercise: Implement Fast Terminal SMC <strong>Challenge:</strong> Implement <strong>Fast Terminal SMC</strong> (FTSMC), which uses a different sliding surface: ```<a class="headerlink" href="#part-8-exercise-implement-fast-terminal-smc-challenge-implement-fast-terminal-smc-ftsmc-which-uses-a-different-sliding-surface" title="Link to this heading">Â¶</a></h2>
<p>s = Î¸â‚ + Î²â‚Â·sign(dÎ¸â‚)Â·|dÎ¸â‚|^Î± + Î¸â‚‚ + Î²â‚‚Â·sign(dÎ¸â‚‚)Â·|dÎ¸â‚‚|^Î³</p>
<div class="highlight-**Requirements:** notranslate"><div class="highlight"><pre><span></span>
1. Create `src/controllers/smc/fast_terminal_smc.py`
2. Add to factory with type `SMCType.FAST_TERMINAL`
3. Add configuration to `config.yaml`
4. Write unit tests
5. Run PSO optimization
6. Compare performance with Terminal SMC and Classical SMC **Expected Learning:**
- Understand how different sliding surface designs affect performance
- Practice the full controller development workflow
- Gain intuition for SMC design choices

---

## Summary **Controller Development Workflow:** 1. **Design:** Define control law mathematically

2. **Implement:** Create Python class with standard interface
3. **Validate:** Add gain checking and error handling
4. **Integrate:** Add to factory and configuration
5. **Test:** Write unit tests and manual testing
6. **Optimize:** Use PSO to tune gains
7. **Compare:** Benchmark against existing controllers **Key Takeaways:** - Controllers must implement `compute_control(state, state_vars, history)`
- Always validate gains in `__init__` (count, bounds, constraints)
- Use weakref for dynamics model to avoid circular references
- Add logging for debugging
- Write unit tests
- Use PSO for automatic gain tuning **When to Create Custom Controllers:** âœ… Research on novel SMC variants
âœ… Application-specific requirements (constraints, objectives)
âœ… Comparing different control strategies
âœ… Educational purposes

---

## Next Steps **Next Tutorial:** [Tutorial 05: Research Workflows](tutorial-05-research-workflow.md) - End-to-end project from theory to publication **Related Guides:**

- [Controllers API](../api/controllers.md): Factory integration and controller interfaces
- [Testing &amp; Validation How-To](../how-to/testing-validation.md): testing strategies **Theory &amp; Foundations:**
- [SMC Theory Guide](../theory/smc-theory.md): Design principles for custom controllers - Practical design guidelines - Gain selection via pole placement - Robustness analysis - Classical vs Super-Twisting comparison **Advanced Topics:**
- Adaptive laws and parameter estimation
- Observer design for state estimation
- Disturbance estimation and rejection
- Real hardware deployment (coming soon) **Congratulations!** You can now design and implement custom SMC controllers for the DIP system.
</pre></div>
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, Research Team
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            <div class="last-updated">
              Last updated on Oct 10, 2025</div>
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Tutorial 04: Custom Controller Development <strong>Level:</strong> Advanced</a><ul>
<li><a class="reference internal" href="#part-1-controller-architecture-overview-the-controller-interface-all-controllers-in-this-framework-implement-a-consistent-interface-python">Part 1: Controller Architecture Overview ### The Controller Interface All controllers in this framework implement a <strong>consistent interface</strong>: ```python</a></li>
</ul>
</li>
<li><a class="reference internal" href="#example-metadata">example-metadata:</a></li>
<li><a class="reference internal" href="#runnable-false-class-mycustomcontroller-def-init-self-gains-max-force-kwargs-initialize-controller-with-gains-and-parameters-pass-def-compute-control-self-state-state-vars-history-compute-control-signal-for-current-state-parameters-state-np-ndarray-state-vector-x-dx-1-d1-2-d2-state-vars-dict-controller-specific-internal-state-history-dict-historical-data-for-multi-step-algorithms-returns-control-float-control-input-force-applied-to-cart-state-vars-dict-updated-internal-state-history-dict-updated-history-pass-def-initialize-history-self-dict-initialize-history-buffer-for-controller-return-def-cleanup-self-clean-up-resources-optional-pass">runnable: false class MyCustomController: def <strong>init</strong>(self, gains, max_force, **kwargs): â€œâ€â€Initialize controller with gains and parameters.â€â€â€ pass def compute_control(self, state, state_vars, history): â€œâ€â€ Compute control signal for current state. Parameters â€”â€”â€”- state : np.ndarray State vector [x, dx, Î¸â‚, dÎ¸â‚, Î¸â‚‚, dÎ¸â‚‚] state_vars : dict Controller-specific internal state history : dict Historical data for multi-step algorithms Returns â€”â€”- control : float Control input (force applied to cart) state_vars : dict Updated internal state history : dict Updated history â€œâ€â€ pass def initialize_history(self) -&gt; dict: â€œâ€â€Initialize history buffer for controller.â€â€â€ return {} def cleanup(self): â€œâ€â€Clean up resources (optional).â€â€â€ pass</a><ul>
<li><a class="reference internal" href="#part-2-implementing-a-terminal-smc-tsmc-what-is-terminal-smc-terminal-sliding-mode-control-uses-a-nonlinear-sliding-surface-with-fractional-powers-to-achieve-finite-time-convergence-faster-than-asymptotic-classical-smc-sliding-surface">Part 2: Implementing a Terminal SMC (TSMC) ### What is Terminal SMC? <strong>Terminal Sliding Mode Control</strong> uses a <strong>nonlinear sliding surface</strong> with fractional powers to achieve <strong>finite-time convergence</strong> (faster than asymptotic). <strong>Classical SMC Sliding Surface:</strong></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id1">example-metadata:</a></li>
<li><a class="reference internal" href="#runnable-false">runnable: false #======================================================================================\</a><ul>
<li><a class="reference internal" href="#part-4-testing-your-custom-controller-manual-testing-bash">Part 4: Testing Your Custom Controller ### Manual Testing ```bash</a></li>
</ul>
</li>
<li><a class="reference internal" href="#test-terminal-smc-with-default-configuration">Test terminal SMC with default configuration</a><ul>
<li><a class="reference internal" href="#part-5-pso-optimization-of-custom-controller-configure-pso-bounds-edit-config-yaml-yaml">Part 5: PSO Optimization of Custom Controller ### Configure PSO Bounds Edit <code class="docutils literal notranslate"><span class="pre">config.yaml</span></code>: ```yaml</a></li>
</ul>
</li>
<li><a class="reference internal" href="#optimize-terminal-smc-gains">Optimize terminal SMC gains</a></li>
<li><a class="reference internal" href="#test-optimized-terminal-smc">Test optimized terminal SMC</a><ul>
<li><a class="reference internal" href="#adding-state-variables-e-g-integral-term">Adding State Variables (e.g., Integral Term)</a></li>
<li><a class="reference internal" href="#part-7-best-practices-1-gain-validation-always-validate-gains-in-init-python">Part 7: Best Practices ### 1. Gain Validation <strong>Always validate gains in <code class="docutils literal notranslate"><span class="pre">__init__</span></code>:</strong> ```python</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id2">example-metadata:</a></li>
<li><a class="reference internal" href="#runnable-false-def-init-self-gains-check-count-if-len-gains-expected-count-raise-valueerror-f-expected-expected-count-gains-got-len-gains-check-bounds-if-any-g-0-for-g-in-gains-4-surface-gains-must-be-positive-raise-valueerror-surface-gains-must-be-non-negative-check-constraints-e-g-exponents-in-0-1-if-not-0-alpha-1-raise-valueerror-f-exponent-must-be-in-0-1-got-alpha">runnable: false def <strong>init</strong>(self, gains, â€¦): # Check count if len(gains) != expected_count: raise ValueError(fâ€Expected {expected_count} gains, got {len(gains)}â€) # Check bounds if any(g &lt; 0 for g in gains[:4]): # Surface gains must be positive raise ValueError(â€œSurface gains must be non-negativeâ€) # Check constraints (e.g., exponents in (0,1)) if not (0 &lt; alpha &lt; 1): raise ValueError(fâ€Exponent Î± must be in (0,1), got {alpha}â€)</a></li>
<li><a class="reference internal" href="#bad-division-by-zero">Bad: Division by zero</a><ul>
<li><a class="reference internal" href="#part-8-exercise-implement-fast-terminal-smc-challenge-implement-fast-terminal-smc-ftsmc-which-uses-a-different-sliding-surface">Part 8: Exercise: Implement Fast Terminal SMC <strong>Challenge:</strong> Implement <strong>Fast Terminal SMC</strong> (FTSMC), which uses a different sliding surface: ```</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=4ebf8126"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=08e7b316"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../_static/back-to-top.js?v=840797bb"></script>
    <script src="../../_static/lazy-load.js?v=dc25293c"></script>
    <script src="../../_static/dark-mode.js?v=bf328970"></script>
    </body>
</html>