#!/bin/sh
# Pre-commit hook for DIP-SMC-PSO project
# Phase 6.5: Local Quality Gate Validation
#
# This hook runs local validation checks before allowing commits.
# To bypass (use sparingly): git commit --no-verify

set -e

echo "🔍 Running pre-commit quality checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track failures
FAILURES=0

# Function to print colored status
print_status() {
    if [ $1 -eq 0 ]; then
        echo "${GREEN}✓${NC} $2"
    else
        echo "${RED}✗${NC} $2"
        FAILURES=$((FAILURES + 1))
    fi
}

# 1. Check Python syntax
echo "\n${YELLOW}[1/5]${NC} Checking Python syntax..."
PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -n "$PYTHON_FILES" ]; then
    for file in $PYTHON_FILES; do
        python -m py_compile "$file" 2>/dev/null
        print_status $? "Python syntax: $file"
    done
else
    echo "  No Python files to check"
fi

# 2. Check for large files
echo "\n${YELLOW}[2/5]${NC} Checking for large files..."
LARGE_FILES=$(git diff --cached --name-only --diff-filter=ACM | while read file; do
    if [ -f "$file" ] && [ $(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null) -gt 1048576 ]; then
        echo "$file"
    fi
done)

if [ -n "$LARGE_FILES" ]; then
    echo "${RED}✗${NC} Large files detected (>1MB):"
    echo "$LARGE_FILES"
    FAILURES=$((FAILURES + 1))
else
    print_status 0 "No large files detected"
fi

# 3. Check for debugging statements
echo "\n${YELLOW}[3/5]${NC} Checking for debugging statements..."
DEBUG_FOUND=0

if [ -n "$PYTHON_FILES" ]; then
    for file in $PYTHON_FILES; do
        if grep -qE "(import pdb|breakpoint\(\)|import ipdb)" "$file"; then
            echo "  ${RED}Warning:${NC} Found debugging statements in $file"
            DEBUG_FOUND=1
        fi
    done
fi

if [ $DEBUG_FOUND -eq 0 ]; then
    print_status 0 "No debugging statements found"
fi

# 4. Check for TODO/FIXME comments in staged code
echo "\n${YELLOW}[4/5]${NC} Checking for TODO/FIXME markers..."
TODO_COUNT=0

if [ -n "$PYTHON_FILES" ]; then
    TODO_COUNT=$(git diff --cached | grep -E '^\+.*#.*(TODO|FIXME)' | wc -l || true)
fi

if [ $TODO_COUNT -gt 0 ]; then
    echo "  ${YELLOW}Info:${NC} $TODO_COUNT TODO/FIXME comments added"
else
    echo "  No new TODO/FIXME markers"
fi

# 5. Run quick linting (ruff) if available
echo "\n${YELLOW}[5/5]${NC} Running ruff linter..."

if command -v ruff &> /dev/null; then
    if [ -n "$PYTHON_FILES" ]; then
        ruff check $PYTHON_FILES --quiet 2>/dev/null
        print_status $? "Ruff linting"
    else
        echo "  No Python files to lint"
    fi
else
    echo "  ${YELLOW}Skipped${NC} (ruff not installed)"
fi

# 6. AUTOMATIC PROJECT STATE TRACKING
echo "\n${YELLOW}[6/6]${NC} Auto-updating project state..."

# Detect Python interpreter
if command -v python3 &> /dev/null; then
    PYTHON_CMD=python3
elif command -v python &> /dev/null; then
    PYTHON_CMD=python
else
    PYTHON_CMD=""
fi

PROJECT_ROOT=$(git rev-parse --show-toplevel)
STATE_MANAGER="$PROJECT_ROOT/.dev_tools/project_state_manager.py"
STATE_FILE="$PROJECT_ROOT/.ai/config/project_state.json"

if [ -n "$PYTHON_CMD" ] && [ -f "$STATE_MANAGER" ]; then
    # Initialize state if missing
    if [ ! -f "$STATE_FILE" ]; then
        "$PYTHON_CMD" "$STATE_MANAGER" init >/dev/null 2>&1 || true
    fi

    # Get commit message from editor or -m flag
    COMMIT_MSG_FILE="$(git rev-parse --git-dir)/COMMIT_EDITMSG"
    COMMIT_MSG=""
    if [ -f "$COMMIT_MSG_FILE" ]; then
        COMMIT_MSG=$(cat "$COMMIT_MSG_FILE" 2>/dev/null || echo "")
    fi

    # Detect task ID from commit message (e.g., "feat(MT-6): ...")
    TASK_ID=$(echo "$COMMIT_MSG" | grep -oE '(QW|MT|LT)-[0-9]+' | head -n1 || echo "")

    # Detect deliverables from staged files
    DELIVERABLES=""
    for file in $(git diff --cached --name-only --diff-filter=A); do
        case "$file" in
            benchmarks/*.md|docs/theory/*.md|src/controllers/*.py|optimization_results/*.json)
                DELIVERABLES="$DELIVERABLES --deliverables $(basename "$file")"
                ;;
        esac
    done

    # Auto-complete task if detected
    if [ -n "$TASK_ID" ] && [ -n "$DELIVERABLES" ]; then
        eval "$PYTHON_CMD" "$STATE_MANAGER" complete "$TASK_ID" "$DELIVERABLES" >/dev/null 2>&1 || true
        git add "$STATE_FILE" >/dev/null 2>&1 || true
        print_status 0 "Auto-completed task $TASK_ID"
    else
        echo "  No task completion detected (normal for most commits)"
    fi
else
    echo "  ${YELLOW}Skipped${NC} (state manager not found or Python unavailable)"
fi

# Summary
echo "\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

if [ $FAILURES -eq 0 ]; then
    echo "${GREEN}✓ All pre-commit checks passed!${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n"
    exit 0
else
    echo "${RED}✗ $FAILURES check(s) failed!${NC}"
    echo ""
    echo "To fix:"
    echo "  - Fix the issues above"
    echo "  - Or bypass with: git commit --no-verify (not recommended)"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n"
    exit 1
fi
