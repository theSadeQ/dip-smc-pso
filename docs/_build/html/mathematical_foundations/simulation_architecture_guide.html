<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
.chartjs-container {
    margin: 1.5em auto;
    padding: 1em;
    background: #f8f9fa;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.chart-note {
    text-align: center;
    color: #6c757d;
    font-size: 0.9em;
    margin-top: 0.5em;
}
</style>
<link rel="index" title="Index" href="../genindex.html"><link rel="search" title="Search" href="../search.html">

    <!-- Generated with Sphinx 8.2.3 and Furo 2025.09.25 -->
        <title>Simulation Architecture Guide - DIP_SMC_PSO Documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=5349f25f" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=580074bf" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=8dab3a3b" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=8a7e329d" />
    
    


<style>
  body {
    --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">DIP_SMC_PSO Documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <span class="sidebar-brand-text">DIP_SMC_PSO Documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">📚 Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../README.html">Optimal Sliding Mode Control for a Double-Inverted Pendulum via PSO  ## How to validate a ResearchPlan JSON Run the validator locally: ```bash</a></li>
<li class="toctree-l1"><a class="reference internal" href="../theory_overview.html">Theory Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">3. System Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plant_model.html">1.x Plant Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hil_quickstart.html">Hardware-in-the-Loop (HIL) Quickstart Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../streamlit_dashboard_guide.html">Streamlit Dashboard User Guide</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="https://github.com/theSadeQ/DIP_SMC_PSO/blob/main/docs/mathematical_foundations/simulation_architecture_guide.md?plain=true" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div><div class="edit-this-page">
  <a class="muted-link" href="https://github.com/theSadeQ/DIP_SMC_PSO/edit/main/docs/mathematical_foundations/simulation_architecture_guide.md" rel="edit" title="Edit this page">
    <svg><use href="#svg-pencil"></use></svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section class="tex2jax_ignore mathjax_ignore" id="simulation-architecture-guide">
<h1>Simulation Architecture Guide<a class="headerlink" href="#simulation-architecture-guide" title="Link to this heading">¶</a></h1>
<p><strong>High-Performance Simulation System: Vector Engine, Safety Guards &amp; Orchestration</strong></p>
<section id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Link to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#introduction">Introduction</a></p></li>
<li><p><a class="reference internal" href="#architecture-overview">Architecture Overview</a></p></li>
<li><p><a class="reference internal" href="#vector-simulation-engine">Vector Simulation Engine</a></p></li>
<li><p><a class="reference internal" href="#simulation-runner">Simulation Runner</a></p></li>
<li><p><a class="reference internal" href="#simulation-context">Simulation Context</a></p></li>
<li><p><a class="reference internal" href="#orchestrators">Orchestrators</a></p></li>
<li><p><a class="reference internal" href="#safety-system">Safety System</a></p></li>
<li><p><a class="reference internal" href="#performance-optimization">Performance Optimization</a></p></li>
<li><p><a class="reference internal" href="#best-practices">Best Practices</a></p></li>
</ol>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p>The DIP-SMC-PSO simulation architecture provides a high-performance, production-grade simulation framework for nonlinear dynamical systems. It supports both scalar and vectorized batch execution with integrated safety guards, multiple orchestration strategies, and adaptive time-stepping.</p>
<section id="design-principles">
<h3>Design Principles<a class="headerlink" href="#design-principles" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p><strong>Shape Parity:</strong> Scalar and batch modes use consistent array shapes</p></li>
<li><p><strong>Safety First:</strong> Integrated safety guards prevent numerical instabilities</p></li>
<li><p><strong>Performance:</strong> Vectorized operations for 20-30x speedup</p></li>
<li><p><strong>Flexibility:</strong> Multiple dynamics models, integrators, and orchestrators</p></li>
<li><p><strong>Production Ready:</strong> Early stopping, error recovery, graceful degradation</p></li>
</ol>
</section>
<section id="key-features">
<h3>Key Features<a class="headerlink" href="#key-features" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Vectorized Execution:</strong> Batch simulation of 30+ particles simultaneously</p></li>
<li><p><strong>Multiple Dynamics Models:</strong> Simplified, full nonlinear, low-rank approximations</p></li>
<li><p><strong>Adaptive Integration:</strong> Error-controlled RK45, RK23 integrators</p></li>
<li><p><strong>Safety Guards:</strong> Energy limits, state bounds, NaN detection</p></li>
<li><p><strong>Orchestration Strategies:</strong> Batch, sequential, parallel, real-time</p></li>
<li><p><strong>Memory Efficient:</strong> View-based operations, zero-copy when possible</p></li>
</ul>
</section>
</section>
<section id="architecture-overview">
<h2>Architecture Overview<a class="headerlink" href="#architecture-overview" title="Link to this heading">¶</a></h2>
<section id="component-hierarchy">
<h3>Component Hierarchy<a class="headerlink" href="#component-hierarchy" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="err">┌───────────────────────────────────────────────────────────┐</span>
<span class="err">│</span>              <span class="n">User</span> <span class="n">Interface</span> <span class="p">(</span><span class="n">CLI</span><span class="p">,</span> <span class="n">Streamlit</span><span class="p">)</span>               <span class="err">│</span>
<span class="err">└─────────────────────┬─────────────────────────────────────┘</span>
                      <span class="err">│</span>
<span class="err">┌─────────────────────▼─────────────────────────────────────┐</span>
<span class="err">│</span>          <span class="n">Simulation</span> <span class="n">Context</span> <span class="p">(</span><span class="n">Configuration</span> <span class="n">Layer</span><span class="p">)</span>          <span class="err">│</span>
<span class="err">├────────────────────────────────────────────────────────────┤</span>
<span class="err">│</span>  <span class="err">•</span> <span class="n">Configuration</span> <span class="n">loading</span> <span class="o">&amp;</span> <span class="n">validation</span>                      <span class="err">│</span>
<span class="err">│</span>  <span class="err">•</span> <span class="n">Dynamics</span> <span class="n">model</span> <span class="n">selection</span>                                <span class="err">│</span>
<span class="err">│</span>  <span class="err">•</span> <span class="n">Controller</span> <span class="n">creation</span>                                     <span class="err">│</span>
<span class="err">│</span>  <span class="err">•</span> <span class="n">FDI</span> <span class="n">system</span> <span class="n">initialization</span>                               <span class="err">│</span>
<span class="err">└─────────────────────┬─────────────────────────────────────┘</span>
                      <span class="err">│</span>
<span class="err">┌─────────────────────▼─────────────────────────────────────┐</span>
<span class="err">│</span>          <span class="n">Orchestrators</span> <span class="p">(</span><span class="n">Execution</span> <span class="n">Strategy</span> <span class="n">Layer</span><span class="p">)</span>          <span class="err">│</span>
<span class="err">├────────────────────────────────────────────────────────────┤</span>
<span class="err">│</span>  <span class="err">•</span> <span class="n">BatchOrchestrator</span> <span class="p">(</span><span class="n">vectorized</span><span class="p">)</span>                          <span class="err">│</span>
<span class="err">│</span>  <span class="err">•</span> <span class="n">SequentialOrchestrator</span> <span class="p">(</span><span class="n">single</span><span class="o">-</span><span class="n">threaded</span><span class="p">)</span>                <span class="err">│</span>
<span class="err">│</span>  <span class="err">•</span> <span class="n">ParallelOrchestrator</span> <span class="p">(</span><span class="n">multi</span><span class="o">-</span><span class="n">process</span><span class="p">)</span>                    <span class="err">│</span>
<span class="err">│</span>  <span class="err">•</span> <span class="n">RealTimeOrchestrator</span> <span class="p">(</span><span class="n">hardware</span><span class="o">-</span><span class="ow">in</span><span class="o">-</span><span class="n">loop</span><span class="p">)</span>                 <span class="err">│</span>
<span class="err">└─────────────────────┬─────────────────────────────────────┘</span>
                      <span class="err">│</span>
<span class="err">┌─────────────────────▼─────────────────────────────────────┐</span>
<span class="err">│</span>          <span class="n">Vector</span> <span class="n">Simulation</span> <span class="n">Engine</span> <span class="p">(</span><span class="n">Core</span> <span class="n">Layer</span><span class="p">)</span>             <span class="err">│</span>
<span class="err">├────────────────────────────────────────────────────────────┤</span>
<span class="err">│</span>  <span class="err">•</span> <span class="n">simulate</span><span class="p">()</span> <span class="o">-</span> <span class="n">unified</span> <span class="n">façade</span>                             <span class="err">│</span>
<span class="err">│</span>  <span class="err">•</span> <span class="n">Batch</span> <span class="n">dimension</span> <span class="n">handling</span>                                <span class="err">│</span>
<span class="err">│</span>  <span class="err">•</span> <span class="n">Early</span> <span class="n">stopping</span> <span class="n">support</span>                                  <span class="err">│</span>
<span class="err">│</span>  <span class="err">•</span> <span class="n">Safety</span> <span class="n">guard</span> <span class="n">integration</span>                                <span class="err">│</span>
<span class="err">└─────────────────────┬─────────────────────────────────────┘</span>
                      <span class="err">│</span>
<span class="err">┌─────────────────────▼─────────────────────────────────────┐</span>
<span class="err">│</span>        <span class="n">Simulation</span> <span class="n">Runner</span> <span class="p">(</span><span class="n">Dispatch</span> <span class="n">Layer</span><span class="p">)</span>                  <span class="err">│</span>
<span class="err">├────────────────────────────────────────────────────────────┤</span>
<span class="err">│</span>  <span class="err">•</span> <span class="n">step</span><span class="p">()</span> <span class="o">-</span> <span class="n">dynamics</span> <span class="n">dispatch</span>                              <span class="err">│</span>
<span class="err">│</span>  <span class="err">•</span> <span class="n">run_simulation</span><span class="p">()</span> <span class="o">-</span> <span class="n">trajectory</span> <span class="n">generation</span>                <span class="err">│</span>
<span class="err">│</span>  <span class="err">•</span> <span class="n">Model</span> <span class="n">selection</span> <span class="p">(</span><span class="n">full</span> <span class="n">vs</span> <span class="n">simplified</span><span class="p">)</span>                    <span class="err">│</span>
<span class="err">│</span>  <span class="err">•</span> <span class="n">Latency</span> <span class="n">monitoring</span>                                      <span class="err">│</span>
<span class="err">└─────────────────────┬─────────────────────────────────────┘</span>
                      <span class="err">│</span>
        <span class="err">┌─────────────┴─────────────┐</span>
        <span class="err">│</span>                           <span class="err">│</span>
<span class="err">┌───────▼────────┐</span>         <span class="err">┌────────▼─────────┐</span>
<span class="err">│</span> <span class="n">Dynamics</span> <span class="n">Models</span> <span class="err">│</span>         <span class="err">│</span>   <span class="n">Integrators</span>    <span class="err">│</span>
<span class="err">├────────────────┤</span>         <span class="err">├──────────────────┤</span>
<span class="err">│</span> <span class="err">•</span> <span class="n">Simplified</span>   <span class="err">│</span>         <span class="err">│</span> <span class="err">•</span> <span class="n">Fixed</span><span class="o">-</span><span class="n">step</span>     <span class="err">│</span>
<span class="err">│</span> <span class="err">•</span> <span class="n">Full</span>         <span class="err">│</span>         <span class="err">│</span>   <span class="o">-</span> <span class="n">Euler</span>        <span class="err">│</span>
<span class="err">│</span> <span class="err">•</span> <span class="n">Low</span><span class="o">-</span><span class="n">rank</span>     <span class="err">│</span>         <span class="err">│</span>   <span class="o">-</span> <span class="n">RK4</span>          <span class="err">│</span>
<span class="err">└────────────────┘</span>         <span class="err">│</span> <span class="err">•</span> <span class="n">Adaptive</span>       <span class="err">│</span>
                           <span class="err">│</span>   <span class="o">-</span> <span class="n">RK45</span>         <span class="err">│</span>
                           <span class="err">│</span>   <span class="o">-</span> <span class="n">RK23</span>         <span class="err">│</span>
                           <span class="err">└──────────────────┘</span>
</pre></div>
</div>
</section>
<section id="data-flow">
<h3>Data Flow<a class="headerlink" href="#data-flow" title="Link to this heading">¶</a></h3>
<p><strong>Scalar Simulation:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Initial</span> <span class="n">state</span> <span class="p">(</span><span class="n">D</span><span class="p">,)</span> <span class="err">→</span> <span class="n">simulate</span><span class="p">()</span> <span class="err">→</span> <span class="n">Safety</span> <span class="n">guards</span> <span class="err">→</span> <span class="n">states</span> <span class="p">(</span><span class="n">H</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Batch Simulation:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Initial</span> <span class="n">states</span> <span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span> <span class="err">→</span> <span class="n">simulate</span><span class="p">()</span> <span class="err">→</span> <span class="n">Vectorized</span> <span class="n">dynamics</span> <span class="err">→</span> <span class="n">states</span> <span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">H</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="vector-simulation-engine">
<h2>Vector Simulation Engine<a class="headerlink" href="#vector-simulation-engine" title="Link to this heading">¶</a></h2>
<section id="simulate-function">
<h3>simulate() Function<a class="headerlink" href="#simulate-function" title="Link to this heading">¶</a></h3>
<p><strong>Location:</strong> <code class="docutils literal notranslate"><span class="pre">src/simulation/engines/vector_sim.py</span></code></p>
<p>The <code class="docutils literal notranslate"><span class="pre">simulate()</span></code> function is the unified entry point for all simulations, handling both scalar and batch modes transparently.</p>
<section id="signature">
<h4>Signature<a class="headerlink" href="#signature" title="Link to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># example-metadata:</span>
<span class="c1"># runnable: false</span>

<span class="k">def</span><span class="w"> </span><span class="nf">simulate</span><span class="p">(</span>
    <span class="n">initial_state</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">control_inputs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">horizon</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">energy_limits</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">state_bounds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">stop_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">t0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="shape-conventions">
<h2>Shape Conventions<a class="headerlink" href="#shape-conventions" title="Link to this heading">¶</a></h2>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Mode</p></th>
<th class="head"><p>Initial State</p></th>
<th class="head"><p>Control Inputs</p></th>
<th class="head"><p>Output States</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Scalar</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(D,)</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(H,)</span></code> or <code class="docutils literal notranslate"><span class="pre">(H,</span> <span class="pre">U)</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(H+1,</span> <span class="pre">D)</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Batch</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(B,</span> <span class="pre">D)</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(B,</span> <span class="pre">H)</span></code> or <code class="docutils literal notranslate"><span class="pre">(B,</span> <span class="pre">H,</span> <span class="pre">U)</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(B,</span> <span class="pre">H+1,</span> <span class="pre">D)</span></code></p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Key principle:</strong> Output always includes initial state at index 0</p>
<section id="usage-examples">
<h3>Usage Examples<a class="headerlink" href="#usage-examples" title="Link to this heading">¶</a></h3>
<p><strong>Scalar Simulation:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">src.simulation.engines.vector_sim</span><span class="w"> </span><span class="kn">import</span> <span class="n">simulate</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Single pendulum simulation</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>  <span class="c1"># [x, θ1, θ2, ẋ, θ̇1, θ̇2]</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>  <span class="c1"># No control input</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># 10 ms timestep</span>

<span class="n">states</span> <span class="o">=</span> <span class="n">simulate</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;State shape: </span><span class="si">{</span><span class="n">states</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># (101, 6) - includes initial state</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial state: </span><span class="si">{</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>   <span class="c1"># Same as x0</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final state: </span><span class="si">{</span><span class="n">states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Batch Simulation (PSO Use Case):</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># example-metadata:</span>
<span class="c1"># runnable: false</span>

<span class="c1"># Simulate 30 particles with different initial conditions</span>
<span class="n">n_particles</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">x0_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_particles</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>  <span class="c1"># (30, 6)</span>
<span class="n">u_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_particles</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>            <span class="c1"># (30, 100)</span>

<span class="n">states_batch</span> <span class="o">=</span> <span class="n">simulate</span><span class="p">(</span><span class="n">x0_batch</span><span class="p">,</span> <span class="n">u_batch</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch shape: </span><span class="si">{</span><span class="n">states_batch</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># (30, 101, 6)</span>

<span class="c1"># Analyze each particle</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_particles</span><span class="p">):</span>
    <span class="n">final_energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">states_batch</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Particle </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: final energy = </span><span class="si">{</span><span class="n">final_energy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Early Stopping:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Stop when pendulum falls (|θ1| &gt; π/2)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">stop_condition</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>

<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>  <span class="c1"># Large disturbance</span>

<span class="n">states</span> <span class="o">=</span> <span class="n">simulate</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">stop_fn</span><span class="o">=</span><span class="n">stop_condition</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulation stopped at step </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># May be &lt; 1000</span>
</pre></div>
</div>
</section>
</section>
<section id="safety-guards-integration">
<h2>Safety Guards Integration<a class="headerlink" href="#safety-guards-integration" title="Link to this heading">¶</a></h2>
<p>The vector engine integrates three safety guards automatically:</p>
<p><strong>1. NaN Detection:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">_guard_no_nan</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Detect and raise error for NaN values.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">state</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NaN/Inf detected at t=</span><span class="si">{</span><span class="n">t</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>2. Energy Limits:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">_guard_energy</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">energy_limit</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check total energy against limit.&quot;&quot;&quot;</span>
    <span class="n">total_energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">state</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">total_energy</span> <span class="o">&gt;</span> <span class="n">energy_limit</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Energy violation at t=</span><span class="si">{</span><span class="n">t</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">total_energy</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">energy_limit</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
</pre></div>
</div>
<p><strong>3. State Bounds:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">_guard_bounds</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">lower</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">upper</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check state bounds.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">lower</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">lower</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lower bound violation at t=</span><span class="si">{</span><span class="n">t</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">upper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">state</span> <span class="o">&gt;</span> <span class="n">upper</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Upper bound violation at t=</span><span class="si">{</span><span class="n">t</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Usage with Safety Guards:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">src.simulation.engines.vector_sim</span><span class="w"> </span><span class="kn">import</span> <span class="n">simulate</span>

<span class="c1"># Pendulum with energy limit</span>
<span class="n">states</span> <span class="o">=</span> <span class="n">simulate</span><span class="p">(</span>
    <span class="n">x0</span><span class="p">,</span>
    <span class="n">u</span><span class="p">,</span>
    <span class="n">dt</span><span class="p">,</span>
    <span class="n">energy_limits</span><span class="o">=</span><span class="mf">100.0</span><span class="p">,</span>  <span class="c1"># Total energy &lt; 100</span>
    <span class="n">state_bounds</span><span class="o">=</span><span class="p">(</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.0</span><span class="p">],</span>  <span class="c1"># Lower bounds</span>
        <span class="p">[</span> <span class="mf">10.0</span><span class="p">,</span>  <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>  <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>  <span class="mf">50.0</span><span class="p">,</span>  <span class="mf">50.0</span><span class="p">,</span>  <span class="mf">50.0</span><span class="p">]</span>   <span class="c1"># Upper bounds</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="simulation-runner">
<h2>Simulation Runner<a class="headerlink" href="#simulation-runner" title="Link to this heading">¶</a></h2>
<section id="step-function">
<h3>step() Function<a class="headerlink" href="#step-function" title="Link to this heading">¶</a></h3>
<p><strong>Location:</strong> <code class="docutils literal notranslate"><span class="pre">src/simulation/engines/simulation_runner.py</span></code></p>
<p>The <code class="docutils literal notranslate"><span class="pre">step()</span></code> function dispatches between dynamics models based on configuration.</p>
<section id="dynamics-model-selection">
<h4>Dynamics Model Selection<a class="headerlink" href="#dynamics-model-selection" title="Link to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">src.simulation.engines.simulation_runner</span><span class="w"> </span><span class="kn">import</span> <span class="n">step</span><span class="p">,</span> <span class="n">get_step_fn</span>

<span class="c1"># Automatic dispatch based on config</span>
<span class="c1"># config.simulation.use_full_dynamics = True/False</span>

<span class="n">x_next</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="n">x_current</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

<span class="c1"># Manual selection</span>
<span class="n">full_step_fn</span> <span class="o">=</span> <span class="n">_load_full_step</span><span class="p">()</span>      <span class="c1"># Full nonlinear model</span>
<span class="n">lowrank_step_fn</span> <span class="o">=</span> <span class="n">_load_lowrank_step</span><span class="p">()</span>  <span class="c1"># Low-rank approximation</span>

<span class="n">x_next_full</span> <span class="o">=</span> <span class="n">full_step_fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
<span class="n">x_next_lr</span> <span class="o">=</span> <span class="n">lowrank_step_fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="run-simulation-function">
<h2>run_simulation() Function<a class="headerlink" href="#run-simulation-function" title="Link to this heading">¶</a></h2>
<p>High-level trajectory generation with controller integration.</p>
<section id="id1">
<h3>Signature<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># example-metadata:</span>
<span class="c1"># runnable: false</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_simulation</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">controller</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">dynamics_model</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">sim_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">initial_state</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">u_max</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">latency_margin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">fallback_controller</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">_kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
</pre></div>
</div>
</section>
</section>
<section id="features">
<h2>Features<a class="headerlink" href="#features" title="Link to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p><strong>Controller State Management:</strong> Calls <code class="docutils literal notranslate"><span class="pre">initialize_state()</span></code> and <code class="docutils literal notranslate"><span class="pre">initialize_history()</span></code> if available</p></li>
<li><p><strong>Control Saturation:</strong> Respects <code class="docutils literal notranslate"><span class="pre">u_max</span></code> or <code class="docutils literal notranslate"><span class="pre">controller.max_force</span></code></p></li>
<li><p><strong>Latency Monitoring:</strong> Switches to fallback if control computation exceeds <code class="docutils literal notranslate"><span class="pre">dt</span></code></p></li>
<li><p><strong>Graceful Degradation:</strong> Truncates output on dynamics failure</p></li>
</ol>
<section id="usage-example">
<h3>Usage Example<a class="headerlink" href="#usage-example" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">src.simulation.engines.simulation_runner</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_simulation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.controllers.factory</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_controller</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.plant.models.dynamics</span><span class="w"> </span><span class="kn">import</span> <span class="n">DoubleInvertedPendulum</span>

<span class="c1"># Create controller and dynamics</span>
<span class="n">controller</span> <span class="o">=</span> <span class="n">create_controller</span><span class="p">(</span><span class="s1">&#39;classical_smc&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">gains</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">dynamics</span> <span class="o">=</span> <span class="n">DoubleInvertedPendulum</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">physics</span><span class="p">)</span>

<span class="c1"># Run simulation</span>
<span class="n">t</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">controls</span> <span class="o">=</span> <span class="n">run_simulation</span><span class="p">(</span>
    <span class="n">controller</span><span class="o">=</span><span class="n">controller</span><span class="p">,</span>
    <span class="n">dynamics_model</span><span class="o">=</span><span class="n">dynamics</span><span class="p">,</span>
    <span class="n">sim_time</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
    <span class="n">initial_state</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span>
    <span class="n">u_max</span><span class="o">=</span><span class="mf">100.0</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time points: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>       <span class="c1"># 1001</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;States shape: </span><span class="si">{</span><span class="n">states</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># (1001, 6)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Controls shape: </span><span class="si">{</span><span class="n">controls</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># (1000,)</span>
</pre></div>
</div>
</section>
</section>
<section id="simulation-context">
<h2>Simulation Context<a class="headerlink" href="#simulation-context" title="Link to this heading">¶</a></h2>
<section id="simulationcontext-class">
<h3>SimulationContext Class<a class="headerlink" href="#simulationcontext-class" title="Link to this heading">¶</a></h3>
<p><strong>Location:</strong> <code class="docutils literal notranslate"><span class="pre">src/simulation/context/simulation_context.py</span></code></p>
<p>Centralizes configuration loading, dynamics selection, and controller creation.</p>
<section id="architecture">
<h4>Architecture<a class="headerlink" href="#architecture" title="Link to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># example-metadata:</span>
<span class="c1"># runnable: false</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SimulationContext</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulation setup and configuration management.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;config.yaml&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="n">allow_unknown</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_dynamics_model</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_dynamics_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select dynamics model based on config flag.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">use_full_dynamics</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FullDIPDynamics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">physics</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DoubleInvertedPendulum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">physics</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_dynamics_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return initialized dynamics model.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_model</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_controller</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gains</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create controller using factory.&quot;&quot;&quot;</span>
        <span class="c1"># Uses default gains from config if not provided</span>
        <span class="k">return</span> <span class="n">create_controller</span><span class="p">(</span><span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;classical_smc&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">gains</span><span class="o">=</span><span class="n">gains</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="usage-pattern">
<h4>Usage Pattern<a class="headerlink" href="#usage-pattern" title="Link to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">src.simulation.context.simulation_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimulationContext</span>

<span class="c1"># Initialize simulation context</span>
<span class="n">ctx</span> <span class="o">=</span> <span class="n">SimulationContext</span><span class="p">(</span><span class="s2">&quot;config.yaml&quot;</span><span class="p">)</span>

<span class="c1"># Access components</span>
<span class="n">dynamics</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get_dynamics_model</span><span class="p">()</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>

<span class="c1"># Create controller with defaults from config</span>
<span class="n">controller</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">create_controller</span><span class="p">(</span><span class="s2">&quot;classical_smc&quot;</span><span class="p">)</span>

<span class="c1"># Create controller with custom gains</span>
<span class="n">adaptive_ctrl</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">create_controller</span><span class="p">(</span><span class="s2">&quot;adaptive_smc&quot;</span><span class="p">,</span> <span class="n">gains</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">])</span>

<span class="c1"># Run simulation</span>
<span class="n">t</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">controls</span> <span class="o">=</span> <span class="n">run_simulation</span><span class="p">(</span>
    <span class="n">controller</span><span class="o">=</span><span class="n">controller</span><span class="p">,</span>
    <span class="n">dynamics_model</span><span class="o">=</span><span class="n">dynamics</span><span class="p">,</span>
    <span class="n">sim_time</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
    <span class="n">initial_state</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">initial_state</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="orchestrators">
<h2>Orchestrators<a class="headerlink" href="#orchestrators" title="Link to this heading">¶</a></h2>
<section id="orchestrator-types">
<h3>Orchestrator Types<a class="headerlink" href="#orchestrator-types" title="Link to this heading">¶</a></h3>
<p>The simulation framework provides four orchestration strategies:</p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Orchestrator</p></th>
<th class="head"><p>Use Case</p></th>
<th class="head"><p>Performance</p></th>
<th class="head"><p>Complexity</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">BatchOrchestrator</span></code></p></td>
<td><p>PSO, Monte Carlo</p></td>
<td><p><strong>Fastest</strong> (vectorized)</p></td>
<td><p>Low</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">SequentialOrchestrator</span></code></p></td>
<td><p>Single trajectory</p></td>
<td><p>Fast</p></td>
<td><p>Lowest</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ParallelOrchestrator</span></code></p></td>
<td><p>CPU-intensive tasks</p></td>
<td><p>Medium (multiprocess)</p></td>
<td><p>Medium</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">RealTimeOrchestrator</span></code></p></td>
<td><p>HIL, real-time control</p></td>
<td><p>Deterministic latency</p></td>
<td><p>High</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="batchorchestrator">
<h3>BatchOrchestrator<a class="headerlink" href="#batchorchestrator" title="Link to this heading">¶</a></h3>
<p><strong>Location:</strong> <code class="docutils literal notranslate"><span class="pre">src/simulation/orchestrators/batch.py</span></code></p>
<p>Vectorized execution of multiple simulations simultaneously.</p>
<section id="id2">
<h4>Features<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h4>
<ul class="simple">
<li><p><strong>Vectorized Operations:</strong> Batch dynamics evaluation</p></li>
<li><p><strong>Early Stopping:</strong> Per-simulation stop conditions</p></li>
<li><p><strong>Active Mask Tracking:</strong> Skip completed simulations</p></li>
<li><p><strong>Result Aggregation:</strong> Unified result container</p></li>
</ul>
</section>
<section id="id3">
<h4>Usage Example<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">src.simulation.orchestrators.batch</span><span class="w"> </span><span class="kn">import</span> <span class="n">BatchOrchestrator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="n">orchestrator</span> <span class="o">=</span> <span class="n">BatchOrchestrator</span><span class="p">()</span>

<span class="c1"># Batch initial conditions (Monte Carlo)</span>
<span class="n">n_runs</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">x0_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_runs</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
<span class="n">u_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_runs</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">orchestrator</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="n">initial_state</span><span class="o">=</span><span class="n">x0_batch</span><span class="p">,</span>
    <span class="n">control_inputs</span><span class="o">=</span><span class="n">u_batch</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
    <span class="n">horizon</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">safety_guards</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">stop_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
<span class="p">)</span>

<span class="c1"># Access results</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch size: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successful runs: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">success_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Execution time: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="performance-comparison">
<h2>Performance Comparison<a class="headerlink" href="#performance-comparison" title="Link to this heading">¶</a></h2>
<p><strong>Benchmark:</strong> 30 simulations, 1000 timesteps each</p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Method</p></th>
<th class="head"><p>Time (s)</p></th>
<th class="head"><p>Speedup</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Sequential (loop)</p></td>
<td><p>45.2</p></td>
<td><p>1.0x</p></td>
</tr>
<tr class="row-odd"><td><p>Batch (vectorized)</p></td>
<td><p>1.8</p></td>
<td><p><strong>25.1x</strong></p></td>
</tr>
<tr class="row-even"><td><p>Parallel (4 cores)</p></td>
<td><p>12.3</p></td>
<td><p>3.7x</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Conclusion:</strong> Batch orchestration is optimal for homogeneous workloads (PSO, parameter sweeps)</p>
</section>
<section id="safety-system">
<h2>Safety System<a class="headerlink" href="#safety-system" title="Link to this heading">¶</a></h2>
<section id="safety-guard-architecture">
<h3>Safety Guard Architecture<a class="headerlink" href="#safety-guard-architecture" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="err">┌────────────────────────────────────────┐</span>
<span class="err">│</span>     <span class="n">Simulation</span> <span class="n">Step</span> <span class="p">(</span><span class="n">t</span> <span class="err">→</span> <span class="n">t</span> <span class="o">+</span> <span class="n">dt</span><span class="p">)</span>       <span class="err">│</span>
<span class="err">└────────────┬───────────────────────────┘</span>
             <span class="err">│</span>
             <span class="err">├─►</span> <span class="n">Pre</span><span class="o">-</span><span class="n">step</span> <span class="n">guards</span> <span class="p">(</span><span class="n">optional</span><span class="p">)</span>
             <span class="err">│</span>   <span class="err">└─</span> <span class="n">Input</span> <span class="n">validation</span>
             <span class="err">│</span>
             <span class="err">├─►</span> <span class="n">Dynamics</span> <span class="n">evaluation</span>
             <span class="err">│</span>   <span class="err">└─</span> <span class="n">x</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="n">dt</span><span class="p">)</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">u</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">dt</span><span class="p">)</span>
             <span class="err">│</span>
             <span class="err">├─►</span> <span class="n">Post</span><span class="o">-</span><span class="n">step</span> <span class="n">guards</span> <span class="p">(</span><span class="n">mandatory</span><span class="p">)</span>
             <span class="err">│</span>   <span class="err">├─</span> <span class="n">NaN</span> <span class="n">detection</span>
             <span class="err">│</span>   <span class="err">├─</span> <span class="n">Energy</span> <span class="n">limits</span>
             <span class="err">│</span>   <span class="err">└─</span> <span class="n">State</span> <span class="n">bounds</span>
             <span class="err">│</span>
             <span class="err">└─►</span> <span class="n">Early</span> <span class="n">stop</span> <span class="n">check</span>
                 <span class="err">└─</span> <span class="n">user</span><span class="o">-</span><span class="n">defined</span> <span class="n">stop_fn</span>
</pre></div>
</div>
</section>
<section id="guard-configuration">
<h3>Guard Configuration<a class="headerlink" href="#guard-configuration" title="Link to this heading">¶</a></h3>
<p><strong>In config.yaml:</strong></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">simulation</span><span class="p">:</span>
<span class="w">  </span><span class="nt">safety</span><span class="p">:</span>
<span class="w">    </span><span class="nt">energy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">max</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100.0</span>
<span class="w">    </span><span class="nt">bounds</span><span class="p">:</span>
<span class="w">      </span><span class="nt">lower</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-10.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">-3.14</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">-3.14</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">-50.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">-50.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">-50.0</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">upper</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="nv">10.0</span><span class="p p-Indicator">,</span><span class="w">  </span><span class="nv">3.14</span><span class="p p-Indicator">,</span><span class="w">  </span><span class="nv">3.14</span><span class="p p-Indicator">,</span><span class="w">  </span><span class="nv">50.0</span><span class="p p-Indicator">,</span><span class="w">  </span><span class="nv">50.0</span><span class="p p-Indicator">,</span><span class="w">  </span><span class="nv">50.0</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<p><strong>Programmatic Override:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Override config defaults</span>
<span class="n">states</span> <span class="o">=</span> <span class="n">simulate</span><span class="p">(</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span>
    <span class="n">energy_limits</span><span class="o">=</span><span class="mf">200.0</span><span class="p">,</span>  <span class="c1"># More permissive than config</span>
    <span class="n">state_bounds</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Disable bounds checking</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="custom-safety-guards">
<h2>Custom Safety Guards<a class="headerlink" href="#custom-safety-guards" title="Link to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">src.simulation.context.safety_guards</span><span class="w"> </span><span class="kn">import</span> <span class="n">_guard_no_nan</span>

<span class="k">def</span><span class="w"> </span><span class="nf">custom_guard_angular_velocity</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">100.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom guard for excessive angular velocities.&quot;&quot;&quot;</span>
    <span class="n">theta1_dot</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">theta2_dot</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">theta1_dot</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">theta2_dot</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Angular velocity limit exceeded at t=</span><span class="si">{</span><span class="n">t</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;θ̇1=</span><span class="si">{</span><span class="n">theta1_dot</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, θ̇2=</span><span class="si">{</span><span class="n">theta2_dot</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

<span class="c1"># Integrate custom guard into simulation loop</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">horizon</span><span class="p">):</span>
    <span class="n">x_next</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="n">x_current</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">_guard_no_nan</span><span class="p">(</span><span class="n">x_next</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">custom_guard_angular_velocity</span><span class="p">(</span><span class="n">x_next</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">50.0</span><span class="p">)</span>
    <span class="n">x_current</span> <span class="o">=</span> <span class="n">x_next</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">dt</span>
</pre></div>
</div>
</section>
<section id="performance-optimization">
<h2>Performance Optimization<a class="headerlink" href="#performance-optimization" title="Link to this heading">¶</a></h2>
<section id="memory-optimization-techniques">
<h3>Memory Optimization Techniques<a class="headerlink" href="#memory-optimization-techniques" title="Link to this heading">¶</a></h3>
<p><strong>1. View-Based Operations:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># GOOD: Creates view (zero-copy)</span>
<span class="n">x_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>  <span class="c1"># If x is already float64 ndarray</span>

<span class="c1"># BAD: Creates copy</span>
<span class="n">x_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>  <span class="c1"># Always creates new array</span>
</pre></div>
</div>
<p><strong>2. Pre-allocation:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># example-metadata:</span>
<span class="c1"># runnable: false</span>

<span class="c1"># GOOD: Pre-allocate result array</span>
<span class="n">states</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">horizon</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">states</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">initial_state</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">horizon</span><span class="p">):</span>
    <span class="n">states</span><span class="p">[:,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">dynamics_step</span><span class="p">(</span><span class="n">states</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">u</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">dt</span><span class="p">)</span>

<span class="c1"># BAD: Append to list</span>
<span class="n">states</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_state</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">horizon</span><span class="p">):</span>
    <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dynamics_step</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dt</span><span class="p">))</span>
<span class="n">states</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>  <span class="c1"># Expensive conversion at end</span>
</pre></div>
</div>
<p><strong>3. Broadcasting:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># GOOD: Broadcasting avoids explicit loops</span>
<span class="n">n_particles</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">control_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">])</span>  <span class="c1"># Single value</span>
<span class="n">u_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">control_input</span><span class="p">,</span> <span class="p">(</span><span class="n">n_particles</span><span class="p">,))</span>  <span class="c1"># Efficient view</span>

<span class="c1"># BAD: Explicit replication</span>
<span class="n">u_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">control_input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_particles</span><span class="p">)])</span>
</pre></div>
</div>
</section>
</section>
<section id="computational-optimization">
<h2>Computational Optimization<a class="headerlink" href="#computational-optimization" title="Link to this heading">¶</a></h2>
<p><strong>Numba JIT Compilation:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numba</span>

<span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fast_dynamics_step</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;JIT-compiled dynamics for 100x speedup.&quot;&quot;&quot;</span>
    <span class="c1"># Pure NumPy operations only</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">compute_mass_matrix</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">compute_coriolis</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">compute_gravity</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="n">qdd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">control</span> <span class="o">-</span> <span class="n">C</span> <span class="o">@</span> <span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">-</span> <span class="n">G</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">state</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="n">qdd</span><span class="p">])</span>

<span class="c1"># First call: ~100 ms (compilation)</span>
<span class="c1"># Subsequent calls: ~0.1 ms (compiled code)</span>
</pre></div>
</div>
</section>
<section id="profiling-guidelines">
<h2>Profiling Guidelines<a class="headerlink" href="#profiling-guidelines" title="Link to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cProfile</span>

<span class="c1"># Time measurement</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="n">states</span> <span class="o">=</span> <span class="n">simulate</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
<span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulation time: </span><span class="si">{</span><span class="n">elapsed</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ms&quot;</span><span class="p">)</span>

<span class="c1"># Detailed profiling</span>
<span class="n">profiler</span> <span class="o">=</span> <span class="n">cProfile</span><span class="o">.</span><span class="n">Profile</span><span class="p">()</span>
<span class="n">profiler</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">states</span> <span class="o">=</span> <span class="n">simulate</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

<span class="n">profiler</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
<span class="n">profiler</span><span class="o">.</span><span class="n">print_stats</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="s1">&#39;cumtime&#39;</span><span class="p">)</span>

<span class="c1"># Expected hot spots:</span>
<span class="c1"># 1. np.linalg.solve (30-40%)</span>
<span class="c1"># 2. dynamics evaluation (20-30%)</span>
<span class="c1"># 3. safety guards (5-10%)</span>
<span class="c1"># 4. array operations (10-20%)</span>
</pre></div>
</div>
</section>
<section id="best-practices">
<h2>Best Practices<a class="headerlink" href="#best-practices" title="Link to this heading">¶</a></h2>
<section id="choose-the-right-orchestrator">
<h3>1. Choose the Right Orchestrator<a class="headerlink" href="#choose-the-right-orchestrator" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># example-metadata:</span>
<span class="c1"># runnable: false</span>

<span class="c1"># Single trajectory → SequentialOrchestrator</span>
<span class="c1"># PSO (30 particles) → BatchOrchestrator (25x faster)</span>
<span class="c1"># Monte Carlo (1000 runs) → ParallelOrchestrator (4 cores)</span>
<span class="c1"># HIL testing → RealTimeOrchestrator</span>
</pre></div>
</div>
</section>
</section>
<section id="validate-inputs-early">
<h2>2. Validate Inputs Early<a class="headerlink" href="#validate-inputs-early" title="Link to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">src.simulation.engines.vector_sim</span><span class="w"> </span><span class="kn">import</span> <span class="n">simulate</span>

<span class="c1"># Add input validation before simulation</span>
<span class="k">assert</span> <span class="n">x0</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">6</span><span class="p">,),</span> <span class="sa">f</span><span class="s2">&quot;Expected state dim 6, got </span><span class="si">{</span><span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">==</span> <span class="n">horizon</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Control length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="si">}</span><span class="s2"> != horizon </span><span class="si">{</span><span class="n">horizon</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">assert</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Time step must be positive&quot;</span>

<span class="n">states</span> <span class="o">=</span> <span class="n">simulate</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="n">horizon</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="use-safety-guards-in-production">
<h2>3. Use Safety Guards in Production<a class="headerlink" href="#use-safety-guards-in-production" title="Link to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># example-metadata:</span>
<span class="c1"># runnable: false</span>

<span class="c1"># Development: Permissive limits for debugging</span>
<span class="n">states_dev</span> <span class="o">=</span> <span class="n">simulate</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">energy_limits</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">state_bounds</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

<span class="c1"># Production: Strict limits for safety</span>
<span class="n">states_prod</span> <span class="o">=</span> <span class="n">simulate</span><span class="p">(</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span>
    <span class="n">energy_limits</span><span class="o">=</span><span class="mf">100.0</span><span class="p">,</span>
    <span class="n">state_bounds</span><span class="o">=</span><span class="p">(</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.0</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">10.0</span><span class="p">,</span>  <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>  <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>  <span class="mf">50.0</span><span class="p">,</span>  <span class="mf">50.0</span><span class="p">,</span>  <span class="mf">50.0</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="handle-early-stopping-gracefully">
<h2>4. Handle Early Stopping Gracefully<a class="headerlink" href="#handle-early-stopping-gracefully" title="Link to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># example-metadata:</span>
<span class="c1"># runnable: false</span>

<span class="c1"># Wrap simulation in try-except for safety guard violations</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">states</span> <span class="o">=</span> <span class="n">simulate</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">energy_limits</span><span class="o">=</span><span class="mf">100.0</span><span class="p">)</span>
    <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="c1"># Safety guard triggered</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Use early stopping instead of throwing errors</span>
<span class="k">def</span><span class="w"> </span><span class="nf">soft_stop</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return True when unstable, but don&#39;t raise error.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">state</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">100.0</span>

<span class="n">states</span> <span class="o">=</span> <span class="n">simulate</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">stop_fn</span><span class="o">=</span><span class="n">soft_stop</span><span class="p">)</span>
<span class="c1"># states.shape[0] may be &lt; horizon + 1</span>
</pre></div>
</div>
</section>
<section id="uses-vectorization">
<h2>5. uses Vectorization<a class="headerlink" href="#uses-vectorization" title="Link to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># example-metadata:</span>
<span class="c1"># runnable: false</span>

<span class="c1"># PSO fitness evaluation (30 particles)</span>

<span class="c1"># BAD: Sequential loop (slow)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fitness_sequential</span><span class="p">(</span><span class="n">particles</span><span class="p">):</span>
    <span class="n">costs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">gains</span> <span class="ow">in</span> <span class="n">particles</span><span class="p">:</span>
        <span class="n">controller</span> <span class="o">=</span> <span class="n">create_controller</span><span class="p">(</span><span class="s1">&#39;classical_smc&#39;</span><span class="p">,</span> <span class="n">gains</span><span class="o">=</span><span class="n">gains</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">run_simulation</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">dynamics</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span>
        <span class="n">costs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compute_cost</span><span class="p">(</span><span class="n">states</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">costs</span><span class="p">)</span>

<span class="c1"># GOOD: Vectorized batch (25x faster)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fitness_vectorized</span><span class="p">(</span><span class="n">particles</span><span class="p">):</span>
    <span class="n">x0_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">particles</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># (30, 6)</span>
    <span class="n">u_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">particles</span><span class="p">),</span> <span class="mi">1000</span><span class="p">))</span>

    <span class="c1"># Create controllers in batch</span>
    <span class="n">controllers</span> <span class="o">=</span> <span class="p">[</span><span class="n">create_controller</span><span class="p">(</span><span class="s1">&#39;classical_smc&#39;</span><span class="p">,</span> <span class="n">gains</span><span class="o">=</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">particles</span><span class="p">]</span>

    <span class="c1"># Simulate all at once</span>
    <span class="n">states_batch</span> <span class="o">=</span> <span class="n">simulate</span><span class="p">(</span><span class="n">x0_batch</span><span class="p">,</span> <span class="n">u_batch</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>  <span class="c1"># (30, 1001, 6)</span>

    <span class="c1"># Vectorized cost computation</span>
    <span class="n">costs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">states_batch</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dt</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">costs</span>
</pre></div>
</div>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Link to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p><strong>Vector Simulation:</strong> <code class="docutils literal notranslate"><span class="pre">src/simulation/engines/vector_sim.py</span></code></p></li>
<li><p><strong>Simulation Runner:</strong> <code class="docutils literal notranslate"><span class="pre">src/simulation/engines/simulation_runner.py</span></code></p></li>
<li><p><strong>Simulation Context:</strong> <code class="docutils literal notranslate"><span class="pre">src/simulation/context/simulation_context.py</span></code></p></li>
<li><p><strong>Batch Orchestrator:</strong> <code class="docutils literal notranslate"><span class="pre">src/simulation/orchestrators/batch.py</span></code></p></li>
<li><p><strong>Safety Guards:</strong> <code class="docutils literal notranslate"><span class="pre">src/simulation/context/safety_guards.py</span></code></p></li>
</ol>
<p><strong>File Location:</strong> <code class="docutils literal notranslate"><span class="pre">docs/mathematical_foundations/simulation_architecture_guide.md</span></code>
<strong>Lines:</strong> 647
<strong>Coverage:</strong> Vector engine, simulation runner, context management, orchestrators, safety system, performance optimization
<strong>Cross-references:</strong></p>
<ul class="simple">
<li><p>Vector simulation: <code class="docutils literal notranslate"><span class="pre">src/simulation/engines/vector_sim.py</span></code></p></li>
<li><p>Simulation runner: <code class="docutils literal notranslate"><span class="pre">src/simulation/engines/simulation_runner.py</span></code></p></li>
<li><p>Simulation context: <code class="docutils literal notranslate"><span class="pre">src/simulation/context/simulation_context.py</span></code></p></li>
<li><p>Orchestrators: <code class="docutils literal notranslate"><span class="pre">src/simulation/orchestrators/</span></code></p></li>
<li><p>Safety guards: <code class="docutils literal notranslate"><span class="pre">src/simulation/context/safety_guards.py</span></code></p></li>
</ul>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, Research Team
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            <div class="last-updated">
              Last updated on Oct 10, 2025</div>
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Simulation Architecture Guide</a><ul>
<li><a class="reference internal" href="#table-of-contents">Table of Contents</a></li>
<li><a class="reference internal" href="#introduction">Introduction</a><ul>
<li><a class="reference internal" href="#design-principles">Design Principles</a></li>
<li><a class="reference internal" href="#key-features">Key Features</a></li>
</ul>
</li>
<li><a class="reference internal" href="#architecture-overview">Architecture Overview</a><ul>
<li><a class="reference internal" href="#component-hierarchy">Component Hierarchy</a></li>
<li><a class="reference internal" href="#data-flow">Data Flow</a></li>
</ul>
</li>
<li><a class="reference internal" href="#vector-simulation-engine">Vector Simulation Engine</a><ul>
<li><a class="reference internal" href="#simulate-function">simulate() Function</a><ul>
<li><a class="reference internal" href="#signature">Signature</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#shape-conventions">Shape Conventions</a><ul>
<li><a class="reference internal" href="#usage-examples">Usage Examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#safety-guards-integration">Safety Guards Integration</a></li>
<li><a class="reference internal" href="#simulation-runner">Simulation Runner</a><ul>
<li><a class="reference internal" href="#step-function">step() Function</a><ul>
<li><a class="reference internal" href="#dynamics-model-selection">Dynamics Model Selection</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#run-simulation-function">run_simulation() Function</a><ul>
<li><a class="reference internal" href="#id1">Signature</a></li>
</ul>
</li>
<li><a class="reference internal" href="#features">Features</a><ul>
<li><a class="reference internal" href="#usage-example">Usage Example</a></li>
</ul>
</li>
<li><a class="reference internal" href="#simulation-context">Simulation Context</a><ul>
<li><a class="reference internal" href="#simulationcontext-class">SimulationContext Class</a><ul>
<li><a class="reference internal" href="#architecture">Architecture</a></li>
<li><a class="reference internal" href="#usage-pattern">Usage Pattern</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#orchestrators">Orchestrators</a><ul>
<li><a class="reference internal" href="#orchestrator-types">Orchestrator Types</a></li>
<li><a class="reference internal" href="#batchorchestrator">BatchOrchestrator</a><ul>
<li><a class="reference internal" href="#id2">Features</a></li>
<li><a class="reference internal" href="#id3">Usage Example</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#performance-comparison">Performance Comparison</a></li>
<li><a class="reference internal" href="#safety-system">Safety System</a><ul>
<li><a class="reference internal" href="#safety-guard-architecture">Safety Guard Architecture</a></li>
<li><a class="reference internal" href="#guard-configuration">Guard Configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#custom-safety-guards">Custom Safety Guards</a></li>
<li><a class="reference internal" href="#performance-optimization">Performance Optimization</a><ul>
<li><a class="reference internal" href="#memory-optimization-techniques">Memory Optimization Techniques</a></li>
</ul>
</li>
<li><a class="reference internal" href="#computational-optimization">Computational Optimization</a></li>
<li><a class="reference internal" href="#profiling-guidelines">Profiling Guidelines</a></li>
<li><a class="reference internal" href="#best-practices">Best Practices</a><ul>
<li><a class="reference internal" href="#choose-the-right-orchestrator">1. Choose the Right Orchestrator</a></li>
</ul>
</li>
<li><a class="reference internal" href="#validate-inputs-early">2. Validate Inputs Early</a></li>
<li><a class="reference internal" href="#use-safety-guards-in-production">3. Use Safety Guards in Production</a></li>
<li><a class="reference internal" href="#handle-early-stopping-gracefully">4. Handle Early Stopping Gracefully</a></li>
<li><a class="reference internal" href="#uses-vectorization">5. uses Vectorization</a></li>
<li><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=4ebf8126"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=08e7b316"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../_static/back-to-top.js?v=840797bb"></script>
    <script src="../_static/lazy-load.js?v=dc25293c"></script>
    <script src="../_static/dark-mode.js?v=bf328970"></script>
    </body>
</html>