<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
.chartjs-container {
    margin: 1.5em auto;
    padding: 1em;
    background: #f8f9fa;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.chart-note {
    text-align: center;
    color: #6c757d;
    font-size: 0.9em;
    margin-top: 0.5em;
}
</style>
<link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <!-- Generated with Sphinx 7.4.7 and Furo 2024.08.06 -->
        <title>interfaces.monitoring.metrics_collector - DIP_SMC_PSO Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5349f25f" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=f5a89ef9" />
    
    


<style>
  body {
    --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">DIP_SMC_PSO Documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">DIP_SMC_PSO Documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">📚 Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Optimal Sliding Mode Control for a Double-Inverted Pendulum via PSO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../theory_overview.html">1. Theoretical Background â€” Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture.html">3. System Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plant_model.html">1.x Plant Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hil_quickstart.html">Hardware-in-the-Loop (HIL) Quickstart Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../streamlit_dashboard_guide.html">Streamlit Dashboard User Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">🎮 Control Systems &amp; Optimization</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../controllers/index.html">Controllers Module Documentation</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Controllers Module Documentation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/classical_smc_technical_guide.html">Classical Sliding Mode Control Technical Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/adaptive_smc_technical_guide.html">Adaptive Sliding Mode Control Technical Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/sta_smc_technical_guide.html">Super-Twisting Sliding Mode Control Technical Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/hybrid_smc_technical_guide.html">Hybrid Adaptive Super-Twisting SMC Technical Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/mpc_technical_guide.html">Model Predictive Control Technical Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/swing_up_smc_technical_guide.html">Swing-Up SMC Technical Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/swing_up_smc_technical_guide.html#example-metadata">example-metadata:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/swing_up_smc_technical_guide.html#runnable-false">runnable: false</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/factory_system_guide.html">SMC Controller Factory System Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/control_primitives_reference.html">Control Primitives Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mathematical_foundations/smc_complete_theory.html">Complete Sliding Mode Control Mathematical Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mathematical_foundations/controller_comparison_theory.html">SMC Controller Comparison Theory</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../controllers/index.html">Controllers Module</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Controllers Module</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../controllers/adaptive_smc.html">controllers.adaptive_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/classic_smc.html">controllers.classic_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory.html">controllers.factory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/mpc_controller.html">controllers.mpc_controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/sta_smc.html">controllers.sta_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/swing_up_smc.html">controllers.swing_up_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/__init__.html">controllers.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/base_controller_interface.html">controllers.base.controller_interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/base_control_primitives.html">controllers.base.control_primitives</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/base___init__.html">controllers.base.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_deprecation.html">controllers.factory.deprecation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_fallback_configs.html">controllers.factory.fallback_configs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_legacy_factory.html">controllers.factory.legacy_factory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_optimization.html">controllers.factory.optimization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_pso_integration.html">controllers.factory.pso_integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_smc_factory.html">controllers.factory.smc_factory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_thread_safety.html">controllers.factory.thread_safety</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory___init__.html">controllers.factory.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/mpc_mpc_controller.html">controllers.mpc.mpc_controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/mpc___init__.html">controllers.mpc.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_adaptive_smc.html">controllers.smc.adaptive_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_classic_smc.html">controllers.smc.classic_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_hybrid_adaptive_sta_smc.html">controllers.smc.hybrid_adaptive_sta_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_sta_smc.html">controllers.smc.sta_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc___init__.html">controllers.smc.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/specialized_swing_up_smc.html">controllers.specialized.swing_up_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/specialized___init__.html">controllers.specialized.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_core_protocols.html">controllers.factory.core.protocols</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_core_registry.html">controllers.factory.core.registry</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_core_threading.html">controllers.factory.core.threading</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_core_validation.html">controllers.factory.core.validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_core___init__.html">controllers.factory.core.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms___init__.html">controllers.smc.algorithms.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_core_equivalent_control.html">controllers.smc.core.equivalent_control</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_core_gain_validation.html">controllers.smc.core.gain_validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_core_sliding_surface.html">controllers.smc.core.sliding_surface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_core_switching_functions.html">controllers.smc.core.switching_functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_core___init__.html">controllers.smc.core.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_adaptive_adaptation_law.html">controllers.smc.algorithms.adaptive.adaptation_law</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_adaptive_config.html">controllers.smc.algorithms.adaptive.config</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_adaptive_controller.html">controllers.smc.algorithms.adaptive.controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_adaptive_parameter_estimation.html">controllers.smc.algorithms.adaptive.parameter_estimation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_adaptive___init__.html">controllers.smc.algorithms.adaptive.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_classical_boundary_layer.html">controllers.smc.algorithms.classical.boundary_layer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_classical_config.html">controllers.smc.algorithms.classical.config</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_classical_controller.html">controllers.smc.algorithms.classical.controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_classical___init__.html">controllers.smc.algorithms.classical.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_hybrid_config.html">controllers.smc.algorithms.hybrid.config</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_hybrid_controller.html">controllers.smc.algorithms.hybrid.controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_hybrid_switching_logic.html">controllers.smc.algorithms.hybrid.switching_logic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_hybrid___init__.html">controllers.smc.algorithms.hybrid.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_super_twisting_config.html">controllers.smc.algorithms.super_twisting.config</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_super_twisting_controller.html">controllers.smc.algorithms.super_twisting.controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_super_twisting_twisting_algorithm.html">controllers.smc.algorithms.super_twisting.twisting_algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_super_twisting___init__.html">controllers.smc.algorithms.super_twisting.<strong>init</strong></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../mathematical_foundations/index.html">Mathematical Foundations</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Mathematical Foundations</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../mathematical_foundations/smc_complete_theory.html">Complete Sliding Mode Control Mathematical Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mathematical_foundations/controller_comparison_theory.html">SMC Controller Comparison Theory</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../plant/models_guide.html">Plant Models Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../optimization_simulation/guide.html">Optimization &amp; Simulation Guide</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../controllers/index.html">Controllers Module</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of Controllers Module</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../controllers/adaptive_smc.html">controllers.adaptive_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/classic_smc.html">controllers.classic_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory.html">controllers.factory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/mpc_controller.html">controllers.mpc_controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/sta_smc.html">controllers.sta_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/swing_up_smc.html">controllers.swing_up_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/__init__.html">controllers.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/base_controller_interface.html">controllers.base.controller_interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/base_control_primitives.html">controllers.base.control_primitives</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/base___init__.html">controllers.base.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_deprecation.html">controllers.factory.deprecation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_fallback_configs.html">controllers.factory.fallback_configs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_legacy_factory.html">controllers.factory.legacy_factory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_optimization.html">controllers.factory.optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_pso_integration.html">controllers.factory.pso_integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_smc_factory.html">controllers.factory.smc_factory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_thread_safety.html">controllers.factory.thread_safety</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory___init__.html">controllers.factory.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/mpc_mpc_controller.html">controllers.mpc.mpc_controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/mpc___init__.html">controllers.mpc.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_adaptive_smc.html">controllers.smc.adaptive_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_classic_smc.html">controllers.smc.classic_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_hybrid_adaptive_sta_smc.html">controllers.smc.hybrid_adaptive_sta_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_sta_smc.html">controllers.smc.sta_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc___init__.html">controllers.smc.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/specialized_swing_up_smc.html">controllers.specialized.swing_up_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/specialized___init__.html">controllers.specialized.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_core_protocols.html">controllers.factory.core.protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_core_registry.html">controllers.factory.core.registry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_core_threading.html">controllers.factory.core.threading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_core_validation.html">controllers.factory.core.validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_core___init__.html">controllers.factory.core.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms___init__.html">controllers.smc.algorithms.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_core_equivalent_control.html">controllers.smc.core.equivalent_control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_core_gain_validation.html">controllers.smc.core.gain_validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_core_sliding_surface.html">controllers.smc.core.sliding_surface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_core_switching_functions.html">controllers.smc.core.switching_functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_core___init__.html">controllers.smc.core.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_adaptive_adaptation_law.html">controllers.smc.algorithms.adaptive.adaptation_law</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_adaptive_config.html">controllers.smc.algorithms.adaptive.config</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_adaptive_controller.html">controllers.smc.algorithms.adaptive.controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_adaptive_parameter_estimation.html">controllers.smc.algorithms.adaptive.parameter_estimation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_adaptive___init__.html">controllers.smc.algorithms.adaptive.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_classical_boundary_layer.html">controllers.smc.algorithms.classical.boundary_layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_classical_config.html">controllers.smc.algorithms.classical.config</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_classical_controller.html">controllers.smc.algorithms.classical.controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_classical___init__.html">controllers.smc.algorithms.classical.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_hybrid_config.html">controllers.smc.algorithms.hybrid.config</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_hybrid_controller.html">controllers.smc.algorithms.hybrid.controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_hybrid_switching_logic.html">controllers.smc.algorithms.hybrid.switching_logic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_hybrid___init__.html">controllers.smc.algorithms.hybrid.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_super_twisting_config.html">controllers.smc.algorithms.super_twisting.config</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_super_twisting_controller.html">controllers.smc.algorithms.super_twisting.controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_super_twisting_twisting_algorithm.html">controllers.smc.algorithms.super_twisting.twisting_algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_super_twisting___init__.html">controllers.smc.algorithms.super_twisting.<strong>init</strong></a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../optimizer/index.html">Optimizer Module</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Optimizer Module</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../optimizer/pso_optimizer.html">optimizer.pso_optimizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../optimizer/__init__.html">optimizer.<strong>init</strong></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../analysis_plan.html">5. Analysis &amp; Verification Plan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../benchmarks_methodology.html">Benchmarks &amp; Methodology</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">🧪 Development &amp; Testing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../TESTING.html">Testing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../test_protocols.html">5.x Test Protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../use_cases.html">4. Use Cases &amp; Operating Modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../context.html">2. Application Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault_detection_guide.html">Fault Detection &amp; Isolation (FDI) Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">📊 Research &amp; Theory</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../presentation/index.html">Research Presentation Materials</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Research Presentation Materials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html">Abstract</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#introduction-and-motivation">Introduction and Motivation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#the-double-inverted-pendulum-as-a-canonical-control-problem">The Double Inverted Pendulum as a Canonical Control Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#the-primary-control-objectives-and-challenges">The Primary Control Objectives and Challenges</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#sliding-mode-control-as-a-robust-solution">Sliding Mode Control as a Robust Solution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#the-gain-tuning-dilemma-and-the-need-for-optimization">The Gain Tuning Dilemma and the Need for Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#particle-swarm-optimization-for-automated-design">Particle Swarm Optimization for Automated Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#synthesis-and-motivation">Synthesis and Motivation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#references">References</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/problem-statement.html">Problem Statement for Double‑Inverted Pendulum (DIP) Control with SMC and PSO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/previous-works.html">Previous Work Before the Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/system-modeling.html"><strong>A Comprehensive Technical Report on the Modeling and Configuration of a Cart‑Based Double Inverted Pendulum System</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/smc-theory.html">Sliding Mode Control for a Double‑Inverted Pendulum: Bridging Theory and Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html">Abstract</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#introduction">1 Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#system-modelling-and-problem-formulation">2 System Modelling and Problem Formulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#simulation-methodology">3 Simulation Methodology</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#classic-sliding-mode-control">4 Classic Sliding Mode Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-i-boundary-layer-method">5 Chattering Mitigation Strategy I: Boundary Layer Method</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-ii-supertwisting-algorithm">6 Chattering Mitigation Strategy II: Super‑Twisting Algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-iii-adaptive-sliding-mode-control">7 Chattering Mitigation Strategy III: Adaptive Sliding Mode Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-iv-hybrid-adaptivesta">8 Chattering Mitigation Strategy IV: Hybrid Adaptive–STA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#synthesis-and-comparative-analysis">9 Synthesis and Comparative Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#references">References</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/pso-optimization.html"><strong>Comprehensive Simulation Analysis and Enhancements for the Double Inverted Pendulum Control System</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/simulation-setup.html">Particle Swarm Optimization for Sliding‑Mode Controller Tuning of a Double Inverted Pendulum</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/results-discussion.html">8 – Results and Discussion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/results-discussion.html#references">References</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html">Abstract</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#introduction-and-motivation">Introduction and Motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#the-double-inverted-pendulum-as-a-canonical-control-problem">The Double Inverted Pendulum as a Canonical Control Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#the-primary-control-objectives-and-challenges">The Primary Control Objectives and Challenges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#sliding-mode-control-as-a-robust-solution">Sliding Mode Control as a Robust Solution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#the-gain-tuning-dilemma-and-the-need-for-optimization">The Gain Tuning Dilemma and the Need for Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#particle-swarm-optimization-for-automated-design">Particle Swarm Optimization for Automated Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#synthesis-and-motivation">Synthesis and Motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#references">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/problem-statement.html">Problem Statement for Double‑Inverted Pendulum (DIP) Control with SMC and PSO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/previous-works.html">Previous Work Before the Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/system-modeling.html"><strong>A Comprehensive Technical Report on the Modeling and Configuration of a Cart‑Based Double Inverted Pendulum System</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/smc-theory.html">Sliding Mode Control for a Double‑Inverted Pendulum: Bridging Theory and Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html">Abstract</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#introduction">1 Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#system-modelling-and-problem-formulation">2 System Modelling and Problem Formulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#simulation-methodology">3 Simulation Methodology</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#classic-sliding-mode-control">4 Classic Sliding Mode Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-i-boundary-layer-method">5 Chattering Mitigation Strategy I: Boundary Layer Method</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-ii-supertwisting-algorithm">6 Chattering Mitigation Strategy II: Super‑Twisting Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-iii-adaptive-sliding-mode-control">7 Chattering Mitigation Strategy III: Adaptive Sliding Mode Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-iv-hybrid-adaptivesta">8 Chattering Mitigation Strategy IV: Hybrid Adaptive–STA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#synthesis-and-comparative-analysis">9 Synthesis and Comparative Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#references">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/pso-optimization.html"><strong>Comprehensive Simulation Analysis and Enhancements for the Double Inverted Pendulum Control System</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/simulation-setup.html">Particle Swarm Optimization for Sliding‑Mode Controller Tuning of a Double Inverted Pendulum</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/results-discussion.html">8 – Results and Discussion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/results-discussion.html#references">References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">📖 API Reference &amp; Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Reference Documentation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../examples/index.html">Examples</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of Examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../bibliography.html">Bibliography &amp; Academic References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">🔧 Project Management</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../CONTRIBUTING.html">Contributing – ResearchPlanSpec Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../RELEASE_CHECKLIST.html">Release Checklist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CHANGELOG.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../symbols.html">Symbols &amp; Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../results_readme.html">Results &amp; Plots</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">📚 Citations &amp; Attribution</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../CITATIONS.html">Citations &amp; Academic Attribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CITATIONS_ACADEMIC.html">Academic Theory Citations &amp; References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DEPENDENCIES.html">Software Dependencies &amp; Citations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PATTERNS.html">Software Design Patterns &amp; Architecture Attribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LICENSES.html">License Compliance &amp; Attribution</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="https://github.com/theSadeQ/DIP_SMC_PSO/blob/main/docs/reference/interfaces/monitoring_metrics_collector.md?plain=true" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div><div class="edit-this-page">
  <a class="muted-link" href="https://github.com/theSadeQ/DIP_SMC_PSO/edit/main/docs/reference/interfaces/monitoring_metrics_collector.md" title="Edit this page">
    <svg><use href="#svg-pencil"></use></svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section class="tex2jax_ignore mathjax_ignore" id="interfaces-monitoring-metrics-collector">
<h1>interfaces.monitoring.metrics_collector<a class="headerlink" href="#interfaces-monitoring-metrics-collector" title="Link to this heading">¶</a></h1>
<p><strong>Source:</strong> <code class="docutils literal notranslate"><span class="pre">src\interfaces\monitoring\metrics_collector.py</span></code></p>
<section id="module-overview">
<h2>Module Overview<a class="headerlink" href="#module-overview" title="Link to this heading">¶</a></h2>
<p>Comprehensive metrics collection system for interface monitoring.
This module provides efficient collection, aggregation, and storage
of various metrics including performance counters, resource usage,
business metrics, and custom measurements across all interface
components.</p>
</section>
<section id="complete-source-code">
<h2>Complete Source Code<a class="headerlink" href="#complete-source-code" title="Link to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="c1">#======================================================================================\\\</span>
<span class="linenos">  2</span><span class="c1">#=================== src/interfaces/monitoring/metrics_collector.py ===================\\\</span>
<span class="linenos">  3</span><span class="c1">#======================================================================================\\\</span>
<span class="linenos">  4</span>
<span class="linenos">  5</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  6</span><span class="sd">Comprehensive metrics collection system for interface monitoring.</span>
<span class="linenos">  7</span><span class="sd">This module provides efficient collection, aggregation, and storage</span>
<span class="linenos">  8</span><span class="sd">of various metrics including performance counters, resource usage,</span>
<span class="linenos">  9</span><span class="sd">business metrics, and custom measurements across all interface</span>
<span class="linenos"> 10</span><span class="sd">components.</span>
<span class="linenos"> 11</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 12</span>
<span class="linenos"> 13</span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="linenos"> 14</span><span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="linenos"> 15</span><span class="kn">import</span><span class="w"> </span><span class="nn">statistics</span>
<span class="linenos"> 16</span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="linenos"> 17</span><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="linenos"> 18</span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Callable</span>
<span class="linenos"> 19</span><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="linenos"> 20</span><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">deque</span>
<span class="linenos"> 21</span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="linenos"> 22</span>
<span class="linenos"> 23</span>
<span class="linenos"> 24</span><span class="k">class</span><span class="w"> </span><span class="nc">MetricType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="linenos"> 25</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Metric type enumeration.&quot;&quot;&quot;</span>
<span class="linenos"> 26</span>    <span class="n">COUNTER</span> <span class="o">=</span> <span class="s2">&quot;counter&quot;</span>          <span class="c1"># Monotonically increasing value</span>
<span class="linenos"> 27</span>    <span class="n">GAUGE</span> <span class="o">=</span> <span class="s2">&quot;gauge&quot;</span>             <span class="c1"># Current value that can go up or down</span>
<span class="linenos"> 28</span>    <span class="n">HISTOGRAM</span> <span class="o">=</span> <span class="s2">&quot;histogram&quot;</span>     <span class="c1"># Distribution of values</span>
<span class="linenos"> 29</span>    <span class="n">SUMMARY</span> <span class="o">=</span> <span class="s2">&quot;summary&quot;</span>         <span class="c1"># Summary statistics</span>
<span class="linenos"> 30</span>    <span class="n">TIMER</span> <span class="o">=</span> <span class="s2">&quot;timer&quot;</span>            <span class="c1"># Duration measurements</span>
<span class="linenos"> 31</span>    <span class="n">RATE</span> <span class="o">=</span> <span class="s2">&quot;rate&quot;</span>              <span class="c1"># Rate of change</span>
<span class="linenos"> 32</span>
<span class="linenos"> 33</span>
<span class="linenos"> 34</span><span class="k">class</span><span class="w"> </span><span class="nc">AggregationType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="linenos"> 35</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Metric aggregation type.&quot;&quot;&quot;</span>
<span class="linenos"> 36</span>    <span class="n">SUM</span> <span class="o">=</span> <span class="s2">&quot;sum&quot;</span>
<span class="linenos"> 37</span>    <span class="n">AVERAGE</span> <span class="o">=</span> <span class="s2">&quot;average&quot;</span>
<span class="linenos"> 38</span>    <span class="n">MIN</span> <span class="o">=</span> <span class="s2">&quot;min&quot;</span>
<span class="linenos"> 39</span>    <span class="n">MAX</span> <span class="o">=</span> <span class="s2">&quot;max&quot;</span>
<span class="linenos"> 40</span>    <span class="n">COUNT</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span>
<span class="linenos"> 41</span>    <span class="n">MEDIAN</span> <span class="o">=</span> <span class="s2">&quot;median&quot;</span>
<span class="linenos"> 42</span>    <span class="n">P95</span> <span class="o">=</span> <span class="s2">&quot;p95&quot;</span>
<span class="linenos"> 43</span>    <span class="n">P99</span> <span class="o">=</span> <span class="s2">&quot;p99&quot;</span>
<span class="linenos"> 44</span>    <span class="n">STDDEV</span> <span class="o">=</span> <span class="s2">&quot;stddev&quot;</span>
<span class="linenos"> 45</span>
<span class="linenos"> 46</span>
<span class="linenos"> 47</span><span class="nd">@dataclass</span>
<span class="linenos"> 48</span><span class="k">class</span><span class="w"> </span><span class="nc">MetricValue</span><span class="p">:</span>
<span class="linenos"> 49</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Individual metric value with timestamp.&quot;&quot;&quot;</span>
<span class="linenos"> 50</span>    <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
<span class="linenos"> 51</span>    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
<span class="linenos"> 52</span>    <span class="n">tags</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="linenos"> 53</span>    <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="linenos"> 54</span>
<span class="linenos"> 55</span>
<span class="linenos"> 56</span><span class="nd">@dataclass</span>
<span class="linenos"> 57</span><span class="k">class</span><span class="w"> </span><span class="nc">Metric</span><span class="p">:</span>
<span class="linenos"> 58</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Metric definition and storage.&quot;&quot;&quot;</span>
<span class="linenos"> 59</span>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<span class="linenos"> 60</span>    <span class="n">metric_type</span><span class="p">:</span> <span class="n">MetricType</span>
<span class="linenos"> 61</span>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="linenos"> 62</span>    <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="linenos"> 63</span>    <span class="n">tags</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="linenos"> 64</span>
<span class="linenos"> 65</span>    <span class="c1"># Value storage</span>
<span class="linenos"> 66</span>    <span class="n">values</span><span class="p">:</span> <span class="n">deque</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">10000</span><span class="p">))</span>
<span class="linenos"> 67</span>
<span class="linenos"> 68</span>    <span class="c1"># Aggregated values</span>
<span class="linenos"> 69</span>    <span class="n">current_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 70</span>    <span class="n">total_value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos"> 71</span>    <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 72</span>    <span class="n">min_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 73</span>    <span class="n">max_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 74</span>
<span class="linenos"> 75</span>    <span class="c1"># Timing</span>
<span class="linenos"> 76</span>    <span class="n">created_at</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
<span class="linenos"> 77</span>    <span class="n">last_updated</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
<span class="linenos"> 78</span>
<span class="linenos"> 79</span>    <span class="c1"># Configuration</span>
<span class="linenos"> 80</span>    <span class="n">retention_window</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3600.0</span>  <span class="c1"># 1 hour</span>
<span class="linenos"> 81</span>    <span class="n">alert_thresholds</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="linenos"> 82</span>
<span class="linenos"> 83</span>    <span class="k">def</span><span class="w"> </span><span class="nf">add_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 84</span>                  <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 85</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add new value to metric.&quot;&quot;&quot;</span>
<span class="linenos"> 86</span>        <span class="n">metric_value</span> <span class="o">=</span> <span class="n">MetricValue</span><span class="p">(</span>
<span class="linenos"> 87</span>            <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
<span class="linenos"> 88</span>            <span class="n">tags</span><span class="o">=</span><span class="n">tags</span> <span class="ow">or</span> <span class="p">{},</span>
<span class="linenos"> 89</span>            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span> <span class="ow">or</span> <span class="p">{}</span>
<span class="linenos"> 90</span>        <span class="p">)</span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span>        <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_value</span><span class="p">)</span>
<span class="linenos"> 93</span>        <span class="bp">self</span><span class="o">.</span><span class="n">last_updated</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="linenos"> 94</span>        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span>        <span class="c1"># Update aggregated values based on metric type</span>
<span class="linenos"> 97</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_type</span> <span class="o">==</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">COUNTER</span><span class="p">:</span>
<span class="linenos"> 98</span>            <span class="bp">self</span><span class="o">.</span><span class="n">total_value</span> <span class="o">+=</span> <span class="n">value</span>
<span class="linenos"> 99</span>            <span class="bp">self</span><span class="o">.</span><span class="n">current_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_value</span>
<span class="linenos">100</span>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_type</span> <span class="o">==</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">GAUGE</span><span class="p">:</span>
<span class="linenos">101</span>            <span class="bp">self</span><span class="o">.</span><span class="n">current_value</span> <span class="o">=</span> <span class="n">value</span>
<span class="linenos">102</span>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">MetricType</span><span class="o">.</span><span class="n">HISTOGRAM</span><span class="p">,</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">SUMMARY</span><span class="p">,</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">TIMER</span><span class="p">]:</span>
<span class="linenos">103</span>            <span class="bp">self</span><span class="o">.</span><span class="n">current_value</span> <span class="o">=</span> <span class="n">value</span>
<span class="linenos">104</span>            <span class="bp">self</span><span class="o">.</span><span class="n">total_value</span> <span class="o">+=</span> <span class="n">value</span>
<span class="linenos">105</span>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_type</span> <span class="o">==</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">RATE</span><span class="p">:</span>
<span class="linenos">106</span>            <span class="bp">self</span><span class="o">.</span><span class="n">current_value</span> <span class="o">=</span> <span class="n">value</span>
<span class="linenos">107</span>
<span class="linenos">108</span>        <span class="c1"># Update min/max</span>
<span class="linenos">109</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="p">:</span>
<span class="linenos">110</span>            <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span> <span class="o">=</span> <span class="n">value</span>
<span class="linenos">111</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_value</span><span class="p">:</span>
<span class="linenos">112</span>            <span class="bp">self</span><span class="o">.</span><span class="n">max_value</span> <span class="o">=</span> <span class="n">value</span>
<span class="linenos">113</span>
<span class="linenos">114</span>    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="linenos">115</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current metric value.&quot;&quot;&quot;</span>
<span class="linenos">116</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_value</span>
<span class="linenos">117</span>
<span class="linenos">118</span>    <span class="k">def</span><span class="w"> </span><span class="nf">get_aggregated_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregation</span><span class="p">:</span> <span class="n">AggregationType</span><span class="p">,</span>
<span class="linenos">119</span>                           <span class="n">window_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="linenos">120</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get aggregated value over specified window.&quot;&quot;&quot;</span>
<span class="linenos">121</span>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
<span class="linenos">122</span>            <span class="k">return</span> <span class="kc">None</span>
<span class="linenos">123</span>
<span class="linenos">124</span>        <span class="c1"># Filter values by time window if specified</span>
<span class="linenos">125</span>        <span class="k">if</span> <span class="n">window_seconds</span><span class="p">:</span>
<span class="linenos">126</span>            <span class="n">cutoff_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">window_seconds</span>
<span class="linenos">127</span>            <span class="n">recent_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&gt;=</span> <span class="n">cutoff_time</span><span class="p">]</span>
<span class="linenos">128</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">129</span>            <span class="n">recent_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
<span class="linenos">130</span>
<span class="linenos">131</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">recent_values</span><span class="p">:</span>
<span class="linenos">132</span>            <span class="k">return</span> <span class="kc">None</span>
<span class="linenos">133</span>
<span class="linenos">134</span>        <span class="k">if</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="n">AggregationType</span><span class="o">.</span><span class="n">SUM</span><span class="p">:</span>
<span class="linenos">135</span>            <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">recent_values</span><span class="p">)</span>
<span class="linenos">136</span>        <span class="k">elif</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="n">AggregationType</span><span class="o">.</span><span class="n">AVERAGE</span><span class="p">:</span>
<span class="linenos">137</span>            <span class="k">return</span> <span class="n">statistics</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">recent_values</span><span class="p">)</span>
<span class="linenos">138</span>        <span class="k">elif</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="n">AggregationType</span><span class="o">.</span><span class="n">MIN</span><span class="p">:</span>
<span class="linenos">139</span>            <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">recent_values</span><span class="p">)</span>
<span class="linenos">140</span>        <span class="k">elif</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="n">AggregationType</span><span class="o">.</span><span class="n">MAX</span><span class="p">:</span>
<span class="linenos">141</span>            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">recent_values</span><span class="p">)</span>
<span class="linenos">142</span>        <span class="k">elif</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="n">AggregationType</span><span class="o">.</span><span class="n">COUNT</span><span class="p">:</span>
<span class="linenos">143</span>            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_values</span><span class="p">)</span>
<span class="linenos">144</span>        <span class="k">elif</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="n">AggregationType</span><span class="o">.</span><span class="n">MEDIAN</span><span class="p">:</span>
<span class="linenos">145</span>            <span class="k">return</span> <span class="n">statistics</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">recent_values</span><span class="p">)</span>
<span class="linenos">146</span>        <span class="k">elif</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="n">AggregationType</span><span class="o">.</span><span class="n">P95</span><span class="p">:</span>
<span class="linenos">147</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_percentile</span><span class="p">(</span><span class="n">recent_values</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
<span class="linenos">148</span>        <span class="k">elif</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="n">AggregationType</span><span class="o">.</span><span class="n">P99</span><span class="p">:</span>
<span class="linenos">149</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_percentile</span><span class="p">(</span><span class="n">recent_values</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>
<span class="linenos">150</span>        <span class="k">elif</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="n">AggregationType</span><span class="o">.</span><span class="n">STDDEV</span><span class="p">:</span>
<span class="linenos">151</span>            <span class="k">return</span> <span class="n">statistics</span><span class="o">.</span><span class="n">stdev</span><span class="p">(</span><span class="n">recent_values</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mf">0.0</span>
<span class="linenos">152</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">153</span>            <span class="k">return</span> <span class="kc">None</span>
<span class="linenos">154</span>
<span class="linenos">155</span>    <span class="k">def</span><span class="w"> </span><span class="nf">get_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window_seconds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="linenos">156</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate rate of change over time window.&quot;&quot;&quot;</span>
<span class="linenos">157</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos">158</span>            <span class="k">return</span> <span class="kc">None</span>
<span class="linenos">159</span>
<span class="linenos">160</span>        <span class="n">cutoff_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">window_seconds</span>
<span class="linenos">161</span>        <span class="n">recent_values</span> <span class="o">=</span> <span class="p">[(</span><span class="n">v</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&gt;=</span> <span class="n">cutoff_time</span><span class="p">]</span>
<span class="linenos">162</span>
<span class="linenos">163</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos">164</span>            <span class="k">return</span> <span class="kc">None</span>
<span class="linenos">165</span>
<span class="linenos">166</span>        <span class="c1"># Sort by timestamp</span>
<span class="linenos">167</span>        <span class="n">recent_values</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">168</span>
<span class="linenos">169</span>        <span class="c1"># Calculate rate</span>
<span class="linenos">170</span>        <span class="n">time_diff</span> <span class="o">=</span> <span class="n">recent_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">recent_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">171</span>        <span class="k">if</span> <span class="n">time_diff</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">172</span>            <span class="k">return</span> <span class="kc">None</span>
<span class="linenos">173</span>
<span class="linenos">174</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_type</span> <span class="o">==</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">COUNTER</span><span class="p">:</span>
<span class="linenos">175</span>            <span class="c1"># For counters, rate is the difference divided by time</span>
<span class="linenos">176</span>            <span class="n">value_diff</span> <span class="o">=</span> <span class="n">recent_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">recent_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">177</span>            <span class="k">return</span> <span class="n">value_diff</span> <span class="o">/</span> <span class="n">time_diff</span>
<span class="linenos">178</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">179</span>            <span class="c1"># For other types, calculate average rate of change</span>
<span class="linenos">180</span>            <span class="n">total_change</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">recent_values</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">recent_values</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
<span class="linenos">181</span>                             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_values</span><span class="p">)))</span>
<span class="linenos">182</span>            <span class="k">return</span> <span class="n">total_change</span> <span class="o">/</span> <span class="n">time_diff</span>
<span class="linenos">183</span>
<span class="linenos">184</span>    <span class="k">def</span><span class="w"> </span><span class="nf">clean_old_values</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">185</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove values outside retention window.&quot;&quot;&quot;</span>
<span class="linenos">186</span>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">retention_window</span><span class="p">:</span>
<span class="linenos">187</span>            <span class="k">return</span>
<span class="linenos">188</span>
<span class="linenos">189</span>        <span class="n">cutoff_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">retention_window</span>
<span class="linenos">190</span>
<span class="linenos">191</span>        <span class="c1"># Remove old values</span>
<span class="linenos">192</span>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&lt;</span> <span class="n">cutoff_time</span><span class="p">:</span>
<span class="linenos">193</span>            <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
<span class="linenos">194</span>
<span class="linenos">195</span>    <span class="k">def</span><span class="w"> </span><span class="nf">get_histogram_buckets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="linenos">196</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get histogram distribution of values.&quot;&quot;&quot;</span>
<span class="linenos">197</span>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
<span class="linenos">198</span>            <span class="k">return</span> <span class="p">{}</span>
<span class="linenos">199</span>
<span class="linenos">200</span>        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
<span class="linenos">201</span>        <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
<span class="linenos">202</span>
<span class="linenos">203</span>        <span class="k">if</span> <span class="n">min_val</span> <span class="o">==</span> <span class="n">max_val</span><span class="p">:</span>
<span class="linenos">204</span>            <span class="k">return</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">min_val</span><span class="p">):</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)}</span>
<span class="linenos">205</span>
<span class="linenos">206</span>        <span class="n">bucket_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_val</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">/</span> <span class="n">bucket_count</span>
<span class="linenos">207</span>        <span class="n">buckets</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="linenos">208</span>
<span class="linenos">209</span>        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
<span class="linenos">210</span>            <span class="n">bucket_index</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">value</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">/</span> <span class="n">bucket_size</span><span class="p">),</span> <span class="n">bucket_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">211</span>            <span class="n">bucket_start</span> <span class="o">=</span> <span class="n">min_val</span> <span class="o">+</span> <span class="n">bucket_index</span> <span class="o">*</span> <span class="n">bucket_size</span>
<span class="linenos">212</span>            <span class="n">bucket_end</span> <span class="o">=</span> <span class="n">bucket_start</span> <span class="o">+</span> <span class="n">bucket_size</span>
<span class="linenos">213</span>            <span class="n">bucket_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bucket_start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">bucket_end</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">214</span>            <span class="n">buckets</span><span class="p">[</span><span class="n">bucket_key</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="linenos">215</span>
<span class="linenos">216</span>        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">buckets</span><span class="p">)</span>
<span class="linenos">217</span>
<span class="linenos">218</span>    <span class="nd">@staticmethod</span>
<span class="linenos">219</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_percentile</span><span class="p">(</span><span class="n">values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">percentile</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="linenos">220</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate percentile of values.&quot;&quot;&quot;</span>
<span class="linenos">221</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">values</span><span class="p">:</span>
<span class="linenos">222</span>            <span class="k">return</span> <span class="mf">0.0</span>
<span class="linenos">223</span>
<span class="linenos">224</span>        <span class="n">sorted_values</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
<span class="linenos">225</span>        <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">percentile</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_values</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
<span class="linenos">226</span>        <span class="k">return</span> <span class="n">sorted_values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
<span class="linenos">227</span>
<span class="linenos">228</span>
<span class="linenos">229</span><span class="k">class</span><span class="w"> </span><span class="nc">MetricsCollector</span><span class="p">:</span>
<span class="linenos">230</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Main metrics collection and management system.&quot;&quot;&quot;</span>
<span class="linenos">231</span>
<span class="linenos">232</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retention_window</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3600.0</span><span class="p">):</span>
<span class="linenos">233</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">234</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_retention_window</span> <span class="o">=</span> <span class="n">retention_window</span>
<span class="linenos">235</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
<span class="linenos">236</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_collectors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">237</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_interval</span> <span class="o">=</span> <span class="mf">300.0</span>  <span class="c1"># 5 minutes</span>
<span class="linenos">238</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_last_cleanup</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="linenos">239</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;metrics_collector&quot;</span><span class="p">)</span>
<span class="linenos">240</span>
<span class="linenos">241</span>    <span class="k">def</span><span class="w"> </span><span class="nf">create_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metric_type</span><span class="p">:</span> <span class="n">MetricType</span><span class="p">,</span>
<span class="linenos">242</span>                     <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="linenos">243</span>                     <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Metric</span><span class="p">:</span>
<span class="linenos">244</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create new metric.&quot;&quot;&quot;</span>
<span class="linenos">245</span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="linenos">246</span>            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">:</span>
<span class="linenos">247</span>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<span class="linenos">248</span>
<span class="linenos">249</span>            <span class="n">metric</span> <span class="o">=</span> <span class="n">Metric</span><span class="p">(</span>
<span class="linenos">250</span>                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="linenos">251</span>                <span class="n">metric_type</span><span class="o">=</span><span class="n">metric_type</span><span class="p">,</span>
<span class="linenos">252</span>                <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
<span class="linenos">253</span>                <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span>
<span class="linenos">254</span>                <span class="n">tags</span><span class="o">=</span><span class="n">tags</span> <span class="ow">or</span> <span class="p">{},</span>
<span class="linenos">255</span>                <span class="n">retention_window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_retention_window</span>
<span class="linenos">256</span>            <span class="p">)</span>
<span class="linenos">257</span>
<span class="linenos">258</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span>
<span class="linenos">259</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created metric: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">metric_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="linenos">260</span>            <span class="k">return</span> <span class="n">metric</span>
<span class="linenos">261</span>
<span class="linenos">262</span>    <span class="k">def</span><span class="w"> </span><span class="nf">get_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Metric</span><span class="p">]:</span>
<span class="linenos">263</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get metric by name.&quot;&quot;&quot;</span>
<span class="linenos">264</span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="linenos">265</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="linenos">266</span>
<span class="linenos">267</span>    <span class="k">def</span><span class="w"> </span><span class="nf">increment_counter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">268</span>                         <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">269</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Increment counter metric.&quot;&quot;&quot;</span>
<span class="linenos">270</span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="linenos">271</span>            <span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create_metric</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">COUNTER</span><span class="p">)</span>
<span class="linenos">272</span>            <span class="n">metric</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="linenos">273</span>
<span class="linenos">274</span>    <span class="k">def</span><span class="w"> </span><span class="nf">set_gauge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
<span class="linenos">275</span>                  <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">276</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set gauge metric value.&quot;&quot;&quot;</span>
<span class="linenos">277</span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="linenos">278</span>            <span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create_metric</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">GAUGE</span><span class="p">)</span>
<span class="linenos">279</span>            <span class="n">metric</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="linenos">280</span>
<span class="linenos">281</span>    <span class="k">def</span><span class="w"> </span><span class="nf">record_histogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
<span class="linenos">282</span>                        <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">283</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Record histogram value.&quot;&quot;&quot;</span>
<span class="linenos">284</span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="linenos">285</span>            <span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create_metric</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">HISTOGRAM</span><span class="p">)</span>
<span class="linenos">286</span>            <span class="n">metric</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="linenos">287</span>
<span class="linenos">288</span>    <span class="k">def</span><span class="w"> </span><span class="nf">record_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">duration</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="linenos">289</span>                    <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">290</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Record timer duration.&quot;&quot;&quot;</span>
<span class="linenos">291</span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="linenos">292</span>            <span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create_metric</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">TIMER</span><span class="p">)</span>
<span class="linenos">293</span>            <span class="n">metric</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="linenos">294</span>
<span class="linenos">295</span>    <span class="k">def</span><span class="w"> </span><span class="nf">record_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="linenos">296</span>                   <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">297</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Record rate metric.&quot;&quot;&quot;</span>
<span class="linenos">298</span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="linenos">299</span>            <span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create_metric</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">RATE</span><span class="p">)</span>
<span class="linenos">300</span>            <span class="n">metric</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="linenos">301</span>
<span class="linenos">302</span>    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Metric</span><span class="p">]:</span>
<span class="linenos">303</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all metrics.&quot;&quot;&quot;</span>
<span class="linenos">304</span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="linenos">305</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_if_needed</span><span class="p">()</span>
<span class="linenos">306</span>            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">)</span>
<span class="linenos">307</span>
<span class="linenos">308</span>    <span class="k">def</span><span class="w"> </span><span class="nf">get_metrics_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="linenos">309</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get summary of all metrics.&quot;&quot;&quot;</span>
<span class="linenos">310</span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="linenos">311</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_if_needed</span><span class="p">()</span>
<span class="linenos">312</span>            <span class="n">summary</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">313</span>
<span class="linenos">314</span>            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">315</span>                <span class="n">summary</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">316</span>                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="o">.</span><span class="n">metric_type</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<span class="linenos">317</span>                    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
<span class="linenos">318</span>                    <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span>
<span class="linenos">319</span>                    <span class="s1">&#39;current_value&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="o">.</span><span class="n">get_current_value</span><span class="p">(),</span>
<span class="linenos">320</span>                    <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="o">.</span><span class="n">count</span><span class="p">,</span>
<span class="linenos">321</span>                    <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="o">.</span><span class="n">min_value</span><span class="p">,</span>
<span class="linenos">322</span>                    <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="o">.</span><span class="n">max_value</span><span class="p">,</span>
<span class="linenos">323</span>                    <span class="s1">&#39;avg&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="o">.</span><span class="n">get_aggregated_value</span><span class="p">(</span><span class="n">AggregationType</span><span class="o">.</span><span class="n">AVERAGE</span><span class="p">),</span>
<span class="linenos">324</span>                    <span class="s1">&#39;last_updated&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="o">.</span><span class="n">last_updated</span><span class="p">,</span>
<span class="linenos">325</span>                    <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="o">.</span><span class="n">tags</span>
<span class="linenos">326</span>                <span class="p">}</span>
<span class="linenos">327</span>
<span class="linenos">328</span>            <span class="k">return</span> <span class="n">summary</span>
<span class="linenos">329</span>
<span class="linenos">330</span>    <span class="k">def</span><span class="w"> </span><span class="nf">add_collector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collector</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">331</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add metrics collector function.&quot;&quot;&quot;</span>
<span class="linenos">332</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_collectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collector</span><span class="p">)</span>
<span class="linenos">333</span>
<span class="linenos">334</span>    <span class="k">def</span><span class="w"> </span><span class="nf">collect_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">335</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run all registered collectors.&quot;&quot;&quot;</span>
<span class="linenos">336</span>        <span class="k">for</span> <span class="n">collector</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collectors</span><span class="p">:</span>
<span class="linenos">337</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">338</span>                <span class="n">metrics_data</span> <span class="o">=</span> <span class="n">collector</span><span class="p">()</span>
<span class="linenos">339</span>                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">340</span>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos">341</span>                        <span class="n">metric_type</span> <span class="o">=</span> <span class="n">MetricType</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;gauge&#39;</span><span class="p">))</span>
<span class="linenos">342</span>                        <span class="n">metric_value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">343</span>                        <span class="n">tags</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="p">{})</span>
<span class="linenos">344</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">_record_metric_value</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">metric_type</span><span class="p">,</span> <span class="n">metric_value</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="linenos">345</span>                    <span class="k">else</span><span class="p">:</span>
<span class="linenos">346</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">set_gauge</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<span class="linenos">347</span>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">348</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in metrics collector: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">349</span>
<span class="linenos">350</span>    <span class="k">def</span><span class="w"> </span><span class="nf">export_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;prometheus&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="linenos">351</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Export metrics in specified format.&quot;&quot;&quot;</span>
<span class="linenos">352</span>        <span class="k">if</span> <span class="n">format_type</span> <span class="o">==</span> <span class="s2">&quot;prometheus&quot;</span><span class="p">:</span>
<span class="linenos">353</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_export_prometheus_format</span><span class="p">()</span>
<span class="linenos">354</span>        <span class="k">elif</span> <span class="n">format_type</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
<span class="linenos">355</span>            <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="linenos">356</span>            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_metrics_summary</span><span class="p">(),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">357</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">358</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported export format: </span><span class="si">{</span><span class="n">format_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">359</span>
<span class="linenos">360</span>    <span class="k">def</span><span class="w"> </span><span class="nf">reset_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos">361</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset metric values.&quot;&quot;&quot;</span>
<span class="linenos">362</span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="linenos">363</span>            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">:</span>
<span class="linenos">364</span>                <span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<span class="linenos">365</span>                <span class="n">metric</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<span class="linenos">366</span>                <span class="n">metric</span><span class="o">.</span><span class="n">current_value</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">367</span>                <span class="n">metric</span><span class="o">.</span><span class="n">total_value</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos">368</span>                <span class="n">metric</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">369</span>                <span class="n">metric</span><span class="o">.</span><span class="n">min_value</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">370</span>                <span class="n">metric</span><span class="o">.</span><span class="n">max_value</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">371</span>                <span class="k">return</span> <span class="kc">True</span>
<span class="linenos">372</span>            <span class="k">return</span> <span class="kc">False</span>
<span class="linenos">373</span>
<span class="linenos">374</span>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos">375</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete metric.&quot;&quot;&quot;</span>
<span class="linenos">376</span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="linenos">377</span>            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">:</span>
<span class="linenos">378</span>                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<span class="linenos">379</span>                <span class="k">return</span> <span class="kc">True</span>
<span class="linenos">380</span>            <span class="k">return</span> <span class="kc">False</span>
<span class="linenos">381</span>
<span class="linenos">382</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_or_create_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metric_type</span><span class="p">:</span> <span class="n">MetricType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Metric</span><span class="p">:</span>
<span class="linenos">383</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get existing metric or create new one.&quot;&quot;&quot;</span>
<span class="linenos">384</span>        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">:</span>
<span class="linenos">385</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_metric</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">metric_type</span><span class="p">)</span>
<span class="linenos">386</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<span class="linenos">387</span>
<span class="linenos">388</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_record_metric_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metric_type</span><span class="p">:</span> <span class="n">MetricType</span><span class="p">,</span>
<span class="linenos">389</span>                           <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">390</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Record metric value with appropriate method.&quot;&quot;&quot;</span>
<span class="linenos">391</span>        <span class="k">if</span> <span class="n">metric_type</span> <span class="o">==</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">COUNTER</span><span class="p">:</span>
<span class="linenos">392</span>            <span class="bp">self</span><span class="o">.</span><span class="n">increment_counter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="linenos">393</span>        <span class="k">elif</span> <span class="n">metric_type</span> <span class="o">==</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">GAUGE</span><span class="p">:</span>
<span class="linenos">394</span>            <span class="bp">self</span><span class="o">.</span><span class="n">set_gauge</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="linenos">395</span>        <span class="k">elif</span> <span class="n">metric_type</span> <span class="o">==</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">HISTOGRAM</span><span class="p">:</span>
<span class="linenos">396</span>            <span class="bp">self</span><span class="o">.</span><span class="n">record_histogram</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="linenos">397</span>        <span class="k">elif</span> <span class="n">metric_type</span> <span class="o">==</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">TIMER</span><span class="p">:</span>
<span class="linenos">398</span>            <span class="bp">self</span><span class="o">.</span><span class="n">record_timer</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="linenos">399</span>        <span class="k">elif</span> <span class="n">metric_type</span> <span class="o">==</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">RATE</span><span class="p">:</span>
<span class="linenos">400</span>            <span class="bp">self</span><span class="o">.</span><span class="n">record_rate</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="linenos">401</span>
<span class="linenos">402</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_cleanup_if_needed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">403</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up old metric values if needed.&quot;&quot;&quot;</span>
<span class="linenos">404</span>        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="linenos">405</span>        <span class="k">if</span> <span class="n">current_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_cleanup</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_interval</span><span class="p">:</span>
<span class="linenos">406</span>            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<span class="linenos">407</span>                <span class="n">metric</span><span class="o">.</span><span class="n">clean_old_values</span><span class="p">()</span>
<span class="linenos">408</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_last_cleanup</span> <span class="o">=</span> <span class="n">current_time</span>
<span class="linenos">409</span>
<span class="linenos">410</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_export_prometheus_format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="linenos">411</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Export metrics in Prometheus format.&quot;&quot;&quot;</span>
<span class="linenos">412</span>        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">413</span>
<span class="linenos">414</span>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">415</span>            <span class="c1"># Add metric help</span>
<span class="linenos">416</span>            <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>
<span class="linenos">417</span>                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# HELP </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">metric</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">418</span>
<span class="linenos">419</span>            <span class="c1"># Add metric type</span>
<span class="linenos">420</span>            <span class="n">prom_type</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">421</span>                <span class="n">MetricType</span><span class="o">.</span><span class="n">COUNTER</span><span class="p">:</span> <span class="s2">&quot;counter&quot;</span><span class="p">,</span>
<span class="linenos">422</span>                <span class="n">MetricType</span><span class="o">.</span><span class="n">GAUGE</span><span class="p">:</span> <span class="s2">&quot;gauge&quot;</span><span class="p">,</span>
<span class="linenos">423</span>                <span class="n">MetricType</span><span class="o">.</span><span class="n">HISTOGRAM</span><span class="p">:</span> <span class="s2">&quot;histogram&quot;</span><span class="p">,</span>
<span class="linenos">424</span>                <span class="n">MetricType</span><span class="o">.</span><span class="n">SUMMARY</span><span class="p">:</span> <span class="s2">&quot;summary&quot;</span><span class="p">,</span>
<span class="linenos">425</span>                <span class="n">MetricType</span><span class="o">.</span><span class="n">TIMER</span><span class="p">:</span> <span class="s2">&quot;histogram&quot;</span><span class="p">,</span>
<span class="linenos">426</span>                <span class="n">MetricType</span><span class="o">.</span><span class="n">RATE</span><span class="p">:</span> <span class="s2">&quot;gauge&quot;</span>
<span class="linenos">427</span>            <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="s2">&quot;gauge&quot;</span><span class="p">)</span>
<span class="linenos">428</span>
<span class="linenos">429</span>            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# TYPE </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">prom_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">430</span>
<span class="linenos">431</span>            <span class="c1"># Add current value</span>
<span class="linenos">432</span>            <span class="n">current_value</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">get_current_value</span><span class="p">()</span>
<span class="linenos">433</span>            <span class="k">if</span> <span class="n">current_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">434</span>                <span class="n">tags_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="linenos">435</span>                <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
<span class="linenos">436</span>                    <span class="n">tag_pairs</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">=&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metric</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
<span class="linenos">437</span>                    <span class="n">tags_str</span> <span class="o">=</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tag_pairs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
<span class="linenos">438</span>
<span class="linenos">439</span>                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">tags_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">current_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">440</span>
<span class="linenos">441</span>        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
<span class="linenos">442</span>
<span class="linenos">443</span>
<span class="linenos">444</span><span class="k">class</span><span class="w"> </span><span class="nc">SystemMetricsCollector</span><span class="p">:</span>
<span class="linenos">445</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;System-level metrics collector for system resources.&quot;&quot;&quot;</span>
<span class="linenos">446</span>
<span class="linenos">447</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collector</span><span class="p">:</span> <span class="n">MetricsCollector</span><span class="p">):</span>
<span class="linenos">448</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_collector</span> <span class="o">=</span> <span class="n">collector</span>
<span class="linenos">449</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_enabled</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">450</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_collection_interval</span> <span class="o">=</span> <span class="mf">30.0</span>  <span class="c1"># 30 seconds</span>
<span class="linenos">451</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_collection_task</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">452</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;system_metrics_collector&quot;</span><span class="p">)</span>
<span class="linenos">453</span>
<span class="linenos">454</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">455</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Start automatic system metrics collection.&quot;&quot;&quot;</span>
<span class="linenos">456</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection_task</span><span class="p">:</span>
<span class="linenos">457</span>            <span class="k">return</span>
<span class="linenos">458</span>
<span class="linenos">459</span>        <span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="linenos">460</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_collection_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_collection_loop</span><span class="p">())</span>
<span class="linenos">461</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Started system metrics collection&quot;</span><span class="p">)</span>
<span class="linenos">462</span>
<span class="linenos">463</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stop_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">464</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop automatic system metrics collection.&quot;&quot;&quot;</span>
<span class="linenos">465</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection_task</span><span class="p">:</span>
<span class="linenos">466</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_collection_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
<span class="linenos">467</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">468</span>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection_task</span>
<span class="linenos">469</span>            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
<span class="linenos">470</span>                <span class="k">pass</span>
<span class="linenos">471</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_collection_task</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">472</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopped system metrics collection&quot;</span><span class="p">)</span>
<span class="linenos">473</span>
<span class="linenos">474</span>    <span class="k">def</span><span class="w"> </span><span class="nf">collect_system_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="linenos">475</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Collect current system metrics.&quot;&quot;&quot;</span>
<span class="linenos">476</span>        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">477</span>
<span class="linenos">478</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">479</span>            <span class="kn">import</span><span class="w"> </span><span class="nn">psutil</span>
<span class="linenos">480</span>
<span class="linenos">481</span>            <span class="c1"># CPU metrics</span>
<span class="linenos">482</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_cpu_percent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_percent</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos">483</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_cpu_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
<span class="linenos">484</span>
<span class="linenos">485</span>            <span class="c1"># Memory metrics</span>
<span class="linenos">486</span>            <span class="n">memory</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span>
<span class="linenos">487</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_memory_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">total</span>
<span class="linenos">488</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_memory_used&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">used</span>
<span class="linenos">489</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_memory_percent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">percent</span>
<span class="linenos">490</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_memory_available&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">available</span>
<span class="linenos">491</span>
<span class="linenos">492</span>            <span class="c1"># Disk metrics</span>
<span class="linenos">493</span>            <span class="n">disk</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">disk_usage</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="linenos">494</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_disk_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">disk</span><span class="o">.</span><span class="n">total</span>
<span class="linenos">495</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_disk_used&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">disk</span><span class="o">.</span><span class="n">used</span>
<span class="linenos">496</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_disk_percent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">disk</span><span class="o">.</span><span class="n">used</span> <span class="o">/</span> <span class="n">disk</span><span class="o">.</span><span class="n">total</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<span class="linenos">497</span>
<span class="linenos">498</span>            <span class="c1"># Network metrics</span>
<span class="linenos">499</span>            <span class="n">network</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">net_io_counters</span><span class="p">()</span>
<span class="linenos">500</span>            <span class="k">if</span> <span class="n">network</span><span class="p">:</span>
<span class="linenos">501</span>                <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_network_bytes_sent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">bytes_sent</span>
<span class="linenos">502</span>                <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_network_bytes_recv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">bytes_recv</span>
<span class="linenos">503</span>                <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_network_packets_sent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">packets_sent</span>
<span class="linenos">504</span>                <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_network_packets_recv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">packets_recv</span>
<span class="linenos">505</span>
<span class="linenos">506</span>            <span class="c1"># Process metrics</span>
<span class="linenos">507</span>            <span class="n">process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">()</span>
<span class="linenos">508</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;process_cpu_percent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">cpu_percent</span><span class="p">()</span>
<span class="linenos">509</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;process_memory_rss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span>
<span class="linenos">510</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;process_memory_vms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">vms</span>
<span class="linenos">511</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;process_num_threads&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">num_threads</span><span class="p">()</span>
<span class="linenos">512</span>
<span class="linenos">513</span>        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
<span class="linenos">514</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;psutil not available, system metrics collection disabled&quot;</span><span class="p">)</span>
<span class="linenos">515</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">516</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error collecting system metrics: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">517</span>
<span class="linenos">518</span>        <span class="k">return</span> <span class="n">metrics</span>
<span class="linenos">519</span>
<span class="linenos">520</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_collection_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">521</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Main collection loop.&quot;&quot;&quot;</span>
<span class="linenos">522</span>        <span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="linenos">523</span>
<span class="linenos">524</span>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enabled</span><span class="p">:</span>
<span class="linenos">525</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">526</span>                <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_system_metrics</span><span class="p">()</span>
<span class="linenos">527</span>
<span class="linenos">528</span>                <span class="c1"># Record all metrics</span>
<span class="linenos">529</span>                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">530</span>                    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;system_&#39;</span><span class="p">):</span>
<span class="linenos">531</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">_collector</span><span class="o">.</span><span class="n">set_gauge</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;system&#39;</span><span class="p">})</span>
<span class="linenos">532</span>                    <span class="k">elif</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;process_&#39;</span><span class="p">):</span>
<span class="linenos">533</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">_collector</span><span class="o">.</span><span class="n">set_gauge</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;process&#39;</span><span class="p">})</span>
<span class="linenos">534</span>
<span class="linenos">535</span>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_collection_interval</span><span class="p">)</span>
<span class="linenos">536</span>
<span class="linenos">537</span>            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
<span class="linenos">538</span>                <span class="k">break</span>
<span class="linenos">539</span>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">540</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in metrics collection loop: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">541</span>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_collection_interval</span><span class="p">)</span>
<span class="linenos">542</span>
<span class="linenos">543</span>
<span class="linenos">544</span><span class="k">class</span><span class="w"> </span><span class="nc">TimerContext</span><span class="p">:</span>
<span class="linenos">545</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Context manager for timing operations.&quot;&quot;&quot;</span>
<span class="linenos">546</span>
<span class="linenos">547</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collector</span><span class="p">:</span> <span class="n">MetricsCollector</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="linenos">548</span>                 <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">549</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_collector</span> <span class="o">=</span> <span class="n">collector</span>
<span class="linenos">550</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_metric_name</span> <span class="o">=</span> <span class="n">metric_name</span>
<span class="linenos">551</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="n">tags</span>
<span class="linenos">552</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">553</span>
<span class="linenos">554</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">555</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="linenos">556</span>        <span class="k">return</span> <span class="bp">self</span>
<span class="linenos">557</span>
<span class="linenos">558</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
<span class="linenos">559</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">560</span>            <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span>
<span class="linenos">561</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_collector</span><span class="o">.</span><span class="n">record_timer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metric_name</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="p">)</span>
<span class="linenos">562</span>
<span class="linenos">563</span>
<span class="linenos">564</span><span class="c1"># Factory functions and utilities</span>
<span class="linenos">565</span><span class="k">def</span><span class="w"> </span><span class="nf">create_metric</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metric_type</span><span class="p">:</span> <span class="n">MetricType</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="linenos">566</span>                 <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Metric</span><span class="p">:</span>
<span class="linenos">567</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a metric instance.&quot;&quot;&quot;</span>
<span class="linenos">568</span>    <span class="k">return</span> <span class="n">Metric</span><span class="p">(</span>
<span class="linenos">569</span>        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="linenos">570</span>        <span class="n">metric_type</span><span class="o">=</span><span class="n">metric_type</span><span class="p">,</span>
<span class="linenos">571</span>        <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
<span class="linenos">572</span>        <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span>
<span class="linenos">573</span>        <span class="n">tags</span><span class="o">=</span><span class="n">tags</span> <span class="ow">or</span> <span class="p">{}</span>
<span class="linenos">574</span>    <span class="p">)</span>
<span class="linenos">575</span>
<span class="linenos">576</span>
<span class="linenos">577</span><span class="k">def</span><span class="w"> </span><span class="nf">timer</span><span class="p">(</span><span class="n">collector</span><span class="p">:</span> <span class="n">MetricsCollector</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="linenos">578</span>          <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TimerContext</span><span class="p">:</span>
<span class="linenos">579</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create timer context manager.&quot;&quot;&quot;</span>
<span class="linenos">580</span>    <span class="k">return</span> <span class="n">TimerContext</span><span class="p">(</span><span class="n">collector</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="linenos">581</span>
<span class="linenos">582</span>
<span class="linenos">583</span><span class="c1"># Decorator for timing functions</span>
<span class="linenos">584</span><span class="k">def</span><span class="w"> </span><span class="nf">timed_function</span><span class="p">(</span><span class="n">collector</span><span class="p">:</span> <span class="n">MetricsCollector</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">585</span>                  <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">586</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator to time function execution.&quot;&quot;&quot;</span>
<span class="linenos">587</span>    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="linenos">588</span>        <span class="k">nonlocal</span> <span class="n">metric_name</span>
<span class="linenos">589</span>        <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">590</span>            <span class="n">metric_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;function_</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">_duration&quot;</span>
<span class="linenos">591</span>
<span class="linenos">592</span>        <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos">593</span>            <span class="k">with</span> <span class="n">timer</span><span class="p">(</span><span class="n">collector</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
<span class="linenos">594</span>                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">595</span>        <span class="k">return</span> <span class="n">wrapper</span>
<span class="linenos">596</span>    <span class="k">return</span> <span class="n">decorator</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="classes">
<h2>Classes<a class="headerlink" href="#classes" title="Link to this heading">¶</a></h2>
<section id="metrictype">
<h3><code class="docutils literal notranslate"><span class="pre">MetricType</span></code><a class="headerlink" href="#metrictype" title="Link to this heading">¶</a></h3>
<p><strong>Inherits from:</strong> <code class="docutils literal notranslate"><span class="pre">Enum</span></code></p>
<p>Metric type enumeration.</p>
<section id="source-code">
<h4>Source Code<a class="headerlink" href="#source-code" title="Link to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">class</span><span class="w"> </span><span class="nc">MetricType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="linenos">2</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Metric type enumeration.&quot;&quot;&quot;</span>
<span class="linenos">3</span>    <span class="n">COUNTER</span> <span class="o">=</span> <span class="s2">&quot;counter&quot;</span>          <span class="c1"># Monotonically increasing value</span>
<span class="linenos">4</span>    <span class="n">GAUGE</span> <span class="o">=</span> <span class="s2">&quot;gauge&quot;</span>             <span class="c1"># Current value that can go up or down</span>
<span class="linenos">5</span>    <span class="n">HISTOGRAM</span> <span class="o">=</span> <span class="s2">&quot;histogram&quot;</span>     <span class="c1"># Distribution of values</span>
<span class="linenos">6</span>    <span class="n">SUMMARY</span> <span class="o">=</span> <span class="s2">&quot;summary&quot;</span>         <span class="c1"># Summary statistics</span>
<span class="linenos">7</span>    <span class="n">TIMER</span> <span class="o">=</span> <span class="s2">&quot;timer&quot;</span>            <span class="c1"># Duration measurements</span>
<span class="linenos">8</span>    <span class="n">RATE</span> <span class="o">=</span> <span class="s2">&quot;rate&quot;</span>              <span class="c1"># Rate of change</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="aggregationtype">
<h3><code class="docutils literal notranslate"><span class="pre">AggregationType</span></code><a class="headerlink" href="#aggregationtype" title="Link to this heading">¶</a></h3>
<p><strong>Inherits from:</strong> <code class="docutils literal notranslate"><span class="pre">Enum</span></code></p>
<p>Metric aggregation type.</p>
<section id="id1">
<h4>Source Code<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">class</span><span class="w"> </span><span class="nc">AggregationType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="linenos"> 2</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Metric aggregation type.&quot;&quot;&quot;</span>
<span class="linenos"> 3</span>    <span class="n">SUM</span> <span class="o">=</span> <span class="s2">&quot;sum&quot;</span>
<span class="linenos"> 4</span>    <span class="n">AVERAGE</span> <span class="o">=</span> <span class="s2">&quot;average&quot;</span>
<span class="linenos"> 5</span>    <span class="n">MIN</span> <span class="o">=</span> <span class="s2">&quot;min&quot;</span>
<span class="linenos"> 6</span>    <span class="n">MAX</span> <span class="o">=</span> <span class="s2">&quot;max&quot;</span>
<span class="linenos"> 7</span>    <span class="n">COUNT</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span>
<span class="linenos"> 8</span>    <span class="n">MEDIAN</span> <span class="o">=</span> <span class="s2">&quot;median&quot;</span>
<span class="linenos"> 9</span>    <span class="n">P95</span> <span class="o">=</span> <span class="s2">&quot;p95&quot;</span>
<span class="linenos">10</span>    <span class="n">P99</span> <span class="o">=</span> <span class="s2">&quot;p99&quot;</span>
<span class="linenos">11</span>    <span class="n">STDDEV</span> <span class="o">=</span> <span class="s2">&quot;stddev&quot;</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="metricvalue">
<h3><code class="docutils literal notranslate"><span class="pre">MetricValue</span></code><a class="headerlink" href="#metricvalue" title="Link to this heading">¶</a></h3>
<p>Individual metric value with timestamp.</p>
<section id="id2">
<h4>Source Code<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="nd">@dataclass</span>
<span class="linenos">2</span><span class="k">class</span><span class="w"> </span><span class="nc">MetricValue</span><span class="p">:</span>
<span class="linenos">3</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Individual metric value with timestamp.&quot;&quot;&quot;</span>
<span class="linenos">4</span>    <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
<span class="linenos">5</span>    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
<span class="linenos">6</span>    <span class="n">tags</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="linenos">7</span>    <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="metric">
<h3><code class="docutils literal notranslate"><span class="pre">Metric</span></code><a class="headerlink" href="#metric" title="Link to this heading">¶</a></h3>
<p>Metric definition and storage.</p>
<section id="id3">
<h4>Source Code<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="nd">@dataclass</span>
<span class="linenos">  2</span><span class="k">class</span><span class="w"> </span><span class="nc">Metric</span><span class="p">:</span>
<span class="linenos">  3</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Metric definition and storage.&quot;&quot;&quot;</span>
<span class="linenos">  4</span>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<span class="linenos">  5</span>    <span class="n">metric_type</span><span class="p">:</span> <span class="n">MetricType</span>
<span class="linenos">  6</span>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="linenos">  7</span>    <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="linenos">  8</span>    <span class="n">tags</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="linenos">  9</span>
<span class="linenos"> 10</span>    <span class="c1"># Value storage</span>
<span class="linenos"> 11</span>    <span class="n">values</span><span class="p">:</span> <span class="n">deque</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">10000</span><span class="p">))</span>
<span class="linenos"> 12</span>
<span class="linenos"> 13</span>    <span class="c1"># Aggregated values</span>
<span class="linenos"> 14</span>    <span class="n">current_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 15</span>    <span class="n">total_value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos"> 16</span>    <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 17</span>    <span class="n">min_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 18</span>    <span class="n">max_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 19</span>
<span class="linenos"> 20</span>    <span class="c1"># Timing</span>
<span class="linenos"> 21</span>    <span class="n">created_at</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
<span class="linenos"> 22</span>    <span class="n">last_updated</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
<span class="linenos"> 23</span>
<span class="linenos"> 24</span>    <span class="c1"># Configuration</span>
<span class="linenos"> 25</span>    <span class="n">retention_window</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3600.0</span>  <span class="c1"># 1 hour</span>
<span class="linenos"> 26</span>    <span class="n">alert_thresholds</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="linenos"> 27</span>
<span class="linenos"> 28</span>    <span class="k">def</span><span class="w"> </span><span class="nf">add_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 29</span>                  <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 30</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add new value to metric.&quot;&quot;&quot;</span>
<span class="linenos"> 31</span>        <span class="n">metric_value</span> <span class="o">=</span> <span class="n">MetricValue</span><span class="p">(</span>
<span class="linenos"> 32</span>            <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
<span class="linenos"> 33</span>            <span class="n">tags</span><span class="o">=</span><span class="n">tags</span> <span class="ow">or</span> <span class="p">{},</span>
<span class="linenos"> 34</span>            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span> <span class="ow">or</span> <span class="p">{}</span>
<span class="linenos"> 35</span>        <span class="p">)</span>
<span class="linenos"> 36</span>
<span class="linenos"> 37</span>        <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_value</span><span class="p">)</span>
<span class="linenos"> 38</span>        <span class="bp">self</span><span class="o">.</span><span class="n">last_updated</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="linenos"> 39</span>        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="linenos"> 40</span>
<span class="linenos"> 41</span>        <span class="c1"># Update aggregated values based on metric type</span>
<span class="linenos"> 42</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_type</span> <span class="o">==</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">COUNTER</span><span class="p">:</span>
<span class="linenos"> 43</span>            <span class="bp">self</span><span class="o">.</span><span class="n">total_value</span> <span class="o">+=</span> <span class="n">value</span>
<span class="linenos"> 44</span>            <span class="bp">self</span><span class="o">.</span><span class="n">current_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_value</span>
<span class="linenos"> 45</span>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_type</span> <span class="o">==</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">GAUGE</span><span class="p">:</span>
<span class="linenos"> 46</span>            <span class="bp">self</span><span class="o">.</span><span class="n">current_value</span> <span class="o">=</span> <span class="n">value</span>
<span class="linenos"> 47</span>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">MetricType</span><span class="o">.</span><span class="n">HISTOGRAM</span><span class="p">,</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">SUMMARY</span><span class="p">,</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">TIMER</span><span class="p">]:</span>
<span class="linenos"> 48</span>            <span class="bp">self</span><span class="o">.</span><span class="n">current_value</span> <span class="o">=</span> <span class="n">value</span>
<span class="linenos"> 49</span>            <span class="bp">self</span><span class="o">.</span><span class="n">total_value</span> <span class="o">+=</span> <span class="n">value</span>
<span class="linenos"> 50</span>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_type</span> <span class="o">==</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">RATE</span><span class="p">:</span>
<span class="linenos"> 51</span>            <span class="bp">self</span><span class="o">.</span><span class="n">current_value</span> <span class="o">=</span> <span class="n">value</span>
<span class="linenos"> 52</span>
<span class="linenos"> 53</span>        <span class="c1"># Update min/max</span>
<span class="linenos"> 54</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="p">:</span>
<span class="linenos"> 55</span>            <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span> <span class="o">=</span> <span class="n">value</span>
<span class="linenos"> 56</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_value</span><span class="p">:</span>
<span class="linenos"> 57</span>            <span class="bp">self</span><span class="o">.</span><span class="n">max_value</span> <span class="o">=</span> <span class="n">value</span>
<span class="linenos"> 58</span>
<span class="linenos"> 59</span>    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="linenos"> 60</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current metric value.&quot;&quot;&quot;</span>
<span class="linenos"> 61</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_value</span>
<span class="linenos"> 62</span>
<span class="linenos"> 63</span>    <span class="k">def</span><span class="w"> </span><span class="nf">get_aggregated_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregation</span><span class="p">:</span> <span class="n">AggregationType</span><span class="p">,</span>
<span class="linenos"> 64</span>                           <span class="n">window_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="linenos"> 65</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get aggregated value over specified window.&quot;&quot;&quot;</span>
<span class="linenos"> 66</span>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
<span class="linenos"> 67</span>            <span class="k">return</span> <span class="kc">None</span>
<span class="linenos"> 68</span>
<span class="linenos"> 69</span>        <span class="c1"># Filter values by time window if specified</span>
<span class="linenos"> 70</span>        <span class="k">if</span> <span class="n">window_seconds</span><span class="p">:</span>
<span class="linenos"> 71</span>            <span class="n">cutoff_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">window_seconds</span>
<span class="linenos"> 72</span>            <span class="n">recent_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&gt;=</span> <span class="n">cutoff_time</span><span class="p">]</span>
<span class="linenos"> 73</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 74</span>            <span class="n">recent_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">recent_values</span><span class="p">:</span>
<span class="linenos"> 77</span>            <span class="k">return</span> <span class="kc">None</span>
<span class="linenos"> 78</span>
<span class="linenos"> 79</span>        <span class="k">if</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="n">AggregationType</span><span class="o">.</span><span class="n">SUM</span><span class="p">:</span>
<span class="linenos"> 80</span>            <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">recent_values</span><span class="p">)</span>
<span class="linenos"> 81</span>        <span class="k">elif</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="n">AggregationType</span><span class="o">.</span><span class="n">AVERAGE</span><span class="p">:</span>
<span class="linenos"> 82</span>            <span class="k">return</span> <span class="n">statistics</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">recent_values</span><span class="p">)</span>
<span class="linenos"> 83</span>        <span class="k">elif</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="n">AggregationType</span><span class="o">.</span><span class="n">MIN</span><span class="p">:</span>
<span class="linenos"> 84</span>            <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">recent_values</span><span class="p">)</span>
<span class="linenos"> 85</span>        <span class="k">elif</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="n">AggregationType</span><span class="o">.</span><span class="n">MAX</span><span class="p">:</span>
<span class="linenos"> 86</span>            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">recent_values</span><span class="p">)</span>
<span class="linenos"> 87</span>        <span class="k">elif</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="n">AggregationType</span><span class="o">.</span><span class="n">COUNT</span><span class="p">:</span>
<span class="linenos"> 88</span>            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_values</span><span class="p">)</span>
<span class="linenos"> 89</span>        <span class="k">elif</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="n">AggregationType</span><span class="o">.</span><span class="n">MEDIAN</span><span class="p">:</span>
<span class="linenos"> 90</span>            <span class="k">return</span> <span class="n">statistics</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">recent_values</span><span class="p">)</span>
<span class="linenos"> 91</span>        <span class="k">elif</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="n">AggregationType</span><span class="o">.</span><span class="n">P95</span><span class="p">:</span>
<span class="linenos"> 92</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_percentile</span><span class="p">(</span><span class="n">recent_values</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
<span class="linenos"> 93</span>        <span class="k">elif</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="n">AggregationType</span><span class="o">.</span><span class="n">P99</span><span class="p">:</span>
<span class="linenos"> 94</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_percentile</span><span class="p">(</span><span class="n">recent_values</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>
<span class="linenos"> 95</span>        <span class="k">elif</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="n">AggregationType</span><span class="o">.</span><span class="n">STDDEV</span><span class="p">:</span>
<span class="linenos"> 96</span>            <span class="k">return</span> <span class="n">statistics</span><span class="o">.</span><span class="n">stdev</span><span class="p">(</span><span class="n">recent_values</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mf">0.0</span>
<span class="linenos"> 97</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 98</span>            <span class="k">return</span> <span class="kc">None</span>
<span class="linenos"> 99</span>
<span class="linenos">100</span>    <span class="k">def</span><span class="w"> </span><span class="nf">get_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window_seconds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="linenos">101</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate rate of change over time window.&quot;&quot;&quot;</span>
<span class="linenos">102</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos">103</span>            <span class="k">return</span> <span class="kc">None</span>
<span class="linenos">104</span>
<span class="linenos">105</span>        <span class="n">cutoff_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">window_seconds</span>
<span class="linenos">106</span>        <span class="n">recent_values</span> <span class="o">=</span> <span class="p">[(</span><span class="n">v</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&gt;=</span> <span class="n">cutoff_time</span><span class="p">]</span>
<span class="linenos">107</span>
<span class="linenos">108</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos">109</span>            <span class="k">return</span> <span class="kc">None</span>
<span class="linenos">110</span>
<span class="linenos">111</span>        <span class="c1"># Sort by timestamp</span>
<span class="linenos">112</span>        <span class="n">recent_values</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">113</span>
<span class="linenos">114</span>        <span class="c1"># Calculate rate</span>
<span class="linenos">115</span>        <span class="n">time_diff</span> <span class="o">=</span> <span class="n">recent_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">recent_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">116</span>        <span class="k">if</span> <span class="n">time_diff</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">117</span>            <span class="k">return</span> <span class="kc">None</span>
<span class="linenos">118</span>
<span class="linenos">119</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_type</span> <span class="o">==</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">COUNTER</span><span class="p">:</span>
<span class="linenos">120</span>            <span class="c1"># For counters, rate is the difference divided by time</span>
<span class="linenos">121</span>            <span class="n">value_diff</span> <span class="o">=</span> <span class="n">recent_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">recent_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">122</span>            <span class="k">return</span> <span class="n">value_diff</span> <span class="o">/</span> <span class="n">time_diff</span>
<span class="linenos">123</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">124</span>            <span class="c1"># For other types, calculate average rate of change</span>
<span class="linenos">125</span>            <span class="n">total_change</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">recent_values</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">recent_values</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
<span class="linenos">126</span>                             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_values</span><span class="p">)))</span>
<span class="linenos">127</span>            <span class="k">return</span> <span class="n">total_change</span> <span class="o">/</span> <span class="n">time_diff</span>
<span class="linenos">128</span>
<span class="linenos">129</span>    <span class="k">def</span><span class="w"> </span><span class="nf">clean_old_values</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">130</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove values outside retention window.&quot;&quot;&quot;</span>
<span class="linenos">131</span>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">retention_window</span><span class="p">:</span>
<span class="linenos">132</span>            <span class="k">return</span>
<span class="linenos">133</span>
<span class="linenos">134</span>        <span class="n">cutoff_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">retention_window</span>
<span class="linenos">135</span>
<span class="linenos">136</span>        <span class="c1"># Remove old values</span>
<span class="linenos">137</span>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&lt;</span> <span class="n">cutoff_time</span><span class="p">:</span>
<span class="linenos">138</span>            <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
<span class="linenos">139</span>
<span class="linenos">140</span>    <span class="k">def</span><span class="w"> </span><span class="nf">get_histogram_buckets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="linenos">141</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get histogram distribution of values.&quot;&quot;&quot;</span>
<span class="linenos">142</span>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
<span class="linenos">143</span>            <span class="k">return</span> <span class="p">{}</span>
<span class="linenos">144</span>
<span class="linenos">145</span>        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
<span class="linenos">146</span>        <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
<span class="linenos">147</span>
<span class="linenos">148</span>        <span class="k">if</span> <span class="n">min_val</span> <span class="o">==</span> <span class="n">max_val</span><span class="p">:</span>
<span class="linenos">149</span>            <span class="k">return</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">min_val</span><span class="p">):</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)}</span>
<span class="linenos">150</span>
<span class="linenos">151</span>        <span class="n">bucket_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_val</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">/</span> <span class="n">bucket_count</span>
<span class="linenos">152</span>        <span class="n">buckets</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="linenos">153</span>
<span class="linenos">154</span>        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
<span class="linenos">155</span>            <span class="n">bucket_index</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">value</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">/</span> <span class="n">bucket_size</span><span class="p">),</span> <span class="n">bucket_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">156</span>            <span class="n">bucket_start</span> <span class="o">=</span> <span class="n">min_val</span> <span class="o">+</span> <span class="n">bucket_index</span> <span class="o">*</span> <span class="n">bucket_size</span>
<span class="linenos">157</span>            <span class="n">bucket_end</span> <span class="o">=</span> <span class="n">bucket_start</span> <span class="o">+</span> <span class="n">bucket_size</span>
<span class="linenos">158</span>            <span class="n">bucket_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bucket_start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">bucket_end</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">159</span>            <span class="n">buckets</span><span class="p">[</span><span class="n">bucket_key</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="linenos">160</span>
<span class="linenos">161</span>        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">buckets</span><span class="p">)</span>
<span class="linenos">162</span>
<span class="linenos">163</span>    <span class="nd">@staticmethod</span>
<span class="linenos">164</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_percentile</span><span class="p">(</span><span class="n">values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">percentile</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="linenos">165</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate percentile of values.&quot;&quot;&quot;</span>
<span class="linenos">166</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">values</span><span class="p">:</span>
<span class="linenos">167</span>            <span class="k">return</span> <span class="mf">0.0</span>
<span class="linenos">168</span>
<span class="linenos">169</span>        <span class="n">sorted_values</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
<span class="linenos">170</span>        <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">percentile</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_values</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
<span class="linenos">171</span>        <span class="k">return</span> <span class="n">sorted_values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="methods-7">
<h4>Methods (7)<a class="headerlink" href="#methods-7" title="Link to this heading">¶</a></h4>
<section id="add-value-self-value-tags-metadata">
<h5><code class="docutils literal notranslate"><span class="pre">add_value(self,</span> <span class="pre">value,</span> <span class="pre">tags,</span> <span class="pre">metadata)</span></code><a class="headerlink" href="#add-value-self-value-tags-metadata" title="Link to this heading">¶</a></h5>
<p>Add new value to metric.</p>
<p><a class="reference internal" href="#method-metric-add_value"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="get-current-value-self">
<h5><code class="docutils literal notranslate"><span class="pre">get_current_value(self)</span></code><a class="headerlink" href="#get-current-value-self" title="Link to this heading">¶</a></h5>
<p>Get current metric value.</p>
<p><a class="reference internal" href="#method-metric-get_current_value"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="get-aggregated-value-self-aggregation-window-seconds">
<h5><code class="docutils literal notranslate"><span class="pre">get_aggregated_value(self,</span> <span class="pre">aggregation,</span> <span class="pre">window_seconds)</span></code><a class="headerlink" href="#get-aggregated-value-self-aggregation-window-seconds" title="Link to this heading">¶</a></h5>
<p>Get aggregated value over specified window.</p>
<p><a class="reference internal" href="#method-metric-get_aggregated_value"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="get-rate-self-window-seconds">
<h5><code class="docutils literal notranslate"><span class="pre">get_rate(self,</span> <span class="pre">window_seconds)</span></code><a class="headerlink" href="#get-rate-self-window-seconds" title="Link to this heading">¶</a></h5>
<p>Calculate rate of change over time window.</p>
<p><a class="reference internal" href="#method-metric-get_rate"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="clean-old-values-self">
<h5><code class="docutils literal notranslate"><span class="pre">clean_old_values(self)</span></code><a class="headerlink" href="#clean-old-values-self" title="Link to this heading">¶</a></h5>
<p>Remove values outside retention window.</p>
<p><a class="reference internal" href="#method-metric-clean_old_values"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="get-histogram-buckets-self-bucket-count">
<h5><code class="docutils literal notranslate"><span class="pre">get_histogram_buckets(self,</span> <span class="pre">bucket_count)</span></code><a class="headerlink" href="#get-histogram-buckets-self-bucket-count" title="Link to this heading">¶</a></h5>
<p>Get histogram distribution of values.</p>
<p><a class="reference internal" href="#method-metric-get_histogram_buckets"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="percentile-values-percentile">
<h5><code class="docutils literal notranslate"><span class="pre">_percentile(values,</span> <span class="pre">percentile)</span></code><a class="headerlink" href="#percentile-values-percentile" title="Link to this heading">¶</a></h5>
<p>Calculate percentile of values.</p>
<p><a class="reference internal" href="#method-metric-_percentile"><span class="xref myst">View full source →</span></a></p>
</section>
</section>
</section>
<hr class="docutils" />
<section id="metricscollector">
<h3><code class="docutils literal notranslate"><span class="pre">MetricsCollector</span></code><a class="headerlink" href="#metricscollector" title="Link to this heading">¶</a></h3>
<p>Main metrics collection and management system.</p>
<section id="id4">
<h4>Source Code<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="k">class</span><span class="w"> </span><span class="nc">MetricsCollector</span><span class="p">:</span>
<span class="linenos">  2</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Main metrics collection and management system.&quot;&quot;&quot;</span>
<span class="linenos">  3</span>
<span class="linenos">  4</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retention_window</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3600.0</span><span class="p">):</span>
<span class="linenos">  5</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">  6</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_retention_window</span> <span class="o">=</span> <span class="n">retention_window</span>
<span class="linenos">  7</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
<span class="linenos">  8</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_collectors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">  9</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_interval</span> <span class="o">=</span> <span class="mf">300.0</span>  <span class="c1"># 5 minutes</span>
<span class="linenos"> 10</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_last_cleanup</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="linenos"> 11</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;metrics_collector&quot;</span><span class="p">)</span>
<span class="linenos"> 12</span>
<span class="linenos"> 13</span>    <span class="k">def</span><span class="w"> </span><span class="nf">create_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metric_type</span><span class="p">:</span> <span class="n">MetricType</span><span class="p">,</span>
<span class="linenos"> 14</span>                     <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="linenos"> 15</span>                     <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Metric</span><span class="p">:</span>
<span class="linenos"> 16</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create new metric.&quot;&quot;&quot;</span>
<span class="linenos"> 17</span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="linenos"> 18</span>            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">:</span>
<span class="linenos"> 19</span>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<span class="linenos"> 20</span>
<span class="linenos"> 21</span>            <span class="n">metric</span> <span class="o">=</span> <span class="n">Metric</span><span class="p">(</span>
<span class="linenos"> 22</span>                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="linenos"> 23</span>                <span class="n">metric_type</span><span class="o">=</span><span class="n">metric_type</span><span class="p">,</span>
<span class="linenos"> 24</span>                <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
<span class="linenos"> 25</span>                <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span>
<span class="linenos"> 26</span>                <span class="n">tags</span><span class="o">=</span><span class="n">tags</span> <span class="ow">or</span> <span class="p">{},</span>
<span class="linenos"> 27</span>                <span class="n">retention_window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_retention_window</span>
<span class="linenos"> 28</span>            <span class="p">)</span>
<span class="linenos"> 29</span>
<span class="linenos"> 30</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span>
<span class="linenos"> 31</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created metric: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">metric_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="linenos"> 32</span>            <span class="k">return</span> <span class="n">metric</span>
<span class="linenos"> 33</span>
<span class="linenos"> 34</span>    <span class="k">def</span><span class="w"> </span><span class="nf">get_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Metric</span><span class="p">]:</span>
<span class="linenos"> 35</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get metric by name.&quot;&quot;&quot;</span>
<span class="linenos"> 36</span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="linenos"> 37</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="linenos"> 38</span>
<span class="linenos"> 39</span>    <span class="k">def</span><span class="w"> </span><span class="nf">increment_counter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos"> 40</span>                         <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 41</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Increment counter metric.&quot;&quot;&quot;</span>
<span class="linenos"> 42</span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="linenos"> 43</span>            <span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create_metric</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">COUNTER</span><span class="p">)</span>
<span class="linenos"> 44</span>            <span class="n">metric</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="linenos"> 45</span>
<span class="linenos"> 46</span>    <span class="k">def</span><span class="w"> </span><span class="nf">set_gauge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
<span class="linenos"> 47</span>                  <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 48</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set gauge metric value.&quot;&quot;&quot;</span>
<span class="linenos"> 49</span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="linenos"> 50</span>            <span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create_metric</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">GAUGE</span><span class="p">)</span>
<span class="linenos"> 51</span>            <span class="n">metric</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="linenos"> 52</span>
<span class="linenos"> 53</span>    <span class="k">def</span><span class="w"> </span><span class="nf">record_histogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
<span class="linenos"> 54</span>                        <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 55</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Record histogram value.&quot;&quot;&quot;</span>
<span class="linenos"> 56</span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="linenos"> 57</span>            <span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create_metric</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">HISTOGRAM</span><span class="p">)</span>
<span class="linenos"> 58</span>            <span class="n">metric</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="linenos"> 59</span>
<span class="linenos"> 60</span>    <span class="k">def</span><span class="w"> </span><span class="nf">record_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">duration</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="linenos"> 61</span>                    <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 62</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Record timer duration.&quot;&quot;&quot;</span>
<span class="linenos"> 63</span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="linenos"> 64</span>            <span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create_metric</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">TIMER</span><span class="p">)</span>
<span class="linenos"> 65</span>            <span class="n">metric</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="linenos"> 66</span>
<span class="linenos"> 67</span>    <span class="k">def</span><span class="w"> </span><span class="nf">record_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="linenos"> 68</span>                   <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 69</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Record rate metric.&quot;&quot;&quot;</span>
<span class="linenos"> 70</span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="linenos"> 71</span>            <span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create_metric</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">RATE</span><span class="p">)</span>
<span class="linenos"> 72</span>            <span class="n">metric</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="linenos"> 73</span>
<span class="linenos"> 74</span>    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Metric</span><span class="p">]:</span>
<span class="linenos"> 75</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all metrics.&quot;&quot;&quot;</span>
<span class="linenos"> 76</span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="linenos"> 77</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_if_needed</span><span class="p">()</span>
<span class="linenos"> 78</span>            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">)</span>
<span class="linenos"> 79</span>
<span class="linenos"> 80</span>    <span class="k">def</span><span class="w"> </span><span class="nf">get_metrics_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="linenos"> 81</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get summary of all metrics.&quot;&quot;&quot;</span>
<span class="linenos"> 82</span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="linenos"> 83</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_if_needed</span><span class="p">()</span>
<span class="linenos"> 84</span>            <span class="n">summary</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 85</span>
<span class="linenos"> 86</span>            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos"> 87</span>                <span class="n">summary</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 88</span>                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="o">.</span><span class="n">metric_type</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<span class="linenos"> 89</span>                    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
<span class="linenos"> 90</span>                    <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span>
<span class="linenos"> 91</span>                    <span class="s1">&#39;current_value&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="o">.</span><span class="n">get_current_value</span><span class="p">(),</span>
<span class="linenos"> 92</span>                    <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="o">.</span><span class="n">count</span><span class="p">,</span>
<span class="linenos"> 93</span>                    <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="o">.</span><span class="n">min_value</span><span class="p">,</span>
<span class="linenos"> 94</span>                    <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="o">.</span><span class="n">max_value</span><span class="p">,</span>
<span class="linenos"> 95</span>                    <span class="s1">&#39;avg&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="o">.</span><span class="n">get_aggregated_value</span><span class="p">(</span><span class="n">AggregationType</span><span class="o">.</span><span class="n">AVERAGE</span><span class="p">),</span>
<span class="linenos"> 96</span>                    <span class="s1">&#39;last_updated&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="o">.</span><span class="n">last_updated</span><span class="p">,</span>
<span class="linenos"> 97</span>                    <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="o">.</span><span class="n">tags</span>
<span class="linenos"> 98</span>                <span class="p">}</span>
<span class="linenos"> 99</span>
<span class="linenos">100</span>            <span class="k">return</span> <span class="n">summary</span>
<span class="linenos">101</span>
<span class="linenos">102</span>    <span class="k">def</span><span class="w"> </span><span class="nf">add_collector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collector</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">103</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add metrics collector function.&quot;&quot;&quot;</span>
<span class="linenos">104</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_collectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collector</span><span class="p">)</span>
<span class="linenos">105</span>
<span class="linenos">106</span>    <span class="k">def</span><span class="w"> </span><span class="nf">collect_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">107</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run all registered collectors.&quot;&quot;&quot;</span>
<span class="linenos">108</span>        <span class="k">for</span> <span class="n">collector</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collectors</span><span class="p">:</span>
<span class="linenos">109</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">110</span>                <span class="n">metrics_data</span> <span class="o">=</span> <span class="n">collector</span><span class="p">()</span>
<span class="linenos">111</span>                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">112</span>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos">113</span>                        <span class="n">metric_type</span> <span class="o">=</span> <span class="n">MetricType</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;gauge&#39;</span><span class="p">))</span>
<span class="linenos">114</span>                        <span class="n">metric_value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">115</span>                        <span class="n">tags</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="p">{})</span>
<span class="linenos">116</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">_record_metric_value</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">metric_type</span><span class="p">,</span> <span class="n">metric_value</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="linenos">117</span>                    <span class="k">else</span><span class="p">:</span>
<span class="linenos">118</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">set_gauge</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<span class="linenos">119</span>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">120</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in metrics collector: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">121</span>
<span class="linenos">122</span>    <span class="k">def</span><span class="w"> </span><span class="nf">export_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;prometheus&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="linenos">123</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Export metrics in specified format.&quot;&quot;&quot;</span>
<span class="linenos">124</span>        <span class="k">if</span> <span class="n">format_type</span> <span class="o">==</span> <span class="s2">&quot;prometheus&quot;</span><span class="p">:</span>
<span class="linenos">125</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_export_prometheus_format</span><span class="p">()</span>
<span class="linenos">126</span>        <span class="k">elif</span> <span class="n">format_type</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
<span class="linenos">127</span>            <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="linenos">128</span>            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_metrics_summary</span><span class="p">(),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">129</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">130</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported export format: </span><span class="si">{</span><span class="n">format_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">131</span>
<span class="linenos">132</span>    <span class="k">def</span><span class="w"> </span><span class="nf">reset_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos">133</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset metric values.&quot;&quot;&quot;</span>
<span class="linenos">134</span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="linenos">135</span>            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">:</span>
<span class="linenos">136</span>                <span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<span class="linenos">137</span>                <span class="n">metric</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<span class="linenos">138</span>                <span class="n">metric</span><span class="o">.</span><span class="n">current_value</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">139</span>                <span class="n">metric</span><span class="o">.</span><span class="n">total_value</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos">140</span>                <span class="n">metric</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">141</span>                <span class="n">metric</span><span class="o">.</span><span class="n">min_value</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">142</span>                <span class="n">metric</span><span class="o">.</span><span class="n">max_value</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">143</span>                <span class="k">return</span> <span class="kc">True</span>
<span class="linenos">144</span>            <span class="k">return</span> <span class="kc">False</span>
<span class="linenos">145</span>
<span class="linenos">146</span>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos">147</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete metric.&quot;&quot;&quot;</span>
<span class="linenos">148</span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="linenos">149</span>            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">:</span>
<span class="linenos">150</span>                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<span class="linenos">151</span>                <span class="k">return</span> <span class="kc">True</span>
<span class="linenos">152</span>            <span class="k">return</span> <span class="kc">False</span>
<span class="linenos">153</span>
<span class="linenos">154</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_or_create_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metric_type</span><span class="p">:</span> <span class="n">MetricType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Metric</span><span class="p">:</span>
<span class="linenos">155</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get existing metric or create new one.&quot;&quot;&quot;</span>
<span class="linenos">156</span>        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">:</span>
<span class="linenos">157</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_metric</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">metric_type</span><span class="p">)</span>
<span class="linenos">158</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<span class="linenos">159</span>
<span class="linenos">160</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_record_metric_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metric_type</span><span class="p">:</span> <span class="n">MetricType</span><span class="p">,</span>
<span class="linenos">161</span>                           <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">162</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Record metric value with appropriate method.&quot;&quot;&quot;</span>
<span class="linenos">163</span>        <span class="k">if</span> <span class="n">metric_type</span> <span class="o">==</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">COUNTER</span><span class="p">:</span>
<span class="linenos">164</span>            <span class="bp">self</span><span class="o">.</span><span class="n">increment_counter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="linenos">165</span>        <span class="k">elif</span> <span class="n">metric_type</span> <span class="o">==</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">GAUGE</span><span class="p">:</span>
<span class="linenos">166</span>            <span class="bp">self</span><span class="o">.</span><span class="n">set_gauge</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="linenos">167</span>        <span class="k">elif</span> <span class="n">metric_type</span> <span class="o">==</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">HISTOGRAM</span><span class="p">:</span>
<span class="linenos">168</span>            <span class="bp">self</span><span class="o">.</span><span class="n">record_histogram</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="linenos">169</span>        <span class="k">elif</span> <span class="n">metric_type</span> <span class="o">==</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">TIMER</span><span class="p">:</span>
<span class="linenos">170</span>            <span class="bp">self</span><span class="o">.</span><span class="n">record_timer</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="linenos">171</span>        <span class="k">elif</span> <span class="n">metric_type</span> <span class="o">==</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">RATE</span><span class="p">:</span>
<span class="linenos">172</span>            <span class="bp">self</span><span class="o">.</span><span class="n">record_rate</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="linenos">173</span>
<span class="linenos">174</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_cleanup_if_needed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">175</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up old metric values if needed.&quot;&quot;&quot;</span>
<span class="linenos">176</span>        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="linenos">177</span>        <span class="k">if</span> <span class="n">current_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_cleanup</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_interval</span><span class="p">:</span>
<span class="linenos">178</span>            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<span class="linenos">179</span>                <span class="n">metric</span><span class="o">.</span><span class="n">clean_old_values</span><span class="p">()</span>
<span class="linenos">180</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_last_cleanup</span> <span class="o">=</span> <span class="n">current_time</span>
<span class="linenos">181</span>
<span class="linenos">182</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_export_prometheus_format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="linenos">183</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Export metrics in Prometheus format.&quot;&quot;&quot;</span>
<span class="linenos">184</span>        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">185</span>
<span class="linenos">186</span>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">187</span>            <span class="c1"># Add metric help</span>
<span class="linenos">188</span>            <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>
<span class="linenos">189</span>                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# HELP </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">metric</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">190</span>
<span class="linenos">191</span>            <span class="c1"># Add metric type</span>
<span class="linenos">192</span>            <span class="n">prom_type</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">193</span>                <span class="n">MetricType</span><span class="o">.</span><span class="n">COUNTER</span><span class="p">:</span> <span class="s2">&quot;counter&quot;</span><span class="p">,</span>
<span class="linenos">194</span>                <span class="n">MetricType</span><span class="o">.</span><span class="n">GAUGE</span><span class="p">:</span> <span class="s2">&quot;gauge&quot;</span><span class="p">,</span>
<span class="linenos">195</span>                <span class="n">MetricType</span><span class="o">.</span><span class="n">HISTOGRAM</span><span class="p">:</span> <span class="s2">&quot;histogram&quot;</span><span class="p">,</span>
<span class="linenos">196</span>                <span class="n">MetricType</span><span class="o">.</span><span class="n">SUMMARY</span><span class="p">:</span> <span class="s2">&quot;summary&quot;</span><span class="p">,</span>
<span class="linenos">197</span>                <span class="n">MetricType</span><span class="o">.</span><span class="n">TIMER</span><span class="p">:</span> <span class="s2">&quot;histogram&quot;</span><span class="p">,</span>
<span class="linenos">198</span>                <span class="n">MetricType</span><span class="o">.</span><span class="n">RATE</span><span class="p">:</span> <span class="s2">&quot;gauge&quot;</span>
<span class="linenos">199</span>            <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric</span><span class="o">.</span><span class="n">metric_type</span><span class="p">,</span> <span class="s2">&quot;gauge&quot;</span><span class="p">)</span>
<span class="linenos">200</span>
<span class="linenos">201</span>            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# TYPE </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">prom_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">202</span>
<span class="linenos">203</span>            <span class="c1"># Add current value</span>
<span class="linenos">204</span>            <span class="n">current_value</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">get_current_value</span><span class="p">()</span>
<span class="linenos">205</span>            <span class="k">if</span> <span class="n">current_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">206</span>                <span class="n">tags_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="linenos">207</span>                <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
<span class="linenos">208</span>                    <span class="n">tag_pairs</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">=&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metric</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
<span class="linenos">209</span>                    <span class="n">tags_str</span> <span class="o">=</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tag_pairs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
<span class="linenos">210</span>
<span class="linenos">211</span>                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">tags_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">current_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">212</span>
<span class="linenos">213</span>        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="methods-19">
<h4>Methods (19)<a class="headerlink" href="#methods-19" title="Link to this heading">¶</a></h4>
<section id="init-self-retention-window">
<h5><code class="docutils literal notranslate"><span class="pre">__init__(self,</span> <span class="pre">retention_window)</span></code><a class="headerlink" href="#init-self-retention-window" title="Link to this heading">¶</a></h5>
<p><a class="reference internal" href="#method-metricscollector-__init__"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="create-metric-self-name-metric-type-description-unit-tags">
<h5><code class="docutils literal notranslate"><span class="pre">create_metric(self,</span> <span class="pre">name,</span> <span class="pre">metric_type,</span> <span class="pre">description,</span> <span class="pre">unit,</span> <span class="pre">tags)</span></code><a class="headerlink" href="#create-metric-self-name-metric-type-description-unit-tags" title="Link to this heading">¶</a></h5>
<p>Create new metric.</p>
<p><a class="reference internal" href="#method-metricscollector-create_metric"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="get-metric-self-name">
<h5><code class="docutils literal notranslate"><span class="pre">get_metric(self,</span> <span class="pre">name)</span></code><a class="headerlink" href="#get-metric-self-name" title="Link to this heading">¶</a></h5>
<p>Get metric by name.</p>
<p><a class="reference internal" href="#method-metricscollector-get_metric"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="increment-counter-self-name-value-tags">
<h5><code class="docutils literal notranslate"><span class="pre">increment_counter(self,</span> <span class="pre">name,</span> <span class="pre">value,</span> <span class="pre">tags)</span></code><a class="headerlink" href="#increment-counter-self-name-value-tags" title="Link to this heading">¶</a></h5>
<p>Increment counter metric.</p>
<p><a class="reference internal" href="#method-metricscollector-increment_counter"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="set-gauge-self-name-value-tags">
<h5><code class="docutils literal notranslate"><span class="pre">set_gauge(self,</span> <span class="pre">name,</span> <span class="pre">value,</span> <span class="pre">tags)</span></code><a class="headerlink" href="#set-gauge-self-name-value-tags" title="Link to this heading">¶</a></h5>
<p>Set gauge metric value.</p>
<p><a class="reference internal" href="#method-metricscollector-set_gauge"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="record-histogram-self-name-value-tags">
<h5><code class="docutils literal notranslate"><span class="pre">record_histogram(self,</span> <span class="pre">name,</span> <span class="pre">value,</span> <span class="pre">tags)</span></code><a class="headerlink" href="#record-histogram-self-name-value-tags" title="Link to this heading">¶</a></h5>
<p>Record histogram value.</p>
<p><a class="reference internal" href="#method-metricscollector-record_histogram"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="record-timer-self-name-duration-tags">
<h5><code class="docutils literal notranslate"><span class="pre">record_timer(self,</span> <span class="pre">name,</span> <span class="pre">duration,</span> <span class="pre">tags)</span></code><a class="headerlink" href="#record-timer-self-name-duration-tags" title="Link to this heading">¶</a></h5>
<p>Record timer duration.</p>
<p><a class="reference internal" href="#method-metricscollector-record_timer"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="record-rate-self-name-rate-tags">
<h5><code class="docutils literal notranslate"><span class="pre">record_rate(self,</span> <span class="pre">name,</span> <span class="pre">rate,</span> <span class="pre">tags)</span></code><a class="headerlink" href="#record-rate-self-name-rate-tags" title="Link to this heading">¶</a></h5>
<p>Record rate metric.</p>
<p><a class="reference internal" href="#method-metricscollector-record_rate"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="get-all-metrics-self">
<h5><code class="docutils literal notranslate"><span class="pre">get_all_metrics(self)</span></code><a class="headerlink" href="#get-all-metrics-self" title="Link to this heading">¶</a></h5>
<p>Get all metrics.</p>
<p><a class="reference internal" href="#method-metricscollector-get_all_metrics"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="get-metrics-summary-self">
<h5><code class="docutils literal notranslate"><span class="pre">get_metrics_summary(self)</span></code><a class="headerlink" href="#get-metrics-summary-self" title="Link to this heading">¶</a></h5>
<p>Get summary of all metrics.</p>
<p><a class="reference internal" href="#method-metricscollector-get_metrics_summary"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="add-collector-self-collector">
<h5><code class="docutils literal notranslate"><span class="pre">add_collector(self,</span> <span class="pre">collector)</span></code><a class="headerlink" href="#add-collector-self-collector" title="Link to this heading">¶</a></h5>
<p>Add metrics collector function.</p>
<p><a class="reference internal" href="#method-metricscollector-add_collector"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="collect-all-self">
<h5><code class="docutils literal notranslate"><span class="pre">collect_all(self)</span></code><a class="headerlink" href="#collect-all-self" title="Link to this heading">¶</a></h5>
<p>Run all registered collectors.</p>
<p><a class="reference internal" href="#method-metricscollector-collect_all"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="export-metrics-self-format-type">
<h5><code class="docutils literal notranslate"><span class="pre">export_metrics(self,</span> <span class="pre">format_type)</span></code><a class="headerlink" href="#export-metrics-self-format-type" title="Link to this heading">¶</a></h5>
<p>Export metrics in specified format.</p>
<p><a class="reference internal" href="#method-metricscollector-export_metrics"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="reset-metric-self-name">
<h5><code class="docutils literal notranslate"><span class="pre">reset_metric(self,</span> <span class="pre">name)</span></code><a class="headerlink" href="#reset-metric-self-name" title="Link to this heading">¶</a></h5>
<p>Reset metric values.</p>
<p><a class="reference internal" href="#method-metricscollector-reset_metric"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="delete-metric-self-name">
<h5><code class="docutils literal notranslate"><span class="pre">delete_metric(self,</span> <span class="pre">name)</span></code><a class="headerlink" href="#delete-metric-self-name" title="Link to this heading">¶</a></h5>
<p>Delete metric.</p>
<p><a class="reference internal" href="#method-metricscollector-delete_metric"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="get-or-create-metric-self-name-metric-type">
<h5><code class="docutils literal notranslate"><span class="pre">_get_or_create_metric(self,</span> <span class="pre">name,</span> <span class="pre">metric_type)</span></code><a class="headerlink" href="#get-or-create-metric-self-name-metric-type" title="Link to this heading">¶</a></h5>
<p>Get existing metric or create new one.</p>
<p><a class="reference internal" href="#method-metricscollector-_get_or_create_metric"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="record-metric-value-self-name-metric-type-value-tags">
<h5><code class="docutils literal notranslate"><span class="pre">_record_metric_value(self,</span> <span class="pre">name,</span> <span class="pre">metric_type,</span> <span class="pre">value,</span> <span class="pre">tags)</span></code><a class="headerlink" href="#record-metric-value-self-name-metric-type-value-tags" title="Link to this heading">¶</a></h5>
<p>Record metric value with appropriate method.</p>
<p><a class="reference internal" href="#method-metricscollector-_record_metric_value"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="cleanup-if-needed-self">
<h5><code class="docutils literal notranslate"><span class="pre">_cleanup_if_needed(self)</span></code><a class="headerlink" href="#cleanup-if-needed-self" title="Link to this heading">¶</a></h5>
<p>Clean up old metric values if needed.</p>
<p><a class="reference internal" href="#method-metricscollector-_cleanup_if_needed"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="export-prometheus-format-self">
<h5><code class="docutils literal notranslate"><span class="pre">_export_prometheus_format(self)</span></code><a class="headerlink" href="#export-prometheus-format-self" title="Link to this heading">¶</a></h5>
<p>Export metrics in Prometheus format.</p>
<p><a class="reference internal" href="#method-metricscollector-_export_prometheus_format"><span class="xref myst">View full source →</span></a></p>
</section>
</section>
</section>
<hr class="docutils" />
<section id="systemmetricscollector">
<h3><code class="docutils literal notranslate"><span class="pre">SystemMetricsCollector</span></code><a class="headerlink" href="#systemmetricscollector" title="Link to this heading">¶</a></h3>
<p>System-level metrics collector for system resources.</p>
<section id="id5">
<h4>Source Code<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">class</span><span class="w"> </span><span class="nc">SystemMetricsCollector</span><span class="p">:</span>
<span class="linenos"> 2</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;System-level metrics collector for system resources.&quot;&quot;&quot;</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collector</span><span class="p">:</span> <span class="n">MetricsCollector</span><span class="p">):</span>
<span class="linenos"> 5</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_collector</span> <span class="o">=</span> <span class="n">collector</span>
<span class="linenos"> 6</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_enabled</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 7</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_collection_interval</span> <span class="o">=</span> <span class="mf">30.0</span>  <span class="c1"># 30 seconds</span>
<span class="linenos"> 8</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_collection_task</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 9</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;system_metrics_collector&quot;</span><span class="p">)</span>
<span class="linenos">10</span>
<span class="linenos">11</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">12</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Start automatic system metrics collection.&quot;&quot;&quot;</span>
<span class="linenos">13</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection_task</span><span class="p">:</span>
<span class="linenos">14</span>            <span class="k">return</span>
<span class="linenos">15</span>
<span class="linenos">16</span>        <span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="linenos">17</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_collection_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_collection_loop</span><span class="p">())</span>
<span class="linenos">18</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Started system metrics collection&quot;</span><span class="p">)</span>
<span class="linenos">19</span>
<span class="linenos">20</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stop_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">21</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop automatic system metrics collection.&quot;&quot;&quot;</span>
<span class="linenos">22</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection_task</span><span class="p">:</span>
<span class="linenos">23</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_collection_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
<span class="linenos">24</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">25</span>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection_task</span>
<span class="linenos">26</span>            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
<span class="linenos">27</span>                <span class="k">pass</span>
<span class="linenos">28</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_collection_task</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">29</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopped system metrics collection&quot;</span><span class="p">)</span>
<span class="linenos">30</span>
<span class="linenos">31</span>    <span class="k">def</span><span class="w"> </span><span class="nf">collect_system_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="linenos">32</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Collect current system metrics.&quot;&quot;&quot;</span>
<span class="linenos">33</span>        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">34</span>
<span class="linenos">35</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">36</span>            <span class="kn">import</span><span class="w"> </span><span class="nn">psutil</span>
<span class="linenos">37</span>
<span class="linenos">38</span>            <span class="c1"># CPU metrics</span>
<span class="linenos">39</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_cpu_percent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_percent</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos">40</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_cpu_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
<span class="linenos">41</span>
<span class="linenos">42</span>            <span class="c1"># Memory metrics</span>
<span class="linenos">43</span>            <span class="n">memory</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span>
<span class="linenos">44</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_memory_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">total</span>
<span class="linenos">45</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_memory_used&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">used</span>
<span class="linenos">46</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_memory_percent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">percent</span>
<span class="linenos">47</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_memory_available&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">available</span>
<span class="linenos">48</span>
<span class="linenos">49</span>            <span class="c1"># Disk metrics</span>
<span class="linenos">50</span>            <span class="n">disk</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">disk_usage</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="linenos">51</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_disk_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">disk</span><span class="o">.</span><span class="n">total</span>
<span class="linenos">52</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_disk_used&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">disk</span><span class="o">.</span><span class="n">used</span>
<span class="linenos">53</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_disk_percent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">disk</span><span class="o">.</span><span class="n">used</span> <span class="o">/</span> <span class="n">disk</span><span class="o">.</span><span class="n">total</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<span class="linenos">54</span>
<span class="linenos">55</span>            <span class="c1"># Network metrics</span>
<span class="linenos">56</span>            <span class="n">network</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">net_io_counters</span><span class="p">()</span>
<span class="linenos">57</span>            <span class="k">if</span> <span class="n">network</span><span class="p">:</span>
<span class="linenos">58</span>                <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_network_bytes_sent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">bytes_sent</span>
<span class="linenos">59</span>                <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_network_bytes_recv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">bytes_recv</span>
<span class="linenos">60</span>                <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_network_packets_sent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">packets_sent</span>
<span class="linenos">61</span>                <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;system_network_packets_recv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">packets_recv</span>
<span class="linenos">62</span>
<span class="linenos">63</span>            <span class="c1"># Process metrics</span>
<span class="linenos">64</span>            <span class="n">process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">()</span>
<span class="linenos">65</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;process_cpu_percent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">cpu_percent</span><span class="p">()</span>
<span class="linenos">66</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;process_memory_rss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span>
<span class="linenos">67</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;process_memory_vms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">vms</span>
<span class="linenos">68</span>            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;process_num_threads&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">num_threads</span><span class="p">()</span>
<span class="linenos">69</span>
<span class="linenos">70</span>        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
<span class="linenos">71</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;psutil not available, system metrics collection disabled&quot;</span><span class="p">)</span>
<span class="linenos">72</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">73</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error collecting system metrics: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">74</span>
<span class="linenos">75</span>        <span class="k">return</span> <span class="n">metrics</span>
<span class="linenos">76</span>
<span class="linenos">77</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_collection_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">78</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Main collection loop.&quot;&quot;&quot;</span>
<span class="linenos">79</span>        <span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="linenos">80</span>
<span class="linenos">81</span>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enabled</span><span class="p">:</span>
<span class="linenos">82</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">83</span>                <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_system_metrics</span><span class="p">()</span>
<span class="linenos">84</span>
<span class="linenos">85</span>                <span class="c1"># Record all metrics</span>
<span class="linenos">86</span>                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">87</span>                    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;system_&#39;</span><span class="p">):</span>
<span class="linenos">88</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">_collector</span><span class="o">.</span><span class="n">set_gauge</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;system&#39;</span><span class="p">})</span>
<span class="linenos">89</span>                    <span class="k">elif</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;process_&#39;</span><span class="p">):</span>
<span class="linenos">90</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">_collector</span><span class="o">.</span><span class="n">set_gauge</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;process&#39;</span><span class="p">})</span>
<span class="linenos">91</span>
<span class="linenos">92</span>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_collection_interval</span><span class="p">)</span>
<span class="linenos">93</span>
<span class="linenos">94</span>            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
<span class="linenos">95</span>                <span class="k">break</span>
<span class="linenos">96</span>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">97</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in metrics collection loop: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">98</span>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_collection_interval</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="methods-5">
<h4>Methods (5)<a class="headerlink" href="#methods-5" title="Link to this heading">¶</a></h4>
<section id="init-self-collector">
<h5><code class="docutils literal notranslate"><span class="pre">__init__(self,</span> <span class="pre">collector)</span></code><a class="headerlink" href="#init-self-collector" title="Link to this heading">¶</a></h5>
<p><a class="reference internal" href="#method-systemmetricscollector-__init__"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="start-collection-self">
<h5><code class="docutils literal notranslate"><span class="pre">start_collection(self)</span></code><a class="headerlink" href="#start-collection-self" title="Link to this heading">¶</a></h5>
<p>Start automatic system metrics collection.</p>
<p><a class="reference internal" href="#method-systemmetricscollector-start_collection"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="stop-collection-self">
<h5><code class="docutils literal notranslate"><span class="pre">stop_collection(self)</span></code><a class="headerlink" href="#stop-collection-self" title="Link to this heading">¶</a></h5>
<p>Stop automatic system metrics collection.</p>
<p><a class="reference internal" href="#method-systemmetricscollector-stop_collection"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="collect-system-metrics-self">
<h5><code class="docutils literal notranslate"><span class="pre">collect_system_metrics(self)</span></code><a class="headerlink" href="#collect-system-metrics-self" title="Link to this heading">¶</a></h5>
<p>Collect current system metrics.</p>
<p><a class="reference internal" href="#method-systemmetricscollector-collect_system_metrics"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="collection-loop-self">
<h5><code class="docutils literal notranslate"><span class="pre">_collection_loop(self)</span></code><a class="headerlink" href="#collection-loop-self" title="Link to this heading">¶</a></h5>
<p>Main collection loop.</p>
<p><a class="reference internal" href="#method-systemmetricscollector-_collection_loop"><span class="xref myst">View full source →</span></a></p>
</section>
</section>
</section>
<hr class="docutils" />
<section id="timercontext">
<h3><code class="docutils literal notranslate"><span class="pre">TimerContext</span></code><a class="headerlink" href="#timercontext" title="Link to this heading">¶</a></h3>
<p>Context manager for timing operations.</p>
<section id="id6">
<h4>Source Code<a class="headerlink" href="#id6" title="Link to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">class</span><span class="w"> </span><span class="nc">TimerContext</span><span class="p">:</span>
<span class="linenos"> 2</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Context manager for timing operations.&quot;&quot;&quot;</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collector</span><span class="p">:</span> <span class="n">MetricsCollector</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 5</span>                 <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 6</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_collector</span> <span class="o">=</span> <span class="n">collector</span>
<span class="linenos"> 7</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_metric_name</span> <span class="o">=</span> <span class="n">metric_name</span>
<span class="linenos"> 8</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="n">tags</span>
<span class="linenos"> 9</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">10</span>
<span class="linenos">11</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">12</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="linenos">13</span>        <span class="k">return</span> <span class="bp">self</span>
<span class="linenos">14</span>
<span class="linenos">15</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
<span class="linenos">16</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">17</span>            <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span>
<span class="linenos">18</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_collector</span><span class="o">.</span><span class="n">record_timer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metric_name</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="methods-3">
<h4>Methods (3)<a class="headerlink" href="#methods-3" title="Link to this heading">¶</a></h4>
<section id="init-self-collector-metric-name-tags">
<h5><code class="docutils literal notranslate"><span class="pre">__init__(self,</span> <span class="pre">collector,</span> <span class="pre">metric_name,</span> <span class="pre">tags)</span></code><a class="headerlink" href="#init-self-collector-metric-name-tags" title="Link to this heading">¶</a></h5>
<p><a class="reference internal" href="#method-timercontext-__init__"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="enter-self">
<h5><code class="docutils literal notranslate"><span class="pre">__enter__(self)</span></code><a class="headerlink" href="#enter-self" title="Link to this heading">¶</a></h5>
<p><a class="reference internal" href="#method-timercontext-__enter__"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="exit-self-exc-type-exc-val-exc-tb">
<h5><code class="docutils literal notranslate"><span class="pre">__exit__(self,</span> <span class="pre">exc_type,</span> <span class="pre">exc_val,</span> <span class="pre">exc_tb)</span></code><a class="headerlink" href="#exit-self-exc-type-exc-val-exc-tb" title="Link to this heading">¶</a></h5>
<p><a class="reference internal" href="#method-timercontext-__exit__"><span class="xref myst">View full source →</span></a></p>
</section>
</section>
</section>
</section>
<hr class="docutils" />
<section id="functions">
<h2>Functions<a class="headerlink" href="#functions" title="Link to this heading">¶</a></h2>
<section id="create-metric-name-metric-type-description-unit-tags">
<h3><code class="docutils literal notranslate"><span class="pre">create_metric(name,</span> <span class="pre">metric_type,</span> <span class="pre">description,</span> <span class="pre">unit,</span> <span class="pre">tags)</span></code><a class="headerlink" href="#create-metric-name-metric-type-description-unit-tags" title="Link to this heading">¶</a></h3>
<p>Create a metric instance.</p>
<section id="id7">
<h4>Source Code<a class="headerlink" href="#id7" title="Link to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">def</span><span class="w"> </span><span class="nf">create_metric</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metric_type</span><span class="p">:</span> <span class="n">MetricType</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="linenos"> 2</span>                 <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Metric</span><span class="p">:</span>
<span class="linenos"> 3</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a metric instance.&quot;&quot;&quot;</span>
<span class="linenos"> 4</span>    <span class="k">return</span> <span class="n">Metric</span><span class="p">(</span>
<span class="linenos"> 5</span>        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="linenos"> 6</span>        <span class="n">metric_type</span><span class="o">=</span><span class="n">metric_type</span><span class="p">,</span>
<span class="linenos"> 7</span>        <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
<span class="linenos"> 8</span>        <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span>
<span class="linenos"> 9</span>        <span class="n">tags</span><span class="o">=</span><span class="n">tags</span> <span class="ow">or</span> <span class="p">{}</span>
<span class="linenos">10</span>    <span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="timer-collector-metric-name-tags">
<h3><code class="docutils literal notranslate"><span class="pre">timer(collector,</span> <span class="pre">metric_name,</span> <span class="pre">tags)</span></code><a class="headerlink" href="#timer-collector-metric-name-tags" title="Link to this heading">¶</a></h3>
<p>Create timer context manager.</p>
<section id="id8">
<h4>Source Code<a class="headerlink" href="#id8" title="Link to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">def</span><span class="w"> </span><span class="nf">timer</span><span class="p">(</span><span class="n">collector</span><span class="p">:</span> <span class="n">MetricsCollector</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="linenos">2</span>          <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TimerContext</span><span class="p">:</span>
<span class="linenos">3</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create timer context manager.&quot;&quot;&quot;</span>
<span class="linenos">4</span>    <span class="k">return</span> <span class="n">TimerContext</span><span class="p">(</span><span class="n">collector</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="timed-function-collector-metric-name-tags">
<h3><code class="docutils literal notranslate"><span class="pre">timed_function(collector,</span> <span class="pre">metric_name,</span> <span class="pre">tags)</span></code><a class="headerlink" href="#timed-function-collector-metric-name-tags" title="Link to this heading">¶</a></h3>
<p>Decorator to time function execution.</p>
<section id="id9">
<h4>Source Code<a class="headerlink" href="#id9" title="Link to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">def</span><span class="w"> </span><span class="nf">timed_function</span><span class="p">(</span><span class="n">collector</span><span class="p">:</span> <span class="n">MetricsCollector</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 2</span>                  <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 3</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator to time function execution.&quot;&quot;&quot;</span>
<span class="linenos"> 4</span>    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="linenos"> 5</span>        <span class="k">nonlocal</span> <span class="n">metric_name</span>
<span class="linenos"> 6</span>        <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 7</span>            <span class="n">metric_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;function_</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">_duration&quot;</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>        <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos">10</span>            <span class="k">with</span> <span class="n">timer</span><span class="p">(</span><span class="n">collector</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
<span class="linenos">11</span>                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">12</span>        <span class="k">return</span> <span class="n">wrapper</span>
<span class="linenos">13</span>    <span class="k">return</span> <span class="n">decorator</span>
</pre></div>
</div>
</section>
</section>
</section>
<hr class="docutils" />
<section id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Link to this heading">¶</a></h2>
<p>This module imports:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">time</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">threading</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">statistics</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">abc</span> <span class="pre">import</span> <span class="pre">ABC,</span> <span class="pre">abstractmethod</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">dataclasses</span> <span class="pre">import</span> <span class="pre">dataclass,</span> <span class="pre">field</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">typing</span> <span class="pre">import</span> <span class="pre">Dict,</span> <span class="pre">List,</span> <span class="pre">Optional,</span> <span class="pre">Any,</span> <span class="pre">Union,</span> <span class="pre">Callable,</span> <span class="pre">Iterator</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">enum</span> <span class="pre">import</span> <span class="pre">Enum</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">collections</span> <span class="pre">import</span> <span class="pre">defaultdict,</span> <span class="pre">deque</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">logging</span></code></p></li>
</ul>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, Research Team
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            <div class="last-updated">
              Last updated on Oct 08, 2025</div>
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">interfaces.monitoring.metrics_collector</a><ul>
<li><a class="reference internal" href="#module-overview">Module Overview</a></li>
<li><a class="reference internal" href="#complete-source-code">Complete Source Code</a></li>
<li><a class="reference internal" href="#classes">Classes</a><ul>
<li><a class="reference internal" href="#metrictype"><code class="docutils literal notranslate"><span class="pre">MetricType</span></code></a><ul>
<li><a class="reference internal" href="#source-code">Source Code</a></li>
</ul>
</li>
<li><a class="reference internal" href="#aggregationtype"><code class="docutils literal notranslate"><span class="pre">AggregationType</span></code></a><ul>
<li><a class="reference internal" href="#id1">Source Code</a></li>
</ul>
</li>
<li><a class="reference internal" href="#metricvalue"><code class="docutils literal notranslate"><span class="pre">MetricValue</span></code></a><ul>
<li><a class="reference internal" href="#id2">Source Code</a></li>
</ul>
</li>
<li><a class="reference internal" href="#metric"><code class="docutils literal notranslate"><span class="pre">Metric</span></code></a><ul>
<li><a class="reference internal" href="#id3">Source Code</a></li>
<li><a class="reference internal" href="#methods-7">Methods (7)</a><ul>
<li><a class="reference internal" href="#add-value-self-value-tags-metadata"><code class="docutils literal notranslate"><span class="pre">add_value(self,</span> <span class="pre">value,</span> <span class="pre">tags,</span> <span class="pre">metadata)</span></code></a></li>
<li><a class="reference internal" href="#get-current-value-self"><code class="docutils literal notranslate"><span class="pre">get_current_value(self)</span></code></a></li>
<li><a class="reference internal" href="#get-aggregated-value-self-aggregation-window-seconds"><code class="docutils literal notranslate"><span class="pre">get_aggregated_value(self,</span> <span class="pre">aggregation,</span> <span class="pre">window_seconds)</span></code></a></li>
<li><a class="reference internal" href="#get-rate-self-window-seconds"><code class="docutils literal notranslate"><span class="pre">get_rate(self,</span> <span class="pre">window_seconds)</span></code></a></li>
<li><a class="reference internal" href="#clean-old-values-self"><code class="docutils literal notranslate"><span class="pre">clean_old_values(self)</span></code></a></li>
<li><a class="reference internal" href="#get-histogram-buckets-self-bucket-count"><code class="docutils literal notranslate"><span class="pre">get_histogram_buckets(self,</span> <span class="pre">bucket_count)</span></code></a></li>
<li><a class="reference internal" href="#percentile-values-percentile"><code class="docutils literal notranslate"><span class="pre">_percentile(values,</span> <span class="pre">percentile)</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#metricscollector"><code class="docutils literal notranslate"><span class="pre">MetricsCollector</span></code></a><ul>
<li><a class="reference internal" href="#id4">Source Code</a></li>
<li><a class="reference internal" href="#methods-19">Methods (19)</a><ul>
<li><a class="reference internal" href="#init-self-retention-window"><code class="docutils literal notranslate"><span class="pre">__init__(self,</span> <span class="pre">retention_window)</span></code></a></li>
<li><a class="reference internal" href="#create-metric-self-name-metric-type-description-unit-tags"><code class="docutils literal notranslate"><span class="pre">create_metric(self,</span> <span class="pre">name,</span> <span class="pre">metric_type,</span> <span class="pre">description,</span> <span class="pre">unit,</span> <span class="pre">tags)</span></code></a></li>
<li><a class="reference internal" href="#get-metric-self-name"><code class="docutils literal notranslate"><span class="pre">get_metric(self,</span> <span class="pre">name)</span></code></a></li>
<li><a class="reference internal" href="#increment-counter-self-name-value-tags"><code class="docutils literal notranslate"><span class="pre">increment_counter(self,</span> <span class="pre">name,</span> <span class="pre">value,</span> <span class="pre">tags)</span></code></a></li>
<li><a class="reference internal" href="#set-gauge-self-name-value-tags"><code class="docutils literal notranslate"><span class="pre">set_gauge(self,</span> <span class="pre">name,</span> <span class="pre">value,</span> <span class="pre">tags)</span></code></a></li>
<li><a class="reference internal" href="#record-histogram-self-name-value-tags"><code class="docutils literal notranslate"><span class="pre">record_histogram(self,</span> <span class="pre">name,</span> <span class="pre">value,</span> <span class="pre">tags)</span></code></a></li>
<li><a class="reference internal" href="#record-timer-self-name-duration-tags"><code class="docutils literal notranslate"><span class="pre">record_timer(self,</span> <span class="pre">name,</span> <span class="pre">duration,</span> <span class="pre">tags)</span></code></a></li>
<li><a class="reference internal" href="#record-rate-self-name-rate-tags"><code class="docutils literal notranslate"><span class="pre">record_rate(self,</span> <span class="pre">name,</span> <span class="pre">rate,</span> <span class="pre">tags)</span></code></a></li>
<li><a class="reference internal" href="#get-all-metrics-self"><code class="docutils literal notranslate"><span class="pre">get_all_metrics(self)</span></code></a></li>
<li><a class="reference internal" href="#get-metrics-summary-self"><code class="docutils literal notranslate"><span class="pre">get_metrics_summary(self)</span></code></a></li>
<li><a class="reference internal" href="#add-collector-self-collector"><code class="docutils literal notranslate"><span class="pre">add_collector(self,</span> <span class="pre">collector)</span></code></a></li>
<li><a class="reference internal" href="#collect-all-self"><code class="docutils literal notranslate"><span class="pre">collect_all(self)</span></code></a></li>
<li><a class="reference internal" href="#export-metrics-self-format-type"><code class="docutils literal notranslate"><span class="pre">export_metrics(self,</span> <span class="pre">format_type)</span></code></a></li>
<li><a class="reference internal" href="#reset-metric-self-name"><code class="docutils literal notranslate"><span class="pre">reset_metric(self,</span> <span class="pre">name)</span></code></a></li>
<li><a class="reference internal" href="#delete-metric-self-name"><code class="docutils literal notranslate"><span class="pre">delete_metric(self,</span> <span class="pre">name)</span></code></a></li>
<li><a class="reference internal" href="#get-or-create-metric-self-name-metric-type"><code class="docutils literal notranslate"><span class="pre">_get_or_create_metric(self,</span> <span class="pre">name,</span> <span class="pre">metric_type)</span></code></a></li>
<li><a class="reference internal" href="#record-metric-value-self-name-metric-type-value-tags"><code class="docutils literal notranslate"><span class="pre">_record_metric_value(self,</span> <span class="pre">name,</span> <span class="pre">metric_type,</span> <span class="pre">value,</span> <span class="pre">tags)</span></code></a></li>
<li><a class="reference internal" href="#cleanup-if-needed-self"><code class="docutils literal notranslate"><span class="pre">_cleanup_if_needed(self)</span></code></a></li>
<li><a class="reference internal" href="#export-prometheus-format-self"><code class="docutils literal notranslate"><span class="pre">_export_prometheus_format(self)</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#systemmetricscollector"><code class="docutils literal notranslate"><span class="pre">SystemMetricsCollector</span></code></a><ul>
<li><a class="reference internal" href="#id5">Source Code</a></li>
<li><a class="reference internal" href="#methods-5">Methods (5)</a><ul>
<li><a class="reference internal" href="#init-self-collector"><code class="docutils literal notranslate"><span class="pre">__init__(self,</span> <span class="pre">collector)</span></code></a></li>
<li><a class="reference internal" href="#start-collection-self"><code class="docutils literal notranslate"><span class="pre">start_collection(self)</span></code></a></li>
<li><a class="reference internal" href="#stop-collection-self"><code class="docutils literal notranslate"><span class="pre">stop_collection(self)</span></code></a></li>
<li><a class="reference internal" href="#collect-system-metrics-self"><code class="docutils literal notranslate"><span class="pre">collect_system_metrics(self)</span></code></a></li>
<li><a class="reference internal" href="#collection-loop-self"><code class="docutils literal notranslate"><span class="pre">_collection_loop(self)</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#timercontext"><code class="docutils literal notranslate"><span class="pre">TimerContext</span></code></a><ul>
<li><a class="reference internal" href="#id6">Source Code</a></li>
<li><a class="reference internal" href="#methods-3">Methods (3)</a><ul>
<li><a class="reference internal" href="#init-self-collector-metric-name-tags"><code class="docutils literal notranslate"><span class="pre">__init__(self,</span> <span class="pre">collector,</span> <span class="pre">metric_name,</span> <span class="pre">tags)</span></code></a></li>
<li><a class="reference internal" href="#enter-self"><code class="docutils literal notranslate"><span class="pre">__enter__(self)</span></code></a></li>
<li><a class="reference internal" href="#exit-self-exc-type-exc-val-exc-tb"><code class="docutils literal notranslate"><span class="pre">__exit__(self,</span> <span class="pre">exc_type,</span> <span class="pre">exc_val,</span> <span class="pre">exc_tb)</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#functions">Functions</a><ul>
<li><a class="reference internal" href="#create-metric-name-metric-type-description-unit-tags"><code class="docutils literal notranslate"><span class="pre">create_metric(name,</span> <span class="pre">metric_type,</span> <span class="pre">description,</span> <span class="pre">unit,</span> <span class="pre">tags)</span></code></a><ul>
<li><a class="reference internal" href="#id7">Source Code</a></li>
</ul>
</li>
<li><a class="reference internal" href="#timer-collector-metric-name-tags"><code class="docutils literal notranslate"><span class="pre">timer(collector,</span> <span class="pre">metric_name,</span> <span class="pre">tags)</span></code></a><ul>
<li><a class="reference internal" href="#id8">Source Code</a></li>
</ul>
</li>
<li><a class="reference internal" href="#timed-function-collector-metric-name-tags"><code class="docutils literal notranslate"><span class="pre">timed_function(collector,</span> <span class="pre">metric_name,</span> <span class="pre">tags)</span></code></a><ul>
<li><a class="reference internal" href="#id9">Source Code</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#dependencies">Dependencies</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=4ebf8126"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=08e7b316"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../_static/back-to-top.js?v=840797bb"></script>
    <script src="../../_static/lazy-load.js?v=dc25293c"></script>
    <script src="../../_static/dark-mode.js?v=bf328970"></script>
    </body>
</html>