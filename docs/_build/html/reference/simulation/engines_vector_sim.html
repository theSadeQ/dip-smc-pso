<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
.chartjs-container {
    margin: 1.5em auto;
    padding: 1em;
    background: #f8f9fa;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.chart-note {
    text-align: center;
    color: #6c757d;
    font-size: 0.9em;
    margin-top: 0.5em;
}
</style>
<link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <!-- Generated with Sphinx 7.4.7 and Furo 2024.08.06 -->
        <title>simulation.engines.vector_sim - DIP_SMC_PSO Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5349f25f" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=f5a89ef9" />
    
    


<style>
  body {
    --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">DIP_SMC_PSO Documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">DIP_SMC_PSO Documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">📚 Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Optimal Sliding Mode Control for a Double-Inverted Pendulum via PSO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../theory_overview.html">1. Theoretical Background â€” Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture.html">3. System Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plant_model.html">1.x Plant Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hil_quickstart.html">Hardware-in-the-Loop (HIL) Quickstart Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../streamlit_dashboard_guide.html">Streamlit Dashboard User Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">🎮 Control Systems &amp; Optimization</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../controllers/index.html">Controllers Module Documentation</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Controllers Module Documentation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/classical_smc_technical_guide.html">Classical Sliding Mode Control Technical Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/adaptive_smc_technical_guide.html">Adaptive Sliding Mode Control Technical Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/sta_smc_technical_guide.html">Super-Twisting Sliding Mode Control Technical Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/hybrid_smc_technical_guide.html">Hybrid Adaptive Super-Twisting SMC Technical Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/mpc_technical_guide.html">Model Predictive Control Technical Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/swing_up_smc_technical_guide.html">Swing-Up SMC Technical Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/swing_up_smc_technical_guide.html#example-metadata">example-metadata:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/swing_up_smc_technical_guide.html#runnable-false">runnable: false</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/factory_system_guide.html">SMC Controller Factory System Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/control_primitives_reference.html">Control Primitives Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mathematical_foundations/smc_complete_theory.html">Complete Sliding Mode Control Mathematical Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mathematical_foundations/controller_comparison_theory.html">SMC Controller Comparison Theory</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../controllers/index.html">Controllers Module</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Controllers Module</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../controllers/adaptive_smc.html">controllers.adaptive_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/classic_smc.html">controllers.classic_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory.html">controllers.factory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/mpc_controller.html">controllers.mpc_controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/sta_smc.html">controllers.sta_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/swing_up_smc.html">controllers.swing_up_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/__init__.html">controllers.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/base_controller_interface.html">controllers.base.controller_interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/base_control_primitives.html">controllers.base.control_primitives</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/base___init__.html">controllers.base.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_deprecation.html">controllers.factory.deprecation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_fallback_configs.html">controllers.factory.fallback_configs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_legacy_factory.html">controllers.factory.legacy_factory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_optimization.html">controllers.factory.optimization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_pso_integration.html">controllers.factory.pso_integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_smc_factory.html">controllers.factory.smc_factory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_thread_safety.html">controllers.factory.thread_safety</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory___init__.html">controllers.factory.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/mpc_mpc_controller.html">controllers.mpc.mpc_controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/mpc___init__.html">controllers.mpc.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_adaptive_smc.html">controllers.smc.adaptive_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_classic_smc.html">controllers.smc.classic_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_hybrid_adaptive_sta_smc.html">controllers.smc.hybrid_adaptive_sta_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_sta_smc.html">controllers.smc.sta_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc___init__.html">controllers.smc.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/specialized_swing_up_smc.html">controllers.specialized.swing_up_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/specialized___init__.html">controllers.specialized.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_core_protocols.html">controllers.factory.core.protocols</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_core_registry.html">controllers.factory.core.registry</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_core_threading.html">controllers.factory.core.threading</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_core_validation.html">controllers.factory.core.validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_core___init__.html">controllers.factory.core.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms___init__.html">controllers.smc.algorithms.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_core_equivalent_control.html">controllers.smc.core.equivalent_control</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_core_gain_validation.html">controllers.smc.core.gain_validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_core_sliding_surface.html">controllers.smc.core.sliding_surface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_core_switching_functions.html">controllers.smc.core.switching_functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_core___init__.html">controllers.smc.core.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_adaptive_adaptation_law.html">controllers.smc.algorithms.adaptive.adaptation_law</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_adaptive_config.html">controllers.smc.algorithms.adaptive.config</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_adaptive_controller.html">controllers.smc.algorithms.adaptive.controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_adaptive_parameter_estimation.html">controllers.smc.algorithms.adaptive.parameter_estimation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_adaptive___init__.html">controllers.smc.algorithms.adaptive.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_classical_boundary_layer.html">controllers.smc.algorithms.classical.boundary_layer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_classical_config.html">controllers.smc.algorithms.classical.config</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_classical_controller.html">controllers.smc.algorithms.classical.controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_classical___init__.html">controllers.smc.algorithms.classical.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_hybrid_config.html">controllers.smc.algorithms.hybrid.config</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_hybrid_controller.html">controllers.smc.algorithms.hybrid.controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_hybrid_switching_logic.html">controllers.smc.algorithms.hybrid.switching_logic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_hybrid___init__.html">controllers.smc.algorithms.hybrid.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_super_twisting_config.html">controllers.smc.algorithms.super_twisting.config</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_super_twisting_controller.html">controllers.smc.algorithms.super_twisting.controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_super_twisting_twisting_algorithm.html">controllers.smc.algorithms.super_twisting.twisting_algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_super_twisting___init__.html">controllers.smc.algorithms.super_twisting.<strong>init</strong></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../mathematical_foundations/index.html">Mathematical Foundations</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Mathematical Foundations</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../mathematical_foundations/smc_complete_theory.html">Complete Sliding Mode Control Mathematical Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mathematical_foundations/controller_comparison_theory.html">SMC Controller Comparison Theory</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../plant/models_guide.html">Plant Models Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../optimization_simulation/guide.html">Optimization &amp; Simulation Guide</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../controllers/index.html">Controllers Module</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of Controllers Module</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../controllers/adaptive_smc.html">controllers.adaptive_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/classic_smc.html">controllers.classic_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory.html">controllers.factory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/mpc_controller.html">controllers.mpc_controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/sta_smc.html">controllers.sta_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/swing_up_smc.html">controllers.swing_up_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/__init__.html">controllers.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/base_controller_interface.html">controllers.base.controller_interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/base_control_primitives.html">controllers.base.control_primitives</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/base___init__.html">controllers.base.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_deprecation.html">controllers.factory.deprecation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_fallback_configs.html">controllers.factory.fallback_configs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_legacy_factory.html">controllers.factory.legacy_factory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_optimization.html">controllers.factory.optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_pso_integration.html">controllers.factory.pso_integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_smc_factory.html">controllers.factory.smc_factory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_thread_safety.html">controllers.factory.thread_safety</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory___init__.html">controllers.factory.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/mpc_mpc_controller.html">controllers.mpc.mpc_controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/mpc___init__.html">controllers.mpc.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_adaptive_smc.html">controllers.smc.adaptive_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_classic_smc.html">controllers.smc.classic_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_hybrid_adaptive_sta_smc.html">controllers.smc.hybrid_adaptive_sta_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_sta_smc.html">controllers.smc.sta_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc___init__.html">controllers.smc.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/specialized_swing_up_smc.html">controllers.specialized.swing_up_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/specialized___init__.html">controllers.specialized.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_core_protocols.html">controllers.factory.core.protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_core_registry.html">controllers.factory.core.registry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_core_threading.html">controllers.factory.core.threading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_core_validation.html">controllers.factory.core.validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_core___init__.html">controllers.factory.core.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms___init__.html">controllers.smc.algorithms.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_core_equivalent_control.html">controllers.smc.core.equivalent_control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_core_gain_validation.html">controllers.smc.core.gain_validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_core_sliding_surface.html">controllers.smc.core.sliding_surface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_core_switching_functions.html">controllers.smc.core.switching_functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_core___init__.html">controllers.smc.core.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_adaptive_adaptation_law.html">controllers.smc.algorithms.adaptive.adaptation_law</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_adaptive_config.html">controllers.smc.algorithms.adaptive.config</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_adaptive_controller.html">controllers.smc.algorithms.adaptive.controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_adaptive_parameter_estimation.html">controllers.smc.algorithms.adaptive.parameter_estimation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_adaptive___init__.html">controllers.smc.algorithms.adaptive.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_classical_boundary_layer.html">controllers.smc.algorithms.classical.boundary_layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_classical_config.html">controllers.smc.algorithms.classical.config</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_classical_controller.html">controllers.smc.algorithms.classical.controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_classical___init__.html">controllers.smc.algorithms.classical.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_hybrid_config.html">controllers.smc.algorithms.hybrid.config</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_hybrid_controller.html">controllers.smc.algorithms.hybrid.controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_hybrid_switching_logic.html">controllers.smc.algorithms.hybrid.switching_logic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_hybrid___init__.html">controllers.smc.algorithms.hybrid.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_super_twisting_config.html">controllers.smc.algorithms.super_twisting.config</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_super_twisting_controller.html">controllers.smc.algorithms.super_twisting.controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_super_twisting_twisting_algorithm.html">controllers.smc.algorithms.super_twisting.twisting_algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_super_twisting___init__.html">controllers.smc.algorithms.super_twisting.<strong>init</strong></a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../optimizer/index.html">Optimizer Module</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Optimizer Module</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../optimizer/pso_optimizer.html">optimizer.pso_optimizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../optimizer/__init__.html">optimizer.<strong>init</strong></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../analysis_plan.html">5. Analysis &amp; Verification Plan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../benchmarks_methodology.html">Benchmarks &amp; Methodology</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">🧪 Development &amp; Testing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../TESTING.html">Testing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../test_protocols.html">5.x Test Protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../use_cases.html">4. Use Cases &amp; Operating Modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../context.html">2. Application Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault_detection_guide.html">Fault Detection &amp; Isolation (FDI) Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">📊 Research &amp; Theory</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../presentation/index.html">Research Presentation Materials</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Research Presentation Materials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html">Abstract</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#introduction-and-motivation">Introduction and Motivation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#the-double-inverted-pendulum-as-a-canonical-control-problem">The Double Inverted Pendulum as a Canonical Control Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#the-primary-control-objectives-and-challenges">The Primary Control Objectives and Challenges</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#sliding-mode-control-as-a-robust-solution">Sliding Mode Control as a Robust Solution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#the-gain-tuning-dilemma-and-the-need-for-optimization">The Gain Tuning Dilemma and the Need for Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#particle-swarm-optimization-for-automated-design">Particle Swarm Optimization for Automated Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#synthesis-and-motivation">Synthesis and Motivation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#references">References</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/problem-statement.html">Problem Statement for Double‑Inverted Pendulum (DIP) Control with SMC and PSO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/previous-works.html">Previous Work Before the Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/system-modeling.html"><strong>A Comprehensive Technical Report on the Modeling and Configuration of a Cart‑Based Double Inverted Pendulum System</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/smc-theory.html">Sliding Mode Control for a Double‑Inverted Pendulum: Bridging Theory and Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html">Abstract</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#introduction">1 Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#system-modelling-and-problem-formulation">2 System Modelling and Problem Formulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#simulation-methodology">3 Simulation Methodology</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#classic-sliding-mode-control">4 Classic Sliding Mode Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-i-boundary-layer-method">5 Chattering Mitigation Strategy I: Boundary Layer Method</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-ii-supertwisting-algorithm">6 Chattering Mitigation Strategy II: Super‑Twisting Algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-iii-adaptive-sliding-mode-control">7 Chattering Mitigation Strategy III: Adaptive Sliding Mode Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-iv-hybrid-adaptivesta">8 Chattering Mitigation Strategy IV: Hybrid Adaptive–STA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#synthesis-and-comparative-analysis">9 Synthesis and Comparative Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#references">References</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/pso-optimization.html"><strong>Comprehensive Simulation Analysis and Enhancements for the Double Inverted Pendulum Control System</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/simulation-setup.html">Particle Swarm Optimization for Sliding‑Mode Controller Tuning of a Double Inverted Pendulum</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/results-discussion.html">8 – Results and Discussion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/results-discussion.html#references">References</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html">Abstract</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#introduction-and-motivation">Introduction and Motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#the-double-inverted-pendulum-as-a-canonical-control-problem">The Double Inverted Pendulum as a Canonical Control Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#the-primary-control-objectives-and-challenges">The Primary Control Objectives and Challenges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#sliding-mode-control-as-a-robust-solution">Sliding Mode Control as a Robust Solution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#the-gain-tuning-dilemma-and-the-need-for-optimization">The Gain Tuning Dilemma and the Need for Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#particle-swarm-optimization-for-automated-design">Particle Swarm Optimization for Automated Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#synthesis-and-motivation">Synthesis and Motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#references">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/problem-statement.html">Problem Statement for Double‑Inverted Pendulum (DIP) Control with SMC and PSO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/previous-works.html">Previous Work Before the Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/system-modeling.html"><strong>A Comprehensive Technical Report on the Modeling and Configuration of a Cart‑Based Double Inverted Pendulum System</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/smc-theory.html">Sliding Mode Control for a Double‑Inverted Pendulum: Bridging Theory and Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html">Abstract</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#introduction">1 Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#system-modelling-and-problem-formulation">2 System Modelling and Problem Formulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#simulation-methodology">3 Simulation Methodology</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#classic-sliding-mode-control">4 Classic Sliding Mode Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-i-boundary-layer-method">5 Chattering Mitigation Strategy I: Boundary Layer Method</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-ii-supertwisting-algorithm">6 Chattering Mitigation Strategy II: Super‑Twisting Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-iii-adaptive-sliding-mode-control">7 Chattering Mitigation Strategy III: Adaptive Sliding Mode Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-iv-hybrid-adaptivesta">8 Chattering Mitigation Strategy IV: Hybrid Adaptive–STA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#synthesis-and-comparative-analysis">9 Synthesis and Comparative Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#references">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/pso-optimization.html"><strong>Comprehensive Simulation Analysis and Enhancements for the Double Inverted Pendulum Control System</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/simulation-setup.html">Particle Swarm Optimization for Sliding‑Mode Controller Tuning of a Double Inverted Pendulum</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/results-discussion.html">8 – Results and Discussion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/results-discussion.html#references">References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">📖 API Reference &amp; Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Reference Documentation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../examples/index.html">Examples</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of Examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../bibliography.html">Bibliography &amp; Academic References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">🔧 Project Management</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../CONTRIBUTING.html">Contributing – ResearchPlanSpec Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../RELEASE_CHECKLIST.html">Release Checklist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CHANGELOG.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../symbols.html">Symbols &amp; Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../results_readme.html">Results &amp; Plots</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">📚 Citations &amp; Attribution</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../CITATIONS.html">Citations &amp; Academic Attribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CITATIONS_ACADEMIC.html">Academic Theory Citations &amp; References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DEPENDENCIES.html">Software Dependencies &amp; Citations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PATTERNS.html">Software Design Patterns &amp; Architecture Attribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LICENSES.html">License Compliance &amp; Attribution</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="https://github.com/theSadeQ/DIP_SMC_PSO/blob/main/docs/reference/simulation/engines_vector_sim.md?plain=true" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div><div class="edit-this-page">
  <a class="muted-link" href="https://github.com/theSadeQ/DIP_SMC_PSO/edit/main/docs/reference/simulation/engines_vector_sim.md" title="Edit this page">
    <svg><use href="#svg-pencil"></use></svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section class="tex2jax_ignore mathjax_ignore" id="simulation-engines-vector-sim">
<h1>simulation.engines.vector_sim<a class="headerlink" href="#simulation-engines-vector-sim" title="Link to this heading">¶</a></h1>
<p><strong>Source:</strong> <code class="docutils literal notranslate"><span class="pre">src\simulation\engines\vector_sim.py</span></code></p>
<section id="module-overview">
<h2>Module Overview<a class="headerlink" href="#module-overview" title="Link to this heading">¶</a></h2>
<p>Unified simulation façade with vectorized safety guards.</p>
<p>This module provides a high‑level <code class="docutils literal notranslate"><span class="pre">simulate</span></code> function that accepts either
scalar or batched initial states and control inputs.  It dispatches the
underlying dynamics step through <code class="docutils literal notranslate"><span class="pre">src.simulation.engines.simulation_runner.step</span></code> and
invokes safety guards after each step and before returning results.  The
interface maintains shape parity between scalar and batch modes: a single
simulation returns an array of shape <code class="docutils literal notranslate"><span class="pre">(H+1,</span> <span class="pre">D)</span></code> while a batch of B
simulations returns a tensor of shape <code class="docutils literal notranslate"><span class="pre">(B,</span> <span class="pre">H+1,</span> <span class="pre">D)</span></code>.  The initial state is
always included at index <code class="docutils literal notranslate"><span class="pre">0</span></code> of the time dimension.</p>
<p>Early stopping is supported via a simple stop callback: if <code class="docutils literal notranslate"><span class="pre">stop_fn</span></code> is
provided and returns True given the current state, all remaining steps are
skipped and the output is truncated to the elapsed horizon plus one.  To
preserve uniform batch shapes, the earliest stopping time across batch
elements truncates the entire batch.</p>
</section>
<section id="complete-source-code">
<h2>Complete Source Code<a class="headerlink" href="#complete-source-code" title="Link to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="c1">#======================================================================================\\\</span>
<span class="linenos">  2</span><span class="c1">#======================== src/simulation/engines/vector_sim.py ========================\\\</span>
<span class="linenos">  3</span><span class="c1">#======================================================================================\\\</span>
<span class="linenos">  4</span>
<span class="linenos">  5</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  6</span><span class="sd">Unified simulation façade with vectorized safety guards.</span>
<span class="linenos">  7</span>
<span class="linenos">  8</span><span class="sd">This module provides a high‑level ``simulate`` function that accepts either</span>
<span class="linenos">  9</span><span class="sd">scalar or batched initial states and control inputs.  It dispatches the</span>
<span class="linenos"> 10</span><span class="sd">underlying dynamics step through ``src.simulation.engines.simulation_runner.step`` and</span>
<span class="linenos"> 11</span><span class="sd">invokes safety guards after each step and before returning results.  The</span>
<span class="linenos"> 12</span><span class="sd">interface maintains shape parity between scalar and batch modes: a single</span>
<span class="linenos"> 13</span><span class="sd">simulation returns an array of shape ``(H+1, D)`` while a batch of B</span>
<span class="linenos"> 14</span><span class="sd">simulations returns a tensor of shape ``(B, H+1, D)``.  The initial state is</span>
<span class="linenos"> 15</span><span class="sd">always included at index ``0`` of the time dimension.</span>
<span class="linenos"> 16</span>
<span class="linenos"> 17</span><span class="sd">Early stopping is supported via a simple stop callback: if ``stop_fn`` is</span>
<span class="linenos"> 18</span><span class="sd">provided and returns True given the current state, all remaining steps are</span>
<span class="linenos"> 19</span><span class="sd">skipped and the output is truncated to the elapsed horizon plus one.  To</span>
<span class="linenos"> 20</span><span class="sd">preserve uniform batch shapes, the earliest stopping time across batch</span>
<span class="linenos"> 21</span><span class="sd">elements truncates the entire batch.</span>
<span class="linenos"> 22</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 23</span>
<span class="linenos"> 24</span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
<span class="linenos"> 25</span>
<span class="linenos"> 26</span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="linenos"> 27</span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="linenos"> 28</span>
<span class="linenos"> 29</span><span class="kn">from</span><span class="w"> </span><span class="nn">.simulation_runner</span><span class="w"> </span><span class="kn">import</span> <span class="n">step</span> <span class="k">as</span> <span class="n">_step_fn</span>  <span class="c1"># dispatches on config flag</span>
<span class="linenos"> 30</span><span class="kn">from</span><span class="w"> </span><span class="nn">..context.safety_guards</span><span class="w"> </span><span class="kn">import</span> <span class="n">_guard_no_nan</span><span class="p">,</span> <span class="n">_guard_energy</span><span class="p">,</span> <span class="n">_guard_bounds</span>
<span class="linenos"> 31</span><span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterable</span>
<span class="linenos"> 32</span><span class="k">try</span><span class="p">:</span>
<span class="linenos"> 33</span>    <span class="kn">from</span><span class="w"> </span><span class="nn">src.config.schemas</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span>  <span class="c1"># type: ignore</span>
<span class="linenos"> 34</span><span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos"> 35</span>    <span class="kn">from</span><span class="w"> </span><span class="nn">types</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleNamespace</span>
<span class="linenos"> 36</span>    <span class="n">config</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">(</span><span class="n">simulation</span><span class="o">=</span><span class="n">SimpleNamespace</span><span class="p">(</span><span class="n">safety</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
<span class="linenos"> 37</span>
<span class="linenos"> 38</span>
<span class="linenos"> 39</span><span class="k">def</span><span class="w"> </span><span class="nf">simulate</span><span class="p">(</span>
<span class="linenos"> 40</span>    <span class="n">initial_state</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="linenos"> 41</span>    <span class="n">control_inputs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="linenos"> 42</span>    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="linenos"> 43</span>    <span class="n">horizon</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 44</span>    <span class="o">*</span><span class="p">,</span>
<span class="linenos"> 45</span>    <span class="n">energy_limits</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 46</span>    <span class="n">state_bounds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 47</span>    <span class="n">stop_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 48</span>    <span class="n">t0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="linenos"> 49</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="linenos"> 50</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulate a dynamical system forward in time.</span>
<span class="linenos"> 51</span>
<span class="linenos"> 52</span><span class="sd">    Parameters</span>
<span class="linenos"> 53</span><span class="sd">    ----------</span>
<span class="linenos"> 54</span><span class="sd">    initial_state : array-like</span>
<span class="linenos"> 55</span><span class="sd">        Initial state of shape ``(D,)`` or ``(B, D)``.  A missing batch</span>
<span class="linenos"> 56</span><span class="sd">        dimension implies ``B=1``.</span>
<span class="linenos"> 57</span><span class="sd">    control_inputs : array-like</span>
<span class="linenos"> 58</span><span class="sd">        Control sequence with shape ``(H,)`` or ``(H, U)`` for scalar runs or</span>
<span class="linenos"> 59</span><span class="sd">        ``(B, H)``/``(B, H, U)`` for batched runs.  The control dimension U</span>
<span class="linenos"> 60</span><span class="sd">        must be broadcastable to the state dimension.</span>
<span class="linenos"> 61</span><span class="sd">    dt : float</span>
<span class="linenos"> 62</span><span class="sd">        Timestep between control inputs.</span>
<span class="linenos"> 63</span><span class="sd">    horizon : int, optional</span>
<span class="linenos"> 64</span><span class="sd">        Number of simulation steps ``H``.  If not provided it is inferred</span>
<span class="linenos"> 65</span><span class="sd">        from the length of ``control_inputs``.</span>
<span class="linenos"> 66</span><span class="sd">    energy_limits : float, optional</span>
<span class="linenos"> 67</span><span class="sd">        Maximum allowed total energy.  When provided the energy guard</span>
<span class="linenos"> 68</span><span class="sd">        compares ``sum(state**2)`` against this limit after each step.</span>
<span class="linenos"> 69</span><span class="sd">    state_bounds : tuple, optional</span>
<span class="linenos"> 70</span><span class="sd">        Pair ``(lower, upper)`` specifying per‑dimension bounds.  Bounds may</span>
<span class="linenos"> 71</span><span class="sd">        be scalars or arrays broadcastable to the state shape.  A ``None``</span>
<span class="linenos"> 72</span><span class="sd">        value disables that side of the bound.</span>
<span class="linenos"> 73</span><span class="sd">    stop_fn : callable, optional</span>
<span class="linenos"> 74</span><span class="sd">        Optional predicate ``stop_fn(state)``.  If provided and returns</span>
<span class="linenos"> 75</span><span class="sd">        True, the simulation stops early and the output is truncated.</span>
<span class="linenos"> 76</span><span class="sd">    t0 : float, default 0.0</span>
<span class="linenos"> 77</span><span class="sd">        Initial simulation time used in bound violation messages.</span>
<span class="linenos"> 78</span>
<span class="linenos"> 79</span><span class="sd">    Returns</span>
<span class="linenos"> 80</span><span class="sd">    -------</span>
<span class="linenos"> 81</span><span class="sd">    numpy.ndarray</span>
<span class="linenos"> 82</span><span class="sd">        Array of simulated states including the initial state.  Shape is</span>
<span class="linenos"> 83</span><span class="sd">        ``(H_stop+1, D)`` for scalar runs or ``(B, H_stop+1, D)`` for</span>
<span class="linenos"> 84</span><span class="sd">        batched runs, where ``H_stop &lt;= horizon`` if early stopping</span>
<span class="linenos"> 85</span><span class="sd">        occurred.</span>
<span class="linenos"> 86</span>
<span class="linenos"> 87</span><span class="sd">    Examples</span>
<span class="linenos"> 88</span><span class="sd">    --------</span>
<span class="linenos"> 89</span><span class="sd">    Scalar simulation:</span>
<span class="linenos"> 90</span><span class="sd">    </span>
<span class="linenos"> 91</span><span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="linenos"> 92</span><span class="sd">    &gt;&gt;&gt; x0 = np.array([1.0, 0.0])</span>
<span class="linenos"> 93</span><span class="sd">    &gt;&gt;&gt; u = np.array([0.1, 0.2])</span>
<span class="linenos"> 94</span><span class="sd">    &gt;&gt;&gt; result = simulate(x0, u, 0.1)</span>
<span class="linenos"> 95</span><span class="sd">    &gt;&gt;&gt; result.shape</span>
<span class="linenos"> 96</span><span class="sd">    (3, 2)</span>
<span class="linenos"> 97</span><span class="sd">    &gt;&gt;&gt; result[0]  # initial state</span>
<span class="linenos"> 98</span><span class="sd">    array([1., 0.])</span>
<span class="linenos"> 99</span><span class="sd">    </span>
<span class="linenos">100</span><span class="sd">    Batch simulation with early stopping:</span>
<span class="linenos">101</span><span class="sd">    </span>
<span class="linenos">102</span><span class="sd">    &gt;&gt;&gt; x0_batch = np.array([[1.0, 0.0], [2.0, 1.0]])  </span>
<span class="linenos">103</span><span class="sd">    &gt;&gt;&gt; u_batch = np.array([[0.1, 0.2], [0.3, 0.4]])</span>
<span class="linenos">104</span><span class="sd">    &gt;&gt;&gt; stop_fn = lambda x: np.sum(x**2) &gt; 10.0</span>
<span class="linenos">105</span><span class="sd">    &gt;&gt;&gt; result = simulate(x0_batch, u_batch, 0.1, stop_fn=stop_fn)</span>
<span class="linenos">106</span><span class="sd">    &gt;&gt;&gt; result.shape[0] == 2  # batch size preserved</span>
<span class="linenos">107</span><span class="sd">    True</span>
<span class="linenos">108</span><span class="sd">    &gt;&gt;&gt; result.shape[1] &lt;= 3  # may be truncated due to early stop</span>
<span class="linenos">109</span><span class="sd">    True</span>
<span class="linenos">110</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">111</span>    <span class="c1"># Convert state to array and normalise batch dimension</span>
<span class="linenos">112</span>    <span class="c1"># MEMORY OPTIMIZATION: asarray creates view when input is already ndarray with correct dtype</span>
<span class="linenos">113</span>    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">initial_state</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">114</span>    <span class="c1"># Determine if batch: ndim &gt; 1 implies (B, D)</span>
<span class="linenos">115</span>    <span class="n">batch_mode</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span>
<span class="linenos">116</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">batch_mode</span><span class="p">:</span>
<span class="linenos">117</span>        <span class="n">x_b</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
<span class="linenos">118</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">119</span>        <span class="n">x_b</span> <span class="o">=</span> <span class="n">x</span>
<span class="linenos">120</span>
<span class="linenos">121</span>    <span class="c1"># Convert controls to array and infer horizon</span>
<span class="linenos">122</span>    <span class="c1"># MEMORY OPTIMIZATION: asarray creates view when input is already ndarray with correct dtype</span>
<span class="linenos">123</span>    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">control_inputs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">124</span>    <span class="c1"># If horizon is not provided, infer from the length of u along its first time axis</span>
<span class="linenos">125</span>    <span class="k">if</span> <span class="n">horizon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">126</span>        <span class="c1"># For shapes (H,) or (H,U) we treat the first dimension as time</span>
<span class="linenos">127</span>        <span class="c1"># For shapes (B,H) or (B,H,U) we use the second dimension</span>
<span class="linenos">128</span>        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">129</span>            <span class="n">H</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos">130</span>        <span class="k">elif</span> <span class="ow">not</span> <span class="n">batch_mode</span><span class="p">:</span>
<span class="linenos">131</span>            <span class="n">H</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">132</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">133</span>            <span class="n">H</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">134</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">135</span>        <span class="n">H</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">horizon</span><span class="p">)</span>
<span class="linenos">136</span>
<span class="linenos">137</span>    <span class="c1"># Prepare output array with maximum possible horizon; will truncate on early stop</span>
<span class="linenos">138</span>    <span class="n">n_batches</span> <span class="o">=</span> <span class="n">x_b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">139</span>    <span class="n">state_dim</span> <span class="o">=</span> <span class="n">x_b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">140</span>    <span class="n">states</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">H</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">141</span>    <span class="n">states</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">x_b</span>
<span class="linenos">142</span>    <span class="n">t</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>
<span class="linenos">143</span>
<span class="linenos">144</span>    <span class="c1"># If no explicit energy or bounds limits were provided, attempt to</span>
<span class="linenos">145</span>    <span class="c1"># retrieve them from the global configuration.  The config object may</span>
<span class="linenos">146</span>    <span class="c1"># expose ``simulation.safety`` with optional ``energy`` and ``bounds``</span>
<span class="linenos">147</span>    <span class="c1"># attributes.  When present these values are used as defaults for</span>
<span class="linenos">148</span>    <span class="c1"># the corresponding guard limits.  This lookup is performed once at</span>
<span class="linenos">149</span>    <span class="c1"># the start of the simulation to avoid repeated attribute access in</span>
<span class="linenos">150</span>    <span class="c1"># the inner loop.</span>
<span class="linenos">151</span>    <span class="k">if</span> <span class="n">energy_limits</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">state_bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">152</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">153</span>            <span class="n">sim_cfg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">154</span>            <span class="n">safety_cfg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sim_cfg</span><span class="p">,</span> <span class="s2">&quot;safety&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">155</span>            <span class="k">if</span> <span class="n">safety_cfg</span><span class="p">:</span>
<span class="linenos">156</span>                <span class="c1"># Populate defaults only if not explicitly provided</span>
<span class="linenos">157</span>                <span class="k">if</span> <span class="n">energy_limits</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">safety_cfg</span><span class="p">,</span> <span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">158</span>                    <span class="k">try</span><span class="p">:</span>
<span class="linenos">159</span>                        <span class="n">energy_limits</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">safety_cfg</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
<span class="linenos">160</span>                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">161</span>                        <span class="n">energy_limits</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">162</span>                <span class="k">if</span> <span class="n">state_bounds</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">safety_cfg</span><span class="p">,</span> <span class="s2">&quot;bounds&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">163</span>                    <span class="k">try</span><span class="p">:</span>
<span class="linenos">164</span>                        <span class="n">lower</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">safety_cfg</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
<span class="linenos">165</span>                        <span class="n">upper</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">safety_cfg</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
<span class="linenos">166</span>                        <span class="n">state_bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
<span class="linenos">167</span>                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">168</span>                        <span class="n">state_bounds</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">169</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">170</span>            <span class="c1"># If config is not available or lacks expected structure, ignore</span>
<span class="linenos">171</span>            <span class="k">pass</span>
<span class="linenos">172</span>
<span class="linenos">173</span>    <span class="c1"># Iterate through time steps</span>
<span class="linenos">174</span>    <span class="n">stop_index</span> <span class="o">=</span> <span class="n">H</span>
<span class="linenos">175</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">H</span><span class="p">):</span>
<span class="linenos">176</span>        <span class="c1"># Extract control input for this time step, broadcasting batch dimension</span>
<span class="linenos">177</span>        <span class="k">if</span> <span class="n">batch_mode</span><span class="p">:</span>
<span class="linenos">178</span>            <span class="c1"># u shape could be (B,H,U) or (H,U) or (H,) or (B,H)</span>
<span class="linenos">179</span>            <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
<span class="linenos">180</span>                <span class="c1"># Handle case where horizon &gt; control sequence length</span>
<span class="linenos">181</span>                <span class="n">control_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">182</span>                <span class="n">u_i</span> <span class="o">=</span> <span class="n">u</span><span class="p">[:,</span> <span class="n">control_idx</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
<span class="linenos">183</span>            <span class="k">elif</span> <span class="n">u</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos">184</span>                <span class="c1"># Could be (B,H) or (H,U)</span>
<span class="linenos">185</span>                <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">n_batches</span> <span class="ow">and</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">186</span>                    <span class="c1"># (B,H) format - use last available control if i exceeds length</span>
<span class="linenos">187</span>                    <span class="n">control_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">188</span>                    <span class="n">u_i</span> <span class="o">=</span> <span class="n">u</span><span class="p">[:,</span> <span class="n">control_idx</span><span class="p">]</span>
<span class="linenos">189</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">190</span>                    <span class="c1"># (H,U) broadcast across batches</span>
<span class="linenos">191</span>                    <span class="n">control_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">192</span>                    <span class="n">u_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">control_idx</span><span class="p">],</span> <span class="p">(</span><span class="n">n_batches</span><span class="p">,)</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="n">control_idx</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="linenos">193</span>            <span class="k">elif</span> <span class="n">u</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">194</span>                <span class="c1"># Scalar control input per step</span>
<span class="linenos">195</span>                <span class="n">control_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">196</span>                <span class="n">u_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">control_idx</span><span class="p">],</span> <span class="p">(</span><span class="n">n_batches</span><span class="p">,))</span>
<span class="linenos">197</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">198</span>                <span class="n">control_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">199</span>                <span class="n">u_i</span> <span class="o">=</span> <span class="n">u</span><span class="p">[:,</span> <span class="n">control_idx</span><span class="p">]</span>
<span class="linenos">200</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">201</span>            <span class="c1"># Non‑batch: shapes (H,) or (H,U) or scalar</span>
<span class="linenos">202</span>            <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">203</span>                <span class="c1"># Scalar control input - use same value for all steps</span>
<span class="linenos">204</span>                <span class="n">u_i</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="linenos">205</span>            <span class="k">elif</span> <span class="n">u</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">206</span>                <span class="n">control_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">207</span>                <span class="n">u_i</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="n">control_idx</span><span class="p">]</span>
<span class="linenos">208</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">209</span>                <span class="n">control_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">210</span>                <span class="n">u_i</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="n">control_idx</span><span class="p">]</span>
<span class="linenos">211</span>        <span class="c1"># Advance one step using the router</span>
<span class="linenos">212</span>        <span class="n">x_next</span> <span class="o">=</span> <span class="n">_step_fn</span><span class="p">(</span><span class="n">x_b</span><span class="p">,</span> <span class="n">u_i</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
<span class="linenos">213</span>        <span class="c1"># Post‑step guards</span>
<span class="linenos">214</span>        <span class="n">_guard_no_nan</span><span class="p">(</span><span class="n">x_next</span><span class="p">,</span> <span class="n">step_idx</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
<span class="linenos">215</span>        <span class="k">if</span> <span class="n">energy_limits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">216</span>            <span class="n">limits</span> <span class="o">=</span> <span class="n">energy_limits</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">energy_limits</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">energy_limits</span><span class="p">)}</span>
<span class="linenos">217</span>            <span class="n">_guard_energy</span><span class="p">(</span><span class="n">x_next</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>
<span class="linenos">218</span>        <span class="k">if</span> <span class="n">state_bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">219</span>            <span class="n">_guard_bounds</span><span class="p">(</span><span class="n">x_next</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">state_bounds</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span> <span class="o">+</span> <span class="n">dt</span><span class="p">)</span>
<span class="linenos">220</span>        <span class="c1"># Record and update state</span>
<span class="linenos">221</span>        <span class="n">states</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">x_next</span>
<span class="linenos">222</span>        <span class="n">x_b</span> <span class="o">=</span> <span class="n">x_next</span>
<span class="linenos">223</span>        <span class="n">t</span> <span class="o">+=</span> <span class="n">dt</span>
<span class="linenos">224</span>        <span class="c1"># Early stop check: call predicate on batch or scalar state</span>
<span class="linenos">225</span>        <span class="k">if</span> <span class="n">stop_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">226</span>            <span class="c1"># Evaluate stop predicate on each batch element; stop if any returns True</span>
<span class="linenos">227</span>            <span class="k">if</span> <span class="n">batch_mode</span><span class="p">:</span>
<span class="linenos">228</span>                <span class="n">stop_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">bool</span><span class="p">(</span><span class="n">stop_fn</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">x_b</span><span class="p">])</span>
<span class="linenos">229</span>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">stop_mask</span><span class="p">):</span>
<span class="linenos">230</span>                    <span class="n">stop_index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos">231</span>                    <span class="k">break</span>
<span class="linenos">232</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">233</span>                <span class="k">if</span> <span class="n">stop_fn</span><span class="p">(</span><span class="n">x_b</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x_b</span><span class="p">,</span> <span class="s2">&quot;squeeze&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">x_b</span><span class="p">):</span>
<span class="linenos">234</span>                    <span class="n">stop_index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos">235</span>                    <span class="k">break</span>
<span class="linenos">236</span>
<span class="linenos">237</span>    <span class="c1"># Pre‑emit guards on the final state (or truncated state)</span>
<span class="linenos">238</span>    <span class="n">_guard_no_nan</span><span class="p">(</span><span class="n">x_b</span><span class="p">,</span> <span class="n">step_idx</span><span class="o">=</span><span class="n">stop_index</span><span class="p">)</span>
<span class="linenos">239</span>    <span class="k">if</span> <span class="n">energy_limits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">240</span>        <span class="n">_guard_energy</span><span class="p">(</span><span class="n">x_b</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">energy_limits</span><span class="p">)})</span>
<span class="linenos">241</span>    <span class="k">if</span> <span class="n">state_bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">242</span>        <span class="n">_guard_bounds</span><span class="p">(</span><span class="n">x_b</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">state_bounds</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
<span class="linenos">243</span>
<span class="linenos">244</span>    <span class="c1"># Truncate output on early stop</span>
<span class="linenos">245</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">states</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">stop_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
<span class="linenos">246</span>    <span class="c1"># Return squeezed array for scalar runs</span>
<span class="linenos">247</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">batch_mode</span><span class="p">:</span>
<span class="linenos">248</span>        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">249</span>    <span class="k">return</span> <span class="n">result</span>
<span class="linenos">250</span>
<span class="linenos">251</span>
<span class="linenos">252</span>
<span class="linenos">253</span><span class="k">def</span><span class="w"> </span><span class="nf">simulate_system_batch</span><span class="p">(</span>
<span class="linenos">254</span>    <span class="o">*</span><span class="p">,</span>
<span class="linenos">255</span>    <span class="n">controller_factory</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Any</span><span class="p">],</span>
<span class="linenos">256</span>    <span class="n">particles</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="linenos">257</span>    <span class="n">sim_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="linenos">258</span>    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="linenos">259</span>    <span class="n">u_max</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">260</span>    <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">261</span>    <span class="n">params_list</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">262</span>    <span class="n">initial_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">263</span>    <span class="n">convergence_tol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">264</span>    <span class="n">grace_period</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="linenos">265</span>    <span class="n">rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">266</span>    <span class="o">**</span><span class="n">_kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="linenos">267</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="linenos">268</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Vectorised batch simulation of multiple controllers.</span>
<span class="linenos">269</span>
<span class="linenos">270</span><span class="sd">    This function wraps ``run_simulation`` to simultaneously simulate a batch</span>
<span class="linenos">271</span><span class="sd">    of controllers with distinct gain vectors (``particles``).  It returns</span>
<span class="linenos">272</span><span class="sd">    time, state, control and sliding-surface arrays for the entire batch.</span>
<span class="linenos">273</span><span class="sd">    Optional early stopping is available: once the magnitude of the sliding</span>
<span class="linenos">274</span><span class="sd">    surface ``sigma`` falls below ``convergence_tol`` for all particles (after</span>
<span class="linenos">275</span><span class="sd">    a grace period), integration halts early and the outputs are truncated.</span>
<span class="linenos">276</span>
<span class="linenos">277</span><span class="sd">    When ``params_list`` is provided, the simulation is repeated for each</span>
<span class="linenos">278</span><span class="sd">    element in the list.  The return value is then a list of results, one per</span>
<span class="linenos">279</span><span class="sd">    parameter set.  For backward compatibility, the dynamics model is</span>
<span class="linenos">280</span><span class="sd">    determined internally by the controller factory; perturbed physics</span>
<span class="linenos">281</span><span class="sd">    parameters are ignored and results are replicated across the list.</span>
<span class="linenos">282</span>
<span class="linenos">283</span><span class="sd">    Parameters</span>
<span class="linenos">284</span><span class="sd">    ----------</span>
<span class="linenos">285</span><span class="sd">    controller_factory : callable</span>
<span class="linenos">286</span><span class="sd">        Factory ``controller_factory(p)`` that returns a controller given a</span>
<span class="linenos">287</span><span class="sd">        gain vector ``p``.  The returned controller must expose a</span>
<span class="linenos">288</span><span class="sd">        ``dynamics_model`` attribute defining the system dynamics.</span>
<span class="linenos">289</span><span class="sd">    particles : array-like</span>
<span class="linenos">290</span><span class="sd">        Array of shape ``(B, G)`` where each row contains a gain vector for</span>
<span class="linenos">291</span><span class="sd">        one particle.  A single particle may be provided as shape ``(G,)``.</span>
<span class="linenos">292</span><span class="sd">    sim_time : float</span>
<span class="linenos">293</span><span class="sd">        Total simulation duration (seconds).</span>
<span class="linenos">294</span><span class="sd">    dt : float</span>
<span class="linenos">295</span><span class="sd">        Timestep for integration (seconds).</span>
<span class="linenos">296</span><span class="sd">    u_max : float, optional</span>
<span class="linenos">297</span><span class="sd">        Control saturation limit.  Overrides controller-specific ``max_force``.</span>
<span class="linenos">298</span><span class="sd">    seed : int, optional</span>
<span class="linenos">299</span><span class="sd">        Deprecated.  Ignored; retained for signature compatibility.</span>
<span class="linenos">300</span><span class="sd">    params_list : iterable, optional</span>
<span class="linenos">301</span><span class="sd">        Optional list of physics parameter objects.  When provided, the</span>
<span class="linenos">302</span><span class="sd">        simulation is repeated for each element.  The current implementation</span>
<span class="linenos">303</span><span class="sd">        ignores these parameters and replicates the base results.</span>
<span class="linenos">304</span><span class="sd">    initial_state : array-like, optional</span>
<span class="linenos">305</span><span class="sd">        Initial state(s) for the batch.  If ``None``, a zero state is used.</span>
<span class="linenos">306</span><span class="sd">        If a 1D array of length ``D`` is provided, it is broadcast across all</span>
<span class="linenos">307</span><span class="sd">        particles.  If a 2D array of shape ``(B, D)`` is provided, it is used</span>
<span class="linenos">308</span><span class="sd">        directly.</span>
<span class="linenos">309</span><span class="sd">    convergence_tol : float, optional</span>
<span class="linenos">310</span><span class="sd">        Threshold for sliding-surface convergence.  When provided and</span>
<span class="linenos">311</span><span class="sd">        positive, the integration stops once ``max(|sigma|) &lt; convergence_tol``</span>
<span class="linenos">312</span><span class="sd">        across all particles (after the grace period).</span>
<span class="linenos">313</span><span class="sd">    grace_period : float, optional</span>
<span class="linenos">314</span><span class="sd">        Duration (seconds) to wait before checking the convergence criterion.</span>
<span class="linenos">315</span><span class="sd">    rng : numpy.random.Generator, optional</span>
<span class="linenos">316</span><span class="sd">        Unused in this implementation.  Present for API compatibility.</span>
<span class="linenos">317</span>
<span class="linenos">318</span><span class="sd">    Returns</span>
<span class="linenos">319</span><span class="sd">    -------</span>
<span class="linenos">320</span><span class="sd">    If ``params_list`` is not provided, returns a tuple ``(t, x_b, u_b, sigma_b)``:</span>
<span class="linenos">321</span><span class="sd">    </span>
<span class="linenos">322</span><span class="sd">    - ``t``: ndarray of shape ``(N+1,)`` of time points</span>
<span class="linenos">323</span><span class="sd">    - ``x_b``: ndarray of shape ``(B, N+1, D)`` of states</span>
<span class="linenos">324</span><span class="sd">    - ``u_b``: ndarray of shape ``(B, N)`` of controls</span>
<span class="linenos">325</span><span class="sd">    - ``sigma_b``: ndarray of shape ``(B, N)`` of sliding-surface values</span>
<span class="linenos">326</span>
<span class="linenos">327</span><span class="sd">    If ``params_list`` is provided, returns a list of such tuples (one per</span>
<span class="linenos">328</span><span class="sd">    element in ``params_list``).</span>
<span class="linenos">329</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">330</span>    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_np</span>  <span class="c1"># local import to avoid polluting namespace</span>
<span class="linenos">331</span>    <span class="c1"># Convert particles to array</span>
<span class="linenos">332</span>    <span class="c1"># MEMORY OPTIMIZATION: asarray creates view when input is already ndarray with correct dtype</span>
<span class="linenos">333</span>    <span class="n">part_arr</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">334</span>    <span class="k">if</span> <span class="n">part_arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">335</span>        <span class="n">part_arr</span> <span class="o">=</span> <span class="n">part_arr</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
<span class="linenos">336</span>    <span class="n">B</span><span class="p">,</span> <span class="n">G</span> <span class="o">=</span> <span class="n">part_arr</span><span class="o">.</span><span class="n">shape</span>
<span class="linenos">337</span>    <span class="c1"># Determine number of steps</span>
<span class="linenos">338</span>    <span class="n">dt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
<span class="linenos">339</span>    <span class="n">sim_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sim_time</span><span class="p">)</span>
<span class="linenos">340</span>    <span class="n">H</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">sim_time</span> <span class="o">/</span> <span class="n">dt</span><span class="p">))</span> <span class="k">if</span> <span class="n">sim_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
<span class="linenos">341</span>    <span class="c1"># Instantiate controllers for each particle</span>
<span class="linenos">342</span>    <span class="n">controllers</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">343</span>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
<span class="linenos">344</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">345</span>            <span class="n">ctrl</span> <span class="o">=</span> <span class="n">controller_factory</span><span class="p">(</span><span class="n">part_arr</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
<span class="linenos">346</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">347</span>            <span class="n">ctrl</span> <span class="o">=</span> <span class="n">controller_factory</span><span class="p">(</span><span class="n">part_arr</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
<span class="linenos">348</span>        <span class="n">controllers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ctrl</span><span class="p">)</span>
<span class="linenos">349</span>    <span class="c1"># Determine state dimension from first controller&#39;s dynamics model</span>
<span class="linenos">350</span>    <span class="k">if</span> <span class="n">initial_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">351</span>        <span class="c1"># Try to introspect state dimension</span>
<span class="linenos">352</span>        <span class="n">state_dim</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">353</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">354</span>            <span class="n">state_dim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">controllers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;state_dim&quot;</span><span class="p">))</span>
<span class="linenos">355</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">356</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">357</span>                <span class="n">state_dim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">controllers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;dynamics_model&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">state_dim</span><span class="p">)</span>
<span class="linenos">358</span>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">359</span>                <span class="n">state_dim</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># fall back to DIP dimension</span>
<span class="linenos">360</span>        <span class="n">init_b</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">B</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">361</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">362</span>        <span class="c1"># MEMORY OPTIMIZATION: asarray creates view when input is already ndarray with correct dtype</span>
<span class="linenos">363</span>        <span class="n">init</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">initial_state</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">364</span>        <span class="k">if</span> <span class="n">init</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">365</span>            <span class="c1"># broadcast across batch</span>
<span class="linenos">366</span>            <span class="c1"># MEMORY OPTIMIZATION: Must copy broadcast_to result (returns view that needs writeable buffer)</span>
<span class="linenos">367</span>            <span class="n">init_b</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">init</span><span class="p">,</span> <span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">368</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">369</span>            <span class="c1"># MEMORY OPTIMIZATION: Copy only when necessary (will be written to)</span>
<span class="linenos">370</span>            <span class="n">init_b</span> <span class="o">=</span> <span class="n">init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">371</span>    <span class="c1"># Preallocate outputs</span>
<span class="linenos">372</span>    <span class="n">t_arr</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">373</span>    <span class="n">x_b</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">B</span><span class="p">,</span> <span class="n">H</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">init_b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">374</span>    <span class="n">u_b</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">B</span><span class="p">,</span> <span class="n">H</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">375</span>    <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">B</span><span class="p">,</span> <span class="n">H</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">376</span>    <span class="n">x_b</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">init_b</span>
<span class="linenos">377</span>    <span class="c1"># Convergence parameters</span>
<span class="linenos">378</span>    <span class="n">check_convergence</span> <span class="o">=</span> <span class="p">(</span><span class="n">convergence_tol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">convergence_tol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos">379</span>    <span class="n">conv_tol</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">convergence_tol</span><span class="p">)</span> <span class="k">if</span> <span class="n">convergence_tol</span> <span class="k">else</span> <span class="mf">0.0</span>
<span class="linenos">380</span>    <span class="n">grace_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">grace_period</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span><span class="p">))</span> <span class="k">if</span> <span class="n">grace_period</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
<span class="linenos">381</span>    <span class="c1"># Per-controller state and history</span>
<span class="linenos">382</span>    <span class="n">state_vars</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span>
<span class="linenos">383</span>    <span class="n">histories</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span>
<span class="linenos">384</span>    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">controllers</span><span class="p">):</span>
<span class="linenos">385</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">386</span>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="s2">&quot;initialize_state&quot;</span><span class="p">):</span>
<span class="linenos">387</span>                <span class="n">state_vars</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">initialize_state</span><span class="p">()</span>  <span class="c1"># type: ignore[assignment]</span>
<span class="linenos">388</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">389</span>            <span class="c1"># OK: initialize_state is optional - graceful fallback to None</span>
<span class="linenos">390</span>            <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="linenos">391</span>            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<span class="linenos">392</span>                <span class="sa">f</span><span class="s2">&quot;Controller </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ctrl</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">) doesn&#39;t support state initialization: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">393</span>            <span class="p">)</span>
<span class="linenos">394</span>            <span class="n">state_vars</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">395</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">396</span>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="s2">&quot;initialize_history&quot;</span><span class="p">):</span>
<span class="linenos">397</span>                <span class="n">histories</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">initialize_history</span><span class="p">()</span>  <span class="c1"># type: ignore[assignment]</span>
<span class="linenos">398</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">399</span>            <span class="c1"># OK: initialize_history is optional - graceful fallback to None</span>
<span class="linenos">400</span>            <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="linenos">401</span>            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<span class="linenos">402</span>                <span class="sa">f</span><span class="s2">&quot;Controller </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ctrl</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">) doesn&#39;t support history initialization: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">403</span>            <span class="p">)</span>
<span class="linenos">404</span>            <span class="n">histories</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">405</span>    <span class="c1"># Determine per-particle saturation limits</span>
<span class="linenos">406</span>    <span class="n">u_limits</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">407</span>    <span class="k">if</span> <span class="n">u_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">408</span>        <span class="n">u_limits</span><span class="p">[:]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">u_max</span><span class="p">)</span>
<span class="linenos">409</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">410</span>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">controllers</span><span class="p">):</span>
<span class="linenos">411</span>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="s2">&quot;max_force&quot;</span><span class="p">):</span>
<span class="linenos">412</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos">413</span>                    <span class="n">u_limits</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="s2">&quot;max_force&quot;</span><span class="p">))</span>
<span class="linenos">414</span>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">415</span>                    <span class="n">u_limits</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">inf</span>
<span class="linenos">416</span>    <span class="c1"># Simulation loop</span>
<span class="linenos">417</span>    <span class="c1"># We will reuse dynamics_model from each controller</span>
<span class="linenos">418</span>    <span class="n">times</span> <span class="o">=</span> <span class="n">t_arr</span>
<span class="linenos">419</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">H</span><span class="p">):</span>
<span class="linenos">420</span>        <span class="n">t_now</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">dt</span>
<span class="linenos">421</span>        <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_now</span>
<span class="linenos">422</span>        <span class="c1"># Compute controls and sigma for each particle</span>
<span class="linenos">423</span>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">controllers</span><span class="p">):</span>
<span class="linenos">424</span>            <span class="n">x_curr</span> <span class="o">=</span> <span class="n">x_b</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
<span class="linenos">425</span>            <span class="c1"># Use compute_control if available</span>
<span class="linenos">426</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">427</span>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="s2">&quot;compute_control&quot;</span><span class="p">):</span>
<span class="linenos">428</span>                    <span class="n">ret</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">compute_control</span><span class="p">(</span><span class="n">x_curr</span><span class="p">,</span> <span class="n">state_vars</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">histories</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
<span class="linenos">429</span>                    <span class="c1"># ret may be namedtuple or tuple</span>
<span class="linenos">430</span>                    <span class="k">try</span><span class="p">:</span>
<span class="linenos">431</span>                        <span class="n">u_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">432</span>                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">433</span>                        <span class="n">u_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="linenos">434</span>                    <span class="c1"># update state and history</span>
<span class="linenos">435</span>                    <span class="k">try</span><span class="p">:</span>
<span class="linenos">436</span>                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos">437</span>                            <span class="n">state_vars</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">438</span>                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
<span class="linenos">439</span>                            <span class="n">histories</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">440</span>                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">441</span>                        <span class="k">pass</span>
<span class="linenos">442</span>                    <span class="c1"># extract sigma if available</span>
<span class="linenos">443</span>                    <span class="n">sigma_val</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos">444</span>                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="s2">&quot;sigma&quot;</span><span class="p">):</span>
<span class="linenos">445</span>                        <span class="n">sigma_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">sigma</span><span class="p">)</span>
<span class="linenos">446</span>                    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
<span class="linenos">447</span>                        <span class="n">sigma_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="linenos">448</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">449</span>                    <span class="n">u_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ctrl</span><span class="p">(</span><span class="n">t_now</span><span class="p">,</span> <span class="n">x_curr</span><span class="p">))</span>
<span class="linenos">450</span>                    <span class="n">sigma_val</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos">451</span>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">452</span>                <span class="c1"># CRITICAL FIX: Don&#39;t catch Warning exceptions (pytest may convert warnings to errors)</span>
<span class="linenos">453</span>                <span class="c1"># Re-raise warnings so they propagate normally and don&#39;t terminate simulation</span>
<span class="linenos">454</span>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">):</span>
<span class="linenos">455</span>                    <span class="k">raise</span>
<span class="linenos">456</span>                <span class="c1"># On actual error computing control, treat as instability and stop</span>
<span class="linenos">457</span>                <span class="n">H</span> <span class="o">=</span> <span class="n">i</span>
<span class="linenos">458</span>                <span class="n">u_b</span> <span class="o">=</span> <span class="n">u_b</span><span class="p">[:,</span> <span class="p">:</span><span class="n">i</span><span class="p">]</span>
<span class="linenos">459</span>                <span class="n">x_b</span> <span class="o">=</span> <span class="n">x_b</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
<span class="linenos">460</span>                <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">sigma_b</span><span class="p">[:,</span> <span class="p">:</span><span class="n">i</span><span class="p">]</span>
<span class="linenos">461</span>                <span class="n">times</span> <span class="o">=</span> <span class="n">times</span><span class="p">[:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
<span class="linenos">462</span>                <span class="c1"># Attach histories</span>
<span class="linenos">463</span>                <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">controllers</span><span class="p">):</span>
<span class="linenos">464</span>                    <span class="n">hist</span> <span class="o">=</span> <span class="n">histories</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
<span class="linenos">465</span>                    <span class="k">if</span> <span class="n">hist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">466</span>                        <span class="k">try</span><span class="p">:</span>
<span class="linenos">467</span>                            <span class="nb">setattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;_last_history&quot;</span><span class="p">,</span> <span class="n">hist</span><span class="p">)</span>
<span class="linenos">468</span>                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">469</span>                            <span class="c1"># OK: _last_history attachment is optional feature</span>
<span class="linenos">470</span>                            <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="linenos">471</span>                            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<span class="linenos">472</span>                                <span class="sa">f</span><span class="s2">&quot;Could not attach history to controller </span><span class="si">{</span><span class="n">jj</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">473</span>                            <span class="p">)</span>
<span class="linenos">474</span>                            <span class="c1"># Continue without history attachment</span>
<span class="linenos">475</span>                <span class="k">if</span> <span class="n">params_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">476</span>                    <span class="k">return</span> <span class="p">[(</span><span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">times</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x_b</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">u_b</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sigma_b</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">params_list</span><span class="p">]</span>
<span class="linenos">477</span>                <span class="k">return</span> <span class="n">times</span><span class="p">,</span> <span class="n">x_b</span><span class="p">,</span> <span class="n">u_b</span><span class="p">,</span> <span class="n">sigma_b</span>
<span class="linenos">478</span>            <span class="c1"># Saturate and store</span>
<span class="linenos">479</span>            <span class="n">limit</span> <span class="o">=</span> <span class="n">u_limits</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
<span class="linenos">480</span>            <span class="k">if</span> <span class="n">limit</span> <span class="o">&lt;</span> <span class="n">_np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
<span class="linenos">481</span>                <span class="k">if</span> <span class="n">u_val</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">:</span>
<span class="linenos">482</span>                    <span class="n">u_val</span> <span class="o">=</span> <span class="n">limit</span>
<span class="linenos">483</span>                <span class="k">elif</span> <span class="n">u_val</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">limit</span><span class="p">:</span>
<span class="linenos">484</span>                    <span class="n">u_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">limit</span>
<span class="linenos">485</span>            <span class="n">u_b</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_val</span>
<span class="linenos">486</span>            <span class="n">sigma_b</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_val</span>
<span class="linenos">487</span>        <span class="c1"># Step all particles forward using their dynamics model</span>
<span class="linenos">488</span>        <span class="n">early_stop</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">489</span>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">controllers</span><span class="p">):</span>
<span class="linenos">490</span>            <span class="n">dyn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="s2">&quot;dynamics_model&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">491</span>            <span class="k">if</span> <span class="n">dyn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">492</span>                <span class="c1"># If controller lacks dynamics_model, fall back to global step</span>
<span class="linenos">493</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos">494</span>                    <span class="n">x_next</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">x_b</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">u_b</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">dt</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
<span class="linenos">495</span>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">496</span>                    <span class="n">x_next</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">497</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">498</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos">499</span>                    <span class="n">x_next</span> <span class="o">=</span> <span class="n">dyn</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">x_b</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">u_b</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">dt</span><span class="p">)</span>
<span class="linenos">500</span>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">501</span>                    <span class="n">x_next</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">502</span>            <span class="k">if</span> <span class="n">x_next</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">503</span>                <span class="n">early_stop</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">504</span>                <span class="k">break</span>
<span class="linenos">505</span>            <span class="c1"># MEMORY OPTIMIZATION: asarray creates view when input is already ndarray with correct dtype</span>
<span class="linenos">506</span>            <span class="n">x_next_arr</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x_next</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">507</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">_np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x_next_arr</span><span class="p">)):</span>
<span class="linenos">508</span>                <span class="n">early_stop</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">509</span>                <span class="k">break</span>
<span class="linenos">510</span>            <span class="n">x_b</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_next_arr</span>
<span class="linenos">511</span>        <span class="k">if</span> <span class="n">early_stop</span><span class="p">:</span>
<span class="linenos">512</span>            <span class="c1"># truncate and exit</span>
<span class="linenos">513</span>            <span class="n">H</span> <span class="o">=</span> <span class="n">i</span>
<span class="linenos">514</span>            <span class="n">u_b</span> <span class="o">=</span> <span class="n">u_b</span><span class="p">[:,</span> <span class="p">:</span><span class="n">i</span><span class="p">]</span>
<span class="linenos">515</span>            <span class="n">x_b</span> <span class="o">=</span> <span class="n">x_b</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
<span class="linenos">516</span>            <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">sigma_b</span><span class="p">[:,</span> <span class="p">:</span><span class="n">i</span><span class="p">]</span>
<span class="linenos">517</span>            <span class="n">times</span> <span class="o">=</span> <span class="n">times</span><span class="p">[:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
<span class="linenos">518</span>            <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">controllers</span><span class="p">):</span>
<span class="linenos">519</span>                <span class="n">hist</span> <span class="o">=</span> <span class="n">histories</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
<span class="linenos">520</span>                <span class="k">if</span> <span class="n">hist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">521</span>                    <span class="k">try</span><span class="p">:</span>
<span class="linenos">522</span>                        <span class="nb">setattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;_last_history&quot;</span><span class="p">,</span> <span class="n">hist</span><span class="p">)</span>
<span class="linenos">523</span>                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">524</span>                        <span class="k">pass</span>
<span class="linenos">525</span>            <span class="k">if</span> <span class="n">params_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">526</span>                <span class="k">return</span> <span class="p">[(</span><span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">times</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x_b</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">u_b</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sigma_b</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">params_list</span><span class="p">]</span>
<span class="linenos">527</span>            <span class="k">return</span> <span class="n">times</span><span class="p">,</span> <span class="n">x_b</span><span class="p">,</span> <span class="n">u_b</span><span class="p">,</span> <span class="n">sigma_b</span>
<span class="linenos">528</span>        <span class="c1"># Early convergence check</span>
<span class="linenos">529</span>        <span class="k">if</span> <span class="n">check_convergence</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">grace_steps</span><span class="p">):</span>
<span class="linenos">530</span>            <span class="n">max_sigma</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sigma_b</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]))</span>
<span class="linenos">531</span>            <span class="k">if</span> <span class="n">max_sigma</span> <span class="o">&lt;</span> <span class="n">conv_tol</span><span class="p">:</span>
<span class="linenos">532</span>                <span class="n">H</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos">533</span>                <span class="n">u_b</span> <span class="o">=</span> <span class="n">u_b</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
<span class="linenos">534</span>                <span class="n">x_b</span> <span class="o">=</span> <span class="n">x_b</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
<span class="linenos">535</span>                <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">sigma_b</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
<span class="linenos">536</span>                <span class="n">times</span> <span class="o">=</span> <span class="n">times</span><span class="p">[:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
<span class="linenos">537</span>                <span class="c1"># copy histories</span>
<span class="linenos">538</span>                <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">controllers</span><span class="p">):</span>
<span class="linenos">539</span>                    <span class="n">hist</span> <span class="o">=</span> <span class="n">histories</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
<span class="linenos">540</span>                    <span class="k">if</span> <span class="n">hist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">541</span>                        <span class="k">try</span><span class="p">:</span>
<span class="linenos">542</span>                            <span class="nb">setattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;_last_history&quot;</span><span class="p">,</span> <span class="n">hist</span><span class="p">)</span>
<span class="linenos">543</span>                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">544</span>                            <span class="k">pass</span>
<span class="linenos">545</span>                <span class="k">if</span> <span class="n">params_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">546</span>                    <span class="k">return</span> <span class="p">[(</span><span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">times</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x_b</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">u_b</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sigma_b</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">params_list</span><span class="p">]</span>
<span class="linenos">547</span>                <span class="k">return</span> <span class="n">times</span><span class="p">,</span> <span class="n">x_b</span><span class="p">,</span> <span class="n">u_b</span><span class="p">,</span> <span class="n">sigma_b</span>
<span class="linenos">548</span>    <span class="c1"># Finalise times</span>
<span class="linenos">549</span>    <span class="n">times</span><span class="p">[</span><span class="n">H</span><span class="p">]</span> <span class="o">=</span> <span class="n">H</span> <span class="o">*</span> <span class="n">dt</span>
<span class="linenos">550</span>    <span class="c1"># attach histories on controllers</span>
<span class="linenos">551</span>    <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">controllers</span><span class="p">):</span>
<span class="linenos">552</span>        <span class="n">hist</span> <span class="o">=</span> <span class="n">histories</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
<span class="linenos">553</span>        <span class="k">if</span> <span class="n">hist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">554</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">555</span>                <span class="nb">setattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;_last_history&quot;</span><span class="p">,</span> <span class="n">hist</span><span class="p">)</span>
<span class="linenos">556</span>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">557</span>                <span class="k">pass</span>
<span class="linenos">558</span>    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">x_b</span><span class="p">,</span> <span class="n">u_b</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">)</span>
<span class="linenos">559</span>    <span class="k">if</span> <span class="n">params_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">560</span>        <span class="k">return</span> <span class="n">result</span>
<span class="linenos">561</span>    <span class="c1"># replicate results for each params entry</span>
<span class="linenos">562</span>    <span class="k">return</span> <span class="p">[(</span><span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">times</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x_b</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">u_b</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sigma_b</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">params_list</span><span class="p">]</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="functions">
<h2>Functions<a class="headerlink" href="#functions" title="Link to this heading">¶</a></h2>
<section id="simulate-initial-state-control-inputs-dt-horizon">
<h3><code class="docutils literal notranslate"><span class="pre">simulate(initial_state,</span> <span class="pre">control_inputs,</span> <span class="pre">dt,</span> <span class="pre">horizon)</span></code><a class="headerlink" href="#simulate-initial-state-control-inputs-dt-horizon" title="Link to this heading">¶</a></h3>
<p>Simulate a dynamical system forward in time.</p>
</section>
</section>
<section id="parameters">
<h2>Parameters<a class="headerlink" href="#parameters" title="Link to this heading">¶</a></h2>
<p>initial_state : array-like
Initial state of shape <code class="docutils literal notranslate"><span class="pre">(D,)</span></code> or <code class="docutils literal notranslate"><span class="pre">(B,</span> <span class="pre">D)</span></code>.  A missing batch
dimension implies <code class="docutils literal notranslate"><span class="pre">B=1</span></code>.
control_inputs : array-like
Control sequence with shape <code class="docutils literal notranslate"><span class="pre">(H,)</span></code> or <code class="docutils literal notranslate"><span class="pre">(H,</span> <span class="pre">U)</span></code> for scalar runs or
<code class="docutils literal notranslate"><span class="pre">(B,</span> <span class="pre">H)</span></code>/<code class="docutils literal notranslate"><span class="pre">(B,</span> <span class="pre">H,</span> <span class="pre">U)</span></code> for batched runs.  The control dimension U
must be broadcastable to the state dimension.
dt : float
Timestep between control inputs.
horizon : int, optional
Number of simulation steps <code class="docutils literal notranslate"><span class="pre">H</span></code>.  If not provided it is inferred
from the length of <code class="docutils literal notranslate"><span class="pre">control_inputs</span></code>.
energy_limits : float, optional
Maximum allowed total energy.  When provided the energy guard
compares <code class="docutils literal notranslate"><span class="pre">sum(state**2)</span></code> against this limit after each step.
state_bounds : tuple, optional
Pair <code class="docutils literal notranslate"><span class="pre">(lower,</span> <span class="pre">upper)</span></code> specifying per‑dimension bounds.  Bounds may
be scalars or arrays broadcastable to the state shape.  A <code class="docutils literal notranslate"><span class="pre">None</span></code>
value disables that side of the bound.
stop_fn : callable, optional
Optional predicate <code class="docutils literal notranslate"><span class="pre">stop_fn(state)</span></code>.  If provided and returns
True, the simulation stops early and the output is truncated.
t0 : float, default 0.0
Initial simulation time used in bound violation messages.</p>
</section>
<section id="returns">
<h2>Returns<a class="headerlink" href="#returns" title="Link to this heading">¶</a></h2>
<p>numpy.ndarray
Array of simulated states including the initial state.  Shape is
<code class="docutils literal notranslate"><span class="pre">(H_stop+1,</span> <span class="pre">D)</span></code> for scalar runs or <code class="docutils literal notranslate"><span class="pre">(B,</span> <span class="pre">H_stop+1,</span> <span class="pre">D)</span></code> for
batched runs, where <code class="docutils literal notranslate"><span class="pre">H_stop</span> <span class="pre">&lt;=</span> <span class="pre">horizon</span></code> if early stopping
occurred.</p>
</section>
<section id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Link to this heading">¶</a></h2>
<p>Scalar simulation:</p>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><p>import numpy as np
x0 = np.array([1.0, 0.0])
u = np.array([0.1, 0.2])
result = simulate(x0, u, 0.1)
result.shape
(3, 2)
result[0]  # initial state
array([1., 0.])</p>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<p>Batch simulation with early stopping:</p>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><p>x0_batch = np.array([[1.0, 0.0], [2.0, 1.0]])<br />
u_batch = np.array([[0.1, 0.2], [0.3, 0.4]])
stop_fn = lambda x: np.sum(x**2) &gt; 10.0
result = simulate(x0_batch, u_batch, 0.1, stop_fn=stop_fn)
result.shape[0] == 2  # batch size preserved
True
result.shape[1] &lt;= 3  # may be truncated due to early stop
True</p>
</div></blockquote>
</div></blockquote>
</div></blockquote>
<section id="source-code">
<h3>Source Code<a class="headerlink" href="#source-code" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="k">def</span><span class="w"> </span><span class="nf">simulate</span><span class="p">(</span>
<span class="linenos">  2</span>    <span class="n">initial_state</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="linenos">  3</span>    <span class="n">control_inputs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="linenos">  4</span>    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="linenos">  5</span>    <span class="n">horizon</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">  6</span>    <span class="o">*</span><span class="p">,</span>
<span class="linenos">  7</span>    <span class="n">energy_limits</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">  8</span>    <span class="n">state_bounds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">  9</span>    <span class="n">stop_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 10</span>    <span class="n">t0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="linenos"> 11</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="linenos"> 12</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulate a dynamical system forward in time.</span>
<span class="linenos"> 13</span>
<span class="linenos"> 14</span><span class="sd">    Parameters</span>
<span class="linenos"> 15</span><span class="sd">    ----------</span>
<span class="linenos"> 16</span><span class="sd">    initial_state : array-like</span>
<span class="linenos"> 17</span><span class="sd">        Initial state of shape ``(D,)`` or ``(B, D)``.  A missing batch</span>
<span class="linenos"> 18</span><span class="sd">        dimension implies ``B=1``.</span>
<span class="linenos"> 19</span><span class="sd">    control_inputs : array-like</span>
<span class="linenos"> 20</span><span class="sd">        Control sequence with shape ``(H,)`` or ``(H, U)`` for scalar runs or</span>
<span class="linenos"> 21</span><span class="sd">        ``(B, H)``/``(B, H, U)`` for batched runs.  The control dimension U</span>
<span class="linenos"> 22</span><span class="sd">        must be broadcastable to the state dimension.</span>
<span class="linenos"> 23</span><span class="sd">    dt : float</span>
<span class="linenos"> 24</span><span class="sd">        Timestep between control inputs.</span>
<span class="linenos"> 25</span><span class="sd">    horizon : int, optional</span>
<span class="linenos"> 26</span><span class="sd">        Number of simulation steps ``H``.  If not provided it is inferred</span>
<span class="linenos"> 27</span><span class="sd">        from the length of ``control_inputs``.</span>
<span class="linenos"> 28</span><span class="sd">    energy_limits : float, optional</span>
<span class="linenos"> 29</span><span class="sd">        Maximum allowed total energy.  When provided the energy guard</span>
<span class="linenos"> 30</span><span class="sd">        compares ``sum(state**2)`` against this limit after each step.</span>
<span class="linenos"> 31</span><span class="sd">    state_bounds : tuple, optional</span>
<span class="linenos"> 32</span><span class="sd">        Pair ``(lower, upper)`` specifying per‑dimension bounds.  Bounds may</span>
<span class="linenos"> 33</span><span class="sd">        be scalars or arrays broadcastable to the state shape.  A ``None``</span>
<span class="linenos"> 34</span><span class="sd">        value disables that side of the bound.</span>
<span class="linenos"> 35</span><span class="sd">    stop_fn : callable, optional</span>
<span class="linenos"> 36</span><span class="sd">        Optional predicate ``stop_fn(state)``.  If provided and returns</span>
<span class="linenos"> 37</span><span class="sd">        True, the simulation stops early and the output is truncated.</span>
<span class="linenos"> 38</span><span class="sd">    t0 : float, default 0.0</span>
<span class="linenos"> 39</span><span class="sd">        Initial simulation time used in bound violation messages.</span>
<span class="linenos"> 40</span>
<span class="linenos"> 41</span><span class="sd">    Returns</span>
<span class="linenos"> 42</span><span class="sd">    -------</span>
<span class="linenos"> 43</span><span class="sd">    numpy.ndarray</span>
<span class="linenos"> 44</span><span class="sd">        Array of simulated states including the initial state.  Shape is</span>
<span class="linenos"> 45</span><span class="sd">        ``(H_stop+1, D)`` for scalar runs or ``(B, H_stop+1, D)`` for</span>
<span class="linenos"> 46</span><span class="sd">        batched runs, where ``H_stop &lt;= horizon`` if early stopping</span>
<span class="linenos"> 47</span><span class="sd">        occurred.</span>
<span class="linenos"> 48</span>
<span class="linenos"> 49</span><span class="sd">    Examples</span>
<span class="linenos"> 50</span><span class="sd">    --------</span>
<span class="linenos"> 51</span><span class="sd">    Scalar simulation:</span>
<span class="linenos"> 52</span><span class="sd">    </span>
<span class="linenos"> 53</span><span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="linenos"> 54</span><span class="sd">    &gt;&gt;&gt; x0 = np.array([1.0, 0.0])</span>
<span class="linenos"> 55</span><span class="sd">    &gt;&gt;&gt; u = np.array([0.1, 0.2])</span>
<span class="linenos"> 56</span><span class="sd">    &gt;&gt;&gt; result = simulate(x0, u, 0.1)</span>
<span class="linenos"> 57</span><span class="sd">    &gt;&gt;&gt; result.shape</span>
<span class="linenos"> 58</span><span class="sd">    (3, 2)</span>
<span class="linenos"> 59</span><span class="sd">    &gt;&gt;&gt; result[0]  # initial state</span>
<span class="linenos"> 60</span><span class="sd">    array([1., 0.])</span>
<span class="linenos"> 61</span><span class="sd">    </span>
<span class="linenos"> 62</span><span class="sd">    Batch simulation with early stopping:</span>
<span class="linenos"> 63</span><span class="sd">    </span>
<span class="linenos"> 64</span><span class="sd">    &gt;&gt;&gt; x0_batch = np.array([[1.0, 0.0], [2.0, 1.0]])  </span>
<span class="linenos"> 65</span><span class="sd">    &gt;&gt;&gt; u_batch = np.array([[0.1, 0.2], [0.3, 0.4]])</span>
<span class="linenos"> 66</span><span class="sd">    &gt;&gt;&gt; stop_fn = lambda x: np.sum(x**2) &gt; 10.0</span>
<span class="linenos"> 67</span><span class="sd">    &gt;&gt;&gt; result = simulate(x0_batch, u_batch, 0.1, stop_fn=stop_fn)</span>
<span class="linenos"> 68</span><span class="sd">    &gt;&gt;&gt; result.shape[0] == 2  # batch size preserved</span>
<span class="linenos"> 69</span><span class="sd">    True</span>
<span class="linenos"> 70</span><span class="sd">    &gt;&gt;&gt; result.shape[1] &lt;= 3  # may be truncated due to early stop</span>
<span class="linenos"> 71</span><span class="sd">    True</span>
<span class="linenos"> 72</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 73</span>    <span class="c1"># Convert state to array and normalise batch dimension</span>
<span class="linenos"> 74</span>    <span class="c1"># MEMORY OPTIMIZATION: asarray creates view when input is already ndarray with correct dtype</span>
<span class="linenos"> 75</span>    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">initial_state</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos"> 76</span>    <span class="c1"># Determine if batch: ndim &gt; 1 implies (B, D)</span>
<span class="linenos"> 77</span>    <span class="n">batch_mode</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span>
<span class="linenos"> 78</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">batch_mode</span><span class="p">:</span>
<span class="linenos"> 79</span>        <span class="n">x_b</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
<span class="linenos"> 80</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 81</span>        <span class="n">x_b</span> <span class="o">=</span> <span class="n">x</span>
<span class="linenos"> 82</span>
<span class="linenos"> 83</span>    <span class="c1"># Convert controls to array and infer horizon</span>
<span class="linenos"> 84</span>    <span class="c1"># MEMORY OPTIMIZATION: asarray creates view when input is already ndarray with correct dtype</span>
<span class="linenos"> 85</span>    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">control_inputs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos"> 86</span>    <span class="c1"># If horizon is not provided, infer from the length of u along its first time axis</span>
<span class="linenos"> 87</span>    <span class="k">if</span> <span class="n">horizon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 88</span>        <span class="c1"># For shapes (H,) or (H,U) we treat the first dimension as time</span>
<span class="linenos"> 89</span>        <span class="c1"># For shapes (B,H) or (B,H,U) we use the second dimension</span>
<span class="linenos"> 90</span>        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos"> 91</span>            <span class="n">H</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos"> 92</span>        <span class="k">elif</span> <span class="ow">not</span> <span class="n">batch_mode</span><span class="p">:</span>
<span class="linenos"> 93</span>            <span class="n">H</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 94</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 95</span>            <span class="n">H</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos"> 96</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 97</span>        <span class="n">H</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">horizon</span><span class="p">)</span>
<span class="linenos"> 98</span>
<span class="linenos"> 99</span>    <span class="c1"># Prepare output array with maximum possible horizon; will truncate on early stop</span>
<span class="linenos">100</span>    <span class="n">n_batches</span> <span class="o">=</span> <span class="n">x_b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">101</span>    <span class="n">state_dim</span> <span class="o">=</span> <span class="n">x_b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">102</span>    <span class="n">states</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">H</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">103</span>    <span class="n">states</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">x_b</span>
<span class="linenos">104</span>    <span class="n">t</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>
<span class="linenos">105</span>
<span class="linenos">106</span>    <span class="c1"># If no explicit energy or bounds limits were provided, attempt to</span>
<span class="linenos">107</span>    <span class="c1"># retrieve them from the global configuration.  The config object may</span>
<span class="linenos">108</span>    <span class="c1"># expose ``simulation.safety`` with optional ``energy`` and ``bounds``</span>
<span class="linenos">109</span>    <span class="c1"># attributes.  When present these values are used as defaults for</span>
<span class="linenos">110</span>    <span class="c1"># the corresponding guard limits.  This lookup is performed once at</span>
<span class="linenos">111</span>    <span class="c1"># the start of the simulation to avoid repeated attribute access in</span>
<span class="linenos">112</span>    <span class="c1"># the inner loop.</span>
<span class="linenos">113</span>    <span class="k">if</span> <span class="n">energy_limits</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">state_bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">114</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">115</span>            <span class="n">sim_cfg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">116</span>            <span class="n">safety_cfg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sim_cfg</span><span class="p">,</span> <span class="s2">&quot;safety&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">117</span>            <span class="k">if</span> <span class="n">safety_cfg</span><span class="p">:</span>
<span class="linenos">118</span>                <span class="c1"># Populate defaults only if not explicitly provided</span>
<span class="linenos">119</span>                <span class="k">if</span> <span class="n">energy_limits</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">safety_cfg</span><span class="p">,</span> <span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">120</span>                    <span class="k">try</span><span class="p">:</span>
<span class="linenos">121</span>                        <span class="n">energy_limits</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">safety_cfg</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
<span class="linenos">122</span>                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">123</span>                        <span class="n">energy_limits</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">124</span>                <span class="k">if</span> <span class="n">state_bounds</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">safety_cfg</span><span class="p">,</span> <span class="s2">&quot;bounds&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">125</span>                    <span class="k">try</span><span class="p">:</span>
<span class="linenos">126</span>                        <span class="n">lower</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">safety_cfg</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
<span class="linenos">127</span>                        <span class="n">upper</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">safety_cfg</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
<span class="linenos">128</span>                        <span class="n">state_bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
<span class="linenos">129</span>                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">130</span>                        <span class="n">state_bounds</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">131</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">132</span>            <span class="c1"># If config is not available or lacks expected structure, ignore</span>
<span class="linenos">133</span>            <span class="k">pass</span>
<span class="linenos">134</span>
<span class="linenos">135</span>    <span class="c1"># Iterate through time steps</span>
<span class="linenos">136</span>    <span class="n">stop_index</span> <span class="o">=</span> <span class="n">H</span>
<span class="linenos">137</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">H</span><span class="p">):</span>
<span class="linenos">138</span>        <span class="c1"># Extract control input for this time step, broadcasting batch dimension</span>
<span class="linenos">139</span>        <span class="k">if</span> <span class="n">batch_mode</span><span class="p">:</span>
<span class="linenos">140</span>            <span class="c1"># u shape could be (B,H,U) or (H,U) or (H,) or (B,H)</span>
<span class="linenos">141</span>            <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
<span class="linenos">142</span>                <span class="c1"># Handle case where horizon &gt; control sequence length</span>
<span class="linenos">143</span>                <span class="n">control_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">144</span>                <span class="n">u_i</span> <span class="o">=</span> <span class="n">u</span><span class="p">[:,</span> <span class="n">control_idx</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
<span class="linenos">145</span>            <span class="k">elif</span> <span class="n">u</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos">146</span>                <span class="c1"># Could be (B,H) or (H,U)</span>
<span class="linenos">147</span>                <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">n_batches</span> <span class="ow">and</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">148</span>                    <span class="c1"># (B,H) format - use last available control if i exceeds length</span>
<span class="linenos">149</span>                    <span class="n">control_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">150</span>                    <span class="n">u_i</span> <span class="o">=</span> <span class="n">u</span><span class="p">[:,</span> <span class="n">control_idx</span><span class="p">]</span>
<span class="linenos">151</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">152</span>                    <span class="c1"># (H,U) broadcast across batches</span>
<span class="linenos">153</span>                    <span class="n">control_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">154</span>                    <span class="n">u_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">control_idx</span><span class="p">],</span> <span class="p">(</span><span class="n">n_batches</span><span class="p">,)</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="n">control_idx</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="linenos">155</span>            <span class="k">elif</span> <span class="n">u</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">156</span>                <span class="c1"># Scalar control input per step</span>
<span class="linenos">157</span>                <span class="n">control_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">158</span>                <span class="n">u_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">control_idx</span><span class="p">],</span> <span class="p">(</span><span class="n">n_batches</span><span class="p">,))</span>
<span class="linenos">159</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">160</span>                <span class="n">control_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">161</span>                <span class="n">u_i</span> <span class="o">=</span> <span class="n">u</span><span class="p">[:,</span> <span class="n">control_idx</span><span class="p">]</span>
<span class="linenos">162</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">163</span>            <span class="c1"># Non‑batch: shapes (H,) or (H,U) or scalar</span>
<span class="linenos">164</span>            <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">165</span>                <span class="c1"># Scalar control input - use same value for all steps</span>
<span class="linenos">166</span>                <span class="n">u_i</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="linenos">167</span>            <span class="k">elif</span> <span class="n">u</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">168</span>                <span class="n">control_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">169</span>                <span class="n">u_i</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="n">control_idx</span><span class="p">]</span>
<span class="linenos">170</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">171</span>                <span class="n">control_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">172</span>                <span class="n">u_i</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="n">control_idx</span><span class="p">]</span>
<span class="linenos">173</span>        <span class="c1"># Advance one step using the router</span>
<span class="linenos">174</span>        <span class="n">x_next</span> <span class="o">=</span> <span class="n">_step_fn</span><span class="p">(</span><span class="n">x_b</span><span class="p">,</span> <span class="n">u_i</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
<span class="linenos">175</span>        <span class="c1"># Post‑step guards</span>
<span class="linenos">176</span>        <span class="n">_guard_no_nan</span><span class="p">(</span><span class="n">x_next</span><span class="p">,</span> <span class="n">step_idx</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
<span class="linenos">177</span>        <span class="k">if</span> <span class="n">energy_limits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">178</span>            <span class="n">limits</span> <span class="o">=</span> <span class="n">energy_limits</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">energy_limits</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">energy_limits</span><span class="p">)}</span>
<span class="linenos">179</span>            <span class="n">_guard_energy</span><span class="p">(</span><span class="n">x_next</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>
<span class="linenos">180</span>        <span class="k">if</span> <span class="n">state_bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">181</span>            <span class="n">_guard_bounds</span><span class="p">(</span><span class="n">x_next</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">state_bounds</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span> <span class="o">+</span> <span class="n">dt</span><span class="p">)</span>
<span class="linenos">182</span>        <span class="c1"># Record and update state</span>
<span class="linenos">183</span>        <span class="n">states</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">x_next</span>
<span class="linenos">184</span>        <span class="n">x_b</span> <span class="o">=</span> <span class="n">x_next</span>
<span class="linenos">185</span>        <span class="n">t</span> <span class="o">+=</span> <span class="n">dt</span>
<span class="linenos">186</span>        <span class="c1"># Early stop check: call predicate on batch or scalar state</span>
<span class="linenos">187</span>        <span class="k">if</span> <span class="n">stop_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">188</span>            <span class="c1"># Evaluate stop predicate on each batch element; stop if any returns True</span>
<span class="linenos">189</span>            <span class="k">if</span> <span class="n">batch_mode</span><span class="p">:</span>
<span class="linenos">190</span>                <span class="n">stop_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">bool</span><span class="p">(</span><span class="n">stop_fn</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">x_b</span><span class="p">])</span>
<span class="linenos">191</span>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">stop_mask</span><span class="p">):</span>
<span class="linenos">192</span>                    <span class="n">stop_index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos">193</span>                    <span class="k">break</span>
<span class="linenos">194</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">195</span>                <span class="k">if</span> <span class="n">stop_fn</span><span class="p">(</span><span class="n">x_b</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x_b</span><span class="p">,</span> <span class="s2">&quot;squeeze&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">x_b</span><span class="p">):</span>
<span class="linenos">196</span>                    <span class="n">stop_index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos">197</span>                    <span class="k">break</span>
<span class="linenos">198</span>
<span class="linenos">199</span>    <span class="c1"># Pre‑emit guards on the final state (or truncated state)</span>
<span class="linenos">200</span>    <span class="n">_guard_no_nan</span><span class="p">(</span><span class="n">x_b</span><span class="p">,</span> <span class="n">step_idx</span><span class="o">=</span><span class="n">stop_index</span><span class="p">)</span>
<span class="linenos">201</span>    <span class="k">if</span> <span class="n">energy_limits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">202</span>        <span class="n">_guard_energy</span><span class="p">(</span><span class="n">x_b</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">energy_limits</span><span class="p">)})</span>
<span class="linenos">203</span>    <span class="k">if</span> <span class="n">state_bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">204</span>        <span class="n">_guard_bounds</span><span class="p">(</span><span class="n">x_b</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">state_bounds</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
<span class="linenos">205</span>
<span class="linenos">206</span>    <span class="c1"># Truncate output on early stop</span>
<span class="linenos">207</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">states</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">stop_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
<span class="linenos">208</span>    <span class="c1"># Return squeezed array for scalar runs</span>
<span class="linenos">209</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">batch_mode</span><span class="p">:</span>
<span class="linenos">210</span>        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">211</span>    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="simulate-system-batch">
<h3><code class="docutils literal notranslate"><span class="pre">simulate_system_batch()</span></code><a class="headerlink" href="#simulate-system-batch" title="Link to this heading">¶</a></h3>
<p>Vectorised batch simulation of multiple controllers.</p>
<p>This function wraps <code class="docutils literal notranslate"><span class="pre">run_simulation</span></code> to simultaneously simulate a batch
of controllers with distinct gain vectors (<code class="docutils literal notranslate"><span class="pre">particles</span></code>).  It returns
time, state, control and sliding-surface arrays for the entire batch.
Optional early stopping is available: once the magnitude of the sliding
surface <code class="docutils literal notranslate"><span class="pre">sigma</span></code> falls below <code class="docutils literal notranslate"><span class="pre">convergence_tol</span></code> for all particles (after
a grace period), integration halts early and the outputs are truncated.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">params_list</span></code> is provided, the simulation is repeated for each
element in the list.  The return value is then a list of results, one per
parameter set.  For backward compatibility, the dynamics model is
determined internally by the controller factory; perturbed physics
parameters are ignored and results are replicated across the list.</p>
</section>
</section>
<section id="id1">
<h2>Parameters<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h2>
<p>controller_factory : callable
Factory <code class="docutils literal notranslate"><span class="pre">controller_factory(p)</span></code> that returns a controller given a
gain vector <code class="docutils literal notranslate"><span class="pre">p</span></code>.  The returned controller must expose a
<code class="docutils literal notranslate"><span class="pre">dynamics_model</span></code> attribute defining the system dynamics.
particles : array-like
Array of shape <code class="docutils literal notranslate"><span class="pre">(B,</span> <span class="pre">G)</span></code> where each row contains a gain vector for
one particle.  A single particle may be provided as shape <code class="docutils literal notranslate"><span class="pre">(G,)</span></code>.
sim_time : float
Total simulation duration (seconds).
dt : float
Timestep for integration (seconds).
u_max : float, optional
Control saturation limit.  Overrides controller-specific <code class="docutils literal notranslate"><span class="pre">max_force</span></code>.
seed : int, optional
Deprecated.  Ignored; retained for signature compatibility.
params_list : iterable, optional
Optional list of physics parameter objects.  When provided, the
simulation is repeated for each element.  The current implementation
ignores these parameters and replicates the base results.
initial_state : array-like, optional
Initial state(s) for the batch.  If <code class="docutils literal notranslate"><span class="pre">None</span></code>, a zero state is used.
If a 1D array of length <code class="docutils literal notranslate"><span class="pre">D</span></code> is provided, it is broadcast across all
particles.  If a 2D array of shape <code class="docutils literal notranslate"><span class="pre">(B,</span> <span class="pre">D)</span></code> is provided, it is used
directly.
convergence_tol : float, optional
Threshold for sliding-surface convergence.  When provided and
positive, the integration stops once <code class="docutils literal notranslate"><span class="pre">max(|sigma|)</span> <span class="pre">&lt;</span> <span class="pre">convergence_tol</span></code>
across all particles (after the grace period).
grace_period : float, optional
Duration (seconds) to wait before checking the convergence criterion.
rng : numpy.random.Generator, optional
Unused in this implementation.  Present for API compatibility.</p>
</section>
<section id="id2">
<h2>Returns<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h2>
<p>If <code class="docutils literal notranslate"><span class="pre">params_list</span></code> is not provided, returns a tuple <code class="docutils literal notranslate"><span class="pre">(t,</span> <span class="pre">x_b,</span> <span class="pre">u_b,</span> <span class="pre">sigma_b)</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">t</span></code>: ndarray of shape <code class="docutils literal notranslate"><span class="pre">(N+1,)</span></code> of time points</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">x_b</span></code>: ndarray of shape <code class="docutils literal notranslate"><span class="pre">(B,</span> <span class="pre">N+1,</span> <span class="pre">D)</span></code> of states</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">u_b</span></code>: ndarray of shape <code class="docutils literal notranslate"><span class="pre">(B,</span> <span class="pre">N)</span></code> of controls</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sigma_b</span></code>: ndarray of shape <code class="docutils literal notranslate"><span class="pre">(B,</span> <span class="pre">N)</span></code> of sliding-surface values</p></li>
</ul>
<p>If <code class="docutils literal notranslate"><span class="pre">params_list</span></code> is provided, returns a list of such tuples (one per
element in <code class="docutils literal notranslate"><span class="pre">params_list</span></code>).</p>
<section id="id3">
<h3>Source Code<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="k">def</span><span class="w"> </span><span class="nf">simulate_system_batch</span><span class="p">(</span>
<span class="linenos">  2</span>    <span class="o">*</span><span class="p">,</span>
<span class="linenos">  3</span>    <span class="n">controller_factory</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Any</span><span class="p">],</span>
<span class="linenos">  4</span>    <span class="n">particles</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="linenos">  5</span>    <span class="n">sim_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="linenos">  6</span>    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="linenos">  7</span>    <span class="n">u_max</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">  8</span>    <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">  9</span>    <span class="n">params_list</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 10</span>    <span class="n">initial_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 11</span>    <span class="n">convergence_tol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 12</span>    <span class="n">grace_period</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="linenos"> 13</span>    <span class="n">rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 14</span>    <span class="o">**</span><span class="n">_kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="linenos"> 15</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="linenos"> 16</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Vectorised batch simulation of multiple controllers.</span>
<span class="linenos"> 17</span>
<span class="linenos"> 18</span><span class="sd">    This function wraps ``run_simulation`` to simultaneously simulate a batch</span>
<span class="linenos"> 19</span><span class="sd">    of controllers with distinct gain vectors (``particles``).  It returns</span>
<span class="linenos"> 20</span><span class="sd">    time, state, control and sliding-surface arrays for the entire batch.</span>
<span class="linenos"> 21</span><span class="sd">    Optional early stopping is available: once the magnitude of the sliding</span>
<span class="linenos"> 22</span><span class="sd">    surface ``sigma`` falls below ``convergence_tol`` for all particles (after</span>
<span class="linenos"> 23</span><span class="sd">    a grace period), integration halts early and the outputs are truncated.</span>
<span class="linenos"> 24</span>
<span class="linenos"> 25</span><span class="sd">    When ``params_list`` is provided, the simulation is repeated for each</span>
<span class="linenos"> 26</span><span class="sd">    element in the list.  The return value is then a list of results, one per</span>
<span class="linenos"> 27</span><span class="sd">    parameter set.  For backward compatibility, the dynamics model is</span>
<span class="linenos"> 28</span><span class="sd">    determined internally by the controller factory; perturbed physics</span>
<span class="linenos"> 29</span><span class="sd">    parameters are ignored and results are replicated across the list.</span>
<span class="linenos"> 30</span>
<span class="linenos"> 31</span><span class="sd">    Parameters</span>
<span class="linenos"> 32</span><span class="sd">    ----------</span>
<span class="linenos"> 33</span><span class="sd">    controller_factory : callable</span>
<span class="linenos"> 34</span><span class="sd">        Factory ``controller_factory(p)`` that returns a controller given a</span>
<span class="linenos"> 35</span><span class="sd">        gain vector ``p``.  The returned controller must expose a</span>
<span class="linenos"> 36</span><span class="sd">        ``dynamics_model`` attribute defining the system dynamics.</span>
<span class="linenos"> 37</span><span class="sd">    particles : array-like</span>
<span class="linenos"> 38</span><span class="sd">        Array of shape ``(B, G)`` where each row contains a gain vector for</span>
<span class="linenos"> 39</span><span class="sd">        one particle.  A single particle may be provided as shape ``(G,)``.</span>
<span class="linenos"> 40</span><span class="sd">    sim_time : float</span>
<span class="linenos"> 41</span><span class="sd">        Total simulation duration (seconds).</span>
<span class="linenos"> 42</span><span class="sd">    dt : float</span>
<span class="linenos"> 43</span><span class="sd">        Timestep for integration (seconds).</span>
<span class="linenos"> 44</span><span class="sd">    u_max : float, optional</span>
<span class="linenos"> 45</span><span class="sd">        Control saturation limit.  Overrides controller-specific ``max_force``.</span>
<span class="linenos"> 46</span><span class="sd">    seed : int, optional</span>
<span class="linenos"> 47</span><span class="sd">        Deprecated.  Ignored; retained for signature compatibility.</span>
<span class="linenos"> 48</span><span class="sd">    params_list : iterable, optional</span>
<span class="linenos"> 49</span><span class="sd">        Optional list of physics parameter objects.  When provided, the</span>
<span class="linenos"> 50</span><span class="sd">        simulation is repeated for each element.  The current implementation</span>
<span class="linenos"> 51</span><span class="sd">        ignores these parameters and replicates the base results.</span>
<span class="linenos"> 52</span><span class="sd">    initial_state : array-like, optional</span>
<span class="linenos"> 53</span><span class="sd">        Initial state(s) for the batch.  If ``None``, a zero state is used.</span>
<span class="linenos"> 54</span><span class="sd">        If a 1D array of length ``D`` is provided, it is broadcast across all</span>
<span class="linenos"> 55</span><span class="sd">        particles.  If a 2D array of shape ``(B, D)`` is provided, it is used</span>
<span class="linenos"> 56</span><span class="sd">        directly.</span>
<span class="linenos"> 57</span><span class="sd">    convergence_tol : float, optional</span>
<span class="linenos"> 58</span><span class="sd">        Threshold for sliding-surface convergence.  When provided and</span>
<span class="linenos"> 59</span><span class="sd">        positive, the integration stops once ``max(|sigma|) &lt; convergence_tol``</span>
<span class="linenos"> 60</span><span class="sd">        across all particles (after the grace period).</span>
<span class="linenos"> 61</span><span class="sd">    grace_period : float, optional</span>
<span class="linenos"> 62</span><span class="sd">        Duration (seconds) to wait before checking the convergence criterion.</span>
<span class="linenos"> 63</span><span class="sd">    rng : numpy.random.Generator, optional</span>
<span class="linenos"> 64</span><span class="sd">        Unused in this implementation.  Present for API compatibility.</span>
<span class="linenos"> 65</span>
<span class="linenos"> 66</span><span class="sd">    Returns</span>
<span class="linenos"> 67</span><span class="sd">    -------</span>
<span class="linenos"> 68</span><span class="sd">    If ``params_list`` is not provided, returns a tuple ``(t, x_b, u_b, sigma_b)``:</span>
<span class="linenos"> 69</span><span class="sd">    </span>
<span class="linenos"> 70</span><span class="sd">    - ``t``: ndarray of shape ``(N+1,)`` of time points</span>
<span class="linenos"> 71</span><span class="sd">    - ``x_b``: ndarray of shape ``(B, N+1, D)`` of states</span>
<span class="linenos"> 72</span><span class="sd">    - ``u_b``: ndarray of shape ``(B, N)`` of controls</span>
<span class="linenos"> 73</span><span class="sd">    - ``sigma_b``: ndarray of shape ``(B, N)`` of sliding-surface values</span>
<span class="linenos"> 74</span>
<span class="linenos"> 75</span><span class="sd">    If ``params_list`` is provided, returns a list of such tuples (one per</span>
<span class="linenos"> 76</span><span class="sd">    element in ``params_list``).</span>
<span class="linenos"> 77</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 78</span>    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_np</span>  <span class="c1"># local import to avoid polluting namespace</span>
<span class="linenos"> 79</span>    <span class="c1"># Convert particles to array</span>
<span class="linenos"> 80</span>    <span class="c1"># MEMORY OPTIMIZATION: asarray creates view when input is already ndarray with correct dtype</span>
<span class="linenos"> 81</span>    <span class="n">part_arr</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos"> 82</span>    <span class="k">if</span> <span class="n">part_arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos"> 83</span>        <span class="n">part_arr</span> <span class="o">=</span> <span class="n">part_arr</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
<span class="linenos"> 84</span>    <span class="n">B</span><span class="p">,</span> <span class="n">G</span> <span class="o">=</span> <span class="n">part_arr</span><span class="o">.</span><span class="n">shape</span>
<span class="linenos"> 85</span>    <span class="c1"># Determine number of steps</span>
<span class="linenos"> 86</span>    <span class="n">dt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
<span class="linenos"> 87</span>    <span class="n">sim_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sim_time</span><span class="p">)</span>
<span class="linenos"> 88</span>    <span class="n">H</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">sim_time</span> <span class="o">/</span> <span class="n">dt</span><span class="p">))</span> <span class="k">if</span> <span class="n">sim_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
<span class="linenos"> 89</span>    <span class="c1"># Instantiate controllers for each particle</span>
<span class="linenos"> 90</span>    <span class="n">controllers</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 91</span>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
<span class="linenos"> 92</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 93</span>            <span class="n">ctrl</span> <span class="o">=</span> <span class="n">controller_factory</span><span class="p">(</span><span class="n">part_arr</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
<span class="linenos"> 94</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos"> 95</span>            <span class="n">ctrl</span> <span class="o">=</span> <span class="n">controller_factory</span><span class="p">(</span><span class="n">part_arr</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
<span class="linenos"> 96</span>        <span class="n">controllers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ctrl</span><span class="p">)</span>
<span class="linenos"> 97</span>    <span class="c1"># Determine state dimension from first controller&#39;s dynamics model</span>
<span class="linenos"> 98</span>    <span class="k">if</span> <span class="n">initial_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 99</span>        <span class="c1"># Try to introspect state dimension</span>
<span class="linenos">100</span>        <span class="n">state_dim</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">101</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">102</span>            <span class="n">state_dim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">controllers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;state_dim&quot;</span><span class="p">))</span>
<span class="linenos">103</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">104</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">105</span>                <span class="n">state_dim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">controllers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;dynamics_model&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">state_dim</span><span class="p">)</span>
<span class="linenos">106</span>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">107</span>                <span class="n">state_dim</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># fall back to DIP dimension</span>
<span class="linenos">108</span>        <span class="n">init_b</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">B</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">109</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">110</span>        <span class="c1"># MEMORY OPTIMIZATION: asarray creates view when input is already ndarray with correct dtype</span>
<span class="linenos">111</span>        <span class="n">init</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">initial_state</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">112</span>        <span class="k">if</span> <span class="n">init</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">113</span>            <span class="c1"># broadcast across batch</span>
<span class="linenos">114</span>            <span class="c1"># MEMORY OPTIMIZATION: Must copy broadcast_to result (returns view that needs writeable buffer)</span>
<span class="linenos">115</span>            <span class="n">init_b</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">init</span><span class="p">,</span> <span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">116</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">117</span>            <span class="c1"># MEMORY OPTIMIZATION: Copy only when necessary (will be written to)</span>
<span class="linenos">118</span>            <span class="n">init_b</span> <span class="o">=</span> <span class="n">init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">119</span>    <span class="c1"># Preallocate outputs</span>
<span class="linenos">120</span>    <span class="n">t_arr</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">121</span>    <span class="n">x_b</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">B</span><span class="p">,</span> <span class="n">H</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">init_b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">122</span>    <span class="n">u_b</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">B</span><span class="p">,</span> <span class="n">H</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">123</span>    <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">B</span><span class="p">,</span> <span class="n">H</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">124</span>    <span class="n">x_b</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">init_b</span>
<span class="linenos">125</span>    <span class="c1"># Convergence parameters</span>
<span class="linenos">126</span>    <span class="n">check_convergence</span> <span class="o">=</span> <span class="p">(</span><span class="n">convergence_tol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">convergence_tol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos">127</span>    <span class="n">conv_tol</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">convergence_tol</span><span class="p">)</span> <span class="k">if</span> <span class="n">convergence_tol</span> <span class="k">else</span> <span class="mf">0.0</span>
<span class="linenos">128</span>    <span class="n">grace_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">grace_period</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span><span class="p">))</span> <span class="k">if</span> <span class="n">grace_period</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
<span class="linenos">129</span>    <span class="c1"># Per-controller state and history</span>
<span class="linenos">130</span>    <span class="n">state_vars</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span>
<span class="linenos">131</span>    <span class="n">histories</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span>
<span class="linenos">132</span>    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">controllers</span><span class="p">):</span>
<span class="linenos">133</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">134</span>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="s2">&quot;initialize_state&quot;</span><span class="p">):</span>
<span class="linenos">135</span>                <span class="n">state_vars</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">initialize_state</span><span class="p">()</span>  <span class="c1"># type: ignore[assignment]</span>
<span class="linenos">136</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">137</span>            <span class="c1"># OK: initialize_state is optional - graceful fallback to None</span>
<span class="linenos">138</span>            <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="linenos">139</span>            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<span class="linenos">140</span>                <span class="sa">f</span><span class="s2">&quot;Controller </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ctrl</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">) doesn&#39;t support state initialization: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">141</span>            <span class="p">)</span>
<span class="linenos">142</span>            <span class="n">state_vars</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">143</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">144</span>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="s2">&quot;initialize_history&quot;</span><span class="p">):</span>
<span class="linenos">145</span>                <span class="n">histories</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">initialize_history</span><span class="p">()</span>  <span class="c1"># type: ignore[assignment]</span>
<span class="linenos">146</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">147</span>            <span class="c1"># OK: initialize_history is optional - graceful fallback to None</span>
<span class="linenos">148</span>            <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="linenos">149</span>            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<span class="linenos">150</span>                <span class="sa">f</span><span class="s2">&quot;Controller </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ctrl</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">) doesn&#39;t support history initialization: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">151</span>            <span class="p">)</span>
<span class="linenos">152</span>            <span class="n">histories</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">153</span>    <span class="c1"># Determine per-particle saturation limits</span>
<span class="linenos">154</span>    <span class="n">u_limits</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">155</span>    <span class="k">if</span> <span class="n">u_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">156</span>        <span class="n">u_limits</span><span class="p">[:]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">u_max</span><span class="p">)</span>
<span class="linenos">157</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">158</span>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">controllers</span><span class="p">):</span>
<span class="linenos">159</span>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="s2">&quot;max_force&quot;</span><span class="p">):</span>
<span class="linenos">160</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos">161</span>                    <span class="n">u_limits</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="s2">&quot;max_force&quot;</span><span class="p">))</span>
<span class="linenos">162</span>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">163</span>                    <span class="n">u_limits</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">inf</span>
<span class="linenos">164</span>    <span class="c1"># Simulation loop</span>
<span class="linenos">165</span>    <span class="c1"># We will reuse dynamics_model from each controller</span>
<span class="linenos">166</span>    <span class="n">times</span> <span class="o">=</span> <span class="n">t_arr</span>
<span class="linenos">167</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">H</span><span class="p">):</span>
<span class="linenos">168</span>        <span class="n">t_now</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">dt</span>
<span class="linenos">169</span>        <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_now</span>
<span class="linenos">170</span>        <span class="c1"># Compute controls and sigma for each particle</span>
<span class="linenos">171</span>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">controllers</span><span class="p">):</span>
<span class="linenos">172</span>            <span class="n">x_curr</span> <span class="o">=</span> <span class="n">x_b</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
<span class="linenos">173</span>            <span class="c1"># Use compute_control if available</span>
<span class="linenos">174</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">175</span>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="s2">&quot;compute_control&quot;</span><span class="p">):</span>
<span class="linenos">176</span>                    <span class="n">ret</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">compute_control</span><span class="p">(</span><span class="n">x_curr</span><span class="p">,</span> <span class="n">state_vars</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">histories</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
<span class="linenos">177</span>                    <span class="c1"># ret may be namedtuple or tuple</span>
<span class="linenos">178</span>                    <span class="k">try</span><span class="p">:</span>
<span class="linenos">179</span>                        <span class="n">u_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">180</span>                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">181</span>                        <span class="n">u_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="linenos">182</span>                    <span class="c1"># update state and history</span>
<span class="linenos">183</span>                    <span class="k">try</span><span class="p">:</span>
<span class="linenos">184</span>                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos">185</span>                            <span class="n">state_vars</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">186</span>                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
<span class="linenos">187</span>                            <span class="n">histories</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">188</span>                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">189</span>                        <span class="k">pass</span>
<span class="linenos">190</span>                    <span class="c1"># extract sigma if available</span>
<span class="linenos">191</span>                    <span class="n">sigma_val</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos">192</span>                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="s2">&quot;sigma&quot;</span><span class="p">):</span>
<span class="linenos">193</span>                        <span class="n">sigma_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">sigma</span><span class="p">)</span>
<span class="linenos">194</span>                    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
<span class="linenos">195</span>                        <span class="n">sigma_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="linenos">196</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">197</span>                    <span class="n">u_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ctrl</span><span class="p">(</span><span class="n">t_now</span><span class="p">,</span> <span class="n">x_curr</span><span class="p">))</span>
<span class="linenos">198</span>                    <span class="n">sigma_val</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos">199</span>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">200</span>                <span class="c1"># CRITICAL FIX: Don&#39;t catch Warning exceptions (pytest may convert warnings to errors)</span>
<span class="linenos">201</span>                <span class="c1"># Re-raise warnings so they propagate normally and don&#39;t terminate simulation</span>
<span class="linenos">202</span>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">):</span>
<span class="linenos">203</span>                    <span class="k">raise</span>
<span class="linenos">204</span>                <span class="c1"># On actual error computing control, treat as instability and stop</span>
<span class="linenos">205</span>                <span class="n">H</span> <span class="o">=</span> <span class="n">i</span>
<span class="linenos">206</span>                <span class="n">u_b</span> <span class="o">=</span> <span class="n">u_b</span><span class="p">[:,</span> <span class="p">:</span><span class="n">i</span><span class="p">]</span>
<span class="linenos">207</span>                <span class="n">x_b</span> <span class="o">=</span> <span class="n">x_b</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
<span class="linenos">208</span>                <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">sigma_b</span><span class="p">[:,</span> <span class="p">:</span><span class="n">i</span><span class="p">]</span>
<span class="linenos">209</span>                <span class="n">times</span> <span class="o">=</span> <span class="n">times</span><span class="p">[:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
<span class="linenos">210</span>                <span class="c1"># Attach histories</span>
<span class="linenos">211</span>                <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">controllers</span><span class="p">):</span>
<span class="linenos">212</span>                    <span class="n">hist</span> <span class="o">=</span> <span class="n">histories</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
<span class="linenos">213</span>                    <span class="k">if</span> <span class="n">hist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">214</span>                        <span class="k">try</span><span class="p">:</span>
<span class="linenos">215</span>                            <span class="nb">setattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;_last_history&quot;</span><span class="p">,</span> <span class="n">hist</span><span class="p">)</span>
<span class="linenos">216</span>                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">217</span>                            <span class="c1"># OK: _last_history attachment is optional feature</span>
<span class="linenos">218</span>                            <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="linenos">219</span>                            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<span class="linenos">220</span>                                <span class="sa">f</span><span class="s2">&quot;Could not attach history to controller </span><span class="si">{</span><span class="n">jj</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">221</span>                            <span class="p">)</span>
<span class="linenos">222</span>                            <span class="c1"># Continue without history attachment</span>
<span class="linenos">223</span>                <span class="k">if</span> <span class="n">params_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">224</span>                    <span class="k">return</span> <span class="p">[(</span><span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">times</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x_b</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">u_b</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sigma_b</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">params_list</span><span class="p">]</span>
<span class="linenos">225</span>                <span class="k">return</span> <span class="n">times</span><span class="p">,</span> <span class="n">x_b</span><span class="p">,</span> <span class="n">u_b</span><span class="p">,</span> <span class="n">sigma_b</span>
<span class="linenos">226</span>            <span class="c1"># Saturate and store</span>
<span class="linenos">227</span>            <span class="n">limit</span> <span class="o">=</span> <span class="n">u_limits</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
<span class="linenos">228</span>            <span class="k">if</span> <span class="n">limit</span> <span class="o">&lt;</span> <span class="n">_np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
<span class="linenos">229</span>                <span class="k">if</span> <span class="n">u_val</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">:</span>
<span class="linenos">230</span>                    <span class="n">u_val</span> <span class="o">=</span> <span class="n">limit</span>
<span class="linenos">231</span>                <span class="k">elif</span> <span class="n">u_val</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">limit</span><span class="p">:</span>
<span class="linenos">232</span>                    <span class="n">u_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">limit</span>
<span class="linenos">233</span>            <span class="n">u_b</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_val</span>
<span class="linenos">234</span>            <span class="n">sigma_b</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_val</span>
<span class="linenos">235</span>        <span class="c1"># Step all particles forward using their dynamics model</span>
<span class="linenos">236</span>        <span class="n">early_stop</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">237</span>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">controllers</span><span class="p">):</span>
<span class="linenos">238</span>            <span class="n">dyn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="s2">&quot;dynamics_model&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">239</span>            <span class="k">if</span> <span class="n">dyn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">240</span>                <span class="c1"># If controller lacks dynamics_model, fall back to global step</span>
<span class="linenos">241</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos">242</span>                    <span class="n">x_next</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">x_b</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">u_b</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">dt</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
<span class="linenos">243</span>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">244</span>                    <span class="n">x_next</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">245</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">246</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos">247</span>                    <span class="n">x_next</span> <span class="o">=</span> <span class="n">dyn</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">x_b</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">u_b</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">dt</span><span class="p">)</span>
<span class="linenos">248</span>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">249</span>                    <span class="n">x_next</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">250</span>            <span class="k">if</span> <span class="n">x_next</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">251</span>                <span class="n">early_stop</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">252</span>                <span class="k">break</span>
<span class="linenos">253</span>            <span class="c1"># MEMORY OPTIMIZATION: asarray creates view when input is already ndarray with correct dtype</span>
<span class="linenos">254</span>            <span class="n">x_next_arr</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x_next</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">255</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">_np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x_next_arr</span><span class="p">)):</span>
<span class="linenos">256</span>                <span class="n">early_stop</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">257</span>                <span class="k">break</span>
<span class="linenos">258</span>            <span class="n">x_b</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_next_arr</span>
<span class="linenos">259</span>        <span class="k">if</span> <span class="n">early_stop</span><span class="p">:</span>
<span class="linenos">260</span>            <span class="c1"># truncate and exit</span>
<span class="linenos">261</span>            <span class="n">H</span> <span class="o">=</span> <span class="n">i</span>
<span class="linenos">262</span>            <span class="n">u_b</span> <span class="o">=</span> <span class="n">u_b</span><span class="p">[:,</span> <span class="p">:</span><span class="n">i</span><span class="p">]</span>
<span class="linenos">263</span>            <span class="n">x_b</span> <span class="o">=</span> <span class="n">x_b</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
<span class="linenos">264</span>            <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">sigma_b</span><span class="p">[:,</span> <span class="p">:</span><span class="n">i</span><span class="p">]</span>
<span class="linenos">265</span>            <span class="n">times</span> <span class="o">=</span> <span class="n">times</span><span class="p">[:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
<span class="linenos">266</span>            <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">controllers</span><span class="p">):</span>
<span class="linenos">267</span>                <span class="n">hist</span> <span class="o">=</span> <span class="n">histories</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
<span class="linenos">268</span>                <span class="k">if</span> <span class="n">hist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">269</span>                    <span class="k">try</span><span class="p">:</span>
<span class="linenos">270</span>                        <span class="nb">setattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;_last_history&quot;</span><span class="p">,</span> <span class="n">hist</span><span class="p">)</span>
<span class="linenos">271</span>                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">272</span>                        <span class="k">pass</span>
<span class="linenos">273</span>            <span class="k">if</span> <span class="n">params_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">274</span>                <span class="k">return</span> <span class="p">[(</span><span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">times</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x_b</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">u_b</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sigma_b</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">params_list</span><span class="p">]</span>
<span class="linenos">275</span>            <span class="k">return</span> <span class="n">times</span><span class="p">,</span> <span class="n">x_b</span><span class="p">,</span> <span class="n">u_b</span><span class="p">,</span> <span class="n">sigma_b</span>
<span class="linenos">276</span>        <span class="c1"># Early convergence check</span>
<span class="linenos">277</span>        <span class="k">if</span> <span class="n">check_convergence</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">grace_steps</span><span class="p">):</span>
<span class="linenos">278</span>            <span class="n">max_sigma</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sigma_b</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]))</span>
<span class="linenos">279</span>            <span class="k">if</span> <span class="n">max_sigma</span> <span class="o">&lt;</span> <span class="n">conv_tol</span><span class="p">:</span>
<span class="linenos">280</span>                <span class="n">H</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos">281</span>                <span class="n">u_b</span> <span class="o">=</span> <span class="n">u_b</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
<span class="linenos">282</span>                <span class="n">x_b</span> <span class="o">=</span> <span class="n">x_b</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
<span class="linenos">283</span>                <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">sigma_b</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
<span class="linenos">284</span>                <span class="n">times</span> <span class="o">=</span> <span class="n">times</span><span class="p">[:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
<span class="linenos">285</span>                <span class="c1"># copy histories</span>
<span class="linenos">286</span>                <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">controllers</span><span class="p">):</span>
<span class="linenos">287</span>                    <span class="n">hist</span> <span class="o">=</span> <span class="n">histories</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
<span class="linenos">288</span>                    <span class="k">if</span> <span class="n">hist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">289</span>                        <span class="k">try</span><span class="p">:</span>
<span class="linenos">290</span>                            <span class="nb">setattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;_last_history&quot;</span><span class="p">,</span> <span class="n">hist</span><span class="p">)</span>
<span class="linenos">291</span>                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">292</span>                            <span class="k">pass</span>
<span class="linenos">293</span>                <span class="k">if</span> <span class="n">params_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">294</span>                    <span class="k">return</span> <span class="p">[(</span><span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">times</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x_b</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">u_b</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sigma_b</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">params_list</span><span class="p">]</span>
<span class="linenos">295</span>                <span class="k">return</span> <span class="n">times</span><span class="p">,</span> <span class="n">x_b</span><span class="p">,</span> <span class="n">u_b</span><span class="p">,</span> <span class="n">sigma_b</span>
<span class="linenos">296</span>    <span class="c1"># Finalise times</span>
<span class="linenos">297</span>    <span class="n">times</span><span class="p">[</span><span class="n">H</span><span class="p">]</span> <span class="o">=</span> <span class="n">H</span> <span class="o">*</span> <span class="n">dt</span>
<span class="linenos">298</span>    <span class="c1"># attach histories on controllers</span>
<span class="linenos">299</span>    <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">controllers</span><span class="p">):</span>
<span class="linenos">300</span>        <span class="n">hist</span> <span class="o">=</span> <span class="n">histories</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
<span class="linenos">301</span>        <span class="k">if</span> <span class="n">hist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">302</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">303</span>                <span class="nb">setattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;_last_history&quot;</span><span class="p">,</span> <span class="n">hist</span><span class="p">)</span>
<span class="linenos">304</span>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">305</span>                <span class="k">pass</span>
<span class="linenos">306</span>    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">x_b</span><span class="p">,</span> <span class="n">u_b</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">)</span>
<span class="linenos">307</span>    <span class="k">if</span> <span class="n">params_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">308</span>        <span class="k">return</span> <span class="n">result</span>
<span class="linenos">309</span>    <span class="c1"># replicate results for each params entry</span>
<span class="linenos">310</span>    <span class="k">return</span> <span class="p">[(</span><span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">times</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x_b</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">u_b</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sigma_b</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">params_list</span><span class="p">]</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Link to this heading">¶</a></h2>
<p>This module imports:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">__future__</span> <span class="pre">import</span> <span class="pre">annotations</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">numpy</span> <span class="pre">as</span> <span class="pre">np</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">typing</span> <span class="pre">import</span> <span class="pre">Any,</span> <span class="pre">Callable,</span> <span class="pre">Optional,</span> <span class="pre">Tuple</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">.simulation_runner</span> <span class="pre">import</span> <span class="pre">step</span> <span class="pre">as</span> <span class="pre">_step_fn</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">..context.safety_guards</span> <span class="pre">import</span> <span class="pre">_guard_no_nan,</span> <span class="pre">_guard_energy,</span> <span class="pre">_guard_bounds</span></code></p></li>
</ul>
</section>
<section id="advanced-mathematical-theory">
<h2>Advanced Mathematical Theory<a class="headerlink" href="#advanced-mathematical-theory" title="Link to this heading">¶</a></h2>
<section id="batch-simulation">
<h3>Batch Simulation<a class="headerlink" href="#batch-simulation" title="Link to this heading">¶</a></h3>
<p><strong>Vectorized state evolution:</strong></p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\vec{X} = [\vec{x}^{(1)}, \vec{x}^{(2)}, \ldots, \vec{x}^{(B)}]^T \in \mathbb{R}^{B \times n}\]</div>
</div>
<p><strong>Batch integration:</strong></p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\vec{X}_{k+1} = \vec{X}_k + h \cdot \vec{F}(\vec{X}_k, \vec{U}_k, t_k)\]</div>
</div>
<p>where <span class="math notranslate nohighlight">\(\vec{F}\)</span> is vectorized dynamics.</p>
</section>
<section id="numba-jit-compilation">
<h3>Numba JIT Compilation<a class="headerlink" href="#numba-jit-compilation" title="Link to this heading">¶</a></h3>
<p><strong>Just-In-Time compilation:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">batch_integrate</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numba</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>  <span class="c1"># Parallel loop</span>
        <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">integrate_single</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dt</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X</span>
</pre></div>
</div>
<p><strong>Performance gain:</strong></p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\text{Speedup} = \frac{T_{\text{Python}}}{T_{\text{Numba}}} \approx 10-100\times\]</div>
</div>
</section>
<section id="memory-layout-optimization">
<h3>Memory Layout Optimization<a class="headerlink" href="#memory-layout-optimization" title="Link to this heading">¶</a></h3>
<p><strong>Cache-friendly memory access:</strong></p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\text{Stride}_1 \text{ (contiguous)} &lt; \text{Stride}_2 \text{ (non-contiguous)}\]</div>
</div>
<p><strong>Optimal array layout:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Good: C-contiguous</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>  <span class="c1"># Row-major</span>

<span class="c1"># Bad: Non-contiguous views</span>
<span class="n">X_bad</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">::</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Strided access</span>
</pre></div>
</div>
</section>
<section id="parallel-efficiency">
<h3>Parallel Efficiency<a class="headerlink" href="#parallel-efficiency" title="Link to this heading">¶</a></h3>
<p><strong>Amdahl’s Law:</strong></p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\text{Speedup} = \frac{1}{(1 - P) + \frac{P}{N_{\text{cores}}}}\]</div>
</div>
<p>where <span class="math notranslate nohighlight">\(P\)</span> is parallelizable fraction.</p>
</section>
</section>
<section id="architecture-diagram">
<h2>Architecture Diagram<a class="headerlink" href="#architecture-diagram" title="Link to this heading">¶</a></h2>
<div class="mermaid">
            graph TD
    A[Batch Initial States X_0] --&gt; B[Numba JIT Compilation]

    B --&gt; C[Parallel Thread Pool]
    C --&gt; D[Thread 1: X_1_]
    C --&gt; E[Thread 2: X_2_]
    C --&gt; F[Thread B: X_B_]

    D --&gt; G[Single Integration]
    E --&gt; G
    F --&gt; G

    G --&gt; H[Vectorized Dynamics]
    H --&gt; I[f_X, U, t_]

    I --&gt; J[Batch State Update]
    J --&gt; K[X_n+1 = X_n + h·F_·_]

    K --&gt; L{All Converged?}
    L --&gt;|No| C
    L --&gt;|Yes| M[Gather Results]

    M --&gt; N[Batch Trajectories]
    N --&gt; O[Statistics Computation]

    style B fill:#9cf
    style H fill:#ff9
    style N fill:#9f9
        </div></section>
<section id="usage-examples">
<h2>Usage Examples<a class="headerlink" href="#usage-examples" title="Link to this heading">¶</a></h2>
<section id="example-1-basic-simulation">
<h3>Example 1: Basic Simulation<a class="headerlink" href="#example-1-basic-simulation" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">src.simulation.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimulationEngine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.simulation.engines</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimulationRunner</span>

<span class="c1"># Initialize simulation engine</span>
<span class="n">runner</span> <span class="o">=</span> <span class="n">SimulationRunner</span><span class="p">(</span>
    <span class="n">controller</span><span class="o">=</span><span class="n">controller</span><span class="p">,</span>
    <span class="n">dynamics</span><span class="o">=</span><span class="n">dynamics</span><span class="p">,</span>
    <span class="n">integrator</span><span class="o">=</span><span class="s1">&#39;rk4&#39;</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.01</span>
<span class="p">)</span>

<span class="c1"># Run simulation</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">initial_state</span><span class="p">,</span>
    <span class="n">duration</span><span class="o">=</span><span class="mf">5.0</span>
<span class="p">)</span>

<span class="c1"># Extract trajectories</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">time</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">states</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">controls</span>
</pre></div>
</div>
</section>
<section id="example-2-adaptive-integration">
<h3>Example 2: Adaptive Integration<a class="headerlink" href="#example-2-adaptive-integration" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">src.simulation.integrators.adaptive</span><span class="w"> </span><span class="kn">import</span> <span class="n">AdaptiveRK45Integrator</span>

<span class="c1"># Create adaptive integrator</span>
<span class="n">integrator</span> <span class="o">=</span> <span class="n">AdaptiveRK45Integrator</span><span class="p">(</span>
    <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
    <span class="n">atol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span>
    <span class="n">max_step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">min_step</span><span class="o">=</span><span class="mf">1e-6</span>
<span class="p">)</span>

<span class="c1"># Simulate with automatic step size control</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">initial_state</span><span class="p">,</span>
    <span class="n">duration</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
    <span class="n">integrator</span><span class="o">=</span><span class="n">integrator</span>
<span class="p">)</span>

<span class="c1"># Check step size history</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Steps taken: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">time</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average dt: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">time</span><span class="p">))</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="example-3-batch-simulation-numba">
<h3>Example 3: Batch Simulation (Numba)<a class="headerlink" href="#example-3-batch-simulation-numba" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">src.simulation.engines</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_batch_simulation</span>

<span class="c1"># Define batch of initial conditions</span>
<span class="n">x0_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>  <span class="c1"># 100 initial states</span>

<span class="c1"># Vectorized batch simulation</span>
<span class="n">results_batch</span> <span class="o">=</span> <span class="n">run_batch_simulation</span><span class="p">(</span>
    <span class="n">controller</span><span class="o">=</span><span class="n">controller</span><span class="p">,</span>
    <span class="n">dynamics</span><span class="o">=</span><span class="n">dynamics</span><span class="p">,</span>
    <span class="n">x0_batch</span><span class="o">=</span><span class="n">x0_batch</span><span class="p">,</span>
    <span class="n">duration</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.01</span>
<span class="p">)</span>

<span class="c1"># Compute batch statistics</span>
<span class="n">mean_trajectory</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">results_batch</span><span class="o">.</span><span class="n">states</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">std_trajectory</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">results_batch</span><span class="o">.</span><span class="n">states</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="example-4-safety-guards">
<h3>Example 4: Safety Guards<a class="headerlink" href="#example-4-safety-guards" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">src.simulation.context</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimulationContext</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.simulation.safety</span><span class="w"> </span><span class="kn">import</span> <span class="n">SafetyGuards</span>

<span class="c1"># Configure safety constraints</span>
<span class="n">safety</span> <span class="o">=</span> <span class="n">SafetyGuards</span><span class="p">(</span>
    <span class="n">state_bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="n">control_bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="n">deadline_ms</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
    <span class="n">max_condition_number</span><span class="o">=</span><span class="mf">1e6</span>
<span class="p">)</span>

<span class="c1"># Simulation with safety monitoring</span>
<span class="k">with</span> <span class="n">SimulationContext</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">dynamics</span><span class="p">,</span> <span class="n">safety</span><span class="p">)</span> <span class="k">as</span> <span class="n">ctx</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>

    <span class="c1"># Check safety violations</span>
    <span class="n">violations</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get_safety_violations</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">violations</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">violations</span><span class="p">)</span><span class="si">}</span><span class="s2"> safety events detected&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="example-5-performance-profiling">
<h3>Example 5: Performance Profiling<a class="headerlink" href="#example-5-performance-profiling" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.simulation.engines</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimulationRunner</span>

<span class="c1"># Profile different integrators</span>
<span class="n">integrators</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;euler&#39;</span><span class="p">,</span> <span class="s1">&#39;rk4&#39;</span><span class="p">,</span> <span class="s1">&#39;rk45&#39;</span><span class="p">]</span>
<span class="n">times</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">integrators</span><span class="p">:</span>
    <span class="n">runner</span> <span class="o">=</span> <span class="n">SimulationRunner</span><span class="p">(</span>
        <span class="n">controller</span><span class="o">=</span><span class="n">controller</span><span class="p">,</span>
        <span class="n">dynamics</span><span class="o">=</span><span class="n">dynamics</span><span class="p">,</span>
        <span class="n">integrator</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
        <span class="n">dt</span><span class="o">=</span><span class="mf">0.01</span>
    <span class="p">)</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

    <span class="n">times</span><span class="p">[</span><span class="n">method</span><span class="p">]</span> <span class="o">=</span> <span class="n">elapsed</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">s (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">time</span><span class="p">)</span><span class="si">}</span><span class="s2"> steps)&quot;</span><span class="p">)</span>

<span class="c1"># Compare speedup</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RK4 vs Euler speedup: </span><span class="si">{</span><span class="n">times</span><span class="p">[</span><span class="s1">&#39;euler&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">times</span><span class="p">[</span><span class="s1">&#39;rk4&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">x&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, Research Team
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            <div class="last-updated">
              Last updated on Oct 08, 2025</div>
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">simulation.engines.vector_sim</a><ul>
<li><a class="reference internal" href="#module-overview">Module Overview</a></li>
<li><a class="reference internal" href="#complete-source-code">Complete Source Code</a></li>
<li><a class="reference internal" href="#functions">Functions</a><ul>
<li><a class="reference internal" href="#simulate-initial-state-control-inputs-dt-horizon"><code class="docutils literal notranslate"><span class="pre">simulate(initial_state,</span> <span class="pre">control_inputs,</span> <span class="pre">dt,</span> <span class="pre">horizon)</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#parameters">Parameters</a></li>
<li><a class="reference internal" href="#returns">Returns</a></li>
<li><a class="reference internal" href="#examples">Examples</a><ul>
<li><a class="reference internal" href="#source-code">Source Code</a></li>
<li><a class="reference internal" href="#simulate-system-batch"><code class="docutils literal notranslate"><span class="pre">simulate_system_batch()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id1">Parameters</a></li>
<li><a class="reference internal" href="#id2">Returns</a><ul>
<li><a class="reference internal" href="#id3">Source Code</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dependencies">Dependencies</a></li>
<li><a class="reference internal" href="#advanced-mathematical-theory">Advanced Mathematical Theory</a><ul>
<li><a class="reference internal" href="#batch-simulation">Batch Simulation</a></li>
<li><a class="reference internal" href="#numba-jit-compilation">Numba JIT Compilation</a></li>
<li><a class="reference internal" href="#memory-layout-optimization">Memory Layout Optimization</a></li>
<li><a class="reference internal" href="#parallel-efficiency">Parallel Efficiency</a></li>
</ul>
</li>
<li><a class="reference internal" href="#architecture-diagram">Architecture Diagram</a></li>
<li><a class="reference internal" href="#usage-examples">Usage Examples</a><ul>
<li><a class="reference internal" href="#example-1-basic-simulation">Example 1: Basic Simulation</a></li>
<li><a class="reference internal" href="#example-2-adaptive-integration">Example 2: Adaptive Integration</a></li>
<li><a class="reference internal" href="#example-3-batch-simulation-numba">Example 3: Batch Simulation (Numba)</a></li>
<li><a class="reference internal" href="#example-4-safety-guards">Example 4: Safety Guards</a></li>
<li><a class="reference internal" href="#example-5-performance-profiling">Example 5: Performance Profiling</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=4ebf8126"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=08e7b316"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>window.MathJax = {"tex": {"tags": "all", "tagSide": "right", "macros": {"vec": ["\\boldsymbol{#1}", 1], "mat": ["\\boldsymbol{#1}", 1], "norm": ["\\left\\|#1\\right\\|", 1], "R": "\\mathbb{R}", "C": "\\mathbb{C}", "N": "\\mathbb{N}", "Z": "\\mathbb{Z}"}}, "options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://unpkg.com/mermaid@10.2.0/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true,theme:'neutral'});</script>
    <script src="../../_static/back-to-top.js?v=840797bb"></script>
    <script src="../../_static/lazy-load.js?v=dc25293c"></script>
    <script src="../../_static/dark-mode.js?v=bf328970"></script>
    </body>
</html>