<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
.chartjs-container {
    margin: 1.5em auto;
    padding: 1em;
    background: #f8f9fa;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.chart-note {
    text-align: center;
    color: #6c757d;
    font-size: 0.9em;
    margin-top: 0.5em;
}
</style>
<link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><link rel="next" title="controllers.smc.hybrid_adaptive_sta_smc" href="smc_hybrid_adaptive_sta_smc.html" /><link rel="prev" title="controllers.smc.adaptive_smc" href="smc_adaptive_smc.html" />

    <!-- Generated with Sphinx 7.4.7 and Furo 2024.08.06 -->
        <title>controllers.smc.classic_smc - DIP_SMC_PSO Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5349f25f" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=f5a89ef9" />
    
    


<style>
  body {
    --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">DIP_SMC_PSO Documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">DIP_SMC_PSO Documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">📚 Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Optimal Sliding Mode Control for a Double-Inverted Pendulum via PSO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../theory_overview.html">1. Theoretical Background â€” Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture.html">3. System Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plant_model.html">1.x Plant Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hil_quickstart.html">Hardware-in-the-Loop (HIL) Quickstart Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../streamlit_dashboard_guide.html">Streamlit Dashboard User Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">🎮 Control Systems &amp; Optimization</span></p>
<ul class="current">
<li class="toctree-l1 current has-children"><a class="reference internal" href="../../controllers/index.html">Controllers Module Documentation</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Controllers Module Documentation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../controllers/classical_smc_technical_guide.html">Classical Sliding Mode Control Technical Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/adaptive_smc_technical_guide.html">Adaptive Sliding Mode Control Technical Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/sta_smc_technical_guide.html">Super-Twisting Sliding Mode Control Technical Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/hybrid_smc_technical_guide.html">Hybrid Adaptive Super-Twisting SMC Technical Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/mpc_technical_guide.html">Model Predictive Control Technical Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/swing_up_smc_technical_guide.html">Swing-Up SMC Technical Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/swing_up_smc_technical_guide.html#example-metadata">example-metadata:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/swing_up_smc_technical_guide.html#runnable-false">runnable: false</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/factory_system_guide.html">SMC Controller Factory System Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/control_primitives_reference.html">Control Primitives Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mathematical_foundations/smc_complete_theory.html">Complete Sliding Mode Control Mathematical Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mathematical_foundations/controller_comparison_theory.html">SMC Controller Comparison Theory</a></li>
<li class="toctree-l2 current has-children"><a class="reference internal" href="index.html">Controllers Module</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Controllers Module</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="adaptive_smc.html">controllers.adaptive_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="classic_smc.html">controllers.classic_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="factory.html">controllers.factory</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpc_controller.html">controllers.mpc_controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="sta_smc.html">controllers.sta_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="swing_up_smc.html">controllers.swing_up_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="__init__.html">controllers.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="base_controller_interface.html">controllers.base.controller_interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="base_control_primitives.html">controllers.base.control_primitives</a></li>
<li class="toctree-l3"><a class="reference internal" href="base___init__.html">controllers.base.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="factory_deprecation.html">controllers.factory.deprecation</a></li>
<li class="toctree-l3"><a class="reference internal" href="factory_fallback_configs.html">controllers.factory.fallback_configs</a></li>
<li class="toctree-l3"><a class="reference internal" href="factory_legacy_factory.html">controllers.factory.legacy_factory</a></li>
<li class="toctree-l3"><a class="reference internal" href="factory_optimization.html">controllers.factory.optimization</a></li>
<li class="toctree-l3"><a class="reference internal" href="factory_pso_integration.html">controllers.factory.pso_integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="factory_smc_factory.html">controllers.factory.smc_factory</a></li>
<li class="toctree-l3"><a class="reference internal" href="factory_thread_safety.html">controllers.factory.thread_safety</a></li>
<li class="toctree-l3"><a class="reference internal" href="factory___init__.html">controllers.factory.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="mpc_mpc_controller.html">controllers.mpc.mpc_controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpc___init__.html">controllers.mpc.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_adaptive_smc.html">controllers.smc.adaptive_smc</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">controllers.smc.classic_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_hybrid_adaptive_sta_smc.html">controllers.smc.hybrid_adaptive_sta_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_sta_smc.html">controllers.smc.sta_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="smc___init__.html">controllers.smc.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="specialized_swing_up_smc.html">controllers.specialized.swing_up_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="specialized___init__.html">controllers.specialized.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="factory_core_protocols.html">controllers.factory.core.protocols</a></li>
<li class="toctree-l3"><a class="reference internal" href="factory_core_registry.html">controllers.factory.core.registry</a></li>
<li class="toctree-l3"><a class="reference internal" href="factory_core_threading.html">controllers.factory.core.threading</a></li>
<li class="toctree-l3"><a class="reference internal" href="factory_core_validation.html">controllers.factory.core.validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="factory_core___init__.html">controllers.factory.core.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_algorithms___init__.html">controllers.smc.algorithms.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_core_equivalent_control.html">controllers.smc.core.equivalent_control</a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_core_gain_validation.html">controllers.smc.core.gain_validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_core_sliding_surface.html">controllers.smc.core.sliding_surface</a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_core_switching_functions.html">controllers.smc.core.switching_functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_core___init__.html">controllers.smc.core.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_algorithms_adaptive_adaptation_law.html">controllers.smc.algorithms.adaptive.adaptation_law</a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_algorithms_adaptive_config.html">controllers.smc.algorithms.adaptive.config</a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_algorithms_adaptive_controller.html">controllers.smc.algorithms.adaptive.controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_algorithms_adaptive_parameter_estimation.html">controllers.smc.algorithms.adaptive.parameter_estimation</a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_algorithms_adaptive___init__.html">controllers.smc.algorithms.adaptive.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_algorithms_classical_boundary_layer.html">controllers.smc.algorithms.classical.boundary_layer</a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_algorithms_classical_config.html">controllers.smc.algorithms.classical.config</a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_algorithms_classical_controller.html">controllers.smc.algorithms.classical.controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_algorithms_classical___init__.html">controllers.smc.algorithms.classical.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_algorithms_hybrid_config.html">controllers.smc.algorithms.hybrid.config</a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_algorithms_hybrid_controller.html">controllers.smc.algorithms.hybrid.controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_algorithms_hybrid_switching_logic.html">controllers.smc.algorithms.hybrid.switching_logic</a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_algorithms_hybrid___init__.html">controllers.smc.algorithms.hybrid.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_algorithms_super_twisting_config.html">controllers.smc.algorithms.super_twisting.config</a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_algorithms_super_twisting_controller.html">controllers.smc.algorithms.super_twisting.controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_algorithms_super_twisting_twisting_algorithm.html">controllers.smc.algorithms.super_twisting.twisting_algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="smc_algorithms_super_twisting___init__.html">controllers.smc.algorithms.super_twisting.<strong>init</strong></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../mathematical_foundations/index.html">Mathematical Foundations</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Mathematical Foundations</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../mathematical_foundations/smc_complete_theory.html">Complete Sliding Mode Control Mathematical Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mathematical_foundations/controller_comparison_theory.html">SMC Controller Comparison Theory</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../plant/models_guide.html">Plant Models Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../optimization_simulation/guide.html">Optimization &amp; Simulation Guide</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Controllers Module</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of Controllers Module</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="adaptive_smc.html">controllers.adaptive_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="classic_smc.html">controllers.classic_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="factory.html">controllers.factory</a></li>
<li class="toctree-l2"><a class="reference internal" href="mpc_controller.html">controllers.mpc_controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="sta_smc.html">controllers.sta_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="swing_up_smc.html">controllers.swing_up_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="__init__.html">controllers.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="base_controller_interface.html">controllers.base.controller_interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="base_control_primitives.html">controllers.base.control_primitives</a></li>
<li class="toctree-l2"><a class="reference internal" href="base___init__.html">controllers.base.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="factory_deprecation.html">controllers.factory.deprecation</a></li>
<li class="toctree-l2"><a class="reference internal" href="factory_fallback_configs.html">controllers.factory.fallback_configs</a></li>
<li class="toctree-l2"><a class="reference internal" href="factory_legacy_factory.html">controllers.factory.legacy_factory</a></li>
<li class="toctree-l2"><a class="reference internal" href="factory_optimization.html">controllers.factory.optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="factory_pso_integration.html">controllers.factory.pso_integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="factory_smc_factory.html">controllers.factory.smc_factory</a></li>
<li class="toctree-l2"><a class="reference internal" href="factory_thread_safety.html">controllers.factory.thread_safety</a></li>
<li class="toctree-l2"><a class="reference internal" href="factory___init__.html">controllers.factory.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="mpc_mpc_controller.html">controllers.mpc.mpc_controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="mpc___init__.html">controllers.mpc.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_adaptive_smc.html">controllers.smc.adaptive_smc</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">controllers.smc.classic_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_hybrid_adaptive_sta_smc.html">controllers.smc.hybrid_adaptive_sta_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_sta_smc.html">controllers.smc.sta_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="smc___init__.html">controllers.smc.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="specialized_swing_up_smc.html">controllers.specialized.swing_up_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="specialized___init__.html">controllers.specialized.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="factory_core_protocols.html">controllers.factory.core.protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="factory_core_registry.html">controllers.factory.core.registry</a></li>
<li class="toctree-l2"><a class="reference internal" href="factory_core_threading.html">controllers.factory.core.threading</a></li>
<li class="toctree-l2"><a class="reference internal" href="factory_core_validation.html">controllers.factory.core.validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="factory_core___init__.html">controllers.factory.core.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_algorithms___init__.html">controllers.smc.algorithms.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_core_equivalent_control.html">controllers.smc.core.equivalent_control</a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_core_gain_validation.html">controllers.smc.core.gain_validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_core_sliding_surface.html">controllers.smc.core.sliding_surface</a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_core_switching_functions.html">controllers.smc.core.switching_functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_core___init__.html">controllers.smc.core.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_algorithms_adaptive_adaptation_law.html">controllers.smc.algorithms.adaptive.adaptation_law</a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_algorithms_adaptive_config.html">controllers.smc.algorithms.adaptive.config</a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_algorithms_adaptive_controller.html">controllers.smc.algorithms.adaptive.controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_algorithms_adaptive_parameter_estimation.html">controllers.smc.algorithms.adaptive.parameter_estimation</a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_algorithms_adaptive___init__.html">controllers.smc.algorithms.adaptive.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_algorithms_classical_boundary_layer.html">controllers.smc.algorithms.classical.boundary_layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_algorithms_classical_config.html">controllers.smc.algorithms.classical.config</a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_algorithms_classical_controller.html">controllers.smc.algorithms.classical.controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_algorithms_classical___init__.html">controllers.smc.algorithms.classical.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_algorithms_hybrid_config.html">controllers.smc.algorithms.hybrid.config</a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_algorithms_hybrid_controller.html">controllers.smc.algorithms.hybrid.controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_algorithms_hybrid_switching_logic.html">controllers.smc.algorithms.hybrid.switching_logic</a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_algorithms_hybrid___init__.html">controllers.smc.algorithms.hybrid.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_algorithms_super_twisting_config.html">controllers.smc.algorithms.super_twisting.config</a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_algorithms_super_twisting_controller.html">controllers.smc.algorithms.super_twisting.controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_algorithms_super_twisting_twisting_algorithm.html">controllers.smc.algorithms.super_twisting.twisting_algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="smc_algorithms_super_twisting___init__.html">controllers.smc.algorithms.super_twisting.<strong>init</strong></a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../optimizer/index.html">Optimizer Module</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Optimizer Module</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../optimizer/pso_optimizer.html">optimizer.pso_optimizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../optimizer/__init__.html">optimizer.<strong>init</strong></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../analysis_plan.html">5. Analysis &amp; Verification Plan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../benchmarks_methodology.html">Benchmarks &amp; Methodology</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">🧪 Development &amp; Testing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../TESTING.html">Testing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../test_protocols.html">5.x Test Protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../use_cases.html">4. Use Cases &amp; Operating Modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../context.html">2. Application Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault_detection_guide.html">Fault Detection &amp; Isolation (FDI) Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">📊 Research &amp; Theory</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../presentation/index.html">Research Presentation Materials</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Research Presentation Materials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html">Abstract</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#introduction-and-motivation">Introduction and Motivation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#the-double-inverted-pendulum-as-a-canonical-control-problem">The Double Inverted Pendulum as a Canonical Control Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#the-primary-control-objectives-and-challenges">The Primary Control Objectives and Challenges</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#sliding-mode-control-as-a-robust-solution">Sliding Mode Control as a Robust Solution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#the-gain-tuning-dilemma-and-the-need-for-optimization">The Gain Tuning Dilemma and the Need for Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#particle-swarm-optimization-for-automated-design">Particle Swarm Optimization for Automated Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#synthesis-and-motivation">Synthesis and Motivation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#references">References</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/problem-statement.html">Problem Statement for Double‑Inverted Pendulum (DIP) Control with SMC and PSO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/previous-works.html">Previous Work Before the Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/system-modeling.html"><strong>A Comprehensive Technical Report on the Modeling and Configuration of a Cart‑Based Double Inverted Pendulum System</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/smc-theory.html">Sliding Mode Control for a Double‑Inverted Pendulum: Bridging Theory and Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html">Abstract</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#introduction">1 Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#system-modelling-and-problem-formulation">2 System Modelling and Problem Formulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#simulation-methodology">3 Simulation Methodology</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#classic-sliding-mode-control">4 Classic Sliding Mode Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-i-boundary-layer-method">5 Chattering Mitigation Strategy I: Boundary Layer Method</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-ii-supertwisting-algorithm">6 Chattering Mitigation Strategy II: Super‑Twisting Algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-iii-adaptive-sliding-mode-control">7 Chattering Mitigation Strategy III: Adaptive Sliding Mode Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-iv-hybrid-adaptivesta">8 Chattering Mitigation Strategy IV: Hybrid Adaptive–STA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#synthesis-and-comparative-analysis">9 Synthesis and Comparative Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#references">References</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/pso-optimization.html"><strong>Comprehensive Simulation Analysis and Enhancements for the Double Inverted Pendulum Control System</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/simulation-setup.html">Particle Swarm Optimization for Sliding‑Mode Controller Tuning of a Double Inverted Pendulum</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/results-discussion.html">8 – Results and Discussion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/results-discussion.html#references">References</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html">Abstract</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#introduction-and-motivation">Introduction and Motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#the-double-inverted-pendulum-as-a-canonical-control-problem">The Double Inverted Pendulum as a Canonical Control Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#the-primary-control-objectives-and-challenges">The Primary Control Objectives and Challenges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#sliding-mode-control-as-a-robust-solution">Sliding Mode Control as a Robust Solution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#the-gain-tuning-dilemma-and-the-need-for-optimization">The Gain Tuning Dilemma and the Need for Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#particle-swarm-optimization-for-automated-design">Particle Swarm Optimization for Automated Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#synthesis-and-motivation">Synthesis and Motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#references">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/problem-statement.html">Problem Statement for Double‑Inverted Pendulum (DIP) Control with SMC and PSO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/previous-works.html">Previous Work Before the Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/system-modeling.html"><strong>A Comprehensive Technical Report on the Modeling and Configuration of a Cart‑Based Double Inverted Pendulum System</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/smc-theory.html">Sliding Mode Control for a Double‑Inverted Pendulum: Bridging Theory and Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html">Abstract</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#introduction">1 Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#system-modelling-and-problem-formulation">2 System Modelling and Problem Formulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#simulation-methodology">3 Simulation Methodology</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#classic-sliding-mode-control">4 Classic Sliding Mode Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-i-boundary-layer-method">5 Chattering Mitigation Strategy I: Boundary Layer Method</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-ii-supertwisting-algorithm">6 Chattering Mitigation Strategy II: Super‑Twisting Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-iii-adaptive-sliding-mode-control">7 Chattering Mitigation Strategy III: Adaptive Sliding Mode Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-iv-hybrid-adaptivesta">8 Chattering Mitigation Strategy IV: Hybrid Adaptive–STA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#synthesis-and-comparative-analysis">9 Synthesis and Comparative Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#references">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/pso-optimization.html"><strong>Comprehensive Simulation Analysis and Enhancements for the Double Inverted Pendulum Control System</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/simulation-setup.html">Particle Swarm Optimization for Sliding‑Mode Controller Tuning of a Double Inverted Pendulum</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/results-discussion.html">8 – Results and Discussion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/results-discussion.html#references">References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">📖 API Reference &amp; Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Reference Documentation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../examples/index.html">Examples</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of Examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../bibliography.html">Bibliography &amp; Academic References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">🔧 Project Management</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../CONTRIBUTING.html">Contributing – ResearchPlanSpec Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../RELEASE_CHECKLIST.html">Release Checklist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CHANGELOG.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../symbols.html">Symbols &amp; Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../results_readme.html">Results &amp; Plots</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">📚 Citations &amp; Attribution</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../CITATIONS.html">Citations &amp; Academic Attribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CITATIONS_ACADEMIC.html">Academic Theory Citations &amp; References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DEPENDENCIES.html">Software Dependencies &amp; Citations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PATTERNS.html">Software Design Patterns &amp; Architecture Attribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LICENSES.html">License Compliance &amp; Attribution</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="https://github.com/theSadeQ/DIP_SMC_PSO/blob/main/docs/reference/controllers/smc_classic_smc.md?plain=true" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div><div class="edit-this-page">
  <a class="muted-link" href="https://github.com/theSadeQ/DIP_SMC_PSO/edit/main/docs/reference/controllers/smc_classic_smc.md" title="Edit this page">
    <svg><use href="#svg-pencil"></use></svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section class="tex2jax_ignore mathjax_ignore" id="controllers-smc-classic-smc">
<h1>controllers.smc.classic_smc<a class="headerlink" href="#controllers-smc-classic-smc" title="Link to this heading">¶</a></h1>
<p><strong>Source:</strong> <code class="docutils literal notranslate"><span class="pre">src\controllers\smc\classic_smc.py</span></code></p>
<section id="module-overview">
<h2>Module Overview<a class="headerlink" href="#module-overview" title="Link to this heading">¶</a></h2>
<p><em>No module docstring available.</em></p>
</section>
<section id="complete-source-code">
<h2>Complete Source Code<a class="headerlink" href="#complete-source-code" title="Link to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="c1">#======================================================================================\\\</span>
<span class="linenos">  2</span><span class="c1">#========================= src/controllers/smc/classic_smc.py =========================\\\</span>
<span class="linenos">  3</span><span class="c1">#======================================================================================\\\</span>
<span class="linenos">  4</span>
<span class="linenos">  5</span><span class="c1"># Changed: enforce strict positivity of sliding‑surface and switching gains and</span>
<span class="linenos">  6</span><span class="c1"># allow zero derivative gain; updated docstring to reflect these constraints.</span>
<span class="linenos">  7</span>
<span class="linenos">  8</span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="linenos">  9</span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="linenos"> 10</span><span class="kn">import</span><span class="w"> </span><span class="nn">weakref</span>
<span class="linenos"> 11</span><span class="c1"># Import from new organized structure</span>
<span class="linenos"> 12</span><span class="kn">from</span><span class="w"> </span><span class="nn">...utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">saturate</span>
<span class="linenos"> 13</span><span class="kn">from</span><span class="w"> </span><span class="nn">...utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClassicalSMCOutput</span>
<span class="linenos"> 14</span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Any</span>
<span class="linenos"> 15</span>
<span class="linenos"> 16</span><span class="c1"># Avoid circular import at runtime</span>
<span class="linenos"> 17</span><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
<span class="linenos"> 18</span>    <span class="c1"># Hint only; don&#39;t import at runtime to avoid path issues</span>
<span class="linenos"> 19</span>    <span class="kn">from</span><span class="w"> </span><span class="nn">...plant.models.dynamics</span><span class="w"> </span><span class="kn">import</span> <span class="n">DoubleInvertedPendulum</span>
<span class="linenos"> 20</span>
<span class="linenos"> 21</span><span class="k">class</span><span class="w"> </span><span class="nc">ClassicalSMC</span><span class="p">:</span>
<span class="linenos"> 22</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 23</span><span class="sd">    Classical Sliding‑Mode Controller for a double‑inverted pendulum.</span>
<span class="linenos"> 24</span>
<span class="linenos"> 25</span><span class="sd">    This controller implements the conventional first‑order sliding‑mode law</span>
<span class="linenos"> 26</span><span class="sd">    consisting of a model‑based equivalent control ``u_eq`` and a robust</span>
<span class="linenos"> 27</span><span class="sd">    discontinuous term.  The robust term uses a continuous approximation to</span>
<span class="linenos"> 28</span><span class="sd">    the sign function (either a hyperbolic tangent or a piecewise‑linear</span>
<span class="linenos"> 29</span><span class="sd">    saturation) within a boundary layer of width ``epsilon`` to attenuate</span>
<span class="linenos"> 30</span><span class="sd">    chattering.  Introducing a boundary layer around the switching surface</span>
<span class="linenos"> 31</span><span class="sd">    replaces the discontinuous signum control with a continuous function,</span>
<span class="linenos"> 32</span><span class="sd">    thereby reducing high‑frequency oscillations.  A number of authors</span>
<span class="linenos"> 33</span><span class="sd">    note that the boundary‑layer approximation attenuates chattering at</span>
<span class="linenos"> 34</span><span class="sd">    the cost of introducing a finite steady‑state tracking error; for</span>
<span class="linenos"> 35</span><span class="sd">    example, a discussion of chattering reduction methods emphasises</span>
<span class="linenos"> 36</span><span class="sd">    that the boundary‑layer method &quot;reduces chattering but leads to a finite</span>
<span class="linenos"> 37</span><span class="sd">    steady state error&quot;.  The user should therefore</span>
<span class="linenos"> 38</span><span class="sd">    select ``epsilon`` to balance chattering reduction against steady‑state</span>
<span class="linenos"> 39</span><span class="sd">    accuracy.</span>
<span class="linenos"> 40</span>
<span class="linenos"> 41</span><span class="sd">    Two switching functions are available: ``tanh`` (smooth hyperbolic</span>
<span class="linenos"> 42</span><span class="sd">    tangent) and ``linear`` (piecewise‑linear saturation).  The ``linear``</span>
<span class="linenos"> 43</span><span class="sd">    switch approximates the sign function more harshly by clipping the</span>
<span class="linenos"> 44</span><span class="sd">    sliding surface directly, which can degrade robustness near the origin</span>
<span class="linenos"> 45</span><span class="sd">    because the control gain effectively drops to zero for small errors.</span>
<span class="linenos"> 46</span><span class="sd">    In contrast, the ``tanh`` switch retains smoothness and maintains a</span>
<span class="linenos"> 47</span><span class="sd">    nonzero slope through the origin, preserving control authority in a</span>
<span class="linenos"> 48</span><span class="sd">    neighbourhood of the sliding surface.  Users should prefer</span>
<span class="linenos"> 49</span><span class="sd">    ``tanh`` unless there is a compelling reason to adopt the linear</span>
<span class="linenos"> 50</span><span class="sd">    saturation and should be aware that linear saturation may cause</span>
<span class="linenos"> 51</span><span class="sd">    increased steady‑state error and slower convergence near the origin.</span>
<span class="linenos"> 52</span>
<span class="linenos"> 53</span><span class="sd">    A small diagonal ``regularization`` is added to the inertia matrix during</span>
<span class="linenos"> 54</span><span class="sd">    inversion to ensure positive definiteness and numerical robustness.</span>
<span class="linenos"> 55</span><span class="sd">    Adding a tiny constant to the diagonal of a symmetric matrix is a</span>
<span class="linenos"> 56</span><span class="sd">    well‑known regularisation technique: in the context of covariance</span>
<span class="linenos"> 57</span><span class="sd">    matrices, Leung and colleagues recommend “adding a small, positive</span>
<span class="linenos"> 58</span><span class="sd">    constant to the diagonal” to ensure the matrix is invertible.</span>
<span class="linenos"> 59</span>
<span class="linenos"> 60</span><span class="sd">    Parameters are typically supplied by a factory that reads a central</span>
<span class="linenos"> 61</span><span class="sd">    configuration.  Each gain vector must contain exactly six elements in the</span>
<span class="linenos"> 62</span><span class="sd">    order ``[k1, k2, lam1, lam2, K, kd]``.  The maximum force ``max_force``</span>
<span class="linenos"> 63</span><span class="sd">    sets the saturation limit for the final control command.</span>
<span class="linenos"> 64</span>
<span class="linenos"> 65</span><span class="sd">    The optional ``controllability_threshold`` parameter decouples</span>
<span class="linenos"> 66</span><span class="sd">    controllability from the boundary layer ``epsilon``.  Earlier</span>
<span class="linenos"> 67</span><span class="sd">    implementations compared the magnitude of ``L·M^{-1}·B`` against</span>
<span class="linenos"> 68</span><span class="sd">    ``epsilon`` to decide whether to compute the equivalent control.  This</span>
<span class="linenos"> 69</span><span class="sd">    conflation of chattering mitigation with controllability made it</span>
<span class="linenos"> 70</span><span class="sd">    difficult to tune each effect separately.  ``controllability_threshold``</span>
<span class="linenos"> 71</span><span class="sd">    defines a lower bound on ``|L·M^{-1}·B|`` below which the equivalent</span>
<span class="linenos"> 72</span><span class="sd">    control is suppressed.  If unspecified, a default of ``1e‑4`` is used</span>
<span class="linenos"> 73</span><span class="sd">    based on matrix conditioning guidelines.  The</span>
<span class="linenos"> 74</span><span class="sd">    boundary layer width ``epsilon`` should therefore be chosen solely to</span>
<span class="linenos"> 75</span><span class="sd">    trade off between chattering and steady‑state error, while</span>
<span class="linenos"> 76</span><span class="sd">    ``controllability_threshold`` governs when the model‑based feedforward</span>
<span class="linenos"> 77</span><span class="sd">    term is applied.</span>
<span class="linenos"> 78</span>
<span class="linenos"> 79</span><span class="sd">    **Gain positivity (F‑4.SMCDesign.2 / RC‑04)** – Sliding‑mode theory</span>
<span class="linenos"> 80</span><span class="sd">    requires that the sliding‑surface gains ``k1``, ``k2`` and the slope</span>
<span class="linenos"> 81</span><span class="sd">    coefficients ``lam1``, ``lam2`` be strictly positive.  Utkin and</span>
<span class="linenos"> 82</span><span class="sd">    Levant note that the discontinuous control gain ``k`` must be a</span>
<span class="linenos"> 83</span><span class="sd">    positive constant【Rhif2012†L563-L564】, and the slope ``λ`` of the</span>
<span class="linenos"> 84</span><span class="sd">    sliding function must be chosen positive to ensure Hurwitz</span>
<span class="linenos"> 85</span><span class="sd">    stability【ModelFreeSMC2018†L340-L345】.  The switching gain ``K`` must</span>
<span class="linenos"> 86</span><span class="sd">    also be strictly positive to drive the system to the sliding surface,</span>
<span class="linenos"> 87</span><span class="sd">    while the derivative gain ``kd`` should be non‑negative to provide</span>
<span class="linenos"> 88</span><span class="sd">    damping.  The constructor validates these constraints and raises</span>
<span class="linenos"> 89</span><span class="sd">    ``ValueError`` when violated.</span>
<span class="linenos"> 90</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<span class="linenos"> 93</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos"> 94</span>        <span class="n">gains</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
<span class="linenos"> 95</span>        <span class="n">max_force</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="linenos"> 96</span>        <span class="n">boundary_layer</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="linenos"> 97</span>        <span class="n">dynamics_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;DoubleInvertedPendulum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 98</span>        <span class="n">regularization</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-10</span><span class="p">,</span>
<span class="linenos"> 99</span>        <span class="n">switch_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tanh&quot;</span><span class="p">,</span>
<span class="linenos">100</span>        <span class="o">*</span><span class="p">,</span>
<span class="linenos">101</span>        <span class="n">boundary_layer_slope</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="linenos">102</span>        <span class="n">controllability_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">103</span>        <span class="n">hysteresis_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="linenos">104</span>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="linenos">105</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">106</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the controller.</span>
<span class="linenos">107</span>
<span class="linenos">108</span><span class="sd">        Args:</span>
<span class="linenos">109</span><span class="sd">            gains: Six gains in the order ``[k1, k2, lam1, lam2, K, kd]``.</span>
<span class="linenos">110</span><span class="sd">            max_force: Saturation limit for the control input (N).</span>
<span class="linenos">111</span><span class="sd">            boundary_layer: Boundary layer thickness (epsilon) for chattering reduction.</span>
<span class="linenos">112</span><span class="sd">            dynamics_model: Dynamics model providing physics matrices via ``_compute_physics_matrices``.</span>
<span class="linenos">113</span><span class="sd">            regularization: Small value to add to the diagonal of the inertia matrix for numerical stability.</span>
<span class="linenos">114</span><span class="sd">            **kwargs: Ignored extras to keep factory compatibility.</span>
<span class="linenos">115</span>
<span class="linenos">116</span><span class="sd">        Raises:</span>
<span class="linenos">117</span><span class="sd">            ValueError: If ``gains`` does not contain exactly six elements</span>
<span class="linenos">118</span><span class="sd">                        or if ``boundary_layer`` is not strictly positive.</span>
<span class="linenos">119</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">120</span>        <span class="c1"># Validate and normalise the supplied gains early.  This makes it</span>
<span class="linenos">121</span>        <span class="c1"># possible for the factory or PSO tuner to reject misconfigured</span>
<span class="linenos">122</span>        <span class="c1"># gain vectors before instantiating the controller.  Accept any</span>
<span class="linenos">123</span>        <span class="c1"># sequence or array-like input and coerce it to a flat NumPy array</span>
<span class="linenos">124</span>        <span class="c1"># of floats.  After validation the gains are unpacked into the</span>
<span class="linenos">125</span>        <span class="c1"># canonical order ``[k1, k2, lam1, lam2, K, kd]``.</span>
<span class="linenos">126</span>        <span class="bp">self</span><span class="o">.</span><span class="n">validate_gains</span><span class="p">(</span><span class="n">gains</span><span class="p">)</span>
<span class="linenos">127</span>        <span class="c1"># Coerce to a 1‑D array of floats; ravel() flattens nested sequences</span>
<span class="linenos">128</span>        <span class="n">gains_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gains</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="linenos">129</span>        <span class="c1"># Store a shallow copy of the gains for external inspection.  Using</span>
<span class="linenos">130</span>        <span class="c1"># list() avoids exposing the internal NumPy array directly.</span>
<span class="linenos">131</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_gains</span> <span class="o">=</span> <span class="n">gains_arr</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="linenos">132</span>        <span class="c1"># Unpack the gains into individual parameters</span>
<span class="linenos">133</span>        <span class="bp">self</span><span class="o">.</span><span class="n">k1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kd</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">gains_arr</span><span class="p">)</span>
<span class="linenos">134</span>        <span class="c1"># Validate shared parameters via central utility.  Positivity of gains</span>
<span class="linenos">135</span>        <span class="c1"># and boundary layers ensures that the sliding surface and switching</span>
<span class="linenos">136</span>        <span class="c1"># function remain well‑defined and stable.</span>
<span class="linenos">137</span>        <span class="c1"># Import from new modular utils structure</span>
<span class="linenos">138</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">139</span>            <span class="kn">from</span><span class="w"> </span><span class="nn">src.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">require_positive</span>  <span class="c1"># when repo root on sys.path</span>
<span class="linenos">140</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">141</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">142</span>                <span class="kn">from</span><span class="w"> </span><span class="nn">...utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">require_positive</span>  <span class="c1"># when importing as src.controllers.*</span>
<span class="linenos">143</span>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">144</span>                <span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">require_positive</span>    <span class="c1"># when src itself on sys.path</span>
<span class="linenos">145</span>        <span class="bp">self</span><span class="o">.</span><span class="n">max_force</span> <span class="o">=</span> <span class="n">require_positive</span><span class="p">(</span><span class="n">max_force</span><span class="p">,</span> <span class="s2">&quot;max_force&quot;</span><span class="p">)</span>
<span class="linenos">146</span>        <span class="c1"># Use helpers for the adaptive boundary layer.  The nominal</span>
<span class="linenos">147</span>        <span class="c1"># thickness ``epsilon0`` must be strictly positive, while</span>
<span class="linenos">148</span>        <span class="c1"># ``boundary_layer_slope`` can be zero or positive.  A positive</span>
<span class="linenos">149</span>        <span class="c1"># slope scales the boundary layer with the norm of the sliding</span>
<span class="linenos">150</span>        <span class="c1"># variable, reducing chattering for large errors and shrinking</span>
<span class="linenos">151</span>        <span class="c1"># the layer as the error vanishes【967233543993377†L104-L115】.</span>
<span class="linenos">152</span>        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon0</span> <span class="o">=</span> <span class="n">require_positive</span><span class="p">(</span><span class="n">boundary_layer</span><span class="p">,</span> <span class="s2">&quot;boundary_layer&quot;</span><span class="p">)</span>
<span class="linenos">153</span>        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">boundary_layer_slope</span><span class="p">)</span>
<span class="linenos">154</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon1</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
<span class="linenos">155</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;boundary_layer_slope must be non‑negative&quot;</span><span class="p">)</span>
<span class="linenos">156</span>        <span class="c1"># Backwards compatibility: retain constant epsilon attribute</span>
<span class="linenos">157</span>        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon0</span>
<span class="linenos">158</span>
<span class="linenos">159</span>        <span class="c1"># Hysteresis ratio defines an inner dead‑band in which the</span>
<span class="linenos">160</span>        <span class="c1"># discontinuous robust term is suppressed.  A value in [0,1]</span>
<span class="linenos">161</span>        <span class="c1"># scales the nominal boundary layer ε; when |σ| &lt; hysteresis_ratio·ε0</span>
<span class="linenos">162</span>        <span class="c1"># the robust term is frozen to zero【967233543993377†L104-L115】.  This</span>
<span class="linenos">163</span>        <span class="c1"># further reduces chattering by avoiding high‑frequency switching</span>
<span class="linenos">164</span>        <span class="c1"># inside a small neighbourhood of the sliding surface.</span>
<span class="linenos">165</span>        <span class="bp">self</span><span class="o">.</span><span class="n">hysteresis_ratio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hysteresis_ratio</span><span class="p">)</span>
<span class="linenos">166</span>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hysteresis_ratio</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">):</span>
<span class="linenos">167</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;hysteresis_ratio must be within [0,1]&quot;</span><span class="p">)</span>
<span class="linenos">168</span>
<span class="linenos">169</span>        <span class="c1"># ---- Additional validation of SMC gains (F‑4.SMCDesign.2 / RC‑04) ----</span>
<span class="linenos">170</span>        <span class="c1"># Sliding‑mode theory requires strictly positive sliding‑surface and</span>
<span class="linenos">171</span>        <span class="c1"># switching gains and non‑negative derivative gain.  Validate each</span>
<span class="linenos">172</span>        <span class="c1"># gain here to catch misconfiguration early【Rhif2012†L563-L564】【ModelFreeSMC2018†L340-L345】.</span>
<span class="linenos">173</span>        <span class="bp">self</span><span class="o">.</span><span class="n">k1</span> <span class="o">=</span> <span class="n">require_positive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k1</span><span class="p">,</span> <span class="s2">&quot;k1&quot;</span><span class="p">)</span>
<span class="linenos">174</span>        <span class="bp">self</span><span class="o">.</span><span class="n">k2</span> <span class="o">=</span> <span class="n">require_positive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k2</span><span class="p">,</span> <span class="s2">&quot;k2&quot;</span><span class="p">)</span>
<span class="linenos">175</span>        <span class="bp">self</span><span class="o">.</span><span class="n">lam1</span> <span class="o">=</span> <span class="n">require_positive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lam1</span><span class="p">,</span> <span class="s2">&quot;lam1&quot;</span><span class="p">)</span>
<span class="linenos">176</span>        <span class="bp">self</span><span class="o">.</span><span class="n">lam2</span> <span class="o">=</span> <span class="n">require_positive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lam2</span><span class="p">,</span> <span class="s2">&quot;lam2&quot;</span><span class="p">)</span>
<span class="linenos">177</span>        <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">require_positive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">)</span>
<span class="linenos">178</span>        <span class="c1"># Allow derivative gain to be zero but not negative</span>
<span class="linenos">179</span>        <span class="bp">self</span><span class="o">.</span><span class="n">kd</span> <span class="o">=</span> <span class="n">require_positive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kd</span><span class="p">,</span> <span class="s2">&quot;kd&quot;</span><span class="p">,</span> <span class="n">allow_zero</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">180</span>
<span class="linenos">181</span>        <span class="c1"># Use weakref for dynamics model to break circular references</span>
<span class="linenos">182</span>        <span class="k">if</span> <span class="n">dynamics_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">183</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_dynamics_ref</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">dynamics_model</span><span class="p">)</span>
<span class="linenos">184</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">185</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_dynamics_ref</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span>
<span class="linenos">186</span>
<span class="linenos">187</span>        <span class="bp">self</span><span class="o">.</span><span class="n">regularization</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">regularization</span><span class="p">)</span>
<span class="linenos">188</span>        <span class="c1"># Switching function selection</span>
<span class="linenos">189</span>        <span class="n">sm</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">switch_method</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="linenos">190</span>        <span class="k">if</span> <span class="n">sm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;tanh&quot;</span><span class="p">,</span> <span class="s2">&quot;linear&quot;</span><span class="p">):</span>
<span class="linenos">191</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;switch_method must be &#39;tanh&#39; or &#39;linear&#39;&quot;</span><span class="p">)</span>
<span class="linenos">192</span>        <span class="bp">self</span><span class="o">.</span><span class="n">switch_method</span> <span class="o">=</span> <span class="n">sm</span>
<span class="linenos">193</span>
<span class="linenos">194</span>        <span class="c1"># Declare the dimensionality of the gain vector.  Exposing the</span>
<span class="linenos">195</span>        <span class="c1"># number of gains allows optimisers such as PSOTuner to infer</span>
<span class="linenos">196</span>        <span class="c1"># controller dimensionality without trial instantiation.  See</span>
<span class="linenos">197</span>        <span class="c1"># design review section 5 (PSO integration).</span>
<span class="linenos">198</span>        <span class="bp">self</span><span class="o">.</span><span class="n">n_gains</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span>
<span class="linenos">199</span>
<span class="linenos">200</span>        <span class="c1"># (C-007) Cache the model&#39;s singularity conditioning threshold if provided.</span>
<span class="linenos">201</span>        <span class="c1"># If unavailable, leave as None to allow regularization to rehabilitate borderline cases.</span>
<span class="linenos">202</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_cond_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">203</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">204</span>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn</span><span class="p">,</span> <span class="s2">&quot;p_model&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn</span><span class="o">.</span><span class="n">p_model</span><span class="p">,</span> <span class="s2">&quot;singularity_cond_threshold&quot;</span><span class="p">):</span>
<span class="linenos">205</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_cond_threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn</span><span class="o">.</span><span class="n">p_model</span><span class="o">.</span><span class="n">singularity_cond_threshold</span><span class="p">)</span>
<span class="linenos">206</span>            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;singularity_cond_threshold&quot;</span><span class="p">):</span>
<span class="linenos">207</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_cond_threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">singularity_cond_threshold</span><span class="p">)</span>
<span class="linenos">208</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">209</span>            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not extract condition threshold, disabling monitoring: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">210</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_cond_threshold</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># OK: Monitoring is optional</span>
<span class="linenos">211</span>
<span class="linenos">212</span>        <span class="c1"># Sliding surface uses only joint rates; cart input appears via B</span>
<span class="linenos">213</span>        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">214</span>        <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">215</span>
<span class="linenos">216</span>        <span class="c1"># Configure logger</span>
<span class="linenos">217</span>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<span class="linenos">218</span>
<span class="linenos">219</span>        <span class="c1"># Store the controllability threshold used when computing the</span>
<span class="linenos">220</span>        <span class="c1"># equivalent control.  Earlier versions used the boundary layer</span>
<span class="linenos">221</span>        <span class="c1"># thickness `epsilon` as the cutoff for |L·M⁻¹·B|, conflating</span>
<span class="linenos">222</span>        <span class="c1"># chattering mitigation with controllability.</span>
<span class="linenos">223</span>        <span class="c1"># Here we allow the caller to specify a separate threshold via</span>
<span class="linenos">224</span>        <span class="c1"># ``controllability_threshold``.  If unspecified, a default of</span>
<span class="linenos">225</span>        <span class="c1"># 1e‑4 is used as a conservative lower bound on |L·M⁻¹·B|; too</span>
<span class="linenos">226</span>        <span class="c1"># small of a threshold can lead to numerical instabilities, while a</span>
<span class="linenos">227</span>        <span class="c1"># larger threshold needlessly suppresses the equivalent control.  See</span>
<span class="linenos">228</span>        <span class="c1"># Golub &amp; Van Loan for background on conditioning of linear systems.</span>
<span class="linenos">229</span>        <span class="k">if</span> <span class="n">controllability_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">230</span>            <span class="c1"># Scale the equivalent‑control threshold with the sum of switching gains.</span>
<span class="linenos">231</span>            <span class="c1"># Sliding‑mode theory states that the switching gain must exceed the</span>
<span class="linenos">232</span>            <span class="c1"># bound of system uncertainties plus a positive margin to guarantee</span>
<span class="linenos">233</span>            <span class="c1"># sliding【412237323761959†L496-L507】.  A threshold proportional to</span>
<span class="linenos">234</span>            <span class="c1"># (k1 + k2) avoids enabling the equivalent control when the system</span>
<span class="linenos">235</span>            <span class="c1"># is poorly controllable and adapts automatically when gains are</span>
<span class="linenos">236</span>            <span class="c1"># tuned.  The factor 0.05 was empirically chosen to provide a</span>
<span class="linenos">237</span>            <span class="c1"># conservative cutoff.</span>
<span class="linenos">238</span>            <span class="bp">self</span><span class="o">.</span><span class="n">eq_threshold</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k2</span><span class="p">)</span>
<span class="linenos">239</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">240</span>            <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">controllability_threshold</span><span class="p">)</span>
<span class="linenos">241</span>            <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
<span class="linenos">242</span>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;controllability_threshold must be &gt; 0&quot;</span><span class="p">)</span>
<span class="linenos">243</span>            <span class="bp">self</span><span class="o">.</span><span class="n">eq_threshold</span> <span class="o">=</span> <span class="n">val</span>
<span class="linenos">244</span>
<span class="linenos">245</span>    <span class="c1"># ------------------------------------------------------------------</span>
<span class="linenos">246</span>    <span class="c1"># Properties</span>
<span class="linenos">247</span>    <span class="c1"># ------------------------------------------------------------------</span>
<span class="linenos">248</span>    <span class="nd">@property</span>
<span class="linenos">249</span>    <span class="k">def</span><span class="w"> </span><span class="nf">gains</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="linenos">250</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the list of gains used by this controller.</span>
<span class="linenos">251</span>
<span class="linenos">252</span><span class="sd">        This property exposes the six control gains in the canonical order</span>
<span class="linenos">253</span><span class="sd">        ``[k1, k2, lam1, lam2, K, kd]`` for external introspection.  The</span>
<span class="linenos">254</span><span class="sd">        returned list is a shallow copy to prevent accidental mutation of</span>
<span class="linenos">255</span><span class="sd">        the controller&#39;s internal parameters.</span>
<span class="linenos">256</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">257</span>        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gains</span><span class="p">)</span>
<span class="linenos">258</span>
<span class="linenos">259</span>    <span class="nd">@property</span>
<span class="linenos">260</span>    <span class="k">def</span><span class="w"> </span><span class="nf">dyn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">261</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Access dynamics model via weakref.&quot;&quot;&quot;</span>
<span class="linenos">262</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamics_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">263</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamics_ref</span><span class="p">()</span>
<span class="linenos">264</span>        <span class="k">return</span> <span class="kc">None</span>
<span class="linenos">265</span>
<span class="linenos">266</span>    <span class="nd">@dyn</span><span class="o">.</span><span class="n">setter</span>
<span class="linenos">267</span>    <span class="k">def</span><span class="w"> </span><span class="nf">dyn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="linenos">268</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set dynamics model using weakref.&quot;&quot;&quot;</span>
<span class="linenos">269</span>        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">270</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_dynamics_ref</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="linenos">271</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">272</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_dynamics_ref</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span>
<span class="linenos">273</span>
<span class="linenos">274</span>    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="linenos">275</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;No internal state for classical SMC; returns an empty tuple.&quot;&quot;&quot;</span>
<span class="linenos">276</span>        <span class="k">return</span> <span class="p">()</span>
<span class="linenos">277</span>
<span class="linenos">278</span>    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_history</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="linenos">279</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;No history tracked for classical SMC; returns an empty dict.&quot;&quot;&quot;</span>
<span class="linenos">280</span>        <span class="k">return</span> <span class="p">{}</span>
<span class="linenos">281</span>
<span class="linenos">282</span>    <span class="nd">@staticmethod</span>
<span class="linenos">283</span>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_gains</span><span class="p">(</span><span class="n">gains</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">284</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">285</span><span class="sd">        Validate that exactly six gains have been provided for the classical SMC.</span>
<span class="linenos">286</span>
<span class="linenos">287</span><span class="sd">        The classical sliding–mode controller uses six gains in the order</span>
<span class="linenos">288</span><span class="sd">        ``[k1, k2, lam1, lam2, K, kd]``.  Any other length is considered</span>
<span class="linenos">289</span><span class="sd">        misconfigured and results in a ``ValueError``.  This validator accepts</span>
<span class="linenos">290</span><span class="sd">        any sequence or array-like input and coerces it to a one‑dimensional</span>
<span class="linenos">291</span><span class="sd">        array of floats before verifying its length.  When coercion fails or</span>
<span class="linenos">292</span><span class="sd">        the resulting array does not contain exactly six elements, a</span>
<span class="linenos">293</span><span class="sd">        ``ValueError`` is raised.</span>
<span class="linenos">294</span>
<span class="linenos">295</span><span class="sd">        Parameters</span>
<span class="linenos">296</span><span class="sd">        ----------</span>
<span class="linenos">297</span><span class="sd">        gains : Sequence[float] or array-like</span>
<span class="linenos">298</span><span class="sd">            Sequence of gain values supplied during construction.</span>
<span class="linenos">299</span>
<span class="linenos">300</span><span class="sd">        Raises</span>
<span class="linenos">301</span><span class="sd">        ------</span>
<span class="linenos">302</span><span class="sd">        ValueError</span>
<span class="linenos">303</span><span class="sd">            If ``gains`` is not convertible to a sequence of length six.</span>
<span class="linenos">304</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">305</span>        <span class="c1"># Attempt to coerce the gains into a flat NumPy array.  Any exception</span>
<span class="linenos">306</span>        <span class="c1"># indicates the input is not sequence-like or contains non-numeric</span>
<span class="linenos">307</span>        <span class="c1"># entries and should result in a validation error.</span>
<span class="linenos">308</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">309</span>            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gains</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="linenos">310</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">311</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos">312</span>                <span class="s2">&quot;ClassicalSMC requires 6 gains: [k1, k2, lam1, lam2, K, kd]&quot;</span>
<span class="linenos">313</span>            <span class="p">)</span>
<span class="linenos">314</span>        <span class="c1"># Ensure exactly six gains are provided</span>
<span class="linenos">315</span>        <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span>
<span class="linenos">316</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos">317</span>                <span class="s2">&quot;ClassicalSMC requires 6 gains: [k1, k2, lam1, lam2, K, kd]&quot;</span>
<span class="linenos">318</span>            <span class="p">)</span>
<span class="linenos">319</span>
<span class="linenos">320</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_sliding_surface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="linenos">321</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the sliding surface value, ``sigma``.</span>
<span class="linenos">322</span>
<span class="linenos">323</span><span class="sd">        Args:</span>
<span class="linenos">324</span><span class="sd">            state: State vector ``[x, theta1, theta2, xdot, dtheta1, dtheta2]``.</span>
<span class="linenos">325</span>
<span class="linenos">326</span><span class="sd">        Returns:</span>
<span class="linenos">327</span><span class="sd">            The scalar sliding surface value.</span>
<span class="linenos">328</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">329</span>        <span class="n">_</span><span class="p">,</span> <span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dtheta1</span><span class="p">,</span> <span class="n">dtheta2</span> <span class="o">=</span> <span class="n">state</span>
<span class="linenos">330</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam1</span> <span class="o">*</span> <span class="n">theta1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam2</span> <span class="o">*</span> <span class="n">theta2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k1</span> <span class="o">*</span> <span class="n">dtheta1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k2</span> <span class="o">*</span> <span class="n">dtheta2</span>
<span class="linenos">331</span>
<span class="linenos">332</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_equivalent_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="linenos">333</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the model-based equivalent control ``u_eq`` with enhanced robustness.</span>
<span class="linenos">334</span>
<span class="linenos">335</span><span class="sd">        Args:</span>
<span class="linenos">336</span><span class="sd">            state: State vector ``[x, theta1, theta2, xdot, dtheta1, dtheta2]``.</span>
<span class="linenos">337</span>
<span class="linenos">338</span><span class="sd">        Returns:</span>
<span class="linenos">339</span><span class="sd">            The scalar equivalent control value, or 0.0 if computation is deemed unreliable.</span>
<span class="linenos">340</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">341</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">342</span>            <span class="c1"># No dynamics model attached; return zero equivalent control.</span>
<span class="linenos">343</span>            <span class="k">return</span> <span class="mf">0.0</span>
<span class="linenos">344</span>
<span class="linenos">345</span>        <span class="n">q_dot</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
<span class="linenos">346</span>        <span class="c1"># Attempt to obtain the physics matrices from the dynamics model.  If</span>
<span class="linenos">347</span>        <span class="c1"># this fails, fall back to purely switching control.  Broad</span>
<span class="linenos">348</span>        <span class="c1"># exceptions are caught here to avoid propagating unexpected errors</span>
<span class="linenos">349</span>        <span class="c1"># upstream.  When the model cannot provide the matrices, equivalent</span>
<span class="linenos">350</span>        <span class="c1"># control is set to zero.</span>
<span class="linenos">351</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">352</span>            <span class="n">M</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyn</span><span class="o">.</span><span class="n">_compute_physics_matrices</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="linenos">353</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">354</span>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Physics matrix computation failed, returning safe zero control: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">355</span>            <span class="k">return</span> <span class="mf">0.0</span>  <span class="c1"># OK: Safe fallback when dynamics unavailable</span>
<span class="linenos">356</span>
<span class="linenos">357</span>        <span class="c1"># Apply Tikhonov regularisation to ensure the inertia matrix is</span>
<span class="linenos">358</span>        <span class="c1"># invertible.  Adding a small positive diagonal term improves</span>
<span class="linenos">359</span>        <span class="c1"># conditioning and avoids the need for expensive singular value</span>
<span class="linenos">360</span>        <span class="c1"># decompositions.  This technique, sometimes called diagonal jitter,</span>
<span class="linenos">361</span>        <span class="c1"># guarantees that the matrix becomes positive definite and</span>
<span class="linenos">362</span>        <span class="c1"># invertible.</span>
<span class="linenos">363</span>        <span class="n">M_reg</span> <span class="o">=</span> <span class="n">M</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<span class="linenos">364</span>
<span class="linenos">365</span>        <span class="c1"># Attempt to solve the linear system directly.  Use ``np.linalg.solve``</span>
<span class="linenos">366</span>        <span class="c1"># instead of a pseudo‑inverse to reduce computational overhead.</span>
<span class="linenos">367</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">368</span>            <span class="c1"># Compute the controllability scalar L @ M_reg^{-1} @ B.</span>
<span class="linenos">369</span>            <span class="n">Minv_B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M_reg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">)</span>
<span class="linenos">370</span>            <span class="n">L_Minv_B</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">@</span> <span class="n">Minv_B</span><span class="p">)</span>
<span class="linenos">371</span>            <span class="c1"># Guard against uncontrollable configurations.  If the scalar</span>
<span class="linenos">372</span>            <span class="c1"># approaches zero the equivalent control becomes ill‑defined and</span>
<span class="linenos">373</span>            <span class="c1"># we conservatively return zero.  The threshold used here</span>
<span class="linenos">374</span>            <span class="c1"># (``self.eq_threshold``) is independent of the boundary‑layer</span>
<span class="linenos">375</span>            <span class="c1"># thickness ``epsilon``.  Earlier versions tied this cutoff</span>
<span class="linenos">376</span>            <span class="c1"># directly to the boundary layer, conflating chattering mitigation</span>
<span class="linenos">377</span>            <span class="c1"># with controllability.  Sliding‑mode literature notes that</span>
<span class="linenos">378</span>            <span class="c1"># widening the boundary layer reduces chattering but induces a</span>
<span class="linenos">379</span>            <span class="c1"># steady‑state error; therefore the</span>
<span class="linenos">380</span>            <span class="c1"># controllability threshold should be tuned separately.  When</span>
<span class="linenos">381</span>            <span class="c1"># |L⋅M⁻¹⋅B| &lt; ``self.eq_threshold`` the equivalent control is</span>
<span class="linenos">382</span>            <span class="c1"># disabled.</span>
<span class="linenos">383</span>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">L_Minv_B</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">eq_threshold</span><span class="p">:</span>
<span class="linenos">384</span>                <span class="k">return</span> <span class="mf">0.0</span>
<span class="linenos">385</span>
<span class="linenos">386</span>            <span class="c1"># Compute the numerator of the equivalent control.  Handle</span>
<span class="linenos">387</span>            <span class="c1"># different shapes of the Coriolis matrix C gracefully: when C</span>
<span class="linenos">388</span>            <span class="c1"># is a matrix multiply by q_dot; when C is already a vector</span>
<span class="linenos">389</span>            <span class="c1"># treat it directly.  See the documentation for details.</span>
<span class="linenos">390</span>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="s2">&quot;ndim&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos">391</span>                <span class="n">rhs</span> <span class="o">=</span> <span class="n">C</span> <span class="o">@</span> <span class="n">q_dot</span> <span class="o">+</span> <span class="n">G</span>
<span class="linenos">392</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">393</span>                <span class="n">rhs</span> <span class="o">=</span> <span class="n">C</span> <span class="o">+</span> <span class="n">G</span>
<span class="linenos">394</span>            <span class="n">Minv_rhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M_reg</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
<span class="linenos">395</span>            <span class="n">term1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">@</span> <span class="n">Minv_rhs</span><span class="p">)</span>
<span class="linenos">396</span>            <span class="n">term2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam1</span> <span class="o">*</span> <span class="n">q_dot</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam2</span> <span class="o">*</span> <span class="n">q_dot</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">397</span>            <span class="n">u_eq</span> <span class="o">=</span> <span class="p">(</span><span class="n">term1</span> <span class="o">-</span> <span class="n">term2</span><span class="p">)</span> <span class="o">/</span> <span class="n">L_Minv_B</span>
<span class="linenos">398</span>        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
<span class="linenos">399</span>            <span class="c1"># Inversion failed despite regularisation; treat as singular.</span>
<span class="linenos">400</span>            <span class="k">return</span> <span class="mf">0.0</span>
<span class="linenos">401</span>
<span class="linenos">402</span>        <span class="c1"># In earlier versions a diagnostic clamp and a tiny bias term were</span>
<span class="linenos">403</span>        <span class="c1"># introduced here.  Empirically clamping the equivalent control to</span>
<span class="linenos">404</span>        <span class="c1"># ±10×max_force and returning an epsilon when u_eq=0 obscured the</span>
<span class="linenos">405</span>        <span class="c1"># true magnitude of the model‑based term and hindered reproducibility.</span>
<span class="linenos">406</span>        <span class="c1"># Current guidance from sliding‑mode theory advocates computing</span>
<span class="linenos">407</span>        <span class="c1"># exactly the model‑based feedforward term and handling large values</span>
<span class="linenos">408</span>        <span class="c1"># via the main saturation at the end of ``compute_control``</span>
<span class="linenos">409</span>        <span class="c1">#.  Therefore we simply return the</span>
<span class="linenos">410</span>        <span class="c1"># computed u_eq without adding biases.  The subsequent saturation</span>
<span class="linenos">411</span>        <span class="c1"># stage in ``compute_control`` will limit the control action.</span>
<span class="linenos">412</span>        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">u_eq</span><span class="p">)</span>
<span class="linenos">413</span>
<span class="linenos">414</span>
<span class="linenos">415</span>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_control</span><span class="p">(</span>
<span class="linenos">416</span>        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">state_vars</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">history</span><span class="p">:</span> <span class="nb">dict</span>
<span class="linenos">417</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ClassicalSMCOutput</span><span class="p">:</span>
<span class="linenos">418</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the control input for the classical SMC.</span>
<span class="linenos">419</span>
<span class="linenos">420</span><span class="sd">        The control law combines a model‑based equivalent term ``u_eq`` with</span>
<span class="linenos">421</span><span class="sd">        a discontinuous (but smoothed) sliding‑mode term.  The robust term</span>
<span class="linenos">422</span><span class="sd">        employs a saturation function within a boundary layer to approximate</span>
<span class="linenos">423</span><span class="sd">        the sign function, which reduces chattering by replacing the infinite</span>
<span class="linenos">424</span><span class="sd">        switching with a continuous control.  The</span>
<span class="linenos">425</span><span class="sd">        total command is given by</span>
<span class="linenos">426</span>
<span class="linenos">427</span><span class="sd">        .. math::</span>
<span class="linenos">428</span>
<span class="linenos">429</span><span class="sd">            u = u_{\\text{eq}} - K \\\\operatorname{sat}\\\\left(\\\\frac{\\\\sigma}{\\\\epsilon}\\\\right) - k_d \\\\, \\\\sigma,</span>
<span class="linenos">430</span>
<span class="linenos">431</span><span class="sd">        where ``sat`` is either ``tanh`` or a linear clip depending on</span>
<span class="linenos">432</span><span class="sd">        ``switch_method``.</span>
<span class="linenos">433</span>
<span class="linenos">434</span><span class="sd">        After summing the terms the result is saturated to lie within</span>
<span class="linenos">435</span><span class="sd">        ``[-max_force, +max_force]``.  Saturation of the final command limits</span>
<span class="linenos">436</span><span class="sd">        actuator effort and ensures physical plausibility.</span>
<span class="linenos">437</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">438</span>        <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_sliding_surface</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="linenos">439</span>
<span class="linenos">440</span>        <span class="c1"># Adaptive boundary layer: compute a state‑dependent epsilon that</span>
<span class="linenos">441</span>        <span class="c1"># scales with the magnitude of the sliding variable.  This</span>
<span class="linenos">442</span>        <span class="c1"># continuous approximation reduces chattering while shrinking</span>
<span class="linenos">443</span>        <span class="c1"># towards zero near the sliding manifold【967233543993377†L104-L115】.</span>
<span class="linenos">444</span>        <span class="n">eps_dyn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon1</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>
<span class="linenos">445</span>        <span class="c1"># Apply hysteresis: when |sigma| lies within a small fraction of the</span>
<span class="linenos">446</span>        <span class="c1"># nominal boundary layer the robust term is suppressed.  This</span>
<span class="linenos">447</span>        <span class="c1"># dead‑band mitigates chattering by freezing the discontinuous</span>
<span class="linenos">448</span>        <span class="c1"># control inside the hysteresis band【967233543993377†L104-L115】.</span>
<span class="linenos">449</span>        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">hysteresis_ratio</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon0</span><span class="p">:</span>
<span class="linenos">450</span>            <span class="n">sat_sigma</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos">451</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">452</span>            <span class="n">sat_sigma</span> <span class="o">=</span> <span class="n">saturate</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">eps_dyn</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">switch_method</span><span class="p">)</span>
<span class="linenos">453</span>
<span class="linenos">454</span>        <span class="n">u_eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_equivalent_control</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="linenos">455</span>        <span class="c1"># Moderately clamp the equivalent control.  Unbounded model‑based</span>
<span class="linenos">456</span>        <span class="c1"># terms can exceed the actuator limits by orders of magnitude,</span>
<span class="linenos">457</span>        <span class="c1"># causing integrator wind‑up and excitation of unmodelled</span>
<span class="linenos">458</span>        <span class="c1"># dynamics.  Sliding‑mode design guidelines recommend limiting</span>
<span class="linenos">459</span>        <span class="c1"># the equivalent component relative to the maximum control</span>
<span class="linenos">460</span>        <span class="c1"># authority.  We saturate u_eq at ±5×max_force,</span>
<span class="linenos">461</span>        <span class="c1"># which preserves the fidelity of the model‑based term while</span>
<span class="linenos">462</span>        <span class="c1"># preventing pathological spikes.</span>
<span class="linenos">463</span>        <span class="n">max_eq</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_force</span>
<span class="linenos">464</span>        <span class="k">if</span> <span class="n">u_eq</span> <span class="o">&gt;</span> <span class="n">max_eq</span><span class="p">:</span>
<span class="linenos">465</span>            <span class="n">u_eq</span> <span class="o">=</span> <span class="n">max_eq</span>
<span class="linenos">466</span>        <span class="k">elif</span> <span class="n">u_eq</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">max_eq</span><span class="p">:</span>
<span class="linenos">467</span>            <span class="n">u_eq</span> <span class="o">=</span> <span class="o">-</span><span class="n">max_eq</span>
<span class="linenos">468</span>
<span class="linenos">469</span>        <span class="n">u_robust</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">*</span> <span class="n">sat_sigma</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kd</span> <span class="o">*</span> <span class="n">sigma</span>
<span class="linenos">470</span>
<span class="linenos">471</span>        <span class="c1"># Combine equivalent and robust terms and saturate final command</span>
<span class="linenos">472</span>        <span class="c1"># to the actuator limits.  The final saturation prevents</span>
<span class="linenos">473</span>        <span class="c1"># commanded torques/forces from exceeding the physical</span>
<span class="linenos">474</span>        <span class="c1"># capability of the actuator.</span>
<span class="linenos">475</span>        <span class="n">u</span> <span class="o">=</span> <span class="n">u_eq</span> <span class="o">+</span> <span class="n">u_robust</span>
<span class="linenos">476</span>        <span class="n">u_saturated</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">max_force</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_force</span><span class="p">))</span>
<span class="linenos">477</span>
<span class="linenos">478</span>        <span class="c1"># Telemetry: append key signals to history (in-place)</span>
<span class="linenos">479</span>        <span class="n">hist</span> <span class="o">=</span> <span class="n">history</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
<span class="linenos">480</span>        <span class="n">hist</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>
<span class="linenos">481</span>        <span class="n">hist</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;epsilon_eff&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">eps_dyn</span><span class="p">))</span>
<span class="linenos">482</span>        <span class="n">hist</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;u_eq&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">u_eq</span><span class="p">))</span>
<span class="linenos">483</span>        <span class="n">hist</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;u_robust&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">u_robust</span><span class="p">))</span>
<span class="linenos">484</span>        <span class="n">hist</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;u_total&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="linenos">485</span>        <span class="n">hist</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">u_saturated</span><span class="p">))</span>
<span class="linenos">486</span>
<span class="linenos">487</span>        <span class="c1"># Return structured output</span>
<span class="linenos">488</span>        <span class="k">return</span> <span class="n">ClassicalSMCOutput</span><span class="p">(</span><span class="n">u_saturated</span><span class="p">,</span> <span class="p">(),</span> <span class="n">hist</span><span class="p">)</span>
<span class="linenos">489</span>
<span class="linenos">490</span>    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">491</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset ClassicalSMC controller state.</span>
<span class="linenos">492</span>
<span class="linenos">493</span><span class="sd">        Classical SMC has no internal state variables to reset since it is</span>
<span class="linenos">494</span><span class="sd">        stateless and purely reactive based on current measurements.</span>
<span class="linenos">495</span><span class="sd">        This method is provided for interface compliance.</span>
<span class="linenos">496</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">497</span>        <span class="c1"># Classical SMC is stateless - no internal state to reset</span>
<span class="linenos">498</span>        <span class="k">pass</span>
<span class="linenos">499</span>
<span class="linenos">500</span>    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">501</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Explicit memory cleanup to prevent leaks.</span>
<span class="linenos">502</span>
<span class="linenos">503</span><span class="sd">        Clears large NumPy arrays and breaks circular references to allow</span>
<span class="linenos">504</span><span class="sd">        proper garbage collection. Should be called when the controller is</span>
<span class="linenos">505</span><span class="sd">        no longer needed.</span>
<span class="linenos">506</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">507</span>        <span class="c1"># Nullify dynamics reference</span>
<span class="linenos">508</span>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_dynamics_ref&#39;</span><span class="p">):</span>
<span class="linenos">509</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_dynamics_ref</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span>
<span class="linenos">510</span>
<span class="linenos">511</span>        <span class="c1"># Clear any cached large arrays (future-proofing)</span>
<span class="linenos">512</span>        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;_state_buffer&#39;</span><span class="p">,</span> <span class="s1">&#39;_control_buffer&#39;</span><span class="p">,</span> <span class="s1">&#39;_surface_buffer&#39;</span><span class="p">]:</span>
<span class="linenos">513</span>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
<span class="linenos">514</span>                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">515</span>
<span class="linenos">516</span>        <span class="c1"># Clear internal arrays</span>
<span class="linenos">517</span>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">):</span>
<span class="linenos">518</span>            <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">519</span>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">):</span>
<span class="linenos">520</span>            <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">521</span>
<span class="linenos">522</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">523</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Destructor for automatic cleanup.</span>
<span class="linenos">524</span>
<span class="linenos">525</span><span class="sd">        Ensures cleanup is called when the controller is garbage collected.</span>
<span class="linenos">526</span><span class="sd">        Catches all exceptions to prevent errors during finalization.</span>
<span class="linenos">527</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">528</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">529</span>            <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
<span class="linenos">530</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">531</span>            <span class="k">pass</span>  <span class="c1"># Prevent exceptions during cleanup</span>
<span class="linenos">532</span>
<span class="linenos">533</span><span class="c1">#=======================================================================================\\\</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="classes">
<h2>Classes<a class="headerlink" href="#classes" title="Link to this heading">¶</a></h2>
<section id="classicalsmc">
<h3><code class="docutils literal notranslate"><span class="pre">ClassicalSMC</span></code><a class="headerlink" href="#classicalsmc" title="Link to this heading">¶</a></h3>
<p>Classical Sliding‑Mode Controller for a double‑inverted pendulum.</p>
<p>This controller implements the conventional first‑order sliding‑mode law
consisting of a model‑based equivalent control <code class="docutils literal notranslate"><span class="pre">u_eq</span></code> and a robust
discontinuous term.  The robust term uses a continuous approximation to
the sign function (either a hyperbolic tangent or a piecewise‑linear
saturation) within a boundary layer of width <code class="docutils literal notranslate"><span class="pre">epsilon</span></code> to attenuate
chattering.  Introducing a boundary layer around the switching surface
replaces the discontinuous signum control with a continuous function,
thereby reducing high‑frequency oscillations.  A number of authors
note that the boundary‑layer approximation attenuates chattering at
the cost of introducing a finite steady‑state tracking error; for
example, a discussion of chattering reduction methods emphasises
that the boundary‑layer method “reduces chattering but leads to a finite
steady state error”.  The user should therefore
select <code class="docutils literal notranslate"><span class="pre">epsilon</span></code> to balance chattering reduction against steady‑state
accuracy.</p>
<p>Two switching functions are available: <code class="docutils literal notranslate"><span class="pre">tanh</span></code> (smooth hyperbolic
tangent) and <code class="docutils literal notranslate"><span class="pre">linear</span></code> (piecewise‑linear saturation).  The <code class="docutils literal notranslate"><span class="pre">linear</span></code>
switch approximates the sign function more harshly by clipping the
sliding surface directly, which can degrade robustness near the origin
because the control gain effectively drops to zero for small errors.
In contrast, the <code class="docutils literal notranslate"><span class="pre">tanh</span></code> switch retains smoothness and maintains a
nonzero slope through the origin, preserving control authority in a
neighbourhood of the sliding surface.  Users should prefer
<code class="docutils literal notranslate"><span class="pre">tanh</span></code> unless there is a compelling reason to adopt the linear
saturation and should be aware that linear saturation may cause
increased steady‑state error and slower convergence near the origin.</p>
<p>A small diagonal <code class="docutils literal notranslate"><span class="pre">regularization</span></code> is added to the inertia matrix during
inversion to ensure positive definiteness and numerical robustness.
Adding a tiny constant to the diagonal of a symmetric matrix is a
well‑known regularisation technique: in the context of covariance
matrices, Leung and colleagues recommend “adding a small, positive
constant to the diagonal” to ensure the matrix is invertible.</p>
<p>Parameters are typically supplied by a factory that reads a central
configuration.  Each gain vector must contain exactly six elements in the
order <code class="docutils literal notranslate"><span class="pre">[k1,</span> <span class="pre">k2,</span> <span class="pre">lam1,</span> <span class="pre">lam2,</span> <span class="pre">K,</span> <span class="pre">kd]</span></code>.  The maximum force <code class="docutils literal notranslate"><span class="pre">max_force</span></code>
sets the saturation limit for the final control command.</p>
<p>The optional <code class="docutils literal notranslate"><span class="pre">controllability_threshold</span></code> parameter decouples
controllability from the boundary layer <code class="docutils literal notranslate"><span class="pre">epsilon</span></code>.  Earlier
implementations compared the magnitude of <code class="docutils literal notranslate"><span class="pre">L·M^{-1}·B</span></code> against
<code class="docutils literal notranslate"><span class="pre">epsilon</span></code> to decide whether to compute the equivalent control.  This
conflation of chattering mitigation with controllability made it
difficult to tune each effect separately.  <code class="docutils literal notranslate"><span class="pre">controllability_threshold</span></code>
defines a lower bound on <code class="docutils literal notranslate"><span class="pre">|L·M^{-1}·B|</span></code> below which the equivalent
control is suppressed.  If unspecified, a default of <code class="docutils literal notranslate"><span class="pre">1e‑4</span></code> is used
based on matrix conditioning guidelines.  The
boundary layer width <code class="docutils literal notranslate"><span class="pre">epsilon</span></code> should therefore be chosen solely to
trade off between chattering and steady‑state error, while
<code class="docutils literal notranslate"><span class="pre">controllability_threshold</span></code> governs when the model‑based feedforward
term is applied.</p>
<p><strong>Gain positivity (F‑4.SMCDesign.2 / RC‑04)</strong> – Sliding‑mode theory
requires that the sliding‑surface gains <code class="docutils literal notranslate"><span class="pre">k1</span></code>, <code class="docutils literal notranslate"><span class="pre">k2</span></code> and the slope
coefficients <code class="docutils literal notranslate"><span class="pre">lam1</span></code>, <code class="docutils literal notranslate"><span class="pre">lam2</span></code> be strictly positive.  Utkin and
Levant note that the discontinuous control gain <code class="docutils literal notranslate"><span class="pre">k</span></code> must be a
positive constant【Rhif2012†L563-L564】, and the slope <code class="docutils literal notranslate"><span class="pre">λ</span></code> of the
sliding function must be chosen positive to ensure Hurwitz
stability【ModelFreeSMC2018†L340-L345】.  The switching gain <code class="docutils literal notranslate"><span class="pre">K</span></code> must
also be strictly positive to drive the system to the sliding surface,
while the derivative gain <code class="docutils literal notranslate"><span class="pre">kd</span></code> should be non‑negative to provide
damping.  The constructor validates these constraints and raises
<code class="docutils literal notranslate"><span class="pre">ValueError</span></code> when violated.</p>
<section id="source-code">
<h4>Source Code<a class="headerlink" href="#source-code" title="Link to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="k">class</span><span class="w"> </span><span class="nc">ClassicalSMC</span><span class="p">:</span>
<span class="linenos">  2</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  3</span><span class="sd">    Classical Sliding‑Mode Controller for a double‑inverted pendulum.</span>
<span class="linenos">  4</span>
<span class="linenos">  5</span><span class="sd">    This controller implements the conventional first‑order sliding‑mode law</span>
<span class="linenos">  6</span><span class="sd">    consisting of a model‑based equivalent control ``u_eq`` and a robust</span>
<span class="linenos">  7</span><span class="sd">    discontinuous term.  The robust term uses a continuous approximation to</span>
<span class="linenos">  8</span><span class="sd">    the sign function (either a hyperbolic tangent or a piecewise‑linear</span>
<span class="linenos">  9</span><span class="sd">    saturation) within a boundary layer of width ``epsilon`` to attenuate</span>
<span class="linenos"> 10</span><span class="sd">    chattering.  Introducing a boundary layer around the switching surface</span>
<span class="linenos"> 11</span><span class="sd">    replaces the discontinuous signum control with a continuous function,</span>
<span class="linenos"> 12</span><span class="sd">    thereby reducing high‑frequency oscillations.  A number of authors</span>
<span class="linenos"> 13</span><span class="sd">    note that the boundary‑layer approximation attenuates chattering at</span>
<span class="linenos"> 14</span><span class="sd">    the cost of introducing a finite steady‑state tracking error; for</span>
<span class="linenos"> 15</span><span class="sd">    example, a discussion of chattering reduction methods emphasises</span>
<span class="linenos"> 16</span><span class="sd">    that the boundary‑layer method &quot;reduces chattering but leads to a finite</span>
<span class="linenos"> 17</span><span class="sd">    steady state error&quot;.  The user should therefore</span>
<span class="linenos"> 18</span><span class="sd">    select ``epsilon`` to balance chattering reduction against steady‑state</span>
<span class="linenos"> 19</span><span class="sd">    accuracy.</span>
<span class="linenos"> 20</span>
<span class="linenos"> 21</span><span class="sd">    Two switching functions are available: ``tanh`` (smooth hyperbolic</span>
<span class="linenos"> 22</span><span class="sd">    tangent) and ``linear`` (piecewise‑linear saturation).  The ``linear``</span>
<span class="linenos"> 23</span><span class="sd">    switch approximates the sign function more harshly by clipping the</span>
<span class="linenos"> 24</span><span class="sd">    sliding surface directly, which can degrade robustness near the origin</span>
<span class="linenos"> 25</span><span class="sd">    because the control gain effectively drops to zero for small errors.</span>
<span class="linenos"> 26</span><span class="sd">    In contrast, the ``tanh`` switch retains smoothness and maintains a</span>
<span class="linenos"> 27</span><span class="sd">    nonzero slope through the origin, preserving control authority in a</span>
<span class="linenos"> 28</span><span class="sd">    neighbourhood of the sliding surface.  Users should prefer</span>
<span class="linenos"> 29</span><span class="sd">    ``tanh`` unless there is a compelling reason to adopt the linear</span>
<span class="linenos"> 30</span><span class="sd">    saturation and should be aware that linear saturation may cause</span>
<span class="linenos"> 31</span><span class="sd">    increased steady‑state error and slower convergence near the origin.</span>
<span class="linenos"> 32</span>
<span class="linenos"> 33</span><span class="sd">    A small diagonal ``regularization`` is added to the inertia matrix during</span>
<span class="linenos"> 34</span><span class="sd">    inversion to ensure positive definiteness and numerical robustness.</span>
<span class="linenos"> 35</span><span class="sd">    Adding a tiny constant to the diagonal of a symmetric matrix is a</span>
<span class="linenos"> 36</span><span class="sd">    well‑known regularisation technique: in the context of covariance</span>
<span class="linenos"> 37</span><span class="sd">    matrices, Leung and colleagues recommend “adding a small, positive</span>
<span class="linenos"> 38</span><span class="sd">    constant to the diagonal” to ensure the matrix is invertible.</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span><span class="sd">    Parameters are typically supplied by a factory that reads a central</span>
<span class="linenos"> 41</span><span class="sd">    configuration.  Each gain vector must contain exactly six elements in the</span>
<span class="linenos"> 42</span><span class="sd">    order ``[k1, k2, lam1, lam2, K, kd]``.  The maximum force ``max_force``</span>
<span class="linenos"> 43</span><span class="sd">    sets the saturation limit for the final control command.</span>
<span class="linenos"> 44</span>
<span class="linenos"> 45</span><span class="sd">    The optional ``controllability_threshold`` parameter decouples</span>
<span class="linenos"> 46</span><span class="sd">    controllability from the boundary layer ``epsilon``.  Earlier</span>
<span class="linenos"> 47</span><span class="sd">    implementations compared the magnitude of ``L·M^{-1}·B`` against</span>
<span class="linenos"> 48</span><span class="sd">    ``epsilon`` to decide whether to compute the equivalent control.  This</span>
<span class="linenos"> 49</span><span class="sd">    conflation of chattering mitigation with controllability made it</span>
<span class="linenos"> 50</span><span class="sd">    difficult to tune each effect separately.  ``controllability_threshold``</span>
<span class="linenos"> 51</span><span class="sd">    defines a lower bound on ``|L·M^{-1}·B|`` below which the equivalent</span>
<span class="linenos"> 52</span><span class="sd">    control is suppressed.  If unspecified, a default of ``1e‑4`` is used</span>
<span class="linenos"> 53</span><span class="sd">    based on matrix conditioning guidelines.  The</span>
<span class="linenos"> 54</span><span class="sd">    boundary layer width ``epsilon`` should therefore be chosen solely to</span>
<span class="linenos"> 55</span><span class="sd">    trade off between chattering and steady‑state error, while</span>
<span class="linenos"> 56</span><span class="sd">    ``controllability_threshold`` governs when the model‑based feedforward</span>
<span class="linenos"> 57</span><span class="sd">    term is applied.</span>
<span class="linenos"> 58</span>
<span class="linenos"> 59</span><span class="sd">    **Gain positivity (F‑4.SMCDesign.2 / RC‑04)** – Sliding‑mode theory</span>
<span class="linenos"> 60</span><span class="sd">    requires that the sliding‑surface gains ``k1``, ``k2`` and the slope</span>
<span class="linenos"> 61</span><span class="sd">    coefficients ``lam1``, ``lam2`` be strictly positive.  Utkin and</span>
<span class="linenos"> 62</span><span class="sd">    Levant note that the discontinuous control gain ``k`` must be a</span>
<span class="linenos"> 63</span><span class="sd">    positive constant【Rhif2012†L563-L564】, and the slope ``λ`` of the</span>
<span class="linenos"> 64</span><span class="sd">    sliding function must be chosen positive to ensure Hurwitz</span>
<span class="linenos"> 65</span><span class="sd">    stability【ModelFreeSMC2018†L340-L345】.  The switching gain ``K`` must</span>
<span class="linenos"> 66</span><span class="sd">    also be strictly positive to drive the system to the sliding surface,</span>
<span class="linenos"> 67</span><span class="sd">    while the derivative gain ``kd`` should be non‑negative to provide</span>
<span class="linenos"> 68</span><span class="sd">    damping.  The constructor validates these constraints and raises</span>
<span class="linenos"> 69</span><span class="sd">    ``ValueError`` when violated.</span>
<span class="linenos"> 70</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 71</span>
<span class="linenos"> 72</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<span class="linenos"> 73</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos"> 74</span>        <span class="n">gains</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
<span class="linenos"> 75</span>        <span class="n">max_force</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="linenos"> 76</span>        <span class="n">boundary_layer</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="linenos"> 77</span>        <span class="n">dynamics_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;DoubleInvertedPendulum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 78</span>        <span class="n">regularization</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-10</span><span class="p">,</span>
<span class="linenos"> 79</span>        <span class="n">switch_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tanh&quot;</span><span class="p">,</span>
<span class="linenos"> 80</span>        <span class="o">*</span><span class="p">,</span>
<span class="linenos"> 81</span>        <span class="n">boundary_layer_slope</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="linenos"> 82</span>        <span class="n">controllability_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 83</span>        <span class="n">hysteresis_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="linenos"> 84</span>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="linenos"> 85</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 86</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the controller.</span>
<span class="linenos"> 87</span>
<span class="linenos"> 88</span><span class="sd">        Args:</span>
<span class="linenos"> 89</span><span class="sd">            gains: Six gains in the order ``[k1, k2, lam1, lam2, K, kd]``.</span>
<span class="linenos"> 90</span><span class="sd">            max_force: Saturation limit for the control input (N).</span>
<span class="linenos"> 91</span><span class="sd">            boundary_layer: Boundary layer thickness (epsilon) for chattering reduction.</span>
<span class="linenos"> 92</span><span class="sd">            dynamics_model: Dynamics model providing physics matrices via ``_compute_physics_matrices``.</span>
<span class="linenos"> 93</span><span class="sd">            regularization: Small value to add to the diagonal of the inertia matrix for numerical stability.</span>
<span class="linenos"> 94</span><span class="sd">            **kwargs: Ignored extras to keep factory compatibility.</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span><span class="sd">        Raises:</span>
<span class="linenos"> 97</span><span class="sd">            ValueError: If ``gains`` does not contain exactly six elements</span>
<span class="linenos"> 98</span><span class="sd">                        or if ``boundary_layer`` is not strictly positive.</span>
<span class="linenos"> 99</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">100</span>        <span class="c1"># Validate and normalise the supplied gains early.  This makes it</span>
<span class="linenos">101</span>        <span class="c1"># possible for the factory or PSO tuner to reject misconfigured</span>
<span class="linenos">102</span>        <span class="c1"># gain vectors before instantiating the controller.  Accept any</span>
<span class="linenos">103</span>        <span class="c1"># sequence or array-like input and coerce it to a flat NumPy array</span>
<span class="linenos">104</span>        <span class="c1"># of floats.  After validation the gains are unpacked into the</span>
<span class="linenos">105</span>        <span class="c1"># canonical order ``[k1, k2, lam1, lam2, K, kd]``.</span>
<span class="linenos">106</span>        <span class="bp">self</span><span class="o">.</span><span class="n">validate_gains</span><span class="p">(</span><span class="n">gains</span><span class="p">)</span>
<span class="linenos">107</span>        <span class="c1"># Coerce to a 1‑D array of floats; ravel() flattens nested sequences</span>
<span class="linenos">108</span>        <span class="n">gains_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gains</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="linenos">109</span>        <span class="c1"># Store a shallow copy of the gains for external inspection.  Using</span>
<span class="linenos">110</span>        <span class="c1"># list() avoids exposing the internal NumPy array directly.</span>
<span class="linenos">111</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_gains</span> <span class="o">=</span> <span class="n">gains_arr</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="linenos">112</span>        <span class="c1"># Unpack the gains into individual parameters</span>
<span class="linenos">113</span>        <span class="bp">self</span><span class="o">.</span><span class="n">k1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kd</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">gains_arr</span><span class="p">)</span>
<span class="linenos">114</span>        <span class="c1"># Validate shared parameters via central utility.  Positivity of gains</span>
<span class="linenos">115</span>        <span class="c1"># and boundary layers ensures that the sliding surface and switching</span>
<span class="linenos">116</span>        <span class="c1"># function remain well‑defined and stable.</span>
<span class="linenos">117</span>        <span class="c1"># Import from new modular utils structure</span>
<span class="linenos">118</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">119</span>            <span class="kn">from</span><span class="w"> </span><span class="nn">src.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">require_positive</span>  <span class="c1"># when repo root on sys.path</span>
<span class="linenos">120</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">121</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">122</span>                <span class="kn">from</span><span class="w"> </span><span class="nn">...utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">require_positive</span>  <span class="c1"># when importing as src.controllers.*</span>
<span class="linenos">123</span>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">124</span>                <span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">require_positive</span>    <span class="c1"># when src itself on sys.path</span>
<span class="linenos">125</span>        <span class="bp">self</span><span class="o">.</span><span class="n">max_force</span> <span class="o">=</span> <span class="n">require_positive</span><span class="p">(</span><span class="n">max_force</span><span class="p">,</span> <span class="s2">&quot;max_force&quot;</span><span class="p">)</span>
<span class="linenos">126</span>        <span class="c1"># Use helpers for the adaptive boundary layer.  The nominal</span>
<span class="linenos">127</span>        <span class="c1"># thickness ``epsilon0`` must be strictly positive, while</span>
<span class="linenos">128</span>        <span class="c1"># ``boundary_layer_slope`` can be zero or positive.  A positive</span>
<span class="linenos">129</span>        <span class="c1"># slope scales the boundary layer with the norm of the sliding</span>
<span class="linenos">130</span>        <span class="c1"># variable, reducing chattering for large errors and shrinking</span>
<span class="linenos">131</span>        <span class="c1"># the layer as the error vanishes【967233543993377†L104-L115】.</span>
<span class="linenos">132</span>        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon0</span> <span class="o">=</span> <span class="n">require_positive</span><span class="p">(</span><span class="n">boundary_layer</span><span class="p">,</span> <span class="s2">&quot;boundary_layer&quot;</span><span class="p">)</span>
<span class="linenos">133</span>        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">boundary_layer_slope</span><span class="p">)</span>
<span class="linenos">134</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon1</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
<span class="linenos">135</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;boundary_layer_slope must be non‑negative&quot;</span><span class="p">)</span>
<span class="linenos">136</span>        <span class="c1"># Backwards compatibility: retain constant epsilon attribute</span>
<span class="linenos">137</span>        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon0</span>
<span class="linenos">138</span>
<span class="linenos">139</span>        <span class="c1"># Hysteresis ratio defines an inner dead‑band in which the</span>
<span class="linenos">140</span>        <span class="c1"># discontinuous robust term is suppressed.  A value in [0,1]</span>
<span class="linenos">141</span>        <span class="c1"># scales the nominal boundary layer ε; when |σ| &lt; hysteresis_ratio·ε0</span>
<span class="linenos">142</span>        <span class="c1"># the robust term is frozen to zero【967233543993377†L104-L115】.  This</span>
<span class="linenos">143</span>        <span class="c1"># further reduces chattering by avoiding high‑frequency switching</span>
<span class="linenos">144</span>        <span class="c1"># inside a small neighbourhood of the sliding surface.</span>
<span class="linenos">145</span>        <span class="bp">self</span><span class="o">.</span><span class="n">hysteresis_ratio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hysteresis_ratio</span><span class="p">)</span>
<span class="linenos">146</span>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hysteresis_ratio</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">):</span>
<span class="linenos">147</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;hysteresis_ratio must be within [0,1]&quot;</span><span class="p">)</span>
<span class="linenos">148</span>
<span class="linenos">149</span>        <span class="c1"># ---- Additional validation of SMC gains (F‑4.SMCDesign.2 / RC‑04) ----</span>
<span class="linenos">150</span>        <span class="c1"># Sliding‑mode theory requires strictly positive sliding‑surface and</span>
<span class="linenos">151</span>        <span class="c1"># switching gains and non‑negative derivative gain.  Validate each</span>
<span class="linenos">152</span>        <span class="c1"># gain here to catch misconfiguration early【Rhif2012†L563-L564】【ModelFreeSMC2018†L340-L345】.</span>
<span class="linenos">153</span>        <span class="bp">self</span><span class="o">.</span><span class="n">k1</span> <span class="o">=</span> <span class="n">require_positive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k1</span><span class="p">,</span> <span class="s2">&quot;k1&quot;</span><span class="p">)</span>
<span class="linenos">154</span>        <span class="bp">self</span><span class="o">.</span><span class="n">k2</span> <span class="o">=</span> <span class="n">require_positive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k2</span><span class="p">,</span> <span class="s2">&quot;k2&quot;</span><span class="p">)</span>
<span class="linenos">155</span>        <span class="bp">self</span><span class="o">.</span><span class="n">lam1</span> <span class="o">=</span> <span class="n">require_positive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lam1</span><span class="p">,</span> <span class="s2">&quot;lam1&quot;</span><span class="p">)</span>
<span class="linenos">156</span>        <span class="bp">self</span><span class="o">.</span><span class="n">lam2</span> <span class="o">=</span> <span class="n">require_positive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lam2</span><span class="p">,</span> <span class="s2">&quot;lam2&quot;</span><span class="p">)</span>
<span class="linenos">157</span>        <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">require_positive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">)</span>
<span class="linenos">158</span>        <span class="c1"># Allow derivative gain to be zero but not negative</span>
<span class="linenos">159</span>        <span class="bp">self</span><span class="o">.</span><span class="n">kd</span> <span class="o">=</span> <span class="n">require_positive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kd</span><span class="p">,</span> <span class="s2">&quot;kd&quot;</span><span class="p">,</span> <span class="n">allow_zero</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">160</span>
<span class="linenos">161</span>        <span class="c1"># Use weakref for dynamics model to break circular references</span>
<span class="linenos">162</span>        <span class="k">if</span> <span class="n">dynamics_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">163</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_dynamics_ref</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">dynamics_model</span><span class="p">)</span>
<span class="linenos">164</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">165</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_dynamics_ref</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span>
<span class="linenos">166</span>
<span class="linenos">167</span>        <span class="bp">self</span><span class="o">.</span><span class="n">regularization</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">regularization</span><span class="p">)</span>
<span class="linenos">168</span>        <span class="c1"># Switching function selection</span>
<span class="linenos">169</span>        <span class="n">sm</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">switch_method</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="linenos">170</span>        <span class="k">if</span> <span class="n">sm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;tanh&quot;</span><span class="p">,</span> <span class="s2">&quot;linear&quot;</span><span class="p">):</span>
<span class="linenos">171</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;switch_method must be &#39;tanh&#39; or &#39;linear&#39;&quot;</span><span class="p">)</span>
<span class="linenos">172</span>        <span class="bp">self</span><span class="o">.</span><span class="n">switch_method</span> <span class="o">=</span> <span class="n">sm</span>
<span class="linenos">173</span>
<span class="linenos">174</span>        <span class="c1"># Declare the dimensionality of the gain vector.  Exposing the</span>
<span class="linenos">175</span>        <span class="c1"># number of gains allows optimisers such as PSOTuner to infer</span>
<span class="linenos">176</span>        <span class="c1"># controller dimensionality without trial instantiation.  See</span>
<span class="linenos">177</span>        <span class="c1"># design review section 5 (PSO integration).</span>
<span class="linenos">178</span>        <span class="bp">self</span><span class="o">.</span><span class="n">n_gains</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span>
<span class="linenos">179</span>
<span class="linenos">180</span>        <span class="c1"># (C-007) Cache the model&#39;s singularity conditioning threshold if provided.</span>
<span class="linenos">181</span>        <span class="c1"># If unavailable, leave as None to allow regularization to rehabilitate borderline cases.</span>
<span class="linenos">182</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_cond_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">183</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">184</span>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn</span><span class="p">,</span> <span class="s2">&quot;p_model&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn</span><span class="o">.</span><span class="n">p_model</span><span class="p">,</span> <span class="s2">&quot;singularity_cond_threshold&quot;</span><span class="p">):</span>
<span class="linenos">185</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_cond_threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn</span><span class="o">.</span><span class="n">p_model</span><span class="o">.</span><span class="n">singularity_cond_threshold</span><span class="p">)</span>
<span class="linenos">186</span>            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;singularity_cond_threshold&quot;</span><span class="p">):</span>
<span class="linenos">187</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_cond_threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">singularity_cond_threshold</span><span class="p">)</span>
<span class="linenos">188</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">189</span>            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not extract condition threshold, disabling monitoring: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">190</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_cond_threshold</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># OK: Monitoring is optional</span>
<span class="linenos">191</span>
<span class="linenos">192</span>        <span class="c1"># Sliding surface uses only joint rates; cart input appears via B</span>
<span class="linenos">193</span>        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">194</span>        <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">195</span>
<span class="linenos">196</span>        <span class="c1"># Configure logger</span>
<span class="linenos">197</span>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<span class="linenos">198</span>
<span class="linenos">199</span>        <span class="c1"># Store the controllability threshold used when computing the</span>
<span class="linenos">200</span>        <span class="c1"># equivalent control.  Earlier versions used the boundary layer</span>
<span class="linenos">201</span>        <span class="c1"># thickness `epsilon` as the cutoff for |L·M⁻¹·B|, conflating</span>
<span class="linenos">202</span>        <span class="c1"># chattering mitigation with controllability.</span>
<span class="linenos">203</span>        <span class="c1"># Here we allow the caller to specify a separate threshold via</span>
<span class="linenos">204</span>        <span class="c1"># ``controllability_threshold``.  If unspecified, a default of</span>
<span class="linenos">205</span>        <span class="c1"># 1e‑4 is used as a conservative lower bound on |L·M⁻¹·B|; too</span>
<span class="linenos">206</span>        <span class="c1"># small of a threshold can lead to numerical instabilities, while a</span>
<span class="linenos">207</span>        <span class="c1"># larger threshold needlessly suppresses the equivalent control.  See</span>
<span class="linenos">208</span>        <span class="c1"># Golub &amp; Van Loan for background on conditioning of linear systems.</span>
<span class="linenos">209</span>        <span class="k">if</span> <span class="n">controllability_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">210</span>            <span class="c1"># Scale the equivalent‑control threshold with the sum of switching gains.</span>
<span class="linenos">211</span>            <span class="c1"># Sliding‑mode theory states that the switching gain must exceed the</span>
<span class="linenos">212</span>            <span class="c1"># bound of system uncertainties plus a positive margin to guarantee</span>
<span class="linenos">213</span>            <span class="c1"># sliding【412237323761959†L496-L507】.  A threshold proportional to</span>
<span class="linenos">214</span>            <span class="c1"># (k1 + k2) avoids enabling the equivalent control when the system</span>
<span class="linenos">215</span>            <span class="c1"># is poorly controllable and adapts automatically when gains are</span>
<span class="linenos">216</span>            <span class="c1"># tuned.  The factor 0.05 was empirically chosen to provide a</span>
<span class="linenos">217</span>            <span class="c1"># conservative cutoff.</span>
<span class="linenos">218</span>            <span class="bp">self</span><span class="o">.</span><span class="n">eq_threshold</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k2</span><span class="p">)</span>
<span class="linenos">219</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">220</span>            <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">controllability_threshold</span><span class="p">)</span>
<span class="linenos">221</span>            <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
<span class="linenos">222</span>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;controllability_threshold must be &gt; 0&quot;</span><span class="p">)</span>
<span class="linenos">223</span>            <span class="bp">self</span><span class="o">.</span><span class="n">eq_threshold</span> <span class="o">=</span> <span class="n">val</span>
<span class="linenos">224</span>
<span class="linenos">225</span>    <span class="c1"># ------------------------------------------------------------------</span>
<span class="linenos">226</span>    <span class="c1"># Properties</span>
<span class="linenos">227</span>    <span class="c1"># ------------------------------------------------------------------</span>
<span class="linenos">228</span>    <span class="nd">@property</span>
<span class="linenos">229</span>    <span class="k">def</span><span class="w"> </span><span class="nf">gains</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="linenos">230</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the list of gains used by this controller.</span>
<span class="linenos">231</span>
<span class="linenos">232</span><span class="sd">        This property exposes the six control gains in the canonical order</span>
<span class="linenos">233</span><span class="sd">        ``[k1, k2, lam1, lam2, K, kd]`` for external introspection.  The</span>
<span class="linenos">234</span><span class="sd">        returned list is a shallow copy to prevent accidental mutation of</span>
<span class="linenos">235</span><span class="sd">        the controller&#39;s internal parameters.</span>
<span class="linenos">236</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">237</span>        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gains</span><span class="p">)</span>
<span class="linenos">238</span>
<span class="linenos">239</span>    <span class="nd">@property</span>
<span class="linenos">240</span>    <span class="k">def</span><span class="w"> </span><span class="nf">dyn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">241</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Access dynamics model via weakref.&quot;&quot;&quot;</span>
<span class="linenos">242</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamics_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">243</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamics_ref</span><span class="p">()</span>
<span class="linenos">244</span>        <span class="k">return</span> <span class="kc">None</span>
<span class="linenos">245</span>
<span class="linenos">246</span>    <span class="nd">@dyn</span><span class="o">.</span><span class="n">setter</span>
<span class="linenos">247</span>    <span class="k">def</span><span class="w"> </span><span class="nf">dyn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="linenos">248</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set dynamics model using weakref.&quot;&quot;&quot;</span>
<span class="linenos">249</span>        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">250</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_dynamics_ref</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="linenos">251</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">252</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_dynamics_ref</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span>
<span class="linenos">253</span>
<span class="linenos">254</span>    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="linenos">255</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;No internal state for classical SMC; returns an empty tuple.&quot;&quot;&quot;</span>
<span class="linenos">256</span>        <span class="k">return</span> <span class="p">()</span>
<span class="linenos">257</span>
<span class="linenos">258</span>    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_history</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="linenos">259</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;No history tracked for classical SMC; returns an empty dict.&quot;&quot;&quot;</span>
<span class="linenos">260</span>        <span class="k">return</span> <span class="p">{}</span>
<span class="linenos">261</span>
<span class="linenos">262</span>    <span class="nd">@staticmethod</span>
<span class="linenos">263</span>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_gains</span><span class="p">(</span><span class="n">gains</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">264</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">265</span><span class="sd">        Validate that exactly six gains have been provided for the classical SMC.</span>
<span class="linenos">266</span>
<span class="linenos">267</span><span class="sd">        The classical sliding–mode controller uses six gains in the order</span>
<span class="linenos">268</span><span class="sd">        ``[k1, k2, lam1, lam2, K, kd]``.  Any other length is considered</span>
<span class="linenos">269</span><span class="sd">        misconfigured and results in a ``ValueError``.  This validator accepts</span>
<span class="linenos">270</span><span class="sd">        any sequence or array-like input and coerces it to a one‑dimensional</span>
<span class="linenos">271</span><span class="sd">        array of floats before verifying its length.  When coercion fails or</span>
<span class="linenos">272</span><span class="sd">        the resulting array does not contain exactly six elements, a</span>
<span class="linenos">273</span><span class="sd">        ``ValueError`` is raised.</span>
<span class="linenos">274</span>
<span class="linenos">275</span><span class="sd">        Parameters</span>
<span class="linenos">276</span><span class="sd">        ----------</span>
<span class="linenos">277</span><span class="sd">        gains : Sequence[float] or array-like</span>
<span class="linenos">278</span><span class="sd">            Sequence of gain values supplied during construction.</span>
<span class="linenos">279</span>
<span class="linenos">280</span><span class="sd">        Raises</span>
<span class="linenos">281</span><span class="sd">        ------</span>
<span class="linenos">282</span><span class="sd">        ValueError</span>
<span class="linenos">283</span><span class="sd">            If ``gains`` is not convertible to a sequence of length six.</span>
<span class="linenos">284</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">285</span>        <span class="c1"># Attempt to coerce the gains into a flat NumPy array.  Any exception</span>
<span class="linenos">286</span>        <span class="c1"># indicates the input is not sequence-like or contains non-numeric</span>
<span class="linenos">287</span>        <span class="c1"># entries and should result in a validation error.</span>
<span class="linenos">288</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">289</span>            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gains</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="linenos">290</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">291</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos">292</span>                <span class="s2">&quot;ClassicalSMC requires 6 gains: [k1, k2, lam1, lam2, K, kd]&quot;</span>
<span class="linenos">293</span>            <span class="p">)</span>
<span class="linenos">294</span>        <span class="c1"># Ensure exactly six gains are provided</span>
<span class="linenos">295</span>        <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span>
<span class="linenos">296</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos">297</span>                <span class="s2">&quot;ClassicalSMC requires 6 gains: [k1, k2, lam1, lam2, K, kd]&quot;</span>
<span class="linenos">298</span>            <span class="p">)</span>
<span class="linenos">299</span>
<span class="linenos">300</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_sliding_surface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="linenos">301</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the sliding surface value, ``sigma``.</span>
<span class="linenos">302</span>
<span class="linenos">303</span><span class="sd">        Args:</span>
<span class="linenos">304</span><span class="sd">            state: State vector ``[x, theta1, theta2, xdot, dtheta1, dtheta2]``.</span>
<span class="linenos">305</span>
<span class="linenos">306</span><span class="sd">        Returns:</span>
<span class="linenos">307</span><span class="sd">            The scalar sliding surface value.</span>
<span class="linenos">308</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">309</span>        <span class="n">_</span><span class="p">,</span> <span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dtheta1</span><span class="p">,</span> <span class="n">dtheta2</span> <span class="o">=</span> <span class="n">state</span>
<span class="linenos">310</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam1</span> <span class="o">*</span> <span class="n">theta1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam2</span> <span class="o">*</span> <span class="n">theta2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k1</span> <span class="o">*</span> <span class="n">dtheta1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k2</span> <span class="o">*</span> <span class="n">dtheta2</span>
<span class="linenos">311</span>
<span class="linenos">312</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_equivalent_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="linenos">313</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the model-based equivalent control ``u_eq`` with enhanced robustness.</span>
<span class="linenos">314</span>
<span class="linenos">315</span><span class="sd">        Args:</span>
<span class="linenos">316</span><span class="sd">            state: State vector ``[x, theta1, theta2, xdot, dtheta1, dtheta2]``.</span>
<span class="linenos">317</span>
<span class="linenos">318</span><span class="sd">        Returns:</span>
<span class="linenos">319</span><span class="sd">            The scalar equivalent control value, or 0.0 if computation is deemed unreliable.</span>
<span class="linenos">320</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">321</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">322</span>            <span class="c1"># No dynamics model attached; return zero equivalent control.</span>
<span class="linenos">323</span>            <span class="k">return</span> <span class="mf">0.0</span>
<span class="linenos">324</span>
<span class="linenos">325</span>        <span class="n">q_dot</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
<span class="linenos">326</span>        <span class="c1"># Attempt to obtain the physics matrices from the dynamics model.  If</span>
<span class="linenos">327</span>        <span class="c1"># this fails, fall back to purely switching control.  Broad</span>
<span class="linenos">328</span>        <span class="c1"># exceptions are caught here to avoid propagating unexpected errors</span>
<span class="linenos">329</span>        <span class="c1"># upstream.  When the model cannot provide the matrices, equivalent</span>
<span class="linenos">330</span>        <span class="c1"># control is set to zero.</span>
<span class="linenos">331</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">332</span>            <span class="n">M</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyn</span><span class="o">.</span><span class="n">_compute_physics_matrices</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="linenos">333</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">334</span>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Physics matrix computation failed, returning safe zero control: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">335</span>            <span class="k">return</span> <span class="mf">0.0</span>  <span class="c1"># OK: Safe fallback when dynamics unavailable</span>
<span class="linenos">336</span>
<span class="linenos">337</span>        <span class="c1"># Apply Tikhonov regularisation to ensure the inertia matrix is</span>
<span class="linenos">338</span>        <span class="c1"># invertible.  Adding a small positive diagonal term improves</span>
<span class="linenos">339</span>        <span class="c1"># conditioning and avoids the need for expensive singular value</span>
<span class="linenos">340</span>        <span class="c1"># decompositions.  This technique, sometimes called diagonal jitter,</span>
<span class="linenos">341</span>        <span class="c1"># guarantees that the matrix becomes positive definite and</span>
<span class="linenos">342</span>        <span class="c1"># invertible.</span>
<span class="linenos">343</span>        <span class="n">M_reg</span> <span class="o">=</span> <span class="n">M</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<span class="linenos">344</span>
<span class="linenos">345</span>        <span class="c1"># Attempt to solve the linear system directly.  Use ``np.linalg.solve``</span>
<span class="linenos">346</span>        <span class="c1"># instead of a pseudo‑inverse to reduce computational overhead.</span>
<span class="linenos">347</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">348</span>            <span class="c1"># Compute the controllability scalar L @ M_reg^{-1} @ B.</span>
<span class="linenos">349</span>            <span class="n">Minv_B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M_reg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">)</span>
<span class="linenos">350</span>            <span class="n">L_Minv_B</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">@</span> <span class="n">Minv_B</span><span class="p">)</span>
<span class="linenos">351</span>            <span class="c1"># Guard against uncontrollable configurations.  If the scalar</span>
<span class="linenos">352</span>            <span class="c1"># approaches zero the equivalent control becomes ill‑defined and</span>
<span class="linenos">353</span>            <span class="c1"># we conservatively return zero.  The threshold used here</span>
<span class="linenos">354</span>            <span class="c1"># (``self.eq_threshold``) is independent of the boundary‑layer</span>
<span class="linenos">355</span>            <span class="c1"># thickness ``epsilon``.  Earlier versions tied this cutoff</span>
<span class="linenos">356</span>            <span class="c1"># directly to the boundary layer, conflating chattering mitigation</span>
<span class="linenos">357</span>            <span class="c1"># with controllability.  Sliding‑mode literature notes that</span>
<span class="linenos">358</span>            <span class="c1"># widening the boundary layer reduces chattering but induces a</span>
<span class="linenos">359</span>            <span class="c1"># steady‑state error; therefore the</span>
<span class="linenos">360</span>            <span class="c1"># controllability threshold should be tuned separately.  When</span>
<span class="linenos">361</span>            <span class="c1"># |L⋅M⁻¹⋅B| &lt; ``self.eq_threshold`` the equivalent control is</span>
<span class="linenos">362</span>            <span class="c1"># disabled.</span>
<span class="linenos">363</span>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">L_Minv_B</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">eq_threshold</span><span class="p">:</span>
<span class="linenos">364</span>                <span class="k">return</span> <span class="mf">0.0</span>
<span class="linenos">365</span>
<span class="linenos">366</span>            <span class="c1"># Compute the numerator of the equivalent control.  Handle</span>
<span class="linenos">367</span>            <span class="c1"># different shapes of the Coriolis matrix C gracefully: when C</span>
<span class="linenos">368</span>            <span class="c1"># is a matrix multiply by q_dot; when C is already a vector</span>
<span class="linenos">369</span>            <span class="c1"># treat it directly.  See the documentation for details.</span>
<span class="linenos">370</span>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="s2">&quot;ndim&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos">371</span>                <span class="n">rhs</span> <span class="o">=</span> <span class="n">C</span> <span class="o">@</span> <span class="n">q_dot</span> <span class="o">+</span> <span class="n">G</span>
<span class="linenos">372</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">373</span>                <span class="n">rhs</span> <span class="o">=</span> <span class="n">C</span> <span class="o">+</span> <span class="n">G</span>
<span class="linenos">374</span>            <span class="n">Minv_rhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M_reg</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
<span class="linenos">375</span>            <span class="n">term1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">@</span> <span class="n">Minv_rhs</span><span class="p">)</span>
<span class="linenos">376</span>            <span class="n">term2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam1</span> <span class="o">*</span> <span class="n">q_dot</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam2</span> <span class="o">*</span> <span class="n">q_dot</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">377</span>            <span class="n">u_eq</span> <span class="o">=</span> <span class="p">(</span><span class="n">term1</span> <span class="o">-</span> <span class="n">term2</span><span class="p">)</span> <span class="o">/</span> <span class="n">L_Minv_B</span>
<span class="linenos">378</span>        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
<span class="linenos">379</span>            <span class="c1"># Inversion failed despite regularisation; treat as singular.</span>
<span class="linenos">380</span>            <span class="k">return</span> <span class="mf">0.0</span>
<span class="linenos">381</span>
<span class="linenos">382</span>        <span class="c1"># In earlier versions a diagnostic clamp and a tiny bias term were</span>
<span class="linenos">383</span>        <span class="c1"># introduced here.  Empirically clamping the equivalent control to</span>
<span class="linenos">384</span>        <span class="c1"># ±10×max_force and returning an epsilon when u_eq=0 obscured the</span>
<span class="linenos">385</span>        <span class="c1"># true magnitude of the model‑based term and hindered reproducibility.</span>
<span class="linenos">386</span>        <span class="c1"># Current guidance from sliding‑mode theory advocates computing</span>
<span class="linenos">387</span>        <span class="c1"># exactly the model‑based feedforward term and handling large values</span>
<span class="linenos">388</span>        <span class="c1"># via the main saturation at the end of ``compute_control``</span>
<span class="linenos">389</span>        <span class="c1">#.  Therefore we simply return the</span>
<span class="linenos">390</span>        <span class="c1"># computed u_eq without adding biases.  The subsequent saturation</span>
<span class="linenos">391</span>        <span class="c1"># stage in ``compute_control`` will limit the control action.</span>
<span class="linenos">392</span>        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">u_eq</span><span class="p">)</span>
<span class="linenos">393</span>
<span class="linenos">394</span>
<span class="linenos">395</span>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_control</span><span class="p">(</span>
<span class="linenos">396</span>        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">state_vars</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">history</span><span class="p">:</span> <span class="nb">dict</span>
<span class="linenos">397</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ClassicalSMCOutput</span><span class="p">:</span>
<span class="linenos">398</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the control input for the classical SMC.</span>
<span class="linenos">399</span>
<span class="linenos">400</span><span class="sd">        The control law combines a model‑based equivalent term ``u_eq`` with</span>
<span class="linenos">401</span><span class="sd">        a discontinuous (but smoothed) sliding‑mode term.  The robust term</span>
<span class="linenos">402</span><span class="sd">        employs a saturation function within a boundary layer to approximate</span>
<span class="linenos">403</span><span class="sd">        the sign function, which reduces chattering by replacing the infinite</span>
<span class="linenos">404</span><span class="sd">        switching with a continuous control.  The</span>
<span class="linenos">405</span><span class="sd">        total command is given by</span>
<span class="linenos">406</span>
<span class="linenos">407</span><span class="sd">        .. math::</span>
<span class="linenos">408</span>
<span class="linenos">409</span><span class="sd">            u = u_{\\text{eq}} - K \\\\operatorname{sat}\\\\left(\\\\frac{\\\\sigma}{\\\\epsilon}\\\\right) - k_d \\\\, \\\\sigma,</span>
<span class="linenos">410</span>
<span class="linenos">411</span><span class="sd">        where ``sat`` is either ``tanh`` or a linear clip depending on</span>
<span class="linenos">412</span><span class="sd">        ``switch_method``.</span>
<span class="linenos">413</span>
<span class="linenos">414</span><span class="sd">        After summing the terms the result is saturated to lie within</span>
<span class="linenos">415</span><span class="sd">        ``[-max_force, +max_force]``.  Saturation of the final command limits</span>
<span class="linenos">416</span><span class="sd">        actuator effort and ensures physical plausibility.</span>
<span class="linenos">417</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">418</span>        <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_sliding_surface</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="linenos">419</span>
<span class="linenos">420</span>        <span class="c1"># Adaptive boundary layer: compute a state‑dependent epsilon that</span>
<span class="linenos">421</span>        <span class="c1"># scales with the magnitude of the sliding variable.  This</span>
<span class="linenos">422</span>        <span class="c1"># continuous approximation reduces chattering while shrinking</span>
<span class="linenos">423</span>        <span class="c1"># towards zero near the sliding manifold【967233543993377†L104-L115】.</span>
<span class="linenos">424</span>        <span class="n">eps_dyn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon1</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>
<span class="linenos">425</span>        <span class="c1"># Apply hysteresis: when |sigma| lies within a small fraction of the</span>
<span class="linenos">426</span>        <span class="c1"># nominal boundary layer the robust term is suppressed.  This</span>
<span class="linenos">427</span>        <span class="c1"># dead‑band mitigates chattering by freezing the discontinuous</span>
<span class="linenos">428</span>        <span class="c1"># control inside the hysteresis band【967233543993377†L104-L115】.</span>
<span class="linenos">429</span>        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">hysteresis_ratio</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon0</span><span class="p">:</span>
<span class="linenos">430</span>            <span class="n">sat_sigma</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos">431</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">432</span>            <span class="n">sat_sigma</span> <span class="o">=</span> <span class="n">saturate</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">eps_dyn</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">switch_method</span><span class="p">)</span>
<span class="linenos">433</span>
<span class="linenos">434</span>        <span class="n">u_eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_equivalent_control</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="linenos">435</span>        <span class="c1"># Moderately clamp the equivalent control.  Unbounded model‑based</span>
<span class="linenos">436</span>        <span class="c1"># terms can exceed the actuator limits by orders of magnitude,</span>
<span class="linenos">437</span>        <span class="c1"># causing integrator wind‑up and excitation of unmodelled</span>
<span class="linenos">438</span>        <span class="c1"># dynamics.  Sliding‑mode design guidelines recommend limiting</span>
<span class="linenos">439</span>        <span class="c1"># the equivalent component relative to the maximum control</span>
<span class="linenos">440</span>        <span class="c1"># authority.  We saturate u_eq at ±5×max_force,</span>
<span class="linenos">441</span>        <span class="c1"># which preserves the fidelity of the model‑based term while</span>
<span class="linenos">442</span>        <span class="c1"># preventing pathological spikes.</span>
<span class="linenos">443</span>        <span class="n">max_eq</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_force</span>
<span class="linenos">444</span>        <span class="k">if</span> <span class="n">u_eq</span> <span class="o">&gt;</span> <span class="n">max_eq</span><span class="p">:</span>
<span class="linenos">445</span>            <span class="n">u_eq</span> <span class="o">=</span> <span class="n">max_eq</span>
<span class="linenos">446</span>        <span class="k">elif</span> <span class="n">u_eq</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">max_eq</span><span class="p">:</span>
<span class="linenos">447</span>            <span class="n">u_eq</span> <span class="o">=</span> <span class="o">-</span><span class="n">max_eq</span>
<span class="linenos">448</span>
<span class="linenos">449</span>        <span class="n">u_robust</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">*</span> <span class="n">sat_sigma</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kd</span> <span class="o">*</span> <span class="n">sigma</span>
<span class="linenos">450</span>
<span class="linenos">451</span>        <span class="c1"># Combine equivalent and robust terms and saturate final command</span>
<span class="linenos">452</span>        <span class="c1"># to the actuator limits.  The final saturation prevents</span>
<span class="linenos">453</span>        <span class="c1"># commanded torques/forces from exceeding the physical</span>
<span class="linenos">454</span>        <span class="c1"># capability of the actuator.</span>
<span class="linenos">455</span>        <span class="n">u</span> <span class="o">=</span> <span class="n">u_eq</span> <span class="o">+</span> <span class="n">u_robust</span>
<span class="linenos">456</span>        <span class="n">u_saturated</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">max_force</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_force</span><span class="p">))</span>
<span class="linenos">457</span>
<span class="linenos">458</span>        <span class="c1"># Telemetry: append key signals to history (in-place)</span>
<span class="linenos">459</span>        <span class="n">hist</span> <span class="o">=</span> <span class="n">history</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
<span class="linenos">460</span>        <span class="n">hist</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>
<span class="linenos">461</span>        <span class="n">hist</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;epsilon_eff&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">eps_dyn</span><span class="p">))</span>
<span class="linenos">462</span>        <span class="n">hist</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;u_eq&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">u_eq</span><span class="p">))</span>
<span class="linenos">463</span>        <span class="n">hist</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;u_robust&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">u_robust</span><span class="p">))</span>
<span class="linenos">464</span>        <span class="n">hist</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;u_total&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
<span class="linenos">465</span>        <span class="n">hist</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">u_saturated</span><span class="p">))</span>
<span class="linenos">466</span>
<span class="linenos">467</span>        <span class="c1"># Return structured output</span>
<span class="linenos">468</span>        <span class="k">return</span> <span class="n">ClassicalSMCOutput</span><span class="p">(</span><span class="n">u_saturated</span><span class="p">,</span> <span class="p">(),</span> <span class="n">hist</span><span class="p">)</span>
<span class="linenos">469</span>
<span class="linenos">470</span>    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">471</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset ClassicalSMC controller state.</span>
<span class="linenos">472</span>
<span class="linenos">473</span><span class="sd">        Classical SMC has no internal state variables to reset since it is</span>
<span class="linenos">474</span><span class="sd">        stateless and purely reactive based on current measurements.</span>
<span class="linenos">475</span><span class="sd">        This method is provided for interface compliance.</span>
<span class="linenos">476</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">477</span>        <span class="c1"># Classical SMC is stateless - no internal state to reset</span>
<span class="linenos">478</span>        <span class="k">pass</span>
<span class="linenos">479</span>
<span class="linenos">480</span>    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">481</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Explicit memory cleanup to prevent leaks.</span>
<span class="linenos">482</span>
<span class="linenos">483</span><span class="sd">        Clears large NumPy arrays and breaks circular references to allow</span>
<span class="linenos">484</span><span class="sd">        proper garbage collection. Should be called when the controller is</span>
<span class="linenos">485</span><span class="sd">        no longer needed.</span>
<span class="linenos">486</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">487</span>        <span class="c1"># Nullify dynamics reference</span>
<span class="linenos">488</span>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_dynamics_ref&#39;</span><span class="p">):</span>
<span class="linenos">489</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_dynamics_ref</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span>
<span class="linenos">490</span>
<span class="linenos">491</span>        <span class="c1"># Clear any cached large arrays (future-proofing)</span>
<span class="linenos">492</span>        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;_state_buffer&#39;</span><span class="p">,</span> <span class="s1">&#39;_control_buffer&#39;</span><span class="p">,</span> <span class="s1">&#39;_surface_buffer&#39;</span><span class="p">]:</span>
<span class="linenos">493</span>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
<span class="linenos">494</span>                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">495</span>
<span class="linenos">496</span>        <span class="c1"># Clear internal arrays</span>
<span class="linenos">497</span>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">):</span>
<span class="linenos">498</span>            <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">499</span>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">):</span>
<span class="linenos">500</span>            <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">501</span>
<span class="linenos">502</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">503</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Destructor for automatic cleanup.</span>
<span class="linenos">504</span>
<span class="linenos">505</span><span class="sd">        Ensures cleanup is called when the controller is garbage collected.</span>
<span class="linenos">506</span><span class="sd">        Catches all exceptions to prevent errors during finalization.</span>
<span class="linenos">507</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">508</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">509</span>            <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
<span class="linenos">510</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">511</span>            <span class="k">pass</span>  <span class="c1"># Prevent exceptions during cleanup</span>
</pre></div>
</div>
</section>
<section id="methods-13">
<h4>Methods (13)<a class="headerlink" href="#methods-13" title="Link to this heading">¶</a></h4>
<section id="init-self-gains-max-force-boundary-layer-dynamics-model-regularization-switch-method">
<h5><code class="docutils literal notranslate"><span class="pre">__init__(self,</span> <span class="pre">gains,</span> <span class="pre">max_force,</span> <span class="pre">boundary_layer,</span> <span class="pre">dynamics_model,</span> <span class="pre">regularization,</span> <span class="pre">switch_method)</span></code><a class="headerlink" href="#init-self-gains-max-force-boundary-layer-dynamics-model-regularization-switch-method" title="Link to this heading">¶</a></h5>
<p>Initialize the controller.</p>
<p><a class="reference internal" href="#method-classicalsmc-__init__"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="gains-self">
<h5><code class="docutils literal notranslate"><span class="pre">gains(self)</span></code><a class="headerlink" href="#gains-self" title="Link to this heading">¶</a></h5>
<p>Return the list of gains used by this controller.</p>
<p><a class="reference internal" href="#method-classicalsmc-gains"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="dyn-self">
<h5><code class="docutils literal notranslate"><span class="pre">dyn(self)</span></code><a class="headerlink" href="#dyn-self" title="Link to this heading">¶</a></h5>
<p>Access dynamics model via weakref.</p>
<p><a class="reference internal" href="#method-classicalsmc-dyn"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="dyn-self-value">
<h5><code class="docutils literal notranslate"><span class="pre">dyn(self,</span> <span class="pre">value)</span></code><a class="headerlink" href="#dyn-self-value" title="Link to this heading">¶</a></h5>
<p>Set dynamics model using weakref.</p>
<p><a class="reference internal" href="#method-classicalsmc-dyn"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="initialize-state-self">
<h5><code class="docutils literal notranslate"><span class="pre">initialize_state(self)</span></code><a class="headerlink" href="#initialize-state-self" title="Link to this heading">¶</a></h5>
<p>No internal state for classical SMC; returns an empty tuple.</p>
<p><a class="reference internal" href="#method-classicalsmc-initialize_state"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="initialize-history-self">
<h5><code class="docutils literal notranslate"><span class="pre">initialize_history(self)</span></code><a class="headerlink" href="#initialize-history-self" title="Link to this heading">¶</a></h5>
<p>No history tracked for classical SMC; returns an empty dict.</p>
<p><a class="reference internal" href="#method-classicalsmc-initialize_history"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="validate-gains-gains">
<h5><code class="docutils literal notranslate"><span class="pre">validate_gains(gains)</span></code><a class="headerlink" href="#validate-gains-gains" title="Link to this heading">¶</a></h5>
<p>Validate that exactly six gains have been provided for the classical SMC.</p>
<p><a class="reference internal" href="#method-classicalsmc-validate_gains"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="compute-sliding-surface-self-state">
<h5><code class="docutils literal notranslate"><span class="pre">_compute_sliding_surface(self,</span> <span class="pre">state)</span></code><a class="headerlink" href="#compute-sliding-surface-self-state" title="Link to this heading">¶</a></h5>
<p>Compute the sliding surface value, <code class="docutils literal notranslate"><span class="pre">sigma</span></code>.</p>
<p><a class="reference internal" href="#method-classicalsmc-_compute_sliding_surface"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="compute-equivalent-control-self-state">
<h5><code class="docutils literal notranslate"><span class="pre">_compute_equivalent_control(self,</span> <span class="pre">state)</span></code><a class="headerlink" href="#compute-equivalent-control-self-state" title="Link to this heading">¶</a></h5>
<p>Compute the model-based equivalent control <code class="docutils literal notranslate"><span class="pre">u_eq</span></code> with enhanced robustness.</p>
<p><a class="reference internal" href="#method-classicalsmc-_compute_equivalent_control"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="compute-control-self-state-state-vars-history">
<h5><code class="docutils literal notranslate"><span class="pre">compute_control(self,</span> <span class="pre">state,</span> <span class="pre">state_vars,</span> <span class="pre">history)</span></code><a class="headerlink" href="#compute-control-self-state-state-vars-history" title="Link to this heading">¶</a></h5>
<p>Compute the control input for the classical SMC.</p>
<p><a class="reference internal" href="#method-classicalsmc-compute_control"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="reset-self">
<h5><code class="docutils literal notranslate"><span class="pre">reset(self)</span></code><a class="headerlink" href="#reset-self" title="Link to this heading">¶</a></h5>
<p>Reset ClassicalSMC controller state.</p>
<p><a class="reference internal" href="#method-classicalsmc-reset"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="cleanup-self">
<h5><code class="docutils literal notranslate"><span class="pre">cleanup(self)</span></code><a class="headerlink" href="#cleanup-self" title="Link to this heading">¶</a></h5>
<p>Explicit memory cleanup to prevent leaks.</p>
<p><a class="reference internal" href="#method-classicalsmc-cleanup"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="del-self">
<h5><code class="docutils literal notranslate"><span class="pre">__del__(self)</span></code><a class="headerlink" href="#del-self" title="Link to this heading">¶</a></h5>
<p>Destructor for automatic cleanup.</p>
<p><a class="reference internal" href="#method-classicalsmc-__del__"><span class="xref myst">View full source →</span></a></p>
</section>
</section>
</section>
</section>
<hr class="docutils" />
<section id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Link to this heading">¶</a></h2>
<p>This module imports:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">numpy</span> <span class="pre">as</span> <span class="pre">np</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">logging</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">weakref</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">...utils</span> <span class="pre">import</span> <span class="pre">saturate</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">...utils</span> <span class="pre">import</span> <span class="pre">ClassicalSMCOutput</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">typing</span> <span class="pre">import</span> <span class="pre">TYPE_CHECKING,</span> <span class="pre">List,</span> <span class="pre">Tuple,</span> <span class="pre">Dict,</span> <span class="pre">Optional,</span> <span class="pre">Union,</span> <span class="pre">Sequence,</span> <span class="pre">Any</span></code></p></li>
</ul>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="smc_hybrid_adaptive_sta_smc.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">controllers.smc.hybrid_adaptive_sta_smc</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="smc_adaptive_smc.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">controllers.smc.adaptive_smc</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, Research Team
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            <div class="last-updated">
              Last updated on Oct 08, 2025</div>
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">controllers.smc.classic_smc</a><ul>
<li><a class="reference internal" href="#module-overview">Module Overview</a></li>
<li><a class="reference internal" href="#complete-source-code">Complete Source Code</a></li>
<li><a class="reference internal" href="#classes">Classes</a><ul>
<li><a class="reference internal" href="#classicalsmc"><code class="docutils literal notranslate"><span class="pre">ClassicalSMC</span></code></a><ul>
<li><a class="reference internal" href="#source-code">Source Code</a></li>
<li><a class="reference internal" href="#methods-13">Methods (13)</a><ul>
<li><a class="reference internal" href="#init-self-gains-max-force-boundary-layer-dynamics-model-regularization-switch-method"><code class="docutils literal notranslate"><span class="pre">__init__(self,</span> <span class="pre">gains,</span> <span class="pre">max_force,</span> <span class="pre">boundary_layer,</span> <span class="pre">dynamics_model,</span> <span class="pre">regularization,</span> <span class="pre">switch_method)</span></code></a></li>
<li><a class="reference internal" href="#gains-self"><code class="docutils literal notranslate"><span class="pre">gains(self)</span></code></a></li>
<li><a class="reference internal" href="#dyn-self"><code class="docutils literal notranslate"><span class="pre">dyn(self)</span></code></a></li>
<li><a class="reference internal" href="#dyn-self-value"><code class="docutils literal notranslate"><span class="pre">dyn(self,</span> <span class="pre">value)</span></code></a></li>
<li><a class="reference internal" href="#initialize-state-self"><code class="docutils literal notranslate"><span class="pre">initialize_state(self)</span></code></a></li>
<li><a class="reference internal" href="#initialize-history-self"><code class="docutils literal notranslate"><span class="pre">initialize_history(self)</span></code></a></li>
<li><a class="reference internal" href="#validate-gains-gains"><code class="docutils literal notranslate"><span class="pre">validate_gains(gains)</span></code></a></li>
<li><a class="reference internal" href="#compute-sliding-surface-self-state"><code class="docutils literal notranslate"><span class="pre">_compute_sliding_surface(self,</span> <span class="pre">state)</span></code></a></li>
<li><a class="reference internal" href="#compute-equivalent-control-self-state"><code class="docutils literal notranslate"><span class="pre">_compute_equivalent_control(self,</span> <span class="pre">state)</span></code></a></li>
<li><a class="reference internal" href="#compute-control-self-state-state-vars-history"><code class="docutils literal notranslate"><span class="pre">compute_control(self,</span> <span class="pre">state,</span> <span class="pre">state_vars,</span> <span class="pre">history)</span></code></a></li>
<li><a class="reference internal" href="#reset-self"><code class="docutils literal notranslate"><span class="pre">reset(self)</span></code></a></li>
<li><a class="reference internal" href="#cleanup-self"><code class="docutils literal notranslate"><span class="pre">cleanup(self)</span></code></a></li>
<li><a class="reference internal" href="#del-self"><code class="docutils literal notranslate"><span class="pre">__del__(self)</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#dependencies">Dependencies</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=4ebf8126"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=08e7b316"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../_static/back-to-top.js?v=840797bb"></script>
    <script src="../../_static/lazy-load.js?v=dc25293c"></script>
    <script src="../../_static/dark-mode.js?v=bf328970"></script>
    </body>
</html>