<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
.chartjs-container {
    margin: 1.5em auto;
    padding: 1em;
    background: #f8f9fa;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.chart-note {
    text-align: center;
    color: #6c757d;
    font-size: 0.9em;
    margin-top: 0.5em;
}
</style>
<link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <!-- Generated with Sphinx 7.4.7 and Furo 2024.08.06 -->
        <title>optimization.algorithms.pso_optimizer - DIP_SMC_PSO Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5349f25f" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=f5a89ef9" />
    
    


<style>
  body {
    --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">DIP_SMC_PSO Documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">DIP_SMC_PSO Documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">📚 Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Optimal Sliding Mode Control for a Double-Inverted Pendulum via PSO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../theory_overview.html">1. Theoretical Background â€” Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture.html">3. System Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plant_model.html">1.x Plant Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hil_quickstart.html">Hardware-in-the-Loop (HIL) Quickstart Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../streamlit_dashboard_guide.html">Streamlit Dashboard User Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">🎮 Control Systems &amp; Optimization</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../controllers/index.html">Controllers Module Documentation</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Controllers Module Documentation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/classical_smc_technical_guide.html">Classical Sliding Mode Control Technical Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/adaptive_smc_technical_guide.html">Adaptive Sliding Mode Control Technical Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/sta_smc_technical_guide.html">Super-Twisting Sliding Mode Control Technical Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/hybrid_smc_technical_guide.html">Hybrid Adaptive Super-Twisting SMC Technical Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/mpc_technical_guide.html">Model Predictive Control Technical Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/swing_up_smc_technical_guide.html">Swing-Up SMC Technical Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/swing_up_smc_technical_guide.html#example-metadata">example-metadata:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/swing_up_smc_technical_guide.html#runnable-false">runnable: false</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/factory_system_guide.html">SMC Controller Factory System Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controllers/control_primitives_reference.html">Control Primitives Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mathematical_foundations/smc_complete_theory.html">Complete Sliding Mode Control Mathematical Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mathematical_foundations/controller_comparison_theory.html">SMC Controller Comparison Theory</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../controllers/index.html">Controllers Module</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Controllers Module</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../controllers/adaptive_smc.html">controllers.adaptive_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/classic_smc.html">controllers.classic_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory.html">controllers.factory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/mpc_controller.html">controllers.mpc_controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/sta_smc.html">controllers.sta_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/swing_up_smc.html">controllers.swing_up_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/__init__.html">controllers.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/base_controller_interface.html">controllers.base.controller_interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/base_control_primitives.html">controllers.base.control_primitives</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/base___init__.html">controllers.base.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_deprecation.html">controllers.factory.deprecation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_fallback_configs.html">controllers.factory.fallback_configs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_legacy_factory.html">controllers.factory.legacy_factory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_optimization.html">controllers.factory.optimization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_pso_integration.html">controllers.factory.pso_integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_smc_factory.html">controllers.factory.smc_factory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_thread_safety.html">controllers.factory.thread_safety</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory___init__.html">controllers.factory.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/mpc_mpc_controller.html">controllers.mpc.mpc_controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/mpc___init__.html">controllers.mpc.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_adaptive_smc.html">controllers.smc.adaptive_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_classic_smc.html">controllers.smc.classic_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_hybrid_adaptive_sta_smc.html">controllers.smc.hybrid_adaptive_sta_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_sta_smc.html">controllers.smc.sta_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc___init__.html">controllers.smc.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/specialized_swing_up_smc.html">controllers.specialized.swing_up_smc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/specialized___init__.html">controllers.specialized.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_core_protocols.html">controllers.factory.core.protocols</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_core_registry.html">controllers.factory.core.registry</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_core_threading.html">controllers.factory.core.threading</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_core_validation.html">controllers.factory.core.validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/factory_core___init__.html">controllers.factory.core.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms___init__.html">controllers.smc.algorithms.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_core_equivalent_control.html">controllers.smc.core.equivalent_control</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_core_gain_validation.html">controllers.smc.core.gain_validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_core_sliding_surface.html">controllers.smc.core.sliding_surface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_core_switching_functions.html">controllers.smc.core.switching_functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_core___init__.html">controllers.smc.core.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_adaptive_adaptation_law.html">controllers.smc.algorithms.adaptive.adaptation_law</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_adaptive_config.html">controllers.smc.algorithms.adaptive.config</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_adaptive_controller.html">controllers.smc.algorithms.adaptive.controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_adaptive_parameter_estimation.html">controllers.smc.algorithms.adaptive.parameter_estimation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_adaptive___init__.html">controllers.smc.algorithms.adaptive.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_classical_boundary_layer.html">controllers.smc.algorithms.classical.boundary_layer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_classical_config.html">controllers.smc.algorithms.classical.config</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_classical_controller.html">controllers.smc.algorithms.classical.controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_classical___init__.html">controllers.smc.algorithms.classical.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_hybrid_config.html">controllers.smc.algorithms.hybrid.config</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_hybrid_controller.html">controllers.smc.algorithms.hybrid.controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_hybrid_switching_logic.html">controllers.smc.algorithms.hybrid.switching_logic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_hybrid___init__.html">controllers.smc.algorithms.hybrid.<strong>init</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_super_twisting_config.html">controllers.smc.algorithms.super_twisting.config</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_super_twisting_controller.html">controllers.smc.algorithms.super_twisting.controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_super_twisting_twisting_algorithm.html">controllers.smc.algorithms.super_twisting.twisting_algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../controllers/smc_algorithms_super_twisting___init__.html">controllers.smc.algorithms.super_twisting.<strong>init</strong></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../mathematical_foundations/index.html">Mathematical Foundations</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Mathematical Foundations</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../mathematical_foundations/smc_complete_theory.html">Complete Sliding Mode Control Mathematical Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mathematical_foundations/controller_comparison_theory.html">SMC Controller Comparison Theory</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../plant/models_guide.html">Plant Models Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../optimization_simulation/guide.html">Optimization &amp; Simulation Guide</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../controllers/index.html">Controllers Module</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of Controllers Module</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../controllers/adaptive_smc.html">controllers.adaptive_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/classic_smc.html">controllers.classic_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory.html">controllers.factory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/mpc_controller.html">controllers.mpc_controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/sta_smc.html">controllers.sta_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/swing_up_smc.html">controllers.swing_up_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/__init__.html">controllers.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/base_controller_interface.html">controllers.base.controller_interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/base_control_primitives.html">controllers.base.control_primitives</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/base___init__.html">controllers.base.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_deprecation.html">controllers.factory.deprecation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_fallback_configs.html">controllers.factory.fallback_configs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_legacy_factory.html">controllers.factory.legacy_factory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_optimization.html">controllers.factory.optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_pso_integration.html">controllers.factory.pso_integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_smc_factory.html">controllers.factory.smc_factory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_thread_safety.html">controllers.factory.thread_safety</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory___init__.html">controllers.factory.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/mpc_mpc_controller.html">controllers.mpc.mpc_controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/mpc___init__.html">controllers.mpc.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_adaptive_smc.html">controllers.smc.adaptive_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_classic_smc.html">controllers.smc.classic_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_hybrid_adaptive_sta_smc.html">controllers.smc.hybrid_adaptive_sta_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_sta_smc.html">controllers.smc.sta_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc___init__.html">controllers.smc.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/specialized_swing_up_smc.html">controllers.specialized.swing_up_smc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/specialized___init__.html">controllers.specialized.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_core_protocols.html">controllers.factory.core.protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_core_registry.html">controllers.factory.core.registry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_core_threading.html">controllers.factory.core.threading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_core_validation.html">controllers.factory.core.validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/factory_core___init__.html">controllers.factory.core.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms___init__.html">controllers.smc.algorithms.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_core_equivalent_control.html">controllers.smc.core.equivalent_control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_core_gain_validation.html">controllers.smc.core.gain_validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_core_sliding_surface.html">controllers.smc.core.sliding_surface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_core_switching_functions.html">controllers.smc.core.switching_functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_core___init__.html">controllers.smc.core.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_adaptive_adaptation_law.html">controllers.smc.algorithms.adaptive.adaptation_law</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_adaptive_config.html">controllers.smc.algorithms.adaptive.config</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_adaptive_controller.html">controllers.smc.algorithms.adaptive.controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_adaptive_parameter_estimation.html">controllers.smc.algorithms.adaptive.parameter_estimation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_adaptive___init__.html">controllers.smc.algorithms.adaptive.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_classical_boundary_layer.html">controllers.smc.algorithms.classical.boundary_layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_classical_config.html">controllers.smc.algorithms.classical.config</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_classical_controller.html">controllers.smc.algorithms.classical.controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_classical___init__.html">controllers.smc.algorithms.classical.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_hybrid_config.html">controllers.smc.algorithms.hybrid.config</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_hybrid_controller.html">controllers.smc.algorithms.hybrid.controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_hybrid_switching_logic.html">controllers.smc.algorithms.hybrid.switching_logic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_hybrid___init__.html">controllers.smc.algorithms.hybrid.<strong>init</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_super_twisting_config.html">controllers.smc.algorithms.super_twisting.config</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_super_twisting_controller.html">controllers.smc.algorithms.super_twisting.controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_super_twisting_twisting_algorithm.html">controllers.smc.algorithms.super_twisting.twisting_algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../controllers/smc_algorithms_super_twisting___init__.html">controllers.smc.algorithms.super_twisting.<strong>init</strong></a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../optimizer/index.html">Optimizer Module</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Optimizer Module</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../optimizer/pso_optimizer.html">optimizer.pso_optimizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../optimizer/__init__.html">optimizer.<strong>init</strong></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../analysis_plan.html">5. Analysis &amp; Verification Plan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../benchmarks_methodology.html">Benchmarks &amp; Methodology</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">🧪 Development &amp; Testing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../TESTING.html">Testing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../test_protocols.html">5.x Test Protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../use_cases.html">4. Use Cases &amp; Operating Modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../context.html">2. Application Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault_detection_guide.html">Fault Detection &amp; Isolation (FDI) Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">📊 Research &amp; Theory</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../presentation/index.html">Research Presentation Materials</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Research Presentation Materials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html">Abstract</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#introduction-and-motivation">Introduction and Motivation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#the-double-inverted-pendulum-as-a-canonical-control-problem">The Double Inverted Pendulum as a Canonical Control Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#the-primary-control-objectives-and-challenges">The Primary Control Objectives and Challenges</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#sliding-mode-control-as-a-robust-solution">Sliding Mode Control as a Robust Solution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#the-gain-tuning-dilemma-and-the-need-for-optimization">The Gain Tuning Dilemma and the Need for Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#particle-swarm-optimization-for-automated-design">Particle Swarm Optimization for Automated Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#synthesis-and-motivation">Synthesis and Motivation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/introduction.html#references">References</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/problem-statement.html">Problem Statement for Double‑Inverted Pendulum (DIP) Control with SMC and PSO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/previous-works.html">Previous Work Before the Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/system-modeling.html"><strong>A Comprehensive Technical Report on the Modeling and Configuration of a Cart‑Based Double Inverted Pendulum System</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/smc-theory.html">Sliding Mode Control for a Double‑Inverted Pendulum: Bridging Theory and Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html">Abstract</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#introduction">1 Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#system-modelling-and-problem-formulation">2 System Modelling and Problem Formulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#simulation-methodology">3 Simulation Methodology</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#classic-sliding-mode-control">4 Classic Sliding Mode Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-i-boundary-layer-method">5 Chattering Mitigation Strategy I: Boundary Layer Method</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-ii-supertwisting-algorithm">6 Chattering Mitigation Strategy II: Super‑Twisting Algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-iii-adaptive-sliding-mode-control">7 Chattering Mitigation Strategy III: Adaptive Sliding Mode Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-iv-hybrid-adaptivesta">8 Chattering Mitigation Strategy IV: Hybrid Adaptive–STA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#synthesis-and-comparative-analysis">9 Synthesis and Comparative Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/chattering-mitigation.html#references">References</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/pso-optimization.html"><strong>Comprehensive Simulation Analysis and Enhancements for the Double Inverted Pendulum Control System</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/simulation-setup.html">Particle Swarm Optimization for Sliding‑Mode Controller Tuning of a Double Inverted Pendulum</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/results-discussion.html">8 – Results and Discussion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presentation/results-discussion.html#references">References</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html">Abstract</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#introduction-and-motivation">Introduction and Motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#the-double-inverted-pendulum-as-a-canonical-control-problem">The Double Inverted Pendulum as a Canonical Control Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#the-primary-control-objectives-and-challenges">The Primary Control Objectives and Challenges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#sliding-mode-control-as-a-robust-solution">Sliding Mode Control as a Robust Solution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#the-gain-tuning-dilemma-and-the-need-for-optimization">The Gain Tuning Dilemma and the Need for Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#particle-swarm-optimization-for-automated-design">Particle Swarm Optimization for Automated Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#synthesis-and-motivation">Synthesis and Motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/introduction.html#references">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/problem-statement.html">Problem Statement for Double‑Inverted Pendulum (DIP) Control with SMC and PSO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/previous-works.html">Previous Work Before the Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/system-modeling.html"><strong>A Comprehensive Technical Report on the Modeling and Configuration of a Cart‑Based Double Inverted Pendulum System</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/smc-theory.html">Sliding Mode Control for a Double‑Inverted Pendulum: Bridging Theory and Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html">Abstract</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#introduction">1 Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#system-modelling-and-problem-formulation">2 System Modelling and Problem Formulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#simulation-methodology">3 Simulation Methodology</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#classic-sliding-mode-control">4 Classic Sliding Mode Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-i-boundary-layer-method">5 Chattering Mitigation Strategy I: Boundary Layer Method</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-ii-supertwisting-algorithm">6 Chattering Mitigation Strategy II: Super‑Twisting Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-iii-adaptive-sliding-mode-control">7 Chattering Mitigation Strategy III: Adaptive Sliding Mode Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#chattering-mitigation-strategy-iv-hybrid-adaptivesta">8 Chattering Mitigation Strategy IV: Hybrid Adaptive–STA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#synthesis-and-comparative-analysis">9 Synthesis and Comparative Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/chattering-mitigation.html#references">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/pso-optimization.html"><strong>Comprehensive Simulation Analysis and Enhancements for the Double Inverted Pendulum Control System</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/simulation-setup.html">Particle Swarm Optimization for Sliding‑Mode Controller Tuning of a Double Inverted Pendulum</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/results-discussion.html">8 – Results and Discussion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../presentation/results-discussion.html#references">References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">📖 API Reference &amp; Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Reference Documentation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../examples/index.html">Examples</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of Examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../bibliography.html">Bibliography &amp; Academic References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">🔧 Project Management</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../CONTRIBUTING.html">Contributing – ResearchPlanSpec Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../RELEASE_CHECKLIST.html">Release Checklist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CHANGELOG.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../symbols.html">Symbols &amp; Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../results_readme.html">Results &amp; Plots</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">📚 Citations &amp; Attribution</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../CITATIONS.html">Citations &amp; Academic Attribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CITATIONS_ACADEMIC.html">Academic Theory Citations &amp; References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DEPENDENCIES.html">Software Dependencies &amp; Citations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PATTERNS.html">Software Design Patterns &amp; Architecture Attribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LICENSES.html">License Compliance &amp; Attribution</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="https://github.com/theSadeQ/DIP_SMC_PSO/blob/main/docs/reference/optimization/algorithms_pso_optimizer.md?plain=true" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div><div class="edit-this-page">
  <a class="muted-link" href="https://github.com/theSadeQ/DIP_SMC_PSO/edit/main/docs/reference/optimization/algorithms_pso_optimizer.md" title="Edit this page">
    <svg><use href="#svg-pencil"></use></svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section class="tex2jax_ignore mathjax_ignore" id="optimization-algorithms-pso-optimizer">
<h1>optimization.algorithms.pso_optimizer<a class="headerlink" href="#optimization-algorithms-pso-optimizer" title="Link to this heading">¶</a></h1>
<p><strong>Source:</strong> <code class="docutils literal notranslate"><span class="pre">src\optimization\algorithms\pso_optimizer.py</span></code></p>
<section id="module-overview">
<h2>Module Overview<a class="headerlink" href="#module-overview" title="Link to this heading">¶</a></h2>
<p>Particle Swarm Optimisation (PSO) tuner for sliding-mode controllers.</p>
</section>
<section id="advanced-mathematical-theory">
<h2>Advanced Mathematical Theory<a class="headerlink" href="#advanced-mathematical-theory" title="Link to this heading">¶</a></h2>
<section id="pso-optimizer-implementation">
<h3>PSO Optimizer Implementation<a class="headerlink" href="#pso-optimizer-implementation" title="Link to this heading">¶</a></h3>
<p><strong>Complete PSO workflow:</strong></p>
<ol class="arabic simple">
<li><p><strong>Initialization:</strong> Sample <span class="math notranslate nohighlight">\(N\)</span> particles uniformly in <span class="math notranslate nohighlight">\(\mathcal{X}\)</span></p></li>
<li><p><strong>Evaluation:</strong> Compute <span class="math notranslate nohighlight">\(f(\vec{x}_i^0)\)</span> for all particles</p></li>
<li><p><strong>Update personal bests:</strong> <span class="math notranslate nohighlight">\(\vec{p}_i = \vec{x}_i^0\)</span></p></li>
<li><p><strong>Update global best:</strong> <span class="math notranslate nohighlight">\(\vec{g} = \arg\min_i f(\vec{p}_i)\)</span></p></li>
<li><p><strong>Iterate:</strong> Update velocities and positions</p></li>
</ol>
</section>
<section id="constraint-handling">
<h3>Constraint Handling<a class="headerlink" href="#constraint-handling" title="Link to this heading">¶</a></h3>
<p><strong>Penalty method:</strong></p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[f_{penalty}(\vec{x}) = f(\vec{x}) + \sum_{j=1}^{m} r_j \max(0, g_j(\vec{x}))^2 + \sum_{k=1}^{p} s_k |h_k(\vec{x})|\]</div>
</div>
<p><strong>Dynamic penalty coefficients:</strong></p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[r_j(t) = r_{j,0} \cdot \left(1 + \frac{t}{T_{max}}\right)^{\beta}\]</div>
</div>
</section>
<section id="convergence-acceleration">
<h3>Convergence Acceleration<a class="headerlink" href="#convergence-acceleration" title="Link to this heading">¶</a></h3>
<p><strong>Quantum PSO (QPSO):</strong></p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[x_{i,d}^{t+1} = \phi p_{i,d} + (1 - \phi) g_d \pm \beta |x_{i,d}^t - C_d| \ln(1/u)\]</div>
</div>
<p>Where <span class="math notranslate nohighlight">\(C_d = \frac{1}{N} \sum_{i=1}^{N} p_{i,d}\)</span> is mean best position.</p>
<p><strong>Bare Bones PSO:</strong></p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[x_{i,d}^{t+1} \sim \mathcal{N}\left(\frac{p_{i,d} + g_d}{2}, |p_{i,d} - g_d|\right)\]</div>
</div>
</section>
<section id="topology-design">
<h3>Topology Design<a class="headerlink" href="#topology-design" title="Link to this heading">¶</a></h3>
<p><strong>Global best (gbest):</strong></p>
<p>All particles influenced by single global best.</p>
<p><strong>Local best (lbest):</strong></p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[l_i = \arg\min_{j \in N_i} f(\vec{p}_j)\]</div>
</div>
<p>Where <span class="math notranslate nohighlight">\(N_i\)</span> is neighborhood of particle <span class="math notranslate nohighlight">\(i\)</span>.</p>
<p><strong>Ring topology:</strong> <span class="math notranslate nohighlight">\(N_i = \{i-1, i, i+1\}\)</span>
<strong>Von Neumann:</strong> <span class="math notranslate nohighlight">\(N_i\)</span> is 2D grid neighborhood</p>
</section>
<section id="parameter-tuning">
<h3>Parameter Tuning<a class="headerlink" href="#parameter-tuning" title="Link to this heading">¶</a></h3>
<p><strong>Default parameters (Clerc):</strong></p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align}
w &amp;= 0.729 \\
c_1 &amp;= c_2 = 1.49445 \\
\phi &amp;= c_1 + c_2 = 2.9889 &gt; 4 \text{ (invalid for standard PSO)}
\end{align}\end{split}\]</div>
</div>
<p><strong>Adaptive parameters:</strong></p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[c_1(t) = c_{1,f} + (c_{1,i} - c_{1,f}) \frac{t}{T_{max}}\]</div>
</div>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[c_2(t) = c_{2,i} + (c_{2,f} - c_{2,i}) \frac{t}{T_{max}}\]</div>
</div>
<p>Typically: <span class="math notranslate nohighlight">\(c_{1,i} = 2.5, c_{1,f} = 0.5, c_{2,i} = 0.5, c_{2,f} = 2.5\)</span></p>
</section>
</section>
<section id="architecture-diagram">
<h2>Architecture Diagram<a class="headerlink" href="#architecture-diagram" title="Link to this heading">¶</a></h2>
<div class="mermaid">
            graph TD
    A[PSO Optimizer] --&gt; B[Setup Problem]
    B --&gt; C[Initialize Parameters]
    C --&gt; D[Create Swarm]
    D --&gt; E[Parallel Evaluation]

    E --&gt; F[Fitness Results]
    F --&gt; G[Update Strategy]

    G --&gt; H{Inertia Weight}
    H --&gt;|Linear| I[Decrease w]
    H --&gt;|Adaptive| J[Adjust w]
    H --&gt;|Chaotic| K[Chaotic w]

    I --&gt; L[Update Swarm]
    J --&gt; L
    K --&gt; L

    L --&gt; M[Constraint Handling]
    M --&gt; N{Violations?}
    N --&gt;|Yes| O[Apply Penalty]
    N --&gt;|No| P[Convergence Check]
    O --&gt; P

    P --&gt; Q{Converged?}
    Q --&gt;|No| E
    Q --&gt;|Yes| R[Return Best Solution]

    style G fill:#9cf
    style P fill:#ff9
    style R fill:#9f9
        </div></section>
<section id="usage-examples">
<h2>Usage Examples<a class="headerlink" href="#usage-examples" title="Link to this heading">¶</a></h2>
<section id="example-1-basic-initialization">
<h3>Example 1: Basic Initialization<a class="headerlink" href="#example-1-basic-initialization" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">src.optimization.core</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="c1"># Initialize with configuration</span>
<span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;parameter&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">}</span>
<span class="n">instance</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="example-2-performance-tuning">
<h3>Example 2: Performance Tuning<a class="headerlink" href="#example-2-performance-tuning" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Adjust parameters for better performance</span>
<span class="n">optimized_params</span> <span class="o">=</span> <span class="n">tune_parameters</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">target_performance</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="example-3-integration-with-optimization">
<h3>Example 3: Integration with Optimization<a class="headerlink" href="#example-3-integration-with-optimization" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use in complete optimization loop</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">create_optimizer</span><span class="p">(</span><span class="n">opt_type</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">optimize</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="example-4-edge-case-handling">
<h3>Example 4: Edge Case Handling<a class="headerlink" href="#example-4-edge-case-handling" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">handle_edge_case</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="example-5-performance-analysis">
<h3>Example 5: Performance Analysis<a class="headerlink" href="#example-5-performance-analysis" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Analyze metrics</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="n">compute_metrics</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best fitness: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">best_fitness</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This module defines the high-throughput, vectorised <code class="docutils literal notranslate"><span class="pre">PSOTuner</span></code> class that wraps
a particle swarm optimisation algorithm around the vectorised simulation of a
double inverted pendulum (DIP) system.  It incorporates improvements from
design review steps, including decoupling of global state, explicit random
number generation, dynamic instability penalties and configurable cost
normalisation.  The implementation follows robust control theory practices
and is fully documented with theoretical backing.</p>
<p>References used throughout this module are provided in the accompanying
design-review report.</p>
</section>
</section>
<section id="id1">
<h2>Architecture Diagram<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h2>
<div class="mermaid">
            graph TD
    A[Parameter Bounds] --&gt; B[Initialize Swarm]
    B --&gt; C[Particle Population]
    C --&gt; D{For Each Particle}
    D --&gt; E[Create Controller]
    E --&gt; F[Run Simulation]
    F --&gt; G[Compute Cost]
    G --&gt; H[Update Personal Best]
    H --&gt; I{All Particles Done?}
    I --&gt;|No| D
    I --&gt;|Yes| J[Update Global Best]
    J --&gt; K{Convergence?}
    K --&gt;|No| L[Update Velocities]
    L --&gt; M[Update Positions]
    M --&gt; D
    K --&gt;|Yes| N[Return Optimal Gains]

    style C fill:#9cf
    style G fill:#ff9
    style J fill:#f9f
    style N fill:#9f9
        </div><p><strong>Data Flow:</strong></p>
<ol class="arabic simple">
<li><p>Initialize swarm in parameter space</p></li>
<li><p>Evaluate fitness via closed-loop simulation</p></li>
<li><p>Update particle velocities: v = wv + c₁(p-x) + c₂(g-x)</p></li>
<li><p>Converge to optimal controller gains</p></li>
<li><p>Return best solution with performance metrics</p></li>
</ol>
</section>
<section id="mathematical-foundation">
<h2>Mathematical Foundation<a class="headerlink" href="#mathematical-foundation" title="Link to this heading">¶</a></h2>
<section id="particle-swarm-optimization">
<h3>Particle Swarm Optimization<a class="headerlink" href="#particle-swarm-optimization" title="Link to this heading">¶</a></h3>
<p>PSO updates particle positions using:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align}
v_i^{k+1} &amp;= wv_i^k + c_1r_1(p_i - x_i^k) + c_2r_2(g - x_i^k) \\
x_i^{k+1} &amp;= x_i^k + v_i^{k+1}
\end{align}\end{split}\]</div>
</div>
<p>Where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(w\)</span>: Inertia weight (exploration vs exploitation)</p></li>
<li><p><span class="math notranslate nohighlight">\(c_1, c_2\)</span>: Cognitive and social coefficients</p></li>
<li><p><span class="math notranslate nohighlight">\(p_i\)</span>: Personal best position</p></li>
<li><p><span class="math notranslate nohighlight">\(g\)</span>: Global best position</p></li>
</ul>
</section>
<section id="convergence-properties">
<h3>Convergence Properties<a class="headerlink" href="#convergence-properties" title="Link to this heading">¶</a></h3>
<p>Proper parameter selection ensures:</p>
<ol class="arabic simple">
<li><p><strong>Global exploration</strong>: <span class="math notranslate nohighlight">\(w \in [0.4, 0.9]\)</span></p></li>
<li><p><strong>Local exploitation</strong>: <span class="math notranslate nohighlight">\(c_1 + c_2 &lt; 4\)</span></p></li>
<li><p><strong>Velocity bounds</strong>: Prevent divergence</p></li>
</ol>
<p><strong>See:</strong> <span class="xref std std-doc">../../../mathematical_foundations/optimization_theory</span></p>
</section>
</section>
<section id="complete-source-code">
<h2>Complete Source Code<a class="headerlink" href="#complete-source-code" title="Link to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="c1">#======================================================================================\\\</span>
<span class="linenos">  2</span><span class="c1">#==================== src/optimization/algorithms/pso_optimizer.py ====================\\\</span>
<span class="linenos">  3</span><span class="c1">#======================================================================================\\\</span>
<span class="linenos">  4</span>
<span class="linenos">  5</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  6</span><span class="sd">Particle Swarm Optimisation (PSO) tuner for sliding-mode controllers.</span>
<span class="linenos">  7</span>
<span class="linenos">  8</span><span class="sd">This module defines the high-throughput, vectorised `PSOTuner` class that wraps</span>
<span class="linenos">  9</span><span class="sd">a particle swarm optimisation algorithm around the vectorised simulation of a</span>
<span class="linenos"> 10</span><span class="sd">double inverted pendulum (DIP) system.  It incorporates improvements from</span>
<span class="linenos"> 11</span><span class="sd">design review steps, including decoupling of global state, explicit random</span>
<span class="linenos"> 12</span><span class="sd">number generation, dynamic instability penalties and configurable cost</span>
<span class="linenos"> 13</span><span class="sd">normalisation.  The implementation follows robust control theory practices</span>
<span class="linenos"> 14</span><span class="sd">and is fully documented with theoretical backing.</span>
<span class="linenos"> 15</span>
<span class="linenos"> 16</span><span class="sd">References used throughout this module are provided in the accompanying</span>
<span class="linenos"> 17</span><span class="sd">design-review report.</span>
<span class="linenos"> 18</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 19</span>
<span class="linenos"> 20</span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
<span class="linenos"> 21</span>
<span class="linenos"> 22</span><span class="c1"># Standard library imports</span>
<span class="linenos"> 23</span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="linenos"> 24</span><span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="linenos"> 25</span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="linenos"> 26</span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
<span class="linenos"> 27</span>
<span class="linenos"> 28</span><span class="c1"># Third-party imports</span>
<span class="linenos"> 29</span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="linenos"> 30</span>
<span class="linenos"> 31</span><span class="c1"># Local project imports</span>
<span class="linenos"> 32</span><span class="kn">from</span><span class="w"> </span><span class="nn">src.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigSchema</span><span class="p">,</span> <span class="n">load_config</span>
<span class="linenos"> 33</span><span class="kn">from</span><span class="w"> </span><span class="nn">src.utils.seed</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_rng</span>
<span class="linenos"> 34</span><span class="kn">from</span><span class="w"> </span><span class="nn">...plant.models.dynamics</span><span class="w"> </span><span class="kn">import</span> <span class="n">DIPParams</span>
<span class="linenos"> 35</span><span class="kn">from</span><span class="w"> </span><span class="nn">...simulation.engines.vector_sim</span><span class="w"> </span><span class="kn">import</span> <span class="n">simulate_system_batch</span>
<span class="linenos"> 36</span>
<span class="linenos"> 37</span><span class="c1"># ---------------------------------------------------------------------------</span>
<span class="linenos"> 38</span><span class="c1"># Module-level configuration</span>
<span class="linenos"> 39</span><span class="c1">#</span>
<span class="linenos"> 40</span><span class="c1"># Module-level constants are retained for backward compatibility but are no</span>
<span class="linenos"> 41</span><span class="c1"># longer mutated by PSOTuner instances.  Earlier versions of this module</span>
<span class="linenos"> 42</span><span class="c1"># modified global variables (e.g., ``NORMALISATION_THRESHOLD`` and</span>
<span class="linenos"> 43</span><span class="c1"># ``PSOTuner.COMBINE_WEIGHTS``) when loading a configuration.  Doing so</span>
<span class="linenos"> 44</span><span class="c1"># introduced hidden coupling between independent optimisation runs and made</span>
<span class="linenos"> 45</span><span class="c1"># concurrent tuning non-deterministic.  To eliminate cross-contamination</span>
<span class="linenos"> 46</span><span class="c1"># PSOTuner now stores normalisation thresholds, combine weights and</span>
<span class="linenos"> 47</span><span class="c1"># instability penalties as instance attributes.  The module constants below</span>
<span class="linenos"> 48</span><span class="c1"># remain as sensible defaults but are no longer altered by PSOTuner.</span>
<span class="linenos"> 49</span><span class="n">NORMALISATION_THRESHOLD</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-12</span>
<span class="linenos"> 50</span>
<span class="linenos"> 51</span><span class="c1"># Initialize module logger</span>
<span class="linenos"> 52</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="linenos"> 53</span>
<span class="linenos"> 54</span>
<span class="linenos"> 55</span><span class="k">def</span><span class="w"> </span><span class="nf">_normalise</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">denom</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="linenos"> 56</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Safely normalise an array by a scalar denominator.</span>
<span class="linenos"> 57</span>
<span class="linenos"> 58</span><span class="sd">    When the denominator is very small (≤ NORMALISATION_THRESHOLD) the input</span>
<span class="linenos"> 59</span><span class="sd">    array is returned unchanged.  The division suppresses divide-by-zero</span>
<span class="linenos"> 60</span><span class="sd">    warnings.  See tests for expected behaviour.</span>
<span class="linenos"> 61</span>
<span class="linenos"> 62</span><span class="sd">    Parameters</span>
<span class="linenos"> 63</span><span class="sd">    ----------</span>
<span class="linenos"> 64</span><span class="sd">    val : np.ndarray</span>
<span class="linenos"> 65</span><span class="sd">        Array of values to be normalised.</span>
<span class="linenos"> 66</span><span class="sd">    denom : float</span>
<span class="linenos"> 67</span><span class="sd">        Scalar denominator.</span>
<span class="linenos"> 68</span>
<span class="linenos"> 69</span><span class="sd">    Returns</span>
<span class="linenos"> 70</span><span class="sd">    -------</span>
<span class="linenos"> 71</span><span class="sd">    np.ndarray</span>
<span class="linenos"> 72</span><span class="sd">        The normalised array.</span>
<span class="linenos"> 73</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 74</span>    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>
<span class="linenos"> 75</span>        <span class="n">ratio</span> <span class="o">=</span> <span class="n">val</span> <span class="o">/</span> <span class="n">denom</span>
<span class="linenos"> 76</span>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">denom</span> <span class="o">&gt;</span> <span class="n">NORMALISATION_THRESHOLD</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
<span class="linenos"> 77</span>
<span class="linenos"> 78</span>
<span class="linenos"> 79</span><span class="nd">@contextmanager</span>
<span class="linenos"> 80</span><span class="k">def</span><span class="w"> </span><span class="nf">_seeded_global_numpy</span><span class="p">(</span><span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 81</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Context manager to temporarily seed the global NumPy RNG.</span>
<span class="linenos"> 82</span>
<span class="linenos"> 83</span><span class="sd">    This is used only in the optimise method to ensure deterministic</span>
<span class="linenos"> 84</span><span class="sd">    behaviour of the PySwarms optimiser when a fixed seed is provided.  It</span>
<span class="linenos"> 85</span><span class="sd">    saves and restores the global RNG state.</span>
<span class="linenos"> 86</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 87</span>    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 88</span>        <span class="k">yield</span>
<span class="linenos"> 89</span>        <span class="k">return</span>
<span class="linenos"> 90</span>    <span class="n">state</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 91</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 92</span>        <span class="n">state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
<span class="linenos"> 93</span>    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># P2: Handle RNG state access failure</span>
<span class="linenos"> 94</span>        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not save RNG state: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 95</span>        <span class="n">state</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 96</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 97</span>        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seed</span><span class="p">))</span>
<span class="linenos"> 98</span>        <span class="k">yield</span>
<span class="linenos"> 99</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">100</span>        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">101</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">102</span>                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="linenos">103</span>            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># P2: Handle RNG state restoration failure</span>
<span class="linenos">104</span>                <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not restore RNG state: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">105</span>
<span class="linenos">106</span>
<span class="linenos">107</span><span class="k">class</span><span class="w"> </span><span class="nc">PSOTuner</span><span class="p">:</span>
<span class="linenos">108</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;High-throughput, vectorised tuner for sliding-mode controllers.</span>
<span class="linenos">109</span>
<span class="linenos">110</span><span class="sd">    The tuner wraps a particle swarm optimisation algorithm around the</span>
<span class="linenos">111</span><span class="sd">    vectorised simulation.  It uses local PRNGs to avoid global side effects</span>
<span class="linenos">112</span><span class="sd">    and computes instability penalties based on normalisation constants.  Cost</span>
<span class="linenos">113</span><span class="sd">    aggregation between mean and worst-case performance is controlled via</span>
<span class="linenos">114</span><span class="sd">    ``COMBINE_WEIGHTS``.</span>
<span class="linenos">115</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">116</span>
<span class="linenos">117</span>    <span class="c1"># Default combine weights for cost aggregation (mean vs max).  The tuple</span>
<span class="linenos">118</span>    <span class="c1"># (0.7, 0.3) balances average performance against worst-case performance.</span>
<span class="linenos">119</span>    <span class="n">COMBINE_WEIGHTS</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
<span class="linenos">120</span>
<span class="linenos">121</span>    <span class="c1"># Class-level fallback penalty.  Static methods that cannot access an</span>
<span class="linenos">122</span>    <span class="c1"># instance use this constant to penalise invalid cost arrays.  A</span>
<span class="linenos">123</span>    <span class="c1"># moderate default (1e6) discourages unstable particles without risking</span>
<span class="linenos">124</span>    <span class="c1"># numerical overflow.  Instance-level penalties override this value.</span>
<span class="linenos">125</span>    <span class="n">INSTABILITY_PENALTY</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e6</span>
<span class="linenos">126</span>
<span class="linenos">127</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<span class="linenos">128</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos">129</span>        <span class="n">controller_factory</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Any</span><span class="p">],</span>
<span class="linenos">130</span>        <span class="n">config</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ConfigSchema</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
<span class="linenos">131</span>        <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">132</span>        <span class="n">rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">133</span>        <span class="o">*</span><span class="p">,</span>
<span class="linenos">134</span>        <span class="n">instability_penalty_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">,</span>
<span class="linenos">135</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">136</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialise the PSOTuner.</span>
<span class="linenos">137</span>
<span class="linenos">138</span><span class="sd">        Parameters</span>
<span class="linenos">139</span><span class="sd">        ----------</span>
<span class="linenos">140</span><span class="sd">        controller_factory : Callable[[np.ndarray], Any]</span>
<span class="linenos">141</span><span class="sd">            A function returning a controller instance given a gain vector.</span>
<span class="linenos">142</span><span class="sd">        config : ConfigSchema or path-like</span>
<span class="linenos">143</span><span class="sd">            A validated configuration object or path to the YAML file.</span>
<span class="linenos">144</span><span class="sd">        seed : int or None, optional</span>
<span class="linenos">145</span><span class="sd">            Seed to initialise the local RNG.  When ``None``, the seed from</span>
<span class="linenos">146</span><span class="sd">            the configuration (``global_seed``) is used if present; otherwise</span>
<span class="linenos">147</span><span class="sd">            the RNG is unseeded.</span>
<span class="linenos">148</span><span class="sd">        rng : numpy.random.Generator or None, optional</span>
<span class="linenos">149</span><span class="sd">            External PRNG.  If provided, this generator is used directly and</span>
<span class="linenos">150</span><span class="sd">            ``seed`` is ignored.</span>
<span class="linenos">151</span><span class="sd">        instability_penalty_factor : float, optional</span>
<span class="linenos">152</span><span class="sd">            Scale factor used to compute the penalty for unstable simulations.</span>
<span class="linenos">153</span><span class="sd">            The penalty is computed as</span>
<span class="linenos">154</span><span class="sd">            ``instability_penalty_factor * (norm_ise + norm_u + norm_du + norm_sigma)``.</span>
<span class="linenos">155</span><span class="sd">            Larger values penalise instability more heavily.  Default is 100.</span>
<span class="linenos">156</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">157</span>        <span class="c1"># Load configuration if a path is provided</span>
<span class="linenos">158</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
<span class="linenos">159</span>            <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ConfigSchema</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="linenos">160</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">161</span>            <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">config</span>
<span class="linenos">162</span>
<span class="linenos">163</span>        <span class="c1"># Store controller factory and config sections</span>
<span class="linenos">164</span>        <span class="bp">self</span><span class="o">.</span><span class="n">controller_factory</span> <span class="o">=</span> <span class="n">controller_factory</span>
<span class="linenos">165</span>        <span class="bp">self</span><span class="o">.</span><span class="n">physics_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">physics</span>
<span class="linenos">166</span>        <span class="bp">self</span><span class="o">.</span><span class="n">sim_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">simulation</span>
<span class="linenos">167</span>        <span class="bp">self</span><span class="o">.</span><span class="n">cost_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">cost_function</span>
<span class="linenos">168</span>        <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_cfg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;physics_uncertainty&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">169</span>
<span class="linenos">170</span>        <span class="c1"># Local PRNG.  Use provided rng or create a new one seeded from</span>
<span class="linenos">171</span>        <span class="c1"># ``seed`` or ``global_seed``.  Avoid modifying global RNGs.</span>
<span class="linenos">172</span>        <span class="n">default_seed</span> <span class="o">=</span> <span class="n">seed</span> <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;global_seed&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">173</span>        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">default_seed</span><span class="p">)</span> <span class="k">if</span> <span class="n">default_seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
<span class="linenos">174</span>        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span> <span class="o">=</span> <span class="n">rng</span> <span class="ow">or</span> <span class="n">create_rng</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
<span class="linenos">175</span>
<span class="linenos">176</span>        <span class="c1"># Factor used to compute instability penalty when no explicit penalty is given</span>
<span class="linenos">177</span>        <span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">instability_penalty_factor</span><span class="p">)</span>
<span class="linenos">178</span>
<span class="linenos">179</span>        <span class="c1"># Deprecation warnings for unused PSOConfig parameters</span>
<span class="linenos">180</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">181</span>            <span class="n">pso_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">pso</span>
<span class="linenos">182</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">183</span>            <span class="n">pso_cfg</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">184</span>        <span class="k">if</span> <span class="n">pso_cfg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">185</span>            <span class="c1"># Enforce deprecation of unused PSO parameters.  Design review</span>
<span class="linenos">186</span>            <span class="c1"># findings recommend removing legacy parameters such as</span>
<span class="linenos">187</span>            <span class="c1"># ``n_processes``, ``hyper_trials``, ``hyper_search`` and</span>
<span class="linenos">188</span>            <span class="c1"># ``study_timeout``.  Accepting these fields silently leads to</span>
<span class="linenos">189</span>            <span class="c1"># misconfigured optimisations and masks typos.  Raise a</span>
<span class="linenos">190</span>            <span class="c1"># ValueError when a deprecated field is supplied and not set</span>
<span class="linenos">191</span>            <span class="c1"># to its default (None or 1 for n_processes) to force</span>
<span class="linenos">192</span>            <span class="c1"># callers to remove outdated keys.</span>
<span class="linenos">193</span>            <span class="n">deprecated_fields</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">194</span>            <span class="n">n_proc</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pso_cfg</span><span class="p">,</span> <span class="s2">&quot;n_processes&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">195</span>            <span class="k">if</span> <span class="n">n_proc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
<span class="linenos">196</span>                <span class="n">deprecated_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;n_processes&quot;</span><span class="p">)</span>
<span class="linenos">197</span>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pso_cfg</span><span class="p">,</span> <span class="s2">&quot;hyper_trials&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">198</span>                <span class="n">deprecated_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;hyper_trials&quot;</span><span class="p">)</span>
<span class="linenos">199</span>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pso_cfg</span><span class="p">,</span> <span class="s2">&quot;hyper_search&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">200</span>                <span class="n">deprecated_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;hyper_search&quot;</span><span class="p">)</span>
<span class="linenos">201</span>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pso_cfg</span><span class="p">,</span> <span class="s2">&quot;study_timeout&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">202</span>                <span class="n">deprecated_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;study_timeout&quot;</span><span class="p">)</span>
<span class="linenos">203</span>            <span class="k">if</span> <span class="n">deprecated_fields</span><span class="p">:</span>
<span class="linenos">204</span>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos">205</span>                    <span class="sa">f</span><span class="s2">&quot;Deprecated PSO configuration fields present: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">deprecated_fields</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
<span class="linenos">206</span>                    <span class="s2">&quot;Please remove these fields from the configuration.&quot;</span>
<span class="linenos">207</span>                <span class="p">)</span>
<span class="linenos">208</span>
<span class="linenos">209</span>        <span class="c1"># Extract cost weights</span>
<span class="linenos">210</span>        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_cfg</span><span class="o">.</span><span class="n">weights</span>
<span class="linenos">211</span>
<span class="linenos">212</span>        <span class="c1"># Determine instability penalty: explicit or computed</span>
<span class="linenos">213</span>        <span class="n">explicit_penalty</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_cfg</span><span class="p">,</span> <span class="s2">&quot;instability_penalty&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">214</span>        <span class="k">if</span> <span class="n">explicit_penalty</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">215</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">216</span>                <span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">explicit_penalty</span><span class="p">)</span>
<span class="linenos">217</span>            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># P2: Handle invalid penalty value</span>
<span class="linenos">218</span>                <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="linenos">219</span>                    <span class="sa">f</span><span class="s2">&quot;Invalid instability_penalty &#39;</span><span class="si">{</span><span class="n">explicit_penalty</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Using default factor </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty_factor</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">220</span>                <span class="p">)</span>
<span class="linenos">221</span>                <span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty_factor</span><span class="p">)</span>
<span class="linenos">222</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">223</span>            <span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># to be computed from norms</span>
<span class="linenos">224</span>
<span class="linenos">225</span>        <span class="c1"># Normalisation constants for state error, control effort, control rate and sliding variable</span>
<span class="linenos">226</span>        <span class="n">norms</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_cfg</span><span class="p">,</span> <span class="s2">&quot;norms&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">227</span>        <span class="k">if</span> <span class="n">norms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">228</span>            <span class="c1"># Handle both dict (from YAML) and object (from Pydantic) forms</span>
<span class="linenos">229</span>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">norms</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos">230</span>                <span class="bp">self</span><span class="o">.</span><span class="n">norm_ise</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">norms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;state_error&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
<span class="linenos">231</span>                <span class="bp">self</span><span class="o">.</span><span class="n">norm_u</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">norms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;control_effort&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
<span class="linenos">232</span>                <span class="bp">self</span><span class="o">.</span><span class="n">norm_du</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">norms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;control_rate&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
<span class="linenos">233</span>                <span class="bp">self</span><span class="o">.</span><span class="n">norm_sigma</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">norms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sliding&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
<span class="linenos">234</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">235</span>                <span class="bp">self</span><span class="o">.</span><span class="n">norm_ise</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">norms</span><span class="p">,</span> <span class="s2">&quot;state_error&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
<span class="linenos">236</span>                <span class="bp">self</span><span class="o">.</span><span class="n">norm_u</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">norms</span><span class="p">,</span> <span class="s2">&quot;control_effort&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
<span class="linenos">237</span>                <span class="bp">self</span><span class="o">.</span><span class="n">norm_du</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">norms</span><span class="p">,</span> <span class="s2">&quot;control_rate&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
<span class="linenos">238</span>                <span class="bp">self</span><span class="o">.</span><span class="n">norm_sigma</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">norms</span><span class="p">,</span> <span class="s2">&quot;sliding&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
<span class="linenos">239</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">240</span>            <span class="bp">self</span><span class="o">.</span><span class="n">norm_ise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_du</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_sigma</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="linenos">241</span>
<span class="linenos">242</span>        <span class="c1"># Compute penalty if not explicitly provided</span>
<span class="linenos">243</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">244</span>            <span class="n">denom_sum</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_ise</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_u</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_du</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_sigma</span><span class="p">)</span>
<span class="linenos">245</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">denom_sum</span><span class="p">)</span> <span class="ow">or</span> <span class="n">denom_sum</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
<span class="linenos">246</span>                <span class="n">denom_sum</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="linenos">247</span>            <span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty_factor</span> <span class="o">*</span> <span class="n">denom_sum</span><span class="p">)</span>
<span class="linenos">248</span>
<span class="linenos">249</span>        <span class="c1"># Automatic baseline normalisation</span>
<span class="linenos">250</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">251</span>            <span class="n">baseline</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_cfg</span><span class="p">,</span> <span class="s2">&quot;baseline&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">252</span>            <span class="n">gains_list</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">253</span>            <span class="k">if</span> <span class="n">baseline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">254</span>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">baseline</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos">255</span>                    <span class="n">gains_list</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gains&quot;</span><span class="p">)</span>
<span class="linenos">256</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">257</span>                    <span class="n">gains_list</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">baseline</span><span class="p">,</span> <span class="s2">&quot;gains&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">258</span>            <span class="k">if</span> <span class="n">gains_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gains_list</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">gains_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">259</span>                <span class="n">baseline_particles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gains_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">260</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos">261</span>                    <span class="n">baseline_ctrl</span> <span class="o">=</span> <span class="n">controller_factory</span><span class="p">(</span><span class="n">baseline_particles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">262</span>                    <span class="n">u_max_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">baseline_ctrl</span><span class="p">,</span> <span class="s2">&quot;max_force&quot;</span><span class="p">,</span> <span class="mf">150.0</span><span class="p">))</span>
<span class="linenos">263</span>                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># P2: Handle baseline controller creation failure</span>
<span class="linenos">264</span>                    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<span class="linenos">265</span>                        <span class="sa">f</span><span class="s2">&quot;Could not create baseline controller for u_max extraction: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Using default 150.0&quot;</span>
<span class="linenos">266</span>                    <span class="p">)</span>
<span class="linenos">267</span>                    <span class="n">u_max_val</span> <span class="o">=</span> <span class="mf">150.0</span>
<span class="linenos">268</span>                <span class="n">res</span> <span class="o">=</span> <span class="n">simulate_system_batch</span><span class="p">(</span>
<span class="linenos">269</span>                    <span class="n">controller_factory</span><span class="o">=</span><span class="n">controller_factory</span><span class="p">,</span>
<span class="linenos">270</span>                    <span class="n">particles</span><span class="o">=</span><span class="n">baseline_particles</span><span class="p">,</span>
<span class="linenos">271</span>                    <span class="n">sim_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_cfg</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span>
<span class="linenos">272</span>                    <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_cfg</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
<span class="linenos">273</span>                    <span class="n">u_max</span><span class="o">=</span><span class="n">u_max_val</span><span class="p">,</span>
<span class="linenos">274</span>                <span class="p">)</span>
<span class="linenos">275</span>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<span class="linenos">276</span>                    <span class="n">t</span><span class="p">,</span> <span class="n">x_b</span><span class="p">,</span> <span class="n">u_b</span><span class="p">,</span> <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">277</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">278</span>                    <span class="n">t</span><span class="p">,</span> <span class="n">x_b</span><span class="p">,</span> <span class="n">u_b</span><span class="p">,</span> <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">res</span>
<span class="linenos">279</span>                <span class="n">x_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x_b</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">280</span>                <span class="n">u_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">u_b</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">281</span>                <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sigma_b</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">282</span>                <span class="n">dt_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">t</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
<span class="linenos">283</span>                <span class="k">if</span> <span class="n">dt_arr</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">284</span>                    <span class="n">dt_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_cfg</span><span class="o">.</span><span class="n">dt</span><span class="p">]])</span>
<span class="linenos">285</span>                <span class="n">N</span> <span class="o">=</span> <span class="n">dt_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">286</span>                <span class="n">time_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="linenos">287</span>                <span class="n">ise_base</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
<span class="linenos">288</span>                    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_b</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt_arr</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">*</span> <span class="n">time_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">289</span>                <span class="p">)</span>
<span class="linenos">290</span>                <span class="n">u_sq_base</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">u_b</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt_arr</span><span class="p">)</span> <span class="o">*</span> <span class="n">time_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">291</span>                <span class="n">du</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">u_b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="n">u_b</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">])</span>
<span class="linenos">292</span>                <span class="n">du_sq_base</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">du</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt_arr</span><span class="p">)</span> <span class="o">*</span> <span class="n">time_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">293</span>                <span class="n">sigma_sq_base</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">sigma_b</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt_arr</span><span class="p">)</span> <span class="o">*</span> <span class="n">time_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">294</span>                <span class="bp">self</span><span class="o">.</span><span class="n">norm_ise</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ise_base</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">)</span>
<span class="linenos">295</span>                <span class="bp">self</span><span class="o">.</span><span class="n">norm_u</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">u_sq_base</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">)</span>
<span class="linenos">296</span>                <span class="bp">self</span><span class="o">.</span><span class="n">norm_du</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">du_sq_base</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">)</span>
<span class="linenos">297</span>                <span class="bp">self</span><span class="o">.</span><span class="n">norm_sigma</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sigma_sq_base</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">)</span>
<span class="linenos">298</span>        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># P2: Baseline normalization is optional</span>
<span class="linenos">299</span>            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<span class="linenos">300</span>                <span class="sa">f</span><span class="s2">&quot;Automatic baseline normalization failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Using default normalization constants.&quot;</span>
<span class="linenos">301</span>            <span class="p">)</span>
<span class="linenos">302</span>
<span class="linenos">303</span>        <span class="c1"># Overrides for combine_weights and normalization_threshold</span>
<span class="linenos">304</span>        <span class="c1"># Instance-level combine weights and normalisation threshold.  Earlier</span>
<span class="linenos">305</span>        <span class="c1"># implementations mutated class or module variables to reflect these</span>
<span class="linenos">306</span>        <span class="c1"># settings.  To avoid cross-contamination between PSO runs, store</span>
<span class="linenos">307</span>        <span class="c1"># them per instance and avoid modifying global state.  Defaults are</span>
<span class="linenos">308</span>        <span class="c1"># taken from the class attributes if present.</span>
<span class="linenos">309</span>        <span class="bp">self</span><span class="o">.</span><span class="n">combine_weights</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
<span class="linenos">310</span>        <span class="c1"># Normalisation threshold for safe division; defaults to module</span>
<span class="linenos">311</span>        <span class="c1"># constant.  Smaller values cause more aggressive normalisation.</span>
<span class="linenos">312</span>        <span class="bp">self</span><span class="o">.</span><span class="n">normalisation_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">NORMALISATION_THRESHOLD</span><span class="p">)</span>
<span class="linenos">313</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">314</span>            <span class="n">cw</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_cfg</span><span class="p">,</span> <span class="s2">&quot;combine_weights&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">315</span>            <span class="k">if</span> <span class="n">cw</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos">316</span>                <span class="n">cw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;combine_weights&quot;</span><span class="p">)</span>
<span class="linenos">317</span>            <span class="k">if</span> <span class="n">cw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">318</span>                <span class="n">mean_w</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">319</span>                <span class="n">max_w</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">320</span>                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos">321</span>                    <span class="n">mean_w</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cw</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">322</span>                    <span class="n">max_w</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cw</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">323</span>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos">324</span>                    <span class="n">mean_w</span> <span class="o">=</span> <span class="n">cw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">mean_w</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mean_w</span>
<span class="linenos">325</span>                    <span class="n">max_w</span> <span class="o">=</span> <span class="n">cw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">max_w</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">max_w</span>
<span class="linenos">326</span>                <span class="k">if</span> <span class="n">mean_w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">327</span>                    <span class="n">mw</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mean_w</span><span class="p">)</span>
<span class="linenos">328</span>                    <span class="n">xw</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_w</span><span class="p">)</span>
<span class="linenos">329</span>                    <span class="n">total</span> <span class="o">=</span> <span class="n">mw</span> <span class="o">+</span> <span class="n">xw</span>
<span class="linenos">330</span>                    <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">331</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">combine_weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">mw</span> <span class="o">/</span> <span class="n">total</span><span class="p">,</span> <span class="n">xw</span> <span class="o">/</span> <span class="n">total</span><span class="p">)</span>
<span class="linenos">332</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">333</span>            <span class="k">pass</span>
<span class="linenos">334</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">335</span>            <span class="n">nt</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_cfg</span><span class="p">,</span> <span class="s2">&quot;normalization_threshold&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">336</span>            <span class="k">if</span> <span class="n">nt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos">337</span>                <span class="n">nt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;normalization_threshold&quot;</span><span class="p">)</span>
<span class="linenos">338</span>            <span class="k">if</span> <span class="n">nt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">339</span>                <span class="bp">self</span><span class="o">.</span><span class="n">normalisation_threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nt</span><span class="p">)</span>
<span class="linenos">340</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">341</span>            <span class="k">pass</span>
<span class="linenos">342</span>
<span class="linenos">343</span>        <span class="c1"># Warn about deprecated PSO fields that are ignored</span>
<span class="linenos">344</span>        <span class="n">deprecated</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">345</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">346</span>            <span class="n">pcfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">pso</span>
<span class="linenos">347</span>            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;n_processes&quot;</span><span class="p">,</span> <span class="s2">&quot;hyper_trials&quot;</span><span class="p">,</span> <span class="s2">&quot;hyper_search&quot;</span><span class="p">,</span> <span class="s2">&quot;study_timeout&quot;</span><span class="p">):</span>
<span class="linenos">348</span>                <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pcfg</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">349</span>                <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{},</span> <span class="p">[]):</span>
<span class="linenos">350</span>                    <span class="n">deprecated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
<span class="linenos">351</span>            <span class="k">if</span> <span class="n">deprecated</span><span class="p">:</span>
<span class="linenos">352</span>                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="linenos">353</span>                    <span class="s2">&quot;PSOConfig fields </span><span class="si">%s</span><span class="s2"> are deprecated and ignored. These parameters will be removed in a future version.&quot;</span><span class="p">,</span>
<span class="linenos">354</span>                    <span class="n">deprecated</span><span class="p">,</span>
<span class="linenos">355</span>                <span class="p">)</span>
<span class="linenos">356</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">357</span>            <span class="k">pass</span>
<span class="linenos">358</span>
<span class="linenos">359</span>
<span class="linenos">360</span>    <span class="c1"># ---------- Robust sampling ----------</span>
<span class="linenos">361</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_iter_perturbed_physics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">DIPParams</span><span class="p">]:</span>
<span class="linenos">362</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Yield perturbed physics parameters for robustness evaluation.</span>
<span class="linenos">363</span>
<span class="linenos">364</span><span class="sd">        The nominal model is yielded first.  Subsequent draws perturb each</span>
<span class="linenos">365</span><span class="sd">        parameter within ±``percent`` of its nominal value as specified in</span>
<span class="linenos">366</span><span class="sd">        ``physics_uncertainty``.  When uncertainty is disabled or ``n_evals ≤ 1``</span>
<span class="linenos">367</span><span class="sd">        only the nominal model is yielded.</span>
<span class="linenos">368</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">369</span>        <span class="k">yield</span> <span class="n">DIPParams</span><span class="o">.</span><span class="n">from_physics_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">physics_cfg</span><span class="p">)</span>
<span class="linenos">370</span>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_cfg</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_cfg</span><span class="o">.</span><span class="n">n_evals</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">371</span>            <span class="k">return</span>
<span class="linenos">372</span>        <span class="n">rng_local</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span>
<span class="linenos">373</span>        <span class="n">base_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">physics_cfg</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
<span class="linenos">374</span>        <span class="n">pu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_cfg</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
<span class="linenos">375</span>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_cfg</span><span class="o">.</span><span class="n">n_evals</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
<span class="linenos">376</span>            <span class="n">perturbed_params</span> <span class="o">=</span> <span class="n">base_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">377</span>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">pct</span> <span class="ow">in</span> <span class="n">pu</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">378</span>                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;n_evals&quot;</span> <span class="ow">or</span> <span class="n">pct</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">perturbed_params</span><span class="p">:</span>
<span class="linenos">379</span>                    <span class="k">continue</span>
<span class="linenos">380</span>                <span class="n">nominal</span> <span class="o">=</span> <span class="n">base_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<span class="linenos">381</span>                <span class="n">delta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pct</span><span class="p">)</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">nominal</span><span class="p">)</span>
<span class="linenos">382</span>                <span class="n">eps</span> <span class="o">=</span> <span class="n">rng_local</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="p">,</span> <span class="o">+</span><span class="n">delta</span><span class="p">)</span>
<span class="linenos">383</span>                <span class="n">perturbed_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nominal</span><span class="p">)</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">eps</span><span class="p">)</span>
<span class="linenos">384</span>            <span class="c1"># Safety: ensure centre of mass does not exceed pendulum length</span>
<span class="linenos">385</span>            <span class="k">if</span> <span class="s2">&quot;pendulum1_com&quot;</span> <span class="ow">in</span> <span class="n">perturbed_params</span> <span class="ow">and</span> <span class="s2">&quot;pendulum1_length&quot;</span> <span class="ow">in</span> <span class="n">perturbed_params</span><span class="p">:</span>
<span class="linenos">386</span>                <span class="k">if</span> <span class="n">perturbed_params</span><span class="p">[</span><span class="s2">&quot;pendulum1_com&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">perturbed_params</span><span class="p">[</span><span class="s2">&quot;pendulum1_length&quot;</span><span class="p">]:</span>
<span class="linenos">387</span>                    <span class="n">perturbed_params</span><span class="p">[</span><span class="s2">&quot;pendulum1_com&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.99</span> <span class="o">*</span> <span class="n">perturbed_params</span><span class="p">[</span><span class="s2">&quot;pendulum1_length&quot;</span><span class="p">]</span>
<span class="linenos">388</span>            <span class="k">if</span> <span class="s2">&quot;pendulum2_com&quot;</span> <span class="ow">in</span> <span class="n">perturbed_params</span> <span class="ow">and</span> <span class="s2">&quot;pendulum2_length&quot;</span> <span class="ow">in</span> <span class="n">perturbed_params</span><span class="p">:</span>
<span class="linenos">389</span>                <span class="k">if</span> <span class="n">perturbed_params</span><span class="p">[</span><span class="s2">&quot;pendulum2_com&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">perturbed_params</span><span class="p">[</span><span class="s2">&quot;pendulum2_length&quot;</span><span class="p">]:</span>
<span class="linenos">390</span>                    <span class="n">perturbed_params</span><span class="p">[</span><span class="s2">&quot;pendulum2_com&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.99</span> <span class="o">*</span> <span class="n">perturbed_params</span><span class="p">[</span><span class="s2">&quot;pendulum2_length&quot;</span><span class="p">]</span>
<span class="linenos">391</span>            <span class="c1"># Handle field mapping for DIPParams</span>
<span class="linenos">392</span>            <span class="n">dipparams_dict</span> <span class="o">=</span> <span class="n">perturbed_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">393</span>            <span class="k">if</span> <span class="s1">&#39;regularization&#39;</span> <span class="ow">in</span> <span class="n">dipparams_dict</span><span class="p">:</span>
<span class="linenos">394</span>                <span class="n">reg</span> <span class="o">=</span> <span class="n">dipparams_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;regularization&#39;</span><span class="p">)</span>
<span class="linenos">395</span>                <span class="n">dipparams_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;min_regularization&#39;</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span>
<span class="linenos">396</span>                <span class="n">dipparams_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;regularization_alpha&#39;</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">)</span>
<span class="linenos">397</span>            <span class="n">dipparams_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;max_condition_number&#39;</span><span class="p">,</span> <span class="mf">1e10</span><span class="p">)</span>
<span class="linenos">398</span>            <span class="n">dipparams_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;use_fixed_regularization&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos">399</span>            <span class="n">dipparams_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;det_threshold&#39;</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">)</span>
<span class="linenos">400</span>            <span class="n">dipparams_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;condition_tol_factor&#39;</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">)</span>
<span class="linenos">401</span>            <span class="n">dipparams_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;singularity_cond_threshold&#39;</span><span class="p">,</span> <span class="mf">1e8</span><span class="p">)</span>
<span class="linenos">402</span>            <span class="k">yield</span> <span class="n">DIPParams</span><span class="p">(</span><span class="o">**</span><span class="n">dipparams_dict</span><span class="p">)</span>
<span class="linenos">403</span>
<span class="linenos">404</span>    <span class="c1"># ---------- Cost computation ----------</span>
<span class="linenos">405</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_cost_from_traj</span><span class="p">(</span>
<span class="linenos">406</span>        <span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">x_b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">u_b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
<span class="linenos">407</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="linenos">408</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the cost per particle from simulated trajectories.</span>
<span class="linenos">409</span>
<span class="linenos">410</span><span class="sd">        The cost combines state error, control effort, control slew and a</span>
<span class="linenos">411</span><span class="sd">        sliding-mode stability term.  State error integrates the squared</span>
<span class="linenos">412</span><span class="sd">        deviation of all state components over the horizon.  Control terms</span>
<span class="linenos">413</span><span class="sd">        integrate squared commands and their rates.  A graded instability</span>
<span class="linenos">414</span><span class="sd">        penalty is applied when trajectories fail early.</span>
<span class="linenos">415</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">416</span>        <span class="c1"># Flag trajectories with any non-finite state entry</span>
<span class="linenos">417</span>        <span class="n">nan_traj_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x_b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="k">if</span> <span class="n">x_b</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="linenos">418</span>        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="linenos">419</span>        <span class="n">dt_b</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
<span class="linenos">420</span>        <span class="n">dt_const</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_cfg</span><span class="o">.</span><span class="n">dt</span>
<span class="linenos">421</span>        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
<span class="linenos">422</span>        <span class="n">B</span> <span class="o">=</span> <span class="n">x_b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">423</span>        <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">424</span>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">425</span>        <span class="c1"># Instability detection</span>
<span class="linenos">426</span>        <span class="n">fall_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_b</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
<span class="linenos">427</span>        <span class="n">explodes_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_b</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">428</span>        <span class="n">unstable_mask</span> <span class="o">=</span> <span class="n">fall_mask</span> <span class="o">|</span> <span class="n">explodes_mask</span>
<span class="linenos">429</span>        <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">B</span><span class="p">,</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">430</span>        <span class="n">temp</span><span class="p">[</span><span class="n">unstable_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="n">unstable_mask</span><span class="p">]</span>
<span class="linenos">431</span>        <span class="n">failure_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">432</span>        <span class="n">time_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">failure_steps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">])</span>
<span class="linenos">433</span>        <span class="c1"># State error: integrate squared error across all state variables  # [CIT-068]</span>
<span class="linenos">434</span>        <span class="n">ise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_b</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt_b</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">*</span> <span class="n">time_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># [CIT-068]</span>
<span class="linenos">435</span>        <span class="n">ise_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalise</span><span class="p">(</span><span class="n">ise</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_ise</span><span class="p">)</span>
<span class="linenos">436</span>        <span class="c1"># Control effort  # [CIT-068]</span>
<span class="linenos">437</span>        <span class="n">u_b_trunc</span> <span class="o">=</span> <span class="n">u_b</span><span class="p">[:,</span> <span class="p">:</span><span class="n">N</span><span class="p">]</span> <span class="k">if</span> <span class="n">u_b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">N</span> <span class="k">else</span> <span class="n">u_b</span>  <span class="c1"># Ensure shape compatibility</span>
<span class="linenos">438</span>        <span class="n">u_sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">u_b_trunc</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt_b</span><span class="p">)</span> <span class="o">*</span> <span class="n">time_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [CIT-068]</span>
<span class="linenos">439</span>        <span class="n">u_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalise</span><span class="p">(</span><span class="n">u_sq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_u</span><span class="p">)</span>
<span class="linenos">440</span>        <span class="c1"># Control slew  # [CIT-068]</span>
<span class="linenos">441</span>        <span class="n">du</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">u_b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="n">u_b</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># [CIT-068]</span>
<span class="linenos">442</span>        <span class="n">du_trunc</span> <span class="o">=</span> <span class="n">du</span><span class="p">[:,</span> <span class="p">:</span><span class="n">N</span><span class="p">]</span> <span class="k">if</span> <span class="n">du</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">N</span> <span class="k">else</span> <span class="n">du</span>  <span class="c1"># Ensure shape compatibility</span>
<span class="linenos">443</span>        <span class="n">du_sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">du_trunc</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt_b</span><span class="p">)</span> <span class="o">*</span> <span class="n">time_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [CIT-068]</span>
<span class="linenos">444</span>        <span class="n">du_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalise</span><span class="p">(</span><span class="n">du_sq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_du</span><span class="p">)</span>
<span class="linenos">445</span>        <span class="c1"># Sliding variable energy  # [CIT-068]</span>
<span class="linenos">446</span>        <span class="n">sigma_b_trunc</span> <span class="o">=</span> <span class="n">sigma_b</span><span class="p">[:,</span> <span class="p">:</span><span class="n">N</span><span class="p">]</span> <span class="k">if</span> <span class="n">sigma_b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">N</span> <span class="k">else</span> <span class="n">sigma_b</span>  <span class="c1"># Ensure shape compatibility</span>
<span class="linenos">447</span>        <span class="n">sigma_sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">sigma_b_trunc</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt_b</span><span class="p">)</span> <span class="o">*</span> <span class="n">time_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [CIT-068]</span>
<span class="linenos">448</span>        <span class="n">sigma_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalise</span><span class="p">(</span><span class="n">sigma_sq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_sigma</span><span class="p">)</span>
<span class="linenos">449</span>
<span class="linenos">450</span>        <span class="c1"># Diagnostic logging for PSO cost components</span>
<span class="linenos">451</span>        <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
<span class="linenos">452</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
<span class="linenos">453</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PSO Cost Component Analysis (Batch Statistics)&quot;</span><span class="p">)</span>
<span class="linenos">454</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
<span class="linenos">455</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ise</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">456</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Raw Cost Components:&quot;</span><span class="p">)</span>
<span class="linenos">457</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ISE        : mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ise</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, std=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ise</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ise</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ise</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">458</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  U²         : mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">u_sq</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, std=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">u_sq</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">u_sq</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">u_sq</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">459</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  (ΔU)²      : mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">du_sq</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, std=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">du_sq</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">du_sq</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">du_sq</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">460</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  σ²         : mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sigma_sq</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, std=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">sigma_sq</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">sigma_sq</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sigma_sq</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">461</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Normalized Costs:&quot;</span><span class="p">)</span>
<span class="linenos">462</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ISE_norm   : mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ise_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, std=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ise_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ise_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ise_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">463</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  U_norm     : mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">u_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, std=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">u_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">u_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">u_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">464</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  DU_norm    : mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">du_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, std=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">du_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">du_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">du_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">465</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  σ_norm     : mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sigma_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, std=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">sigma_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">sigma_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sigma_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">466</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Weighted Cost Contributions:&quot;</span><span class="p">)</span>
<span class="linenos">467</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  w_state × ISE_n : mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">state_error</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ise_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">468</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  w_ctrl  × U_n   : mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">control_effort</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">u_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">469</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  w_rate  × DU_n  : mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">control_rate</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">du_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">470</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  w_stab  × σ_n   : mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">stability</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sigma_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">471</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Normalization Constants:&quot;</span><span class="p">)</span>
<span class="linenos">472</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  norm_ise=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_ise</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, norm_u=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_u</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, norm_du=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_du</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, norm_sigma=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_sigma</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">473</span>
<span class="linenos">474</span>        <span class="c1"># Graded penalty for early failure</span>
<span class="linenos">475</span>        <span class="n">failure_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="n">failure_steps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt_const</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_cfg</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
<span class="linenos">476</span>        <span class="n">penalty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">stability</span> <span class="o">*</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_cfg</span><span class="o">.</span><span class="n">duration</span> <span class="o">-</span> <span class="n">failure_t</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_cfg</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span>
<span class="linenos">477</span>        <span class="n">J</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">478</span>            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">state_error</span> <span class="o">*</span> <span class="n">ise_n</span>
<span class="linenos">479</span>            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">control_effort</span> <span class="o">*</span> <span class="n">u_n</span>
<span class="linenos">480</span>            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">control_rate</span> <span class="o">*</span> <span class="n">du_n</span>
<span class="linenos">481</span>            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">stability</span> <span class="o">*</span> <span class="n">sigma_n</span>
<span class="linenos">482</span>        <span class="p">)</span> <span class="o">+</span> <span class="n">penalty</span>  <span class="c1"># [CIT-068]</span>
<span class="linenos">483</span>        <span class="c1"># Explicitly penalise NaN trajectories</span>
<span class="linenos">484</span>        <span class="k">if</span> <span class="n">nan_traj_mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<span class="linenos">485</span>            <span class="n">J</span> <span class="o">=</span> <span class="n">J</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">486</span>            <span class="n">J</span><span class="p">[</span><span class="n">nan_traj_mask</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span><span class="p">)</span>
<span class="linenos">487</span>        <span class="n">J</span> <span class="o">=</span> <span class="n">J</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">488</span>        <span class="n">nan_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">J</span><span class="p">)</span>
<span class="linenos">489</span>        <span class="k">if</span> <span class="n">nan_mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<span class="linenos">490</span>            <span class="n">J</span><span class="p">[</span><span class="n">nan_mask</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span><span class="p">)</span>
<span class="linenos">491</span>        <span class="k">return</span> <span class="n">J</span>
<span class="linenos">492</span>
<span class="linenos">493</span>    <span class="c1"># ---------- Normalisation and cost aggregation helpers ----------</span>
<span class="linenos">494</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_normalise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">denom</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="linenos">495</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Safely normalise an array by a scalar denominator using the instance&#39;s threshold.</span>
<span class="linenos">496</span>
<span class="linenos">497</span><span class="sd">        When the denominator is less than or equal to ``self.normalisation_threshold`` the</span>
<span class="linenos">498</span><span class="sd">        original array is returned unchanged.  This prevents amplification of</span>
<span class="linenos">499</span><span class="sd">        numerical noise in near-zero denominators.</span>
<span class="linenos">500</span>
<span class="linenos">501</span><span class="sd">        Parameters</span>
<span class="linenos">502</span><span class="sd">        ----------</span>
<span class="linenos">503</span><span class="sd">        val : np.ndarray</span>
<span class="linenos">504</span><span class="sd">            Array of values to be normalised.</span>
<span class="linenos">505</span><span class="sd">        denom : float</span>
<span class="linenos">506</span><span class="sd">            Scalar denominator.</span>
<span class="linenos">507</span>
<span class="linenos">508</span><span class="sd">        Returns</span>
<span class="linenos">509</span><span class="sd">        -------</span>
<span class="linenos">510</span><span class="sd">        np.ndarray</span>
<span class="linenos">511</span><span class="sd">            The normalised array.</span>
<span class="linenos">512</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">513</span>        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>
<span class="linenos">514</span>            <span class="n">ratio</span> <span class="o">=</span> <span class="n">val</span> <span class="o">/</span> <span class="n">denom</span>
<span class="linenos">515</span>        <span class="n">thr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalisation_threshold</span><span class="p">)</span>
<span class="linenos">516</span>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">denom</span> <span class="o">&gt;</span> <span class="n">thr</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
<span class="linenos">517</span>
<span class="linenos">518</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_combine_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">costs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="linenos">519</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate costs across uncertainty draws using the instance&#39;s weights.</span>
<span class="linenos">520</span>
<span class="linenos">521</span><span class="sd">        For a one-dimensional array of costs, return ``w_mean*mean + w_max*max``.  For</span>
<span class="linenos">522</span><span class="sd">        a two-dimensional array of shape (D, B), aggregate along the first</span>
<span class="linenos">523</span><span class="sd">        dimension (draws) and return an array of shape (B,).  Non-finite inputs</span>
<span class="linenos">524</span><span class="sd">        result in the instability penalty.</span>
<span class="linenos">525</span>
<span class="linenos">526</span><span class="sd">        Parameters</span>
<span class="linenos">527</span><span class="sd">        ----------</span>
<span class="linenos">528</span><span class="sd">        costs : np.ndarray</span>
<span class="linenos">529</span><span class="sd">            1D or 2D array of cost values.</span>
<span class="linenos">530</span>
<span class="linenos">531</span><span class="sd">        Returns</span>
<span class="linenos">532</span><span class="sd">        -------</span>
<span class="linenos">533</span><span class="sd">        np.ndarray or float</span>
<span class="linenos">534</span><span class="sd">            Aggregated costs per particle or a single scalar cost.</span>
<span class="linenos">535</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">536</span>        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">costs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">537</span>        <span class="n">mean_w</span><span class="p">,</span> <span class="n">max_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_weights</span>
<span class="linenos">538</span>        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">539</span>            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">c</span><span class="p">)):</span>
<span class="linenos">540</span>                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span><span class="p">)</span>
<span class="linenos">541</span>            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">mean_w</span> <span class="o">*</span> <span class="n">c</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="n">max_w</span> <span class="o">*</span> <span class="n">c</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="linenos">542</span>        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos">543</span>            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">c</span><span class="p">)):</span>
<span class="linenos">544</span>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">545</span>            <span class="k">return</span> <span class="n">mean_w</span> <span class="o">*</span> <span class="n">c</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">max_w</span> <span class="o">*</span> <span class="n">c</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">546</span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;costs must be 1D or 2D&quot;</span><span class="p">)</span>
<span class="linenos">547</span>
<span class="linenos">548</span>    <span class="c1"># ---------- Fitness evaluation ----------</span>
<span class="linenos">549</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_fitness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">particles</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="linenos">550</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Vectorised fitness function for a swarm of particles.&quot;&quot;&quot;</span>
<span class="linenos">551</span>        <span class="n">ref_ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_factory</span><span class="p">(</span><span class="n">particles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">552</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_u_max</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ref_ctrl</span><span class="p">,</span> <span class="s2">&quot;max_force&quot;</span><span class="p">,</span> <span class="mf">150.0</span><span class="p">)</span>
<span class="linenos">553</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_cfg</span><span class="o">.</span><span class="n">duration</span>
<span class="linenos">554</span>        <span class="n">B</span> <span class="o">=</span> <span class="n">particles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">555</span>        <span class="n">violation_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="linenos">556</span>        <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">violation_mask</span>
<span class="linenos">557</span>        <span class="n">valid_particles</span> <span class="o">=</span> <span class="n">particles</span>
<span class="linenos">558</span>        <span class="c1"># Pre-filter particles using validate_gains if available</span>
<span class="linenos">559</span>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ref_ctrl</span><span class="p">,</span> <span class="s2">&quot;validate_gains&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">ref_ctrl</span><span class="p">,</span> <span class="s2">&quot;validate_gains&quot;</span><span class="p">)):</span>
<span class="linenos">560</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">561</span>                <span class="n">valid_mask_arr</span> <span class="o">=</span> <span class="n">ref_ctrl</span><span class="o">.</span><span class="n">validate_gains</span><span class="p">(</span><span class="n">particles</span><span class="p">)</span>
<span class="linenos">562</span>                <span class="n">valid_mask_arr</span> <span class="o">=</span> <span class="n">valid_mask_arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">563</span>                <span class="k">if</span> <span class="n">valid_mask_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">particles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
<span class="linenos">564</span>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;validate_gains returned mask with wrong length&quot;</span><span class="p">)</span>
<span class="linenos">565</span>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">566</span>                <span class="n">valid_mask_arr</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">567</span>            <span class="k">if</span> <span class="n">valid_mask_arr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">568</span>                <span class="n">violation_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">valid_mask_arr</span>
<span class="linenos">569</span>                <span class="k">if</span> <span class="n">violation_mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<span class="linenos">570</span>                    <span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">violation_mask</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">571</span>                        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">572</span>                    <span class="n">valid_particles</span> <span class="o">=</span> <span class="n">particles</span><span class="p">[</span><span class="o">~</span><span class="n">violation_mask</span><span class="p">]</span>
<span class="linenos">573</span>                    <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">violation_mask</span>
<span class="linenos">574</span>        <span class="c1"># Evaluate under uncertainty draws if configured</span>
<span class="linenos">575</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_cfg</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_cfg</span><span class="o">.</span><span class="n">n_evals</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">576</span>            <span class="n">physics_models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter_perturbed_physics</span><span class="p">())</span>
<span class="linenos">577</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">578</span>                <span class="n">results_list</span> <span class="o">=</span> <span class="n">simulate_system_batch</span><span class="p">(</span>
<span class="linenos">579</span>                    <span class="n">controller_factory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">controller_factory</span><span class="p">,</span>
<span class="linenos">580</span>                    <span class="n">particles</span><span class="o">=</span><span class="n">valid_particles</span><span class="p">,</span>
<span class="linenos">581</span>                    <span class="n">sim_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="p">,</span>
<span class="linenos">582</span>                    <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_cfg</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
<span class="linenos">583</span>                    <span class="n">u_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_u_max</span><span class="p">,</span>
<span class="linenos">584</span>                    <span class="n">params_list</span><span class="o">=</span><span class="n">physics_models</span><span class="p">,</span>
<span class="linenos">585</span>                <span class="p">)</span>
<span class="linenos">586</span>            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
<span class="linenos">587</span>                <span class="n">results_list</span> <span class="o">=</span> <span class="n">simulate_system_batch</span><span class="p">(</span>
<span class="linenos">588</span>                    <span class="n">controller_factory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">controller_factory</span><span class="p">,</span>
<span class="linenos">589</span>                    <span class="n">particles</span><span class="o">=</span><span class="n">valid_particles</span><span class="p">,</span>
<span class="linenos">590</span>                    <span class="n">sim_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="p">,</span>
<span class="linenos">591</span>                    <span class="n">u_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_u_max</span><span class="p">,</span>
<span class="linenos">592</span>                    <span class="n">params_list</span><span class="o">=</span><span class="n">physics_models</span><span class="p">,</span>
<span class="linenos">593</span>                <span class="p">)</span>
<span class="linenos">594</span>            <span class="n">all_costs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">595</span>            <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">x_b</span><span class="p">,</span> <span class="n">u_b</span><span class="p">,</span> <span class="n">sigma_b</span> <span class="ow">in</span> <span class="n">results_list</span><span class="p">:</span>
<span class="linenos">596</span>                <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_cost_from_traj</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x_b</span><span class="p">,</span> <span class="n">u_b</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">)</span>
<span class="linenos">597</span>                <span class="n">nan_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>
<span class="linenos">598</span>                <span class="k">if</span> <span class="n">nan_mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<span class="linenos">599</span>                    <span class="n">cost</span> <span class="o">=</span> <span class="n">cost</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">600</span>                    <span class="n">cost</span><span class="p">[</span><span class="n">nan_mask</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span><span class="p">)</span>
<span class="linenos">601</span>                <span class="n">all_costs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>
<span class="linenos">602</span>            <span class="n">costs_per_draw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">all_costs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">603</span>            <span class="n">J_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_costs</span><span class="p">(</span><span class="n">costs_per_draw</span><span class="p">)</span>
<span class="linenos">604</span>            <span class="n">penalty</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span><span class="p">)</span>
<span class="linenos">605</span>            <span class="n">unstable_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">costs_per_draw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">penalty</span>
<span class="linenos">606</span>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">unstable_mask</span><span class="p">):</span>
<span class="linenos">607</span>                <span class="n">J_valid</span> <span class="o">=</span> <span class="n">J_valid</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">608</span>                <span class="n">J_valid</span><span class="p">[</span><span class="n">unstable_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">penalty</span>
<span class="linenos">609</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">610</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">611</span>                <span class="n">t</span><span class="p">,</span> <span class="n">x_b</span><span class="p">,</span> <span class="n">u_b</span><span class="p">,</span> <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">simulate_system_batch</span><span class="p">(</span>
<span class="linenos">612</span>                    <span class="n">controller_factory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">controller_factory</span><span class="p">,</span>
<span class="linenos">613</span>                    <span class="n">particles</span><span class="o">=</span><span class="n">valid_particles</span><span class="p">,</span>
<span class="linenos">614</span>                    <span class="n">sim_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="p">,</span>
<span class="linenos">615</span>                    <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_cfg</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
<span class="linenos">616</span>                    <span class="n">u_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_u_max</span><span class="p">,</span>
<span class="linenos">617</span>                <span class="p">)</span>
<span class="linenos">618</span>            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
<span class="linenos">619</span>                <span class="n">t</span><span class="p">,</span> <span class="n">x_b</span><span class="p">,</span> <span class="n">u_b</span><span class="p">,</span> <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">simulate_system_batch</span><span class="p">(</span>
<span class="linenos">620</span>                    <span class="n">controller_factory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">controller_factory</span><span class="p">,</span>
<span class="linenos">621</span>                    <span class="n">particles</span><span class="o">=</span><span class="n">valid_particles</span><span class="p">,</span>
<span class="linenos">622</span>                    <span class="n">sim_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="p">,</span>
<span class="linenos">623</span>                    <span class="n">u_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_u_max</span><span class="p">,</span>
<span class="linenos">624</span>                <span class="p">)</span>
<span class="linenos">625</span>            <span class="c1"># Determine which particles produced non-finite trajectories.</span>
<span class="linenos">626</span>            <span class="c1"># Construct a mask that flags any particle whose state, control or</span>
<span class="linenos">627</span>            <span class="c1"># sliding variable contains NaNs or infinite values.  Parentheses</span>
<span class="linenos">628</span>            <span class="c1"># group the three boolean arrays to avoid inadvertent line</span>
<span class="linenos">629</span>            <span class="c1"># continuation issues in Python syntax.</span>
<span class="linenos">630</span>            <span class="n">nan_mask</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">631</span>                <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x_b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="linenos">632</span>                <span class="o">|</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">u_b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="linenos">633</span>                <span class="o">|</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sigma_b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="linenos">634</span>            <span class="p">)</span>
<span class="linenos">635</span>            <span class="n">J_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_cost_from_traj</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x_b</span><span class="p">,</span> <span class="n">u_b</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">)</span>
<span class="linenos">636</span>            <span class="k">if</span> <span class="n">nan_mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<span class="linenos">637</span>                <span class="n">J_valid</span><span class="p">[</span><span class="n">nan_mask</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span><span class="p">)</span>
<span class="linenos">638</span>        <span class="k">if</span> <span class="n">violation_mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<span class="linenos">639</span>            <span class="n">J_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">640</span>            <span class="n">J_full</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">J_valid</span>
<span class="linenos">641</span>            <span class="k">return</span> <span class="n">J_full</span>
<span class="linenos">642</span>        <span class="k">return</span> <span class="n">J_valid</span>
<span class="linenos">643</span>
<span class="linenos">644</span>    <span class="c1"># ---------- Optimisation ----------</span>
<span class="linenos">645</span>    <span class="k">def</span><span class="w"> </span><span class="nf">optimise</span><span class="p">(</span>
<span class="linenos">646</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos">647</span>        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="linenos">648</span>        <span class="n">iters_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">649</span>        <span class="n">n_particles_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">650</span>        <span class="n">options_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">651</span>        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="linenos">652</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="linenos">653</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run particle swarm optimisation with optional overrides.</span>
<span class="linenos">654</span>
<span class="linenos">655</span><span class="sd">        This method constructs a `pyswarms.single.GlobalBestPSO` instance from</span>
<span class="linenos">656</span><span class="sd">        the PSO configuration and executes the optimisation loop.  Two</span>
<span class="linenos">657</span><span class="sd">        enhancements are supported beyond the standard PSO:</span>
<span class="linenos">658</span>
<span class="linenos">659</span><span class="sd">        * **Velocity clamping:** if ``pso_cfg.velocity_clamp`` is a tuple</span>
<span class="linenos">660</span><span class="sd">          ``(delta_min, delta_max)``, the per-dimension particle velocities are</span>
<span class="linenos">661</span><span class="sd">          constrained to lie within ``delta_min*(bmax - bmin)`` and</span>
<span class="linenos">662</span><span class="sd">          ``delta_max*(bmax - bmin)``.  Clamping prevents</span>
<span class="linenos">663</span><span class="sd">          particles from overshooting and encourages stability.  When unset,</span>
<span class="linenos">664</span><span class="sd">          no explicit velocity limits are imposed.</span>
<span class="linenos">665</span><span class="sd">        * **Inertia weight scheduling:** if ``pso_cfg.w_schedule`` is provided</span>
<span class="linenos">666</span><span class="sd">          as ``(w_start, w_end)``, the inertia weight is decreased linearly</span>
<span class="linenos">667</span><span class="sd">          from ``w_start`` to ``w_end`` over the iteration horizon to shift</span>
<span class="linenos">668</span><span class="sd">          gradually from global exploration to local exploitation.</span>
<span class="linenos">669</span><span class="sd">          When a schedule is specified, the method runs a manual stepping loop,</span>
<span class="linenos">670</span><span class="sd">          updating ``optimizer.options[&#39;w&#39;]`` at each iteration and capturing</span>
<span class="linenos">671</span><span class="sd">          the best cost and position history.</span>
<span class="linenos">672</span>
<span class="linenos">673</span><span class="sd">        Parameters</span>
<span class="linenos">674</span><span class="sd">        ----------</span>
<span class="linenos">675</span><span class="sd">        iters_override : int, optional</span>
<span class="linenos">676</span><span class="sd">            Overrides the number of iterations specified in the configuration.</span>
<span class="linenos">677</span><span class="sd">        n_particles_override : int, optional</span>
<span class="linenos">678</span><span class="sd">            Overrides the swarm size specified in the configuration.</span>
<span class="linenos">679</span><span class="sd">        options_override : dict, optional</span>
<span class="linenos">680</span><span class="sd">            Dictionary of PSO hyperparameters (e.g., inertia and cognitive/social</span>
<span class="linenos">681</span><span class="sd">            weights) that update defaults from configuration.  These values</span>
<span class="linenos">682</span><span class="sd">            take precedence over the configuration defaults but are superseded</span>
<span class="linenos">683</span><span class="sd">            by ``w_schedule`` for the inertia weight.</span>
<span class="linenos">684</span>
<span class="linenos">685</span><span class="sd">        Returns</span>
<span class="linenos">686</span><span class="sd">        -------</span>
<span class="linenos">687</span><span class="sd">        dict</span>
<span class="linenos">688</span><span class="sd">            A dictionary containing ``best_cost``, ``best_pos`` and a history</span>
<span class="linenos">689</span><span class="sd">            of costs and positions.  When a schedule is used, the history</span>
<span class="linenos">690</span><span class="sd">            arrays have length ``iters``; otherwise the history is taken</span>
<span class="linenos">691</span><span class="sd">            directly from the underlying PSO optimiser.</span>
<span class="linenos">692</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">693</span>        <span class="kn">from</span><span class="w"> </span><span class="nn">pyswarms.single</span><span class="w"> </span><span class="kn">import</span> <span class="n">GlobalBestPSO</span>
<span class="linenos">694</span>        <span class="n">pso_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">pso</span>
<span class="linenos">695</span>
<span class="linenos">696</span>        <span class="c1"># Get expected dimensions from controller factory</span>
<span class="linenos">697</span>        <span class="n">expected_dims</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controller_factory</span><span class="p">,</span> <span class="s2">&quot;n_gains&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">698</span>        <span class="k">if</span> <span class="n">expected_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">699</span>            <span class="c1"># Try to create a test controller to infer dimensions</span>
<span class="linenos">700</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">701</span>                <span class="c1"># Use default gains to create a test controller and infer dimensions</span>
<span class="linenos">702</span>                <span class="n">test_gains_configs</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">703</span>                    <span class="s1">&#39;classical_smc&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span>  <span class="c1"># 6 gains</span>
<span class="linenos">704</span>                    <span class="s1">&#39;adaptive_smc&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span>  <span class="c1"># 5 gains</span>
<span class="linenos">705</span>                    <span class="s1">&#39;sta_smc&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>  <span class="c1"># 6 gains</span>
<span class="linenos">706</span>                    <span class="s1">&#39;hybrid_adaptive_sta_smc&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>  <span class="c1"># 4 gains</span>
<span class="linenos">707</span>                <span class="p">}</span>
<span class="linenos">708</span>
<span class="linenos">709</span>                <span class="c1"># Try to determine controller type and appropriate test gains</span>
<span class="linenos">710</span>                <span class="n">controller_type_hint</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controller_factory</span><span class="p">,</span> <span class="s2">&quot;controller_type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">711</span>
<span class="linenos">712</span>                <span class="k">if</span> <span class="n">controller_type_hint</span> <span class="ow">and</span> <span class="n">controller_type_hint</span> <span class="ow">in</span> <span class="n">test_gains_configs</span><span class="p">:</span>
<span class="linenos">713</span>                    <span class="n">test_gains</span> <span class="o">=</span> <span class="n">test_gains_configs</span><span class="p">[</span><span class="n">controller_type_hint</span><span class="p">]</span>
<span class="linenos">714</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">715</span>                    <span class="c1"># Try classical_smc as default</span>
<span class="linenos">716</span>                    <span class="n">test_gains</span> <span class="o">=</span> <span class="n">test_gains_configs</span><span class="p">[</span><span class="s1">&#39;classical_smc&#39;</span><span class="p">]</span>
<span class="linenos">717</span>
<span class="linenos">718</span>                <span class="c1"># Create test controller to infer dimensions</span>
<span class="linenos">719</span>                <span class="n">test_controller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_factory</span><span class="p">(</span><span class="n">test_gains</span><span class="p">)</span>
<span class="linenos">720</span>
<span class="linenos">721</span>                <span class="c1"># Try to get n_gains from the controller instance</span>
<span class="linenos">722</span>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test_controller</span><span class="p">,</span> <span class="s1">&#39;n_gains&#39;</span><span class="p">):</span>
<span class="linenos">723</span>                    <span class="n">expected_dims</span> <span class="o">=</span> <span class="n">test_controller</span><span class="o">.</span><span class="n">n_gains</span>
<span class="linenos">724</span>                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test_controller</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test_controller</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;gains&#39;</span><span class="p">):</span>
<span class="linenos">725</span>                    <span class="n">expected_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_controller</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">gains</span><span class="p">)</span>
<span class="linenos">726</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">727</span>                    <span class="n">expected_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_gains</span><span class="p">)</span>
<span class="linenos">728</span>
<span class="linenos">729</span>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">730</span>                <span class="c1"># Fallback to default dimensions</span>
<span class="linenos">731</span>                <span class="n">expected_dims</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># Classical SMC default</span>
<span class="linenos">732</span>
<span class="linenos">733</span>        <span class="c1"># Determine controller type to select appropriate bounds</span>
<span class="linenos">734</span>        <span class="n">controller_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controller_factory</span><span class="p">,</span> <span class="s2">&quot;controller_type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">735</span>
<span class="linenos">736</span>        <span class="c1"># If no controller type from factory, try to infer from a test controller</span>
<span class="linenos">737</span>        <span class="k">if</span> <span class="n">controller_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">738</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">739</span>                <span class="n">test_gains</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">][:</span><span class="n">expected_dims</span><span class="p">]</span>
<span class="linenos">740</span>                <span class="n">test_controller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_factory</span><span class="p">(</span><span class="n">test_gains</span><span class="p">)</span>
<span class="linenos">741</span>                <span class="n">controller_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">test_controller</span><span class="p">,</span> <span class="s1">&#39;controller_type&#39;</span><span class="p">,</span> <span class="s1">&#39;classical_smc&#39;</span><span class="p">)</span>
<span class="linenos">742</span>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">743</span>                <span class="n">controller_type</span> <span class="o">=</span> <span class="s1">&#39;classical_smc&#39;</span>  <span class="c1"># Default fallback</span>
<span class="linenos">744</span>
<span class="linenos">745</span>        <span class="c1"># Get controller-specific bounds if available, otherwise use default bounds</span>
<span class="linenos">746</span>        <span class="n">bounds_config</span> <span class="o">=</span> <span class="n">pso_cfg</span><span class="o">.</span><span class="n">bounds</span>
<span class="linenos">747</span>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">bounds_config</span><span class="p">,</span> <span class="n">controller_type</span><span class="p">):</span>
<span class="linenos">748</span>            <span class="n">controller_bounds</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">bounds_config</span><span class="p">,</span> <span class="n">controller_type</span><span class="p">)</span>
<span class="linenos">749</span>            <span class="n">min_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">controller_bounds</span><span class="o">.</span><span class="n">min</span><span class="p">)</span>
<span class="linenos">750</span>            <span class="n">max_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">controller_bounds</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>
<span class="linenos">751</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">752</span>            <span class="c1"># Fallback to default bounds</span>
<span class="linenos">753</span>            <span class="n">min_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bounds_config</span><span class="o">.</span><span class="n">min</span><span class="p">)</span>
<span class="linenos">754</span>            <span class="n">max_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bounds_config</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>
<span class="linenos">755</span>
<span class="linenos">756</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">min_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">max_list</span><span class="p">):</span>
<span class="linenos">757</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos">758</span>                <span class="sa">f</span><span class="s2">&quot;PSO bounds min/max lengths differ: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">min_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">max_list</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">759</span>            <span class="p">)</span>
<span class="linenos">760</span>
<span class="linenos">761</span>        <span class="c1"># Validate bounds length matches expected dimensions</span>
<span class="linenos">762</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">min_list</span><span class="p">)</span> <span class="o">!=</span> <span class="n">expected_dims</span><span class="p">:</span>
<span class="linenos">763</span>            <span class="c1"># Try to adjust bounds to match expected dimensions</span>
<span class="linenos">764</span>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">min_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">expected_dims</span><span class="p">:</span>
<span class="linenos">765</span>                <span class="c1"># Truncate bounds</span>
<span class="linenos">766</span>                <span class="n">min_list</span> <span class="o">=</span> <span class="n">min_list</span><span class="p">[:</span><span class="n">expected_dims</span><span class="p">]</span>
<span class="linenos">767</span>                <span class="n">max_list</span> <span class="o">=</span> <span class="n">max_list</span><span class="p">[:</span><span class="n">expected_dims</span><span class="p">]</span>
<span class="linenos">768</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">769</span>                <span class="c1"># Extend bounds with reasonable defaults</span>
<span class="linenos">770</span>                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">min_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">expected_dims</span><span class="p">:</span>
<span class="linenos">771</span>                    <span class="n">min_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="linenos">772</span>                    <span class="n">max_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">50.0</span><span class="p">)</span>
<span class="linenos">773</span>        <span class="n">pso_options</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">774</span>            <span class="s1">&#39;c1&#39;</span><span class="p">:</span> <span class="n">pso_cfg</span><span class="o">.</span><span class="n">c1</span><span class="p">,</span>
<span class="linenos">775</span>            <span class="s1">&#39;c2&#39;</span><span class="p">:</span> <span class="n">pso_cfg</span><span class="o">.</span><span class="n">c2</span><span class="p">,</span>
<span class="linenos">776</span>            <span class="s1">&#39;w&#39;</span><span class="p">:</span> <span class="n">pso_cfg</span><span class="o">.</span><span class="n">w</span><span class="p">,</span>
<span class="linenos">777</span>        <span class="p">}</span>
<span class="linenos">778</span>        <span class="c1"># Warn the user if PSO hyperparameters are outside recommended ranges.</span>
<span class="linenos">779</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">780</span>            <span class="c1"># Recommended swarm sizes are 10–30 and balanced c1≈c2.</span>
<span class="linenos">781</span>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">10</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pso_cfg</span><span class="o">.</span><span class="n">n_particles</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="p">):</span>
<span class="linenos">782</span>                <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="linenos">783</span>                    <span class="s2">&quot;n_particles=</span><span class="si">%s</span><span class="s2"> is outside the recommended range [10,50] for PSO&quot;</span><span class="p">,</span> <span class="n">pso_cfg</span><span class="o">.</span><span class="n">n_particles</span>
<span class="linenos">784</span>                <span class="p">)</span>
<span class="linenos">785</span>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">pso_cfg</span><span class="o">.</span><span class="n">c1</span><span class="p">)</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">pso_cfg</span><span class="o">.</span><span class="n">c2</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
<span class="linenos">786</span>                <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="linenos">787</span>                    <span class="s2">&quot;PSO acceleration coefficients are unbalanced (c1=</span><span class="si">%s</span><span class="s2">, c2=</span><span class="si">%s</span><span class="s2">); set c1≈c2 to avoid divergence&quot;</span><span class="p">,</span>
<span class="linenos">788</span>                    <span class="n">pso_cfg</span><span class="o">.</span><span class="n">c1</span><span class="p">,</span> <span class="n">pso_cfg</span><span class="o">.</span><span class="n">c2</span>
<span class="linenos">789</span>                <span class="p">)</span>
<span class="linenos">790</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">791</span>            <span class="c1"># Ignore warnings if parameters are missing or cannot be cast.</span>
<span class="linenos">792</span>            <span class="k">pass</span>
<span class="linenos">793</span>        <span class="k">if</span> <span class="n">options_override</span><span class="p">:</span>
<span class="linenos">794</span>            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">options_override</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">795</span>                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">pso_options</span><span class="p">:</span>
<span class="linenos">796</span>                    <span class="n">pso_options</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="linenos">797</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">798</span>                    <span class="n">pso_options</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
<span class="linenos">799</span>        <span class="n">bmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">min_list</span><span class="p">[:</span><span class="n">expected_dims</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">800</span>        <span class="n">bmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">max_list</span><span class="p">[:</span><span class="n">expected_dims</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">801</span>        <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">bmin</span><span class="p">,</span> <span class="n">bmax</span><span class="p">)</span>
<span class="linenos">802</span>        <span class="n">n_particles</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_particles_override</span><span class="p">)</span> <span class="k">if</span> <span class="n">n_particles_override</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">pso_cfg</span><span class="o">.</span><span class="n">n_particles</span><span class="p">)</span>
<span class="linenos">803</span>        <span class="n">iters</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">iters_override</span><span class="p">)</span> <span class="k">if</span> <span class="n">iters_override</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">pso_cfg</span><span class="o">.</span><span class="n">iters</span><span class="p">)</span>
<span class="linenos">804</span>        <span class="k">if</span> <span class="n">n_particles</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">iters</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">805</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;n_particles and iters must be positive&quot;</span><span class="p">)</span>
<span class="linenos">806</span>        <span class="c1"># Reinitialise the local RNG when a fixed seed is provided.  Using a</span>
<span class="linenos">807</span>        <span class="c1"># per-instance Generator avoids global side effects.</span>
<span class="linenos">808</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">809</span>            <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">))</span>
<span class="linenos">810</span>        <span class="c1"># Initialise swarm positions using the local RNG to avoid</span>
<span class="linenos">811</span>        <span class="c1"># invoking the global NumPy RNG.  Without specifying init_pos</span>
<span class="linenos">812</span>        <span class="c1"># the underlying PSO implementation seeds the global RNG.</span>
<span class="linenos">813</span>        <span class="n">init_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">bmin</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">bmax</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_particles</span><span class="p">,</span> <span class="n">expected_dims</span><span class="p">))</span>
<span class="linenos">814</span>        <span class="c1"># Derive a seed for the PSO library from the local RNG.  Passing a</span>
<span class="linenos">815</span>        <span class="c1"># deterministic seed ensures that the PSO optimiser does not rely on</span>
<span class="linenos">816</span>        <span class="c1"># NumPy&#39;s global RNG and produces reproducible results across runs.</span>
<span class="linenos">817</span>        <span class="n">seed_int</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">818</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">819</span>            <span class="n">seed_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
<span class="linenos">820</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">821</span>            <span class="n">seed_int</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">822</span>        <span class="c1"># Compute optional velocity clamp.  Velocity clamping prevents particles</span>
<span class="linenos">823</span>        <span class="c1"># from diverging and helps ensure convergence.  The clamping limits are</span>
<span class="linenos">824</span>        <span class="c1"># expressed as fractions of the search range and multiplied by ``bmax - bmin``.</span>
<span class="linenos">825</span>        <span class="n">v_clamp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">826</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">827</span>            <span class="n">vc</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pso_cfg</span><span class="p">,</span> <span class="s2">&quot;velocity_clamp&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">828</span>            <span class="k">if</span> <span class="n">vc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">829</span>                <span class="n">frac_min</span><span class="p">,</span> <span class="n">frac_max</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vc</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">vc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="linenos">830</span>                <span class="c1"># Compute per-dimension ranges</span>
<span class="linenos">831</span>                <span class="n">range_vec</span> <span class="o">=</span> <span class="n">bmax</span> <span class="o">-</span> <span class="n">bmin</span>
<span class="linenos">832</span>                <span class="n">v_clamp</span> <span class="o">=</span> <span class="p">(</span><span class="n">frac_min</span> <span class="o">*</span> <span class="n">range_vec</span><span class="p">,</span> <span class="n">frac_max</span> <span class="o">*</span> <span class="n">range_vec</span><span class="p">)</span>
<span class="linenos">833</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">834</span>            <span class="n">v_clamp</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">835</span>
<span class="linenos">836</span>        <span class="c1"># Create optimizer - handle version compatibility for PySwarms</span>
<span class="linenos">837</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">838</span>            <span class="c1"># Try with newer PySwarms API that supports seed and velocity_clamp</span>
<span class="linenos">839</span>            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">GlobalBestPSO</span><span class="p">(</span>
<span class="linenos">840</span>                <span class="n">n_particles</span><span class="o">=</span><span class="n">n_particles</span><span class="p">,</span>
<span class="linenos">841</span>                <span class="n">dimensions</span><span class="o">=</span><span class="n">expected_dims</span><span class="p">,</span>
<span class="linenos">842</span>                <span class="n">options</span><span class="o">=</span><span class="n">pso_options</span><span class="p">,</span>
<span class="linenos">843</span>                <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
<span class="linenos">844</span>                <span class="n">init_pos</span><span class="o">=</span><span class="n">init_pos</span><span class="p">,</span>
<span class="linenos">845</span>                <span class="n">seed</span><span class="o">=</span><span class="n">seed_int</span><span class="p">,</span>
<span class="linenos">846</span>                <span class="n">velocity_clamp</span><span class="o">=</span><span class="n">v_clamp</span><span class="p">,</span>
<span class="linenos">847</span>            <span class="p">)</span>
<span class="linenos">848</span>        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
<span class="linenos">849</span>            <span class="c1"># Fallback for PySwarms 1.3.0 which doesn&#39;t support seed or velocity_clamp</span>
<span class="linenos">850</span>            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">GlobalBestPSO</span><span class="p">(</span>
<span class="linenos">851</span>                <span class="n">n_particles</span><span class="o">=</span><span class="n">n_particles</span><span class="p">,</span>
<span class="linenos">852</span>                <span class="n">dimensions</span><span class="o">=</span><span class="n">expected_dims</span><span class="p">,</span>
<span class="linenos">853</span>                <span class="n">options</span><span class="o">=</span><span class="n">pso_options</span><span class="p">,</span>
<span class="linenos">854</span>                <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
<span class="linenos">855</span>                <span class="n">init_pos</span><span class="o">=</span><span class="n">init_pos</span><span class="p">,</span>
<span class="linenos">856</span>            <span class="p">)</span>
<span class="linenos">857</span>        <span class="c1"># If an inertia weight schedule is provided, perform manual stepping.  A</span>
<span class="linenos">858</span>        <span class="c1"># linearly decreasing inertia weight from 0.9 to 0.4 encourages early</span>
<span class="linenos">859</span>        <span class="c1"># exploration and late exploitation.  The</span>
<span class="linenos">860</span>        <span class="c1"># optimisation loop updates ``optimizer.options[&#39;w&#39;]`` at each step and</span>
<span class="linenos">861</span>        <span class="c1"># records cost and position history.</span>
<span class="linenos">862</span>        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pso_cfg</span><span class="p">,</span> <span class="s2">&quot;w_schedule&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">863</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">864</span>                <span class="n">w_start</span><span class="p">,</span> <span class="n">w_end</span> <span class="o">=</span> <span class="n">pso_cfg</span><span class="o">.</span><span class="n">w_schedule</span>
<span class="linenos">865</span>                <span class="c1"># Generate equally spaced inertia weights over the iteration horizon</span>
<span class="linenos">866</span>                <span class="n">w_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">w_start</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">w_end</span><span class="p">),</span> <span class="n">iters</span><span class="p">)</span>
<span class="linenos">867</span>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">868</span>                <span class="c1"># Fall back to constant inertia if schedule is invalid</span>
<span class="linenos">869</span>                <span class="n">w_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">iters</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">pso_cfg</span><span class="o">.</span><span class="n">w</span><span class="p">))</span>
<span class="linenos">870</span>            <span class="n">cost_hist</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">871</span>            <span class="n">pos_hist</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">872</span>            <span class="k">for</span> <span class="n">w_val</span> <span class="ow">in</span> <span class="n">w_values</span><span class="p">:</span>
<span class="linenos">873</span>                <span class="c1"># Update inertia weight for this iteration</span>
<span class="linenos">874</span>                <span class="n">optimizer</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">w_val</span><span class="p">)</span>
<span class="linenos">875</span>                <span class="c1"># Execute a single PSO step; returns current best cost and position</span>
<span class="linenos">876</span>                <span class="n">step_cost</span><span class="p">,</span> <span class="n">step_pos</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fitness</span><span class="p">)</span>
<span class="linenos">877</span>                <span class="n">cost_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">step_cost</span><span class="p">))</span>
<span class="linenos">878</span>                <span class="n">pos_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">step_pos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
<span class="linenos">879</span>            <span class="c1"># Retrieve final global best values from the swarm</span>
<span class="linenos">880</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">881</span>                <span class="n">final_cost</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">swarm</span><span class="o">.</span><span class="n">best_cost</span><span class="p">)</span>
<span class="linenos">882</span>                <span class="n">final_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">swarm</span><span class="o">.</span><span class="n">best_pos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">883</span>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">884</span>                <span class="c1"># Fallback to the last recorded values</span>
<span class="linenos">885</span>                <span class="n">final_cost</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cost_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="linenos">886</span>                <span class="n">final_pos</span> <span class="o">=</span> <span class="n">pos_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">887</span>            <span class="k">return</span> <span class="p">{</span>
<span class="linenos">888</span>                <span class="s2">&quot;best_cost&quot;</span><span class="p">:</span> <span class="n">final_cost</span><span class="p">,</span>
<span class="linenos">889</span>                <span class="s2">&quot;best_pos&quot;</span><span class="p">:</span> <span class="n">final_pos</span><span class="p">,</span>
<span class="linenos">890</span>                <span class="s2">&quot;history&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos">891</span>                    <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cost_hist</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
<span class="linenos">892</span>                    <span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pos_hist</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
<span class="linenos">893</span>                <span class="p">},</span>
<span class="linenos">894</span>            <span class="p">}</span>
<span class="linenos">895</span>        <span class="c1"># Otherwise run the built-in optimise method using constant inertia.  The</span>
<span class="linenos">896</span>        <span class="c1"># inertia weight ``w`` should typically lie in [0.4, 0.9].</span>
<span class="linenos">897</span>        <span class="n">cost</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fitness</span><span class="p">,</span> <span class="n">iters</span><span class="o">=</span><span class="n">iters</span><span class="p">)</span>
<span class="linenos">898</span>        <span class="k">return</span> <span class="p">{</span>
<span class="linenos">899</span>            <span class="s2">&quot;best_cost&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">cost</span><span class="p">),</span>
<span class="linenos">900</span>            <span class="s2">&quot;best_pos&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span>
<span class="linenos">901</span>            <span class="s2">&quot;history&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos">902</span>                <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">cost_history</span><span class="p">,</span>
<span class="linenos">903</span>                <span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">pos_history</span><span class="p">,</span>
<span class="linenos">904</span>            <span class="p">},</span>
<span class="linenos">905</span>        <span class="p">}</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="classes">
<h2>Classes<a class="headerlink" href="#classes" title="Link to this heading">¶</a></h2>
<section id="psotuner">
<h3><code class="docutils literal notranslate"><span class="pre">PSOTuner</span></code><a class="headerlink" href="#psotuner" title="Link to this heading">¶</a></h3>
<p>High-throughput, vectorised tuner for sliding-mode controllers.</p>
<p>The tuner wraps a particle swarm optimisation algorithm around the
vectorised simulation.  It uses local PRNGs to avoid global side effects
and computes instability penalties based on normalisation constants.  Cost
aggregation between mean and worst-case performance is controlled via
<code class="docutils literal notranslate"><span class="pre">COMBINE_WEIGHTS</span></code>.</p>
<section id="source-code">
<h4>Source Code<a class="headerlink" href="#source-code" title="Link to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="k">class</span><span class="w"> </span><span class="nc">PSOTuner</span><span class="p">:</span>
<span class="linenos">  2</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;High-throughput, vectorised tuner for sliding-mode controllers.</span>
<span class="linenos">  3</span>
<span class="linenos">  4</span><span class="sd">    The tuner wraps a particle swarm optimisation algorithm around the</span>
<span class="linenos">  5</span><span class="sd">    vectorised simulation.  It uses local PRNGs to avoid global side effects</span>
<span class="linenos">  6</span><span class="sd">    and computes instability penalties based on normalisation constants.  Cost</span>
<span class="linenos">  7</span><span class="sd">    aggregation between mean and worst-case performance is controlled via</span>
<span class="linenos">  8</span><span class="sd">    ``COMBINE_WEIGHTS``.</span>
<span class="linenos">  9</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 10</span>
<span class="linenos"> 11</span>    <span class="c1"># Default combine weights for cost aggregation (mean vs max).  The tuple</span>
<span class="linenos"> 12</span>    <span class="c1"># (0.7, 0.3) balances average performance against worst-case performance.</span>
<span class="linenos"> 13</span>    <span class="n">COMBINE_WEIGHTS</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
<span class="linenos"> 14</span>
<span class="linenos"> 15</span>    <span class="c1"># Class-level fallback penalty.  Static methods that cannot access an</span>
<span class="linenos"> 16</span>    <span class="c1"># instance use this constant to penalise invalid cost arrays.  A</span>
<span class="linenos"> 17</span>    <span class="c1"># moderate default (1e6) discourages unstable particles without risking</span>
<span class="linenos"> 18</span>    <span class="c1"># numerical overflow.  Instance-level penalties override this value.</span>
<span class="linenos"> 19</span>    <span class="n">INSTABILITY_PENALTY</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e6</span>
<span class="linenos"> 20</span>
<span class="linenos"> 21</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<span class="linenos"> 22</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos"> 23</span>        <span class="n">controller_factory</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Any</span><span class="p">],</span>
<span class="linenos"> 24</span>        <span class="n">config</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ConfigSchema</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
<span class="linenos"> 25</span>        <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 26</span>        <span class="n">rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 27</span>        <span class="o">*</span><span class="p">,</span>
<span class="linenos"> 28</span>        <span class="n">instability_penalty_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">,</span>
<span class="linenos"> 29</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 30</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialise the PSOTuner.</span>
<span class="linenos"> 31</span>
<span class="linenos"> 32</span><span class="sd">        Parameters</span>
<span class="linenos"> 33</span><span class="sd">        ----------</span>
<span class="linenos"> 34</span><span class="sd">        controller_factory : Callable[[np.ndarray], Any]</span>
<span class="linenos"> 35</span><span class="sd">            A function returning a controller instance given a gain vector.</span>
<span class="linenos"> 36</span><span class="sd">        config : ConfigSchema or path-like</span>
<span class="linenos"> 37</span><span class="sd">            A validated configuration object or path to the YAML file.</span>
<span class="linenos"> 38</span><span class="sd">        seed : int or None, optional</span>
<span class="linenos"> 39</span><span class="sd">            Seed to initialise the local RNG.  When ``None``, the seed from</span>
<span class="linenos"> 40</span><span class="sd">            the configuration (``global_seed``) is used if present; otherwise</span>
<span class="linenos"> 41</span><span class="sd">            the RNG is unseeded.</span>
<span class="linenos"> 42</span><span class="sd">        rng : numpy.random.Generator or None, optional</span>
<span class="linenos"> 43</span><span class="sd">            External PRNG.  If provided, this generator is used directly and</span>
<span class="linenos"> 44</span><span class="sd">            ``seed`` is ignored.</span>
<span class="linenos"> 45</span><span class="sd">        instability_penalty_factor : float, optional</span>
<span class="linenos"> 46</span><span class="sd">            Scale factor used to compute the penalty for unstable simulations.</span>
<span class="linenos"> 47</span><span class="sd">            The penalty is computed as</span>
<span class="linenos"> 48</span><span class="sd">            ``instability_penalty_factor * (norm_ise + norm_u + norm_du + norm_sigma)``.</span>
<span class="linenos"> 49</span><span class="sd">            Larger values penalise instability more heavily.  Default is 100.</span>
<span class="linenos"> 50</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 51</span>        <span class="c1"># Load configuration if a path is provided</span>
<span class="linenos"> 52</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
<span class="linenos"> 53</span>            <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">:</span> <span class="n">ConfigSchema</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="linenos"> 54</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 55</span>            <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">config</span>
<span class="linenos"> 56</span>
<span class="linenos"> 57</span>        <span class="c1"># Store controller factory and config sections</span>
<span class="linenos"> 58</span>        <span class="bp">self</span><span class="o">.</span><span class="n">controller_factory</span> <span class="o">=</span> <span class="n">controller_factory</span>
<span class="linenos"> 59</span>        <span class="bp">self</span><span class="o">.</span><span class="n">physics_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">physics</span>
<span class="linenos"> 60</span>        <span class="bp">self</span><span class="o">.</span><span class="n">sim_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">simulation</span>
<span class="linenos"> 61</span>        <span class="bp">self</span><span class="o">.</span><span class="n">cost_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">cost_function</span>
<span class="linenos"> 62</span>        <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_cfg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;physics_uncertainty&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 63</span>
<span class="linenos"> 64</span>        <span class="c1"># Local PRNG.  Use provided rng or create a new one seeded from</span>
<span class="linenos"> 65</span>        <span class="c1"># ``seed`` or ``global_seed``.  Avoid modifying global RNGs.</span>
<span class="linenos"> 66</span>        <span class="n">default_seed</span> <span class="o">=</span> <span class="n">seed</span> <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;global_seed&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 67</span>        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">default_seed</span><span class="p">)</span> <span class="k">if</span> <span class="n">default_seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
<span class="linenos"> 68</span>        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span> <span class="o">=</span> <span class="n">rng</span> <span class="ow">or</span> <span class="n">create_rng</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
<span class="linenos"> 69</span>
<span class="linenos"> 70</span>        <span class="c1"># Factor used to compute instability penalty when no explicit penalty is given</span>
<span class="linenos"> 71</span>        <span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">instability_penalty_factor</span><span class="p">)</span>
<span class="linenos"> 72</span>
<span class="linenos"> 73</span>        <span class="c1"># Deprecation warnings for unused PSOConfig parameters</span>
<span class="linenos"> 74</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 75</span>            <span class="n">pso_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">pso</span>
<span class="linenos"> 76</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos"> 77</span>            <span class="n">pso_cfg</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 78</span>        <span class="k">if</span> <span class="n">pso_cfg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 79</span>            <span class="c1"># Enforce deprecation of unused PSO parameters.  Design review</span>
<span class="linenos"> 80</span>            <span class="c1"># findings recommend removing legacy parameters such as</span>
<span class="linenos"> 81</span>            <span class="c1"># ``n_processes``, ``hyper_trials``, ``hyper_search`` and</span>
<span class="linenos"> 82</span>            <span class="c1"># ``study_timeout``.  Accepting these fields silently leads to</span>
<span class="linenos"> 83</span>            <span class="c1"># misconfigured optimisations and masks typos.  Raise a</span>
<span class="linenos"> 84</span>            <span class="c1"># ValueError when a deprecated field is supplied and not set</span>
<span class="linenos"> 85</span>            <span class="c1"># to its default (None or 1 for n_processes) to force</span>
<span class="linenos"> 86</span>            <span class="c1"># callers to remove outdated keys.</span>
<span class="linenos"> 87</span>            <span class="n">deprecated_fields</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 88</span>            <span class="n">n_proc</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pso_cfg</span><span class="p">,</span> <span class="s2">&quot;n_processes&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 89</span>            <span class="k">if</span> <span class="n">n_proc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 90</span>                <span class="n">deprecated_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;n_processes&quot;</span><span class="p">)</span>
<span class="linenos"> 91</span>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pso_cfg</span><span class="p">,</span> <span class="s2">&quot;hyper_trials&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 92</span>                <span class="n">deprecated_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;hyper_trials&quot;</span><span class="p">)</span>
<span class="linenos"> 93</span>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pso_cfg</span><span class="p">,</span> <span class="s2">&quot;hyper_search&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 94</span>                <span class="n">deprecated_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;hyper_search&quot;</span><span class="p">)</span>
<span class="linenos"> 95</span>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pso_cfg</span><span class="p">,</span> <span class="s2">&quot;study_timeout&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 96</span>                <span class="n">deprecated_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;study_timeout&quot;</span><span class="p">)</span>
<span class="linenos"> 97</span>            <span class="k">if</span> <span class="n">deprecated_fields</span><span class="p">:</span>
<span class="linenos"> 98</span>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos"> 99</span>                    <span class="sa">f</span><span class="s2">&quot;Deprecated PSO configuration fields present: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">deprecated_fields</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
<span class="linenos">100</span>                    <span class="s2">&quot;Please remove these fields from the configuration.&quot;</span>
<span class="linenos">101</span>                <span class="p">)</span>
<span class="linenos">102</span>
<span class="linenos">103</span>        <span class="c1"># Extract cost weights</span>
<span class="linenos">104</span>        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_cfg</span><span class="o">.</span><span class="n">weights</span>
<span class="linenos">105</span>
<span class="linenos">106</span>        <span class="c1"># Determine instability penalty: explicit or computed</span>
<span class="linenos">107</span>        <span class="n">explicit_penalty</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_cfg</span><span class="p">,</span> <span class="s2">&quot;instability_penalty&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">108</span>        <span class="k">if</span> <span class="n">explicit_penalty</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">109</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">110</span>                <span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">explicit_penalty</span><span class="p">)</span>
<span class="linenos">111</span>            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># P2: Handle invalid penalty value</span>
<span class="linenos">112</span>                <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="linenos">113</span>                    <span class="sa">f</span><span class="s2">&quot;Invalid instability_penalty &#39;</span><span class="si">{</span><span class="n">explicit_penalty</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Using default factor </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty_factor</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">114</span>                <span class="p">)</span>
<span class="linenos">115</span>                <span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty_factor</span><span class="p">)</span>
<span class="linenos">116</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">117</span>            <span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># to be computed from norms</span>
<span class="linenos">118</span>
<span class="linenos">119</span>        <span class="c1"># Normalisation constants for state error, control effort, control rate and sliding variable</span>
<span class="linenos">120</span>        <span class="n">norms</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_cfg</span><span class="p">,</span> <span class="s2">&quot;norms&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">121</span>        <span class="k">if</span> <span class="n">norms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">122</span>            <span class="c1"># Handle both dict (from YAML) and object (from Pydantic) forms</span>
<span class="linenos">123</span>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">norms</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos">124</span>                <span class="bp">self</span><span class="o">.</span><span class="n">norm_ise</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">norms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;state_error&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
<span class="linenos">125</span>                <span class="bp">self</span><span class="o">.</span><span class="n">norm_u</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">norms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;control_effort&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
<span class="linenos">126</span>                <span class="bp">self</span><span class="o">.</span><span class="n">norm_du</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">norms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;control_rate&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
<span class="linenos">127</span>                <span class="bp">self</span><span class="o">.</span><span class="n">norm_sigma</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">norms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sliding&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
<span class="linenos">128</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">129</span>                <span class="bp">self</span><span class="o">.</span><span class="n">norm_ise</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">norms</span><span class="p">,</span> <span class="s2">&quot;state_error&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
<span class="linenos">130</span>                <span class="bp">self</span><span class="o">.</span><span class="n">norm_u</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">norms</span><span class="p">,</span> <span class="s2">&quot;control_effort&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
<span class="linenos">131</span>                <span class="bp">self</span><span class="o">.</span><span class="n">norm_du</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">norms</span><span class="p">,</span> <span class="s2">&quot;control_rate&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
<span class="linenos">132</span>                <span class="bp">self</span><span class="o">.</span><span class="n">norm_sigma</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">norms</span><span class="p">,</span> <span class="s2">&quot;sliding&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
<span class="linenos">133</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">134</span>            <span class="bp">self</span><span class="o">.</span><span class="n">norm_ise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_du</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_sigma</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="linenos">135</span>
<span class="linenos">136</span>        <span class="c1"># Compute penalty if not explicitly provided</span>
<span class="linenos">137</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">138</span>            <span class="n">denom_sum</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_ise</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_u</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_du</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_sigma</span><span class="p">)</span>
<span class="linenos">139</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">denom_sum</span><span class="p">)</span> <span class="ow">or</span> <span class="n">denom_sum</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
<span class="linenos">140</span>                <span class="n">denom_sum</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="linenos">141</span>            <span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty_factor</span> <span class="o">*</span> <span class="n">denom_sum</span><span class="p">)</span>
<span class="linenos">142</span>
<span class="linenos">143</span>        <span class="c1"># Automatic baseline normalisation</span>
<span class="linenos">144</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">145</span>            <span class="n">baseline</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_cfg</span><span class="p">,</span> <span class="s2">&quot;baseline&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">146</span>            <span class="n">gains_list</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">147</span>            <span class="k">if</span> <span class="n">baseline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">148</span>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">baseline</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos">149</span>                    <span class="n">gains_list</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gains&quot;</span><span class="p">)</span>
<span class="linenos">150</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">151</span>                    <span class="n">gains_list</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">baseline</span><span class="p">,</span> <span class="s2">&quot;gains&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">152</span>            <span class="k">if</span> <span class="n">gains_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gains_list</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">gains_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">153</span>                <span class="n">baseline_particles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gains_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">154</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos">155</span>                    <span class="n">baseline_ctrl</span> <span class="o">=</span> <span class="n">controller_factory</span><span class="p">(</span><span class="n">baseline_particles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">156</span>                    <span class="n">u_max_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">baseline_ctrl</span><span class="p">,</span> <span class="s2">&quot;max_force&quot;</span><span class="p">,</span> <span class="mf">150.0</span><span class="p">))</span>
<span class="linenos">157</span>                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># P2: Handle baseline controller creation failure</span>
<span class="linenos">158</span>                    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<span class="linenos">159</span>                        <span class="sa">f</span><span class="s2">&quot;Could not create baseline controller for u_max extraction: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Using default 150.0&quot;</span>
<span class="linenos">160</span>                    <span class="p">)</span>
<span class="linenos">161</span>                    <span class="n">u_max_val</span> <span class="o">=</span> <span class="mf">150.0</span>
<span class="linenos">162</span>                <span class="n">res</span> <span class="o">=</span> <span class="n">simulate_system_batch</span><span class="p">(</span>
<span class="linenos">163</span>                    <span class="n">controller_factory</span><span class="o">=</span><span class="n">controller_factory</span><span class="p">,</span>
<span class="linenos">164</span>                    <span class="n">particles</span><span class="o">=</span><span class="n">baseline_particles</span><span class="p">,</span>
<span class="linenos">165</span>                    <span class="n">sim_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_cfg</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span>
<span class="linenos">166</span>                    <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_cfg</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
<span class="linenos">167</span>                    <span class="n">u_max</span><span class="o">=</span><span class="n">u_max_val</span><span class="p">,</span>
<span class="linenos">168</span>                <span class="p">)</span>
<span class="linenos">169</span>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<span class="linenos">170</span>                    <span class="n">t</span><span class="p">,</span> <span class="n">x_b</span><span class="p">,</span> <span class="n">u_b</span><span class="p">,</span> <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">171</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">172</span>                    <span class="n">t</span><span class="p">,</span> <span class="n">x_b</span><span class="p">,</span> <span class="n">u_b</span><span class="p">,</span> <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">res</span>
<span class="linenos">173</span>                <span class="n">x_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x_b</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">174</span>                <span class="n">u_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">u_b</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">175</span>                <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sigma_b</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">176</span>                <span class="n">dt_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">t</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
<span class="linenos">177</span>                <span class="k">if</span> <span class="n">dt_arr</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">178</span>                    <span class="n">dt_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_cfg</span><span class="o">.</span><span class="n">dt</span><span class="p">]])</span>
<span class="linenos">179</span>                <span class="n">N</span> <span class="o">=</span> <span class="n">dt_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">180</span>                <span class="n">time_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="linenos">181</span>                <span class="n">ise_base</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
<span class="linenos">182</span>                    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_b</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt_arr</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">*</span> <span class="n">time_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">183</span>                <span class="p">)</span>
<span class="linenos">184</span>                <span class="n">u_sq_base</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">u_b</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt_arr</span><span class="p">)</span> <span class="o">*</span> <span class="n">time_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">185</span>                <span class="n">du</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">u_b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="n">u_b</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">])</span>
<span class="linenos">186</span>                <span class="n">du_sq_base</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">du</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt_arr</span><span class="p">)</span> <span class="o">*</span> <span class="n">time_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">187</span>                <span class="n">sigma_sq_base</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">sigma_b</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt_arr</span><span class="p">)</span> <span class="o">*</span> <span class="n">time_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">188</span>                <span class="bp">self</span><span class="o">.</span><span class="n">norm_ise</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ise_base</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">)</span>
<span class="linenos">189</span>                <span class="bp">self</span><span class="o">.</span><span class="n">norm_u</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">u_sq_base</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">)</span>
<span class="linenos">190</span>                <span class="bp">self</span><span class="o">.</span><span class="n">norm_du</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">du_sq_base</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">)</span>
<span class="linenos">191</span>                <span class="bp">self</span><span class="o">.</span><span class="n">norm_sigma</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sigma_sq_base</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">)</span>
<span class="linenos">192</span>        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># P2: Baseline normalization is optional</span>
<span class="linenos">193</span>            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<span class="linenos">194</span>                <span class="sa">f</span><span class="s2">&quot;Automatic baseline normalization failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Using default normalization constants.&quot;</span>
<span class="linenos">195</span>            <span class="p">)</span>
<span class="linenos">196</span>
<span class="linenos">197</span>        <span class="c1"># Overrides for combine_weights and normalization_threshold</span>
<span class="linenos">198</span>        <span class="c1"># Instance-level combine weights and normalisation threshold.  Earlier</span>
<span class="linenos">199</span>        <span class="c1"># implementations mutated class or module variables to reflect these</span>
<span class="linenos">200</span>        <span class="c1"># settings.  To avoid cross-contamination between PSO runs, store</span>
<span class="linenos">201</span>        <span class="c1"># them per instance and avoid modifying global state.  Defaults are</span>
<span class="linenos">202</span>        <span class="c1"># taken from the class attributes if present.</span>
<span class="linenos">203</span>        <span class="bp">self</span><span class="o">.</span><span class="n">combine_weights</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
<span class="linenos">204</span>        <span class="c1"># Normalisation threshold for safe division; defaults to module</span>
<span class="linenos">205</span>        <span class="c1"># constant.  Smaller values cause more aggressive normalisation.</span>
<span class="linenos">206</span>        <span class="bp">self</span><span class="o">.</span><span class="n">normalisation_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">NORMALISATION_THRESHOLD</span><span class="p">)</span>
<span class="linenos">207</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">208</span>            <span class="n">cw</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_cfg</span><span class="p">,</span> <span class="s2">&quot;combine_weights&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">209</span>            <span class="k">if</span> <span class="n">cw</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos">210</span>                <span class="n">cw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;combine_weights&quot;</span><span class="p">)</span>
<span class="linenos">211</span>            <span class="k">if</span> <span class="n">cw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">212</span>                <span class="n">mean_w</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">213</span>                <span class="n">max_w</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">214</span>                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos">215</span>                    <span class="n">mean_w</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cw</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">216</span>                    <span class="n">max_w</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cw</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">217</span>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos">218</span>                    <span class="n">mean_w</span> <span class="o">=</span> <span class="n">cw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">mean_w</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mean_w</span>
<span class="linenos">219</span>                    <span class="n">max_w</span> <span class="o">=</span> <span class="n">cw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">max_w</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">max_w</span>
<span class="linenos">220</span>                <span class="k">if</span> <span class="n">mean_w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">221</span>                    <span class="n">mw</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mean_w</span><span class="p">)</span>
<span class="linenos">222</span>                    <span class="n">xw</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_w</span><span class="p">)</span>
<span class="linenos">223</span>                    <span class="n">total</span> <span class="o">=</span> <span class="n">mw</span> <span class="o">+</span> <span class="n">xw</span>
<span class="linenos">224</span>                    <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">225</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">combine_weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">mw</span> <span class="o">/</span> <span class="n">total</span><span class="p">,</span> <span class="n">xw</span> <span class="o">/</span> <span class="n">total</span><span class="p">)</span>
<span class="linenos">226</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">227</span>            <span class="k">pass</span>
<span class="linenos">228</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">229</span>            <span class="n">nt</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_cfg</span><span class="p">,</span> <span class="s2">&quot;normalization_threshold&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">230</span>            <span class="k">if</span> <span class="n">nt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos">231</span>                <span class="n">nt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;normalization_threshold&quot;</span><span class="p">)</span>
<span class="linenos">232</span>            <span class="k">if</span> <span class="n">nt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">233</span>                <span class="bp">self</span><span class="o">.</span><span class="n">normalisation_threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nt</span><span class="p">)</span>
<span class="linenos">234</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">235</span>            <span class="k">pass</span>
<span class="linenos">236</span>
<span class="linenos">237</span>        <span class="c1"># Warn about deprecated PSO fields that are ignored</span>
<span class="linenos">238</span>        <span class="n">deprecated</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">239</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">240</span>            <span class="n">pcfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">pso</span>
<span class="linenos">241</span>            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;n_processes&quot;</span><span class="p">,</span> <span class="s2">&quot;hyper_trials&quot;</span><span class="p">,</span> <span class="s2">&quot;hyper_search&quot;</span><span class="p">,</span> <span class="s2">&quot;study_timeout&quot;</span><span class="p">):</span>
<span class="linenos">242</span>                <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pcfg</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">243</span>                <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{},</span> <span class="p">[]):</span>
<span class="linenos">244</span>                    <span class="n">deprecated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
<span class="linenos">245</span>            <span class="k">if</span> <span class="n">deprecated</span><span class="p">:</span>
<span class="linenos">246</span>                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="linenos">247</span>                    <span class="s2">&quot;PSOConfig fields </span><span class="si">%s</span><span class="s2"> are deprecated and ignored. These parameters will be removed in a future version.&quot;</span><span class="p">,</span>
<span class="linenos">248</span>                    <span class="n">deprecated</span><span class="p">,</span>
<span class="linenos">249</span>                <span class="p">)</span>
<span class="linenos">250</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">251</span>            <span class="k">pass</span>
<span class="linenos">252</span>
<span class="linenos">253</span>
<span class="linenos">254</span>    <span class="c1"># ---------- Robust sampling ----------</span>
<span class="linenos">255</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_iter_perturbed_physics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">DIPParams</span><span class="p">]:</span>
<span class="linenos">256</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Yield perturbed physics parameters for robustness evaluation.</span>
<span class="linenos">257</span>
<span class="linenos">258</span><span class="sd">        The nominal model is yielded first.  Subsequent draws perturb each</span>
<span class="linenos">259</span><span class="sd">        parameter within ±``percent`` of its nominal value as specified in</span>
<span class="linenos">260</span><span class="sd">        ``physics_uncertainty``.  When uncertainty is disabled or ``n_evals ≤ 1``</span>
<span class="linenos">261</span><span class="sd">        only the nominal model is yielded.</span>
<span class="linenos">262</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">263</span>        <span class="k">yield</span> <span class="n">DIPParams</span><span class="o">.</span><span class="n">from_physics_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">physics_cfg</span><span class="p">)</span>
<span class="linenos">264</span>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_cfg</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_cfg</span><span class="o">.</span><span class="n">n_evals</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">265</span>            <span class="k">return</span>
<span class="linenos">266</span>        <span class="n">rng_local</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span>
<span class="linenos">267</span>        <span class="n">base_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">physics_cfg</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
<span class="linenos">268</span>        <span class="n">pu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_cfg</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
<span class="linenos">269</span>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_cfg</span><span class="o">.</span><span class="n">n_evals</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
<span class="linenos">270</span>            <span class="n">perturbed_params</span> <span class="o">=</span> <span class="n">base_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">271</span>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">pct</span> <span class="ow">in</span> <span class="n">pu</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">272</span>                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;n_evals&quot;</span> <span class="ow">or</span> <span class="n">pct</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">perturbed_params</span><span class="p">:</span>
<span class="linenos">273</span>                    <span class="k">continue</span>
<span class="linenos">274</span>                <span class="n">nominal</span> <span class="o">=</span> <span class="n">base_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<span class="linenos">275</span>                <span class="n">delta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pct</span><span class="p">)</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">nominal</span><span class="p">)</span>
<span class="linenos">276</span>                <span class="n">eps</span> <span class="o">=</span> <span class="n">rng_local</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="p">,</span> <span class="o">+</span><span class="n">delta</span><span class="p">)</span>
<span class="linenos">277</span>                <span class="n">perturbed_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nominal</span><span class="p">)</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">eps</span><span class="p">)</span>
<span class="linenos">278</span>            <span class="c1"># Safety: ensure centre of mass does not exceed pendulum length</span>
<span class="linenos">279</span>            <span class="k">if</span> <span class="s2">&quot;pendulum1_com&quot;</span> <span class="ow">in</span> <span class="n">perturbed_params</span> <span class="ow">and</span> <span class="s2">&quot;pendulum1_length&quot;</span> <span class="ow">in</span> <span class="n">perturbed_params</span><span class="p">:</span>
<span class="linenos">280</span>                <span class="k">if</span> <span class="n">perturbed_params</span><span class="p">[</span><span class="s2">&quot;pendulum1_com&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">perturbed_params</span><span class="p">[</span><span class="s2">&quot;pendulum1_length&quot;</span><span class="p">]:</span>
<span class="linenos">281</span>                    <span class="n">perturbed_params</span><span class="p">[</span><span class="s2">&quot;pendulum1_com&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.99</span> <span class="o">*</span> <span class="n">perturbed_params</span><span class="p">[</span><span class="s2">&quot;pendulum1_length&quot;</span><span class="p">]</span>
<span class="linenos">282</span>            <span class="k">if</span> <span class="s2">&quot;pendulum2_com&quot;</span> <span class="ow">in</span> <span class="n">perturbed_params</span> <span class="ow">and</span> <span class="s2">&quot;pendulum2_length&quot;</span> <span class="ow">in</span> <span class="n">perturbed_params</span><span class="p">:</span>
<span class="linenos">283</span>                <span class="k">if</span> <span class="n">perturbed_params</span><span class="p">[</span><span class="s2">&quot;pendulum2_com&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">perturbed_params</span><span class="p">[</span><span class="s2">&quot;pendulum2_length&quot;</span><span class="p">]:</span>
<span class="linenos">284</span>                    <span class="n">perturbed_params</span><span class="p">[</span><span class="s2">&quot;pendulum2_com&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.99</span> <span class="o">*</span> <span class="n">perturbed_params</span><span class="p">[</span><span class="s2">&quot;pendulum2_length&quot;</span><span class="p">]</span>
<span class="linenos">285</span>            <span class="c1"># Handle field mapping for DIPParams</span>
<span class="linenos">286</span>            <span class="n">dipparams_dict</span> <span class="o">=</span> <span class="n">perturbed_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">287</span>            <span class="k">if</span> <span class="s1">&#39;regularization&#39;</span> <span class="ow">in</span> <span class="n">dipparams_dict</span><span class="p">:</span>
<span class="linenos">288</span>                <span class="n">reg</span> <span class="o">=</span> <span class="n">dipparams_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;regularization&#39;</span><span class="p">)</span>
<span class="linenos">289</span>                <span class="n">dipparams_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;min_regularization&#39;</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span>
<span class="linenos">290</span>                <span class="n">dipparams_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;regularization_alpha&#39;</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">)</span>
<span class="linenos">291</span>            <span class="n">dipparams_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;max_condition_number&#39;</span><span class="p">,</span> <span class="mf">1e10</span><span class="p">)</span>
<span class="linenos">292</span>            <span class="n">dipparams_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;use_fixed_regularization&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos">293</span>            <span class="n">dipparams_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;det_threshold&#39;</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">)</span>
<span class="linenos">294</span>            <span class="n">dipparams_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;condition_tol_factor&#39;</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">)</span>
<span class="linenos">295</span>            <span class="n">dipparams_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;singularity_cond_threshold&#39;</span><span class="p">,</span> <span class="mf">1e8</span><span class="p">)</span>
<span class="linenos">296</span>            <span class="k">yield</span> <span class="n">DIPParams</span><span class="p">(</span><span class="o">**</span><span class="n">dipparams_dict</span><span class="p">)</span>
<span class="linenos">297</span>
<span class="linenos">298</span>    <span class="c1"># ---------- Cost computation ----------</span>
<span class="linenos">299</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_cost_from_traj</span><span class="p">(</span>
<span class="linenos">300</span>        <span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">x_b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">u_b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
<span class="linenos">301</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="linenos">302</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the cost per particle from simulated trajectories.</span>
<span class="linenos">303</span>
<span class="linenos">304</span><span class="sd">        The cost combines state error, control effort, control slew and a</span>
<span class="linenos">305</span><span class="sd">        sliding-mode stability term.  State error integrates the squared</span>
<span class="linenos">306</span><span class="sd">        deviation of all state components over the horizon.  Control terms</span>
<span class="linenos">307</span><span class="sd">        integrate squared commands and their rates.  A graded instability</span>
<span class="linenos">308</span><span class="sd">        penalty is applied when trajectories fail early.</span>
<span class="linenos">309</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">310</span>        <span class="c1"># Flag trajectories with any non-finite state entry</span>
<span class="linenos">311</span>        <span class="n">nan_traj_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x_b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="k">if</span> <span class="n">x_b</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="linenos">312</span>        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="linenos">313</span>        <span class="n">dt_b</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
<span class="linenos">314</span>        <span class="n">dt_const</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_cfg</span><span class="o">.</span><span class="n">dt</span>
<span class="linenos">315</span>        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
<span class="linenos">316</span>        <span class="n">B</span> <span class="o">=</span> <span class="n">x_b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">317</span>        <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">318</span>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">319</span>        <span class="c1"># Instability detection</span>
<span class="linenos">320</span>        <span class="n">fall_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_b</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
<span class="linenos">321</span>        <span class="n">explodes_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_b</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">322</span>        <span class="n">unstable_mask</span> <span class="o">=</span> <span class="n">fall_mask</span> <span class="o">|</span> <span class="n">explodes_mask</span>
<span class="linenos">323</span>        <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">B</span><span class="p">,</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">324</span>        <span class="n">temp</span><span class="p">[</span><span class="n">unstable_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="n">unstable_mask</span><span class="p">]</span>
<span class="linenos">325</span>        <span class="n">failure_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">326</span>        <span class="n">time_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">failure_steps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">])</span>
<span class="linenos">327</span>        <span class="c1"># State error: integrate squared error across all state variables  # [CIT-068]</span>
<span class="linenos">328</span>        <span class="n">ise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_b</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt_b</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">*</span> <span class="n">time_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># [CIT-068]</span>
<span class="linenos">329</span>        <span class="n">ise_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalise</span><span class="p">(</span><span class="n">ise</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_ise</span><span class="p">)</span>
<span class="linenos">330</span>        <span class="c1"># Control effort  # [CIT-068]</span>
<span class="linenos">331</span>        <span class="n">u_b_trunc</span> <span class="o">=</span> <span class="n">u_b</span><span class="p">[:,</span> <span class="p">:</span><span class="n">N</span><span class="p">]</span> <span class="k">if</span> <span class="n">u_b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">N</span> <span class="k">else</span> <span class="n">u_b</span>  <span class="c1"># Ensure shape compatibility</span>
<span class="linenos">332</span>        <span class="n">u_sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">u_b_trunc</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt_b</span><span class="p">)</span> <span class="o">*</span> <span class="n">time_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [CIT-068]</span>
<span class="linenos">333</span>        <span class="n">u_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalise</span><span class="p">(</span><span class="n">u_sq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_u</span><span class="p">)</span>
<span class="linenos">334</span>        <span class="c1"># Control slew  # [CIT-068]</span>
<span class="linenos">335</span>        <span class="n">du</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">u_b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="n">u_b</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># [CIT-068]</span>
<span class="linenos">336</span>        <span class="n">du_trunc</span> <span class="o">=</span> <span class="n">du</span><span class="p">[:,</span> <span class="p">:</span><span class="n">N</span><span class="p">]</span> <span class="k">if</span> <span class="n">du</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">N</span> <span class="k">else</span> <span class="n">du</span>  <span class="c1"># Ensure shape compatibility</span>
<span class="linenos">337</span>        <span class="n">du_sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">du_trunc</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt_b</span><span class="p">)</span> <span class="o">*</span> <span class="n">time_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [CIT-068]</span>
<span class="linenos">338</span>        <span class="n">du_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalise</span><span class="p">(</span><span class="n">du_sq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_du</span><span class="p">)</span>
<span class="linenos">339</span>        <span class="c1"># Sliding variable energy  # [CIT-068]</span>
<span class="linenos">340</span>        <span class="n">sigma_b_trunc</span> <span class="o">=</span> <span class="n">sigma_b</span><span class="p">[:,</span> <span class="p">:</span><span class="n">N</span><span class="p">]</span> <span class="k">if</span> <span class="n">sigma_b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">N</span> <span class="k">else</span> <span class="n">sigma_b</span>  <span class="c1"># Ensure shape compatibility</span>
<span class="linenos">341</span>        <span class="n">sigma_sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">sigma_b_trunc</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dt_b</span><span class="p">)</span> <span class="o">*</span> <span class="n">time_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [CIT-068]</span>
<span class="linenos">342</span>        <span class="n">sigma_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalise</span><span class="p">(</span><span class="n">sigma_sq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_sigma</span><span class="p">)</span>
<span class="linenos">343</span>
<span class="linenos">344</span>        <span class="c1"># Diagnostic logging for PSO cost components</span>
<span class="linenos">345</span>        <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
<span class="linenos">346</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
<span class="linenos">347</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PSO Cost Component Analysis (Batch Statistics)&quot;</span><span class="p">)</span>
<span class="linenos">348</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
<span class="linenos">349</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ise</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">350</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Raw Cost Components:&quot;</span><span class="p">)</span>
<span class="linenos">351</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ISE        : mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ise</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, std=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ise</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ise</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ise</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">352</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  U²         : mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">u_sq</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, std=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">u_sq</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">u_sq</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">u_sq</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">353</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  (ΔU)²      : mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">du_sq</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, std=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">du_sq</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">du_sq</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">du_sq</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">354</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  σ²         : mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sigma_sq</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, std=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">sigma_sq</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">sigma_sq</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sigma_sq</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">355</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Normalized Costs:&quot;</span><span class="p">)</span>
<span class="linenos">356</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ISE_norm   : mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ise_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, std=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ise_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ise_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ise_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">357</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  U_norm     : mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">u_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, std=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">u_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">u_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">u_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">358</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  DU_norm    : mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">du_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, std=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">du_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">du_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">du_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">359</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  σ_norm     : mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sigma_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, std=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">sigma_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">sigma_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sigma_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">360</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Weighted Cost Contributions:&quot;</span><span class="p">)</span>
<span class="linenos">361</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  w_state × ISE_n : mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">state_error</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ise_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">362</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  w_ctrl  × U_n   : mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">control_effort</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">u_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">363</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  w_rate  × DU_n  : mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">control_rate</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">du_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">364</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  w_stab  × σ_n   : mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">stability</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sigma_n</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">365</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Normalization Constants:&quot;</span><span class="p">)</span>
<span class="linenos">366</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  norm_ise=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_ise</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, norm_u=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_u</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, norm_du=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_du</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, norm_sigma=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_sigma</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">367</span>
<span class="linenos">368</span>        <span class="c1"># Graded penalty for early failure</span>
<span class="linenos">369</span>        <span class="n">failure_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="n">failure_steps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt_const</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_cfg</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
<span class="linenos">370</span>        <span class="n">penalty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">stability</span> <span class="o">*</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_cfg</span><span class="o">.</span><span class="n">duration</span> <span class="o">-</span> <span class="n">failure_t</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_cfg</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span>
<span class="linenos">371</span>        <span class="n">J</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">372</span>            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">state_error</span> <span class="o">*</span> <span class="n">ise_n</span>
<span class="linenos">373</span>            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">control_effort</span> <span class="o">*</span> <span class="n">u_n</span>
<span class="linenos">374</span>            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">control_rate</span> <span class="o">*</span> <span class="n">du_n</span>
<span class="linenos">375</span>            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">stability</span> <span class="o">*</span> <span class="n">sigma_n</span>
<span class="linenos">376</span>        <span class="p">)</span> <span class="o">+</span> <span class="n">penalty</span>  <span class="c1"># [CIT-068]</span>
<span class="linenos">377</span>        <span class="c1"># Explicitly penalise NaN trajectories</span>
<span class="linenos">378</span>        <span class="k">if</span> <span class="n">nan_traj_mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<span class="linenos">379</span>            <span class="n">J</span> <span class="o">=</span> <span class="n">J</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">380</span>            <span class="n">J</span><span class="p">[</span><span class="n">nan_traj_mask</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span><span class="p">)</span>
<span class="linenos">381</span>        <span class="n">J</span> <span class="o">=</span> <span class="n">J</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">382</span>        <span class="n">nan_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">J</span><span class="p">)</span>
<span class="linenos">383</span>        <span class="k">if</span> <span class="n">nan_mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<span class="linenos">384</span>            <span class="n">J</span><span class="p">[</span><span class="n">nan_mask</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span><span class="p">)</span>
<span class="linenos">385</span>        <span class="k">return</span> <span class="n">J</span>
<span class="linenos">386</span>
<span class="linenos">387</span>    <span class="c1"># ---------- Normalisation and cost aggregation helpers ----------</span>
<span class="linenos">388</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_normalise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">denom</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="linenos">389</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Safely normalise an array by a scalar denominator using the instance&#39;s threshold.</span>
<span class="linenos">390</span>
<span class="linenos">391</span><span class="sd">        When the denominator is less than or equal to ``self.normalisation_threshold`` the</span>
<span class="linenos">392</span><span class="sd">        original array is returned unchanged.  This prevents amplification of</span>
<span class="linenos">393</span><span class="sd">        numerical noise in near-zero denominators.</span>
<span class="linenos">394</span>
<span class="linenos">395</span><span class="sd">        Parameters</span>
<span class="linenos">396</span><span class="sd">        ----------</span>
<span class="linenos">397</span><span class="sd">        val : np.ndarray</span>
<span class="linenos">398</span><span class="sd">            Array of values to be normalised.</span>
<span class="linenos">399</span><span class="sd">        denom : float</span>
<span class="linenos">400</span><span class="sd">            Scalar denominator.</span>
<span class="linenos">401</span>
<span class="linenos">402</span><span class="sd">        Returns</span>
<span class="linenos">403</span><span class="sd">        -------</span>
<span class="linenos">404</span><span class="sd">        np.ndarray</span>
<span class="linenos">405</span><span class="sd">            The normalised array.</span>
<span class="linenos">406</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">407</span>        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>
<span class="linenos">408</span>            <span class="n">ratio</span> <span class="o">=</span> <span class="n">val</span> <span class="o">/</span> <span class="n">denom</span>
<span class="linenos">409</span>        <span class="n">thr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalisation_threshold</span><span class="p">)</span>
<span class="linenos">410</span>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">denom</span> <span class="o">&gt;</span> <span class="n">thr</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
<span class="linenos">411</span>
<span class="linenos">412</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_combine_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">costs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="linenos">413</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate costs across uncertainty draws using the instance&#39;s weights.</span>
<span class="linenos">414</span>
<span class="linenos">415</span><span class="sd">        For a one-dimensional array of costs, return ``w_mean*mean + w_max*max``.  For</span>
<span class="linenos">416</span><span class="sd">        a two-dimensional array of shape (D, B), aggregate along the first</span>
<span class="linenos">417</span><span class="sd">        dimension (draws) and return an array of shape (B,).  Non-finite inputs</span>
<span class="linenos">418</span><span class="sd">        result in the instability penalty.</span>
<span class="linenos">419</span>
<span class="linenos">420</span><span class="sd">        Parameters</span>
<span class="linenos">421</span><span class="sd">        ----------</span>
<span class="linenos">422</span><span class="sd">        costs : np.ndarray</span>
<span class="linenos">423</span><span class="sd">            1D or 2D array of cost values.</span>
<span class="linenos">424</span>
<span class="linenos">425</span><span class="sd">        Returns</span>
<span class="linenos">426</span><span class="sd">        -------</span>
<span class="linenos">427</span><span class="sd">        np.ndarray or float</span>
<span class="linenos">428</span><span class="sd">            Aggregated costs per particle or a single scalar cost.</span>
<span class="linenos">429</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">430</span>        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">costs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">431</span>        <span class="n">mean_w</span><span class="p">,</span> <span class="n">max_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_weights</span>
<span class="linenos">432</span>        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">433</span>            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">c</span><span class="p">)):</span>
<span class="linenos">434</span>                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span><span class="p">)</span>
<span class="linenos">435</span>            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">mean_w</span> <span class="o">*</span> <span class="n">c</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="n">max_w</span> <span class="o">*</span> <span class="n">c</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="linenos">436</span>        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos">437</span>            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">c</span><span class="p">)):</span>
<span class="linenos">438</span>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">439</span>            <span class="k">return</span> <span class="n">mean_w</span> <span class="o">*</span> <span class="n">c</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">max_w</span> <span class="o">*</span> <span class="n">c</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">440</span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;costs must be 1D or 2D&quot;</span><span class="p">)</span>
<span class="linenos">441</span>
<span class="linenos">442</span>    <span class="c1"># ---------- Fitness evaluation ----------</span>
<span class="linenos">443</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_fitness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">particles</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="linenos">444</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Vectorised fitness function for a swarm of particles.&quot;&quot;&quot;</span>
<span class="linenos">445</span>        <span class="n">ref_ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_factory</span><span class="p">(</span><span class="n">particles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">446</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_u_max</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ref_ctrl</span><span class="p">,</span> <span class="s2">&quot;max_force&quot;</span><span class="p">,</span> <span class="mf">150.0</span><span class="p">)</span>
<span class="linenos">447</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_cfg</span><span class="o">.</span><span class="n">duration</span>
<span class="linenos">448</span>        <span class="n">B</span> <span class="o">=</span> <span class="n">particles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">449</span>        <span class="n">violation_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="linenos">450</span>        <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">violation_mask</span>
<span class="linenos">451</span>        <span class="n">valid_particles</span> <span class="o">=</span> <span class="n">particles</span>
<span class="linenos">452</span>        <span class="c1"># Pre-filter particles using validate_gains if available</span>
<span class="linenos">453</span>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ref_ctrl</span><span class="p">,</span> <span class="s2">&quot;validate_gains&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">ref_ctrl</span><span class="p">,</span> <span class="s2">&quot;validate_gains&quot;</span><span class="p">)):</span>
<span class="linenos">454</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">455</span>                <span class="n">valid_mask_arr</span> <span class="o">=</span> <span class="n">ref_ctrl</span><span class="o">.</span><span class="n">validate_gains</span><span class="p">(</span><span class="n">particles</span><span class="p">)</span>
<span class="linenos">456</span>                <span class="n">valid_mask_arr</span> <span class="o">=</span> <span class="n">valid_mask_arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">457</span>                <span class="k">if</span> <span class="n">valid_mask_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">particles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
<span class="linenos">458</span>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;validate_gains returned mask with wrong length&quot;</span><span class="p">)</span>
<span class="linenos">459</span>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">460</span>                <span class="n">valid_mask_arr</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">461</span>            <span class="k">if</span> <span class="n">valid_mask_arr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">462</span>                <span class="n">violation_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">valid_mask_arr</span>
<span class="linenos">463</span>                <span class="k">if</span> <span class="n">violation_mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<span class="linenos">464</span>                    <span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">violation_mask</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">465</span>                        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">466</span>                    <span class="n">valid_particles</span> <span class="o">=</span> <span class="n">particles</span><span class="p">[</span><span class="o">~</span><span class="n">violation_mask</span><span class="p">]</span>
<span class="linenos">467</span>                    <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">violation_mask</span>
<span class="linenos">468</span>        <span class="c1"># Evaluate under uncertainty draws if configured</span>
<span class="linenos">469</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_cfg</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_cfg</span><span class="o">.</span><span class="n">n_evals</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">470</span>            <span class="n">physics_models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter_perturbed_physics</span><span class="p">())</span>
<span class="linenos">471</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">472</span>                <span class="n">results_list</span> <span class="o">=</span> <span class="n">simulate_system_batch</span><span class="p">(</span>
<span class="linenos">473</span>                    <span class="n">controller_factory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">controller_factory</span><span class="p">,</span>
<span class="linenos">474</span>                    <span class="n">particles</span><span class="o">=</span><span class="n">valid_particles</span><span class="p">,</span>
<span class="linenos">475</span>                    <span class="n">sim_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="p">,</span>
<span class="linenos">476</span>                    <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_cfg</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
<span class="linenos">477</span>                    <span class="n">u_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_u_max</span><span class="p">,</span>
<span class="linenos">478</span>                    <span class="n">params_list</span><span class="o">=</span><span class="n">physics_models</span><span class="p">,</span>
<span class="linenos">479</span>                <span class="p">)</span>
<span class="linenos">480</span>            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
<span class="linenos">481</span>                <span class="n">results_list</span> <span class="o">=</span> <span class="n">simulate_system_batch</span><span class="p">(</span>
<span class="linenos">482</span>                    <span class="n">controller_factory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">controller_factory</span><span class="p">,</span>
<span class="linenos">483</span>                    <span class="n">particles</span><span class="o">=</span><span class="n">valid_particles</span><span class="p">,</span>
<span class="linenos">484</span>                    <span class="n">sim_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="p">,</span>
<span class="linenos">485</span>                    <span class="n">u_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_u_max</span><span class="p">,</span>
<span class="linenos">486</span>                    <span class="n">params_list</span><span class="o">=</span><span class="n">physics_models</span><span class="p">,</span>
<span class="linenos">487</span>                <span class="p">)</span>
<span class="linenos">488</span>            <span class="n">all_costs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">489</span>            <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">x_b</span><span class="p">,</span> <span class="n">u_b</span><span class="p">,</span> <span class="n">sigma_b</span> <span class="ow">in</span> <span class="n">results_list</span><span class="p">:</span>
<span class="linenos">490</span>                <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_cost_from_traj</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x_b</span><span class="p">,</span> <span class="n">u_b</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">)</span>
<span class="linenos">491</span>                <span class="n">nan_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>
<span class="linenos">492</span>                <span class="k">if</span> <span class="n">nan_mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<span class="linenos">493</span>                    <span class="n">cost</span> <span class="o">=</span> <span class="n">cost</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">494</span>                    <span class="n">cost</span><span class="p">[</span><span class="n">nan_mask</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span><span class="p">)</span>
<span class="linenos">495</span>                <span class="n">all_costs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>
<span class="linenos">496</span>            <span class="n">costs_per_draw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">all_costs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">497</span>            <span class="n">J_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_costs</span><span class="p">(</span><span class="n">costs_per_draw</span><span class="p">)</span>
<span class="linenos">498</span>            <span class="n">penalty</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span><span class="p">)</span>
<span class="linenos">499</span>            <span class="n">unstable_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">costs_per_draw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">penalty</span>
<span class="linenos">500</span>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">unstable_mask</span><span class="p">):</span>
<span class="linenos">501</span>                <span class="n">J_valid</span> <span class="o">=</span> <span class="n">J_valid</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">502</span>                <span class="n">J_valid</span><span class="p">[</span><span class="n">unstable_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">penalty</span>
<span class="linenos">503</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">504</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">505</span>                <span class="n">t</span><span class="p">,</span> <span class="n">x_b</span><span class="p">,</span> <span class="n">u_b</span><span class="p">,</span> <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">simulate_system_batch</span><span class="p">(</span>
<span class="linenos">506</span>                    <span class="n">controller_factory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">controller_factory</span><span class="p">,</span>
<span class="linenos">507</span>                    <span class="n">particles</span><span class="o">=</span><span class="n">valid_particles</span><span class="p">,</span>
<span class="linenos">508</span>                    <span class="n">sim_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="p">,</span>
<span class="linenos">509</span>                    <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_cfg</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
<span class="linenos">510</span>                    <span class="n">u_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_u_max</span><span class="p">,</span>
<span class="linenos">511</span>                <span class="p">)</span>
<span class="linenos">512</span>            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
<span class="linenos">513</span>                <span class="n">t</span><span class="p">,</span> <span class="n">x_b</span><span class="p">,</span> <span class="n">u_b</span><span class="p">,</span> <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">simulate_system_batch</span><span class="p">(</span>
<span class="linenos">514</span>                    <span class="n">controller_factory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">controller_factory</span><span class="p">,</span>
<span class="linenos">515</span>                    <span class="n">particles</span><span class="o">=</span><span class="n">valid_particles</span><span class="p">,</span>
<span class="linenos">516</span>                    <span class="n">sim_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="p">,</span>
<span class="linenos">517</span>                    <span class="n">u_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_u_max</span><span class="p">,</span>
<span class="linenos">518</span>                <span class="p">)</span>
<span class="linenos">519</span>            <span class="c1"># Determine which particles produced non-finite trajectories.</span>
<span class="linenos">520</span>            <span class="c1"># Construct a mask that flags any particle whose state, control or</span>
<span class="linenos">521</span>            <span class="c1"># sliding variable contains NaNs or infinite values.  Parentheses</span>
<span class="linenos">522</span>            <span class="c1"># group the three boolean arrays to avoid inadvertent line</span>
<span class="linenos">523</span>            <span class="c1"># continuation issues in Python syntax.</span>
<span class="linenos">524</span>            <span class="n">nan_mask</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">525</span>                <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x_b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="linenos">526</span>                <span class="o">|</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">u_b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="linenos">527</span>                <span class="o">|</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sigma_b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="linenos">528</span>            <span class="p">)</span>
<span class="linenos">529</span>            <span class="n">J_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_cost_from_traj</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x_b</span><span class="p">,</span> <span class="n">u_b</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">)</span>
<span class="linenos">530</span>            <span class="k">if</span> <span class="n">nan_mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<span class="linenos">531</span>                <span class="n">J_valid</span><span class="p">[</span><span class="n">nan_mask</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span><span class="p">)</span>
<span class="linenos">532</span>        <span class="k">if</span> <span class="n">violation_mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<span class="linenos">533</span>            <span class="n">J_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instability_penalty</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">534</span>            <span class="n">J_full</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">J_valid</span>
<span class="linenos">535</span>            <span class="k">return</span> <span class="n">J_full</span>
<span class="linenos">536</span>        <span class="k">return</span> <span class="n">J_valid</span>
<span class="linenos">537</span>
<span class="linenos">538</span>    <span class="c1"># ---------- Optimisation ----------</span>
<span class="linenos">539</span>    <span class="k">def</span><span class="w"> </span><span class="nf">optimise</span><span class="p">(</span>
<span class="linenos">540</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos">541</span>        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="linenos">542</span>        <span class="n">iters_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">543</span>        <span class="n">n_particles_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">544</span>        <span class="n">options_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">545</span>        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="linenos">546</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="linenos">547</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run particle swarm optimisation with optional overrides.</span>
<span class="linenos">548</span>
<span class="linenos">549</span><span class="sd">        This method constructs a `pyswarms.single.GlobalBestPSO` instance from</span>
<span class="linenos">550</span><span class="sd">        the PSO configuration and executes the optimisation loop.  Two</span>
<span class="linenos">551</span><span class="sd">        enhancements are supported beyond the standard PSO:</span>
<span class="linenos">552</span>
<span class="linenos">553</span><span class="sd">        * **Velocity clamping:** if ``pso_cfg.velocity_clamp`` is a tuple</span>
<span class="linenos">554</span><span class="sd">          ``(delta_min, delta_max)``, the per-dimension particle velocities are</span>
<span class="linenos">555</span><span class="sd">          constrained to lie within ``delta_min*(bmax - bmin)`` and</span>
<span class="linenos">556</span><span class="sd">          ``delta_max*(bmax - bmin)``.  Clamping prevents</span>
<span class="linenos">557</span><span class="sd">          particles from overshooting and encourages stability.  When unset,</span>
<span class="linenos">558</span><span class="sd">          no explicit velocity limits are imposed.</span>
<span class="linenos">559</span><span class="sd">        * **Inertia weight scheduling:** if ``pso_cfg.w_schedule`` is provided</span>
<span class="linenos">560</span><span class="sd">          as ``(w_start, w_end)``, the inertia weight is decreased linearly</span>
<span class="linenos">561</span><span class="sd">          from ``w_start`` to ``w_end`` over the iteration horizon to shift</span>
<span class="linenos">562</span><span class="sd">          gradually from global exploration to local exploitation.</span>
<span class="linenos">563</span><span class="sd">          When a schedule is specified, the method runs a manual stepping loop,</span>
<span class="linenos">564</span><span class="sd">          updating ``optimizer.options[&#39;w&#39;]`` at each iteration and capturing</span>
<span class="linenos">565</span><span class="sd">          the best cost and position history.</span>
<span class="linenos">566</span>
<span class="linenos">567</span><span class="sd">        Parameters</span>
<span class="linenos">568</span><span class="sd">        ----------</span>
<span class="linenos">569</span><span class="sd">        iters_override : int, optional</span>
<span class="linenos">570</span><span class="sd">            Overrides the number of iterations specified in the configuration.</span>
<span class="linenos">571</span><span class="sd">        n_particles_override : int, optional</span>
<span class="linenos">572</span><span class="sd">            Overrides the swarm size specified in the configuration.</span>
<span class="linenos">573</span><span class="sd">        options_override : dict, optional</span>
<span class="linenos">574</span><span class="sd">            Dictionary of PSO hyperparameters (e.g., inertia and cognitive/social</span>
<span class="linenos">575</span><span class="sd">            weights) that update defaults from configuration.  These values</span>
<span class="linenos">576</span><span class="sd">            take precedence over the configuration defaults but are superseded</span>
<span class="linenos">577</span><span class="sd">            by ``w_schedule`` for the inertia weight.</span>
<span class="linenos">578</span>
<span class="linenos">579</span><span class="sd">        Returns</span>
<span class="linenos">580</span><span class="sd">        -------</span>
<span class="linenos">581</span><span class="sd">        dict</span>
<span class="linenos">582</span><span class="sd">            A dictionary containing ``best_cost``, ``best_pos`` and a history</span>
<span class="linenos">583</span><span class="sd">            of costs and positions.  When a schedule is used, the history</span>
<span class="linenos">584</span><span class="sd">            arrays have length ``iters``; otherwise the history is taken</span>
<span class="linenos">585</span><span class="sd">            directly from the underlying PSO optimiser.</span>
<span class="linenos">586</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">587</span>        <span class="kn">from</span><span class="w"> </span><span class="nn">pyswarms.single</span><span class="w"> </span><span class="kn">import</span> <span class="n">GlobalBestPSO</span>
<span class="linenos">588</span>        <span class="n">pso_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">pso</span>
<span class="linenos">589</span>
<span class="linenos">590</span>        <span class="c1"># Get expected dimensions from controller factory</span>
<span class="linenos">591</span>        <span class="n">expected_dims</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controller_factory</span><span class="p">,</span> <span class="s2">&quot;n_gains&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">592</span>        <span class="k">if</span> <span class="n">expected_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">593</span>            <span class="c1"># Try to create a test controller to infer dimensions</span>
<span class="linenos">594</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">595</span>                <span class="c1"># Use default gains to create a test controller and infer dimensions</span>
<span class="linenos">596</span>                <span class="n">test_gains_configs</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">597</span>                    <span class="s1">&#39;classical_smc&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span>  <span class="c1"># 6 gains</span>
<span class="linenos">598</span>                    <span class="s1">&#39;adaptive_smc&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span>  <span class="c1"># 5 gains</span>
<span class="linenos">599</span>                    <span class="s1">&#39;sta_smc&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>  <span class="c1"># 6 gains</span>
<span class="linenos">600</span>                    <span class="s1">&#39;hybrid_adaptive_sta_smc&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>  <span class="c1"># 4 gains</span>
<span class="linenos">601</span>                <span class="p">}</span>
<span class="linenos">602</span>
<span class="linenos">603</span>                <span class="c1"># Try to determine controller type and appropriate test gains</span>
<span class="linenos">604</span>                <span class="n">controller_type_hint</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controller_factory</span><span class="p">,</span> <span class="s2">&quot;controller_type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">605</span>
<span class="linenos">606</span>                <span class="k">if</span> <span class="n">controller_type_hint</span> <span class="ow">and</span> <span class="n">controller_type_hint</span> <span class="ow">in</span> <span class="n">test_gains_configs</span><span class="p">:</span>
<span class="linenos">607</span>                    <span class="n">test_gains</span> <span class="o">=</span> <span class="n">test_gains_configs</span><span class="p">[</span><span class="n">controller_type_hint</span><span class="p">]</span>
<span class="linenos">608</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">609</span>                    <span class="c1"># Try classical_smc as default</span>
<span class="linenos">610</span>                    <span class="n">test_gains</span> <span class="o">=</span> <span class="n">test_gains_configs</span><span class="p">[</span><span class="s1">&#39;classical_smc&#39;</span><span class="p">]</span>
<span class="linenos">611</span>
<span class="linenos">612</span>                <span class="c1"># Create test controller to infer dimensions</span>
<span class="linenos">613</span>                <span class="n">test_controller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_factory</span><span class="p">(</span><span class="n">test_gains</span><span class="p">)</span>
<span class="linenos">614</span>
<span class="linenos">615</span>                <span class="c1"># Try to get n_gains from the controller instance</span>
<span class="linenos">616</span>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test_controller</span><span class="p">,</span> <span class="s1">&#39;n_gains&#39;</span><span class="p">):</span>
<span class="linenos">617</span>                    <span class="n">expected_dims</span> <span class="o">=</span> <span class="n">test_controller</span><span class="o">.</span><span class="n">n_gains</span>
<span class="linenos">618</span>                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test_controller</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test_controller</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;gains&#39;</span><span class="p">):</span>
<span class="linenos">619</span>                    <span class="n">expected_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_controller</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">gains</span><span class="p">)</span>
<span class="linenos">620</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">621</span>                    <span class="n">expected_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_gains</span><span class="p">)</span>
<span class="linenos">622</span>
<span class="linenos">623</span>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">624</span>                <span class="c1"># Fallback to default dimensions</span>
<span class="linenos">625</span>                <span class="n">expected_dims</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># Classical SMC default</span>
<span class="linenos">626</span>
<span class="linenos">627</span>        <span class="c1"># Determine controller type to select appropriate bounds</span>
<span class="linenos">628</span>        <span class="n">controller_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controller_factory</span><span class="p">,</span> <span class="s2">&quot;controller_type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">629</span>
<span class="linenos">630</span>        <span class="c1"># If no controller type from factory, try to infer from a test controller</span>
<span class="linenos">631</span>        <span class="k">if</span> <span class="n">controller_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">632</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">633</span>                <span class="n">test_gains</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">][:</span><span class="n">expected_dims</span><span class="p">]</span>
<span class="linenos">634</span>                <span class="n">test_controller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_factory</span><span class="p">(</span><span class="n">test_gains</span><span class="p">)</span>
<span class="linenos">635</span>                <span class="n">controller_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">test_controller</span><span class="p">,</span> <span class="s1">&#39;controller_type&#39;</span><span class="p">,</span> <span class="s1">&#39;classical_smc&#39;</span><span class="p">)</span>
<span class="linenos">636</span>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">637</span>                <span class="n">controller_type</span> <span class="o">=</span> <span class="s1">&#39;classical_smc&#39;</span>  <span class="c1"># Default fallback</span>
<span class="linenos">638</span>
<span class="linenos">639</span>        <span class="c1"># Get controller-specific bounds if available, otherwise use default bounds</span>
<span class="linenos">640</span>        <span class="n">bounds_config</span> <span class="o">=</span> <span class="n">pso_cfg</span><span class="o">.</span><span class="n">bounds</span>
<span class="linenos">641</span>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">bounds_config</span><span class="p">,</span> <span class="n">controller_type</span><span class="p">):</span>
<span class="linenos">642</span>            <span class="n">controller_bounds</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">bounds_config</span><span class="p">,</span> <span class="n">controller_type</span><span class="p">)</span>
<span class="linenos">643</span>            <span class="n">min_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">controller_bounds</span><span class="o">.</span><span class="n">min</span><span class="p">)</span>
<span class="linenos">644</span>            <span class="n">max_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">controller_bounds</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>
<span class="linenos">645</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">646</span>            <span class="c1"># Fallback to default bounds</span>
<span class="linenos">647</span>            <span class="n">min_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bounds_config</span><span class="o">.</span><span class="n">min</span><span class="p">)</span>
<span class="linenos">648</span>            <span class="n">max_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bounds_config</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>
<span class="linenos">649</span>
<span class="linenos">650</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">min_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">max_list</span><span class="p">):</span>
<span class="linenos">651</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos">652</span>                <span class="sa">f</span><span class="s2">&quot;PSO bounds min/max lengths differ: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">min_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">max_list</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">653</span>            <span class="p">)</span>
<span class="linenos">654</span>
<span class="linenos">655</span>        <span class="c1"># Validate bounds length matches expected dimensions</span>
<span class="linenos">656</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">min_list</span><span class="p">)</span> <span class="o">!=</span> <span class="n">expected_dims</span><span class="p">:</span>
<span class="linenos">657</span>            <span class="c1"># Try to adjust bounds to match expected dimensions</span>
<span class="linenos">658</span>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">min_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">expected_dims</span><span class="p">:</span>
<span class="linenos">659</span>                <span class="c1"># Truncate bounds</span>
<span class="linenos">660</span>                <span class="n">min_list</span> <span class="o">=</span> <span class="n">min_list</span><span class="p">[:</span><span class="n">expected_dims</span><span class="p">]</span>
<span class="linenos">661</span>                <span class="n">max_list</span> <span class="o">=</span> <span class="n">max_list</span><span class="p">[:</span><span class="n">expected_dims</span><span class="p">]</span>
<span class="linenos">662</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">663</span>                <span class="c1"># Extend bounds with reasonable defaults</span>
<span class="linenos">664</span>                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">min_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">expected_dims</span><span class="p">:</span>
<span class="linenos">665</span>                    <span class="n">min_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="linenos">666</span>                    <span class="n">max_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">50.0</span><span class="p">)</span>
<span class="linenos">667</span>        <span class="n">pso_options</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">668</span>            <span class="s1">&#39;c1&#39;</span><span class="p">:</span> <span class="n">pso_cfg</span><span class="o">.</span><span class="n">c1</span><span class="p">,</span>
<span class="linenos">669</span>            <span class="s1">&#39;c2&#39;</span><span class="p">:</span> <span class="n">pso_cfg</span><span class="o">.</span><span class="n">c2</span><span class="p">,</span>
<span class="linenos">670</span>            <span class="s1">&#39;w&#39;</span><span class="p">:</span> <span class="n">pso_cfg</span><span class="o">.</span><span class="n">w</span><span class="p">,</span>
<span class="linenos">671</span>        <span class="p">}</span>
<span class="linenos">672</span>        <span class="c1"># Warn the user if PSO hyperparameters are outside recommended ranges.</span>
<span class="linenos">673</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">674</span>            <span class="c1"># Recommended swarm sizes are 10–30 and balanced c1≈c2.</span>
<span class="linenos">675</span>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">10</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pso_cfg</span><span class="o">.</span><span class="n">n_particles</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="p">):</span>
<span class="linenos">676</span>                <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="linenos">677</span>                    <span class="s2">&quot;n_particles=</span><span class="si">%s</span><span class="s2"> is outside the recommended range [10,50] for PSO&quot;</span><span class="p">,</span> <span class="n">pso_cfg</span><span class="o">.</span><span class="n">n_particles</span>
<span class="linenos">678</span>                <span class="p">)</span>
<span class="linenos">679</span>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">pso_cfg</span><span class="o">.</span><span class="n">c1</span><span class="p">)</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">pso_cfg</span><span class="o">.</span><span class="n">c2</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
<span class="linenos">680</span>                <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="linenos">681</span>                    <span class="s2">&quot;PSO acceleration coefficients are unbalanced (c1=</span><span class="si">%s</span><span class="s2">, c2=</span><span class="si">%s</span><span class="s2">); set c1≈c2 to avoid divergence&quot;</span><span class="p">,</span>
<span class="linenos">682</span>                    <span class="n">pso_cfg</span><span class="o">.</span><span class="n">c1</span><span class="p">,</span> <span class="n">pso_cfg</span><span class="o">.</span><span class="n">c2</span>
<span class="linenos">683</span>                <span class="p">)</span>
<span class="linenos">684</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">685</span>            <span class="c1"># Ignore warnings if parameters are missing or cannot be cast.</span>
<span class="linenos">686</span>            <span class="k">pass</span>
<span class="linenos">687</span>        <span class="k">if</span> <span class="n">options_override</span><span class="p">:</span>
<span class="linenos">688</span>            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">options_override</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">689</span>                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">pso_options</span><span class="p">:</span>
<span class="linenos">690</span>                    <span class="n">pso_options</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="linenos">691</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">692</span>                    <span class="n">pso_options</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
<span class="linenos">693</span>        <span class="n">bmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">min_list</span><span class="p">[:</span><span class="n">expected_dims</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">694</span>        <span class="n">bmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">max_list</span><span class="p">[:</span><span class="n">expected_dims</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">695</span>        <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">bmin</span><span class="p">,</span> <span class="n">bmax</span><span class="p">)</span>
<span class="linenos">696</span>        <span class="n">n_particles</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_particles_override</span><span class="p">)</span> <span class="k">if</span> <span class="n">n_particles_override</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">pso_cfg</span><span class="o">.</span><span class="n">n_particles</span><span class="p">)</span>
<span class="linenos">697</span>        <span class="n">iters</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">iters_override</span><span class="p">)</span> <span class="k">if</span> <span class="n">iters_override</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">pso_cfg</span><span class="o">.</span><span class="n">iters</span><span class="p">)</span>
<span class="linenos">698</span>        <span class="k">if</span> <span class="n">n_particles</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">iters</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">699</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;n_particles and iters must be positive&quot;</span><span class="p">)</span>
<span class="linenos">700</span>        <span class="c1"># Reinitialise the local RNG when a fixed seed is provided.  Using a</span>
<span class="linenos">701</span>        <span class="c1"># per-instance Generator avoids global side effects.</span>
<span class="linenos">702</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">703</span>            <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">))</span>
<span class="linenos">704</span>        <span class="c1"># Initialise swarm positions using the local RNG to avoid</span>
<span class="linenos">705</span>        <span class="c1"># invoking the global NumPy RNG.  Without specifying init_pos</span>
<span class="linenos">706</span>        <span class="c1"># the underlying PSO implementation seeds the global RNG.</span>
<span class="linenos">707</span>        <span class="n">init_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">bmin</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">bmax</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_particles</span><span class="p">,</span> <span class="n">expected_dims</span><span class="p">))</span>
<span class="linenos">708</span>        <span class="c1"># Derive a seed for the PSO library from the local RNG.  Passing a</span>
<span class="linenos">709</span>        <span class="c1"># deterministic seed ensures that the PSO optimiser does not rely on</span>
<span class="linenos">710</span>        <span class="c1"># NumPy&#39;s global RNG and produces reproducible results across runs.</span>
<span class="linenos">711</span>        <span class="n">seed_int</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">712</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">713</span>            <span class="n">seed_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
<span class="linenos">714</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">715</span>            <span class="n">seed_int</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">716</span>        <span class="c1"># Compute optional velocity clamp.  Velocity clamping prevents particles</span>
<span class="linenos">717</span>        <span class="c1"># from diverging and helps ensure convergence.  The clamping limits are</span>
<span class="linenos">718</span>        <span class="c1"># expressed as fractions of the search range and multiplied by ``bmax - bmin``.</span>
<span class="linenos">719</span>        <span class="n">v_clamp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">720</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">721</span>            <span class="n">vc</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pso_cfg</span><span class="p">,</span> <span class="s2">&quot;velocity_clamp&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">722</span>            <span class="k">if</span> <span class="n">vc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">723</span>                <span class="n">frac_min</span><span class="p">,</span> <span class="n">frac_max</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vc</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">vc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="linenos">724</span>                <span class="c1"># Compute per-dimension ranges</span>
<span class="linenos">725</span>                <span class="n">range_vec</span> <span class="o">=</span> <span class="n">bmax</span> <span class="o">-</span> <span class="n">bmin</span>
<span class="linenos">726</span>                <span class="n">v_clamp</span> <span class="o">=</span> <span class="p">(</span><span class="n">frac_min</span> <span class="o">*</span> <span class="n">range_vec</span><span class="p">,</span> <span class="n">frac_max</span> <span class="o">*</span> <span class="n">range_vec</span><span class="p">)</span>
<span class="linenos">727</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">728</span>            <span class="n">v_clamp</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">729</span>
<span class="linenos">730</span>        <span class="c1"># Create optimizer - handle version compatibility for PySwarms</span>
<span class="linenos">731</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">732</span>            <span class="c1"># Try with newer PySwarms API that supports seed and velocity_clamp</span>
<span class="linenos">733</span>            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">GlobalBestPSO</span><span class="p">(</span>
<span class="linenos">734</span>                <span class="n">n_particles</span><span class="o">=</span><span class="n">n_particles</span><span class="p">,</span>
<span class="linenos">735</span>                <span class="n">dimensions</span><span class="o">=</span><span class="n">expected_dims</span><span class="p">,</span>
<span class="linenos">736</span>                <span class="n">options</span><span class="o">=</span><span class="n">pso_options</span><span class="p">,</span>
<span class="linenos">737</span>                <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
<span class="linenos">738</span>                <span class="n">init_pos</span><span class="o">=</span><span class="n">init_pos</span><span class="p">,</span>
<span class="linenos">739</span>                <span class="n">seed</span><span class="o">=</span><span class="n">seed_int</span><span class="p">,</span>
<span class="linenos">740</span>                <span class="n">velocity_clamp</span><span class="o">=</span><span class="n">v_clamp</span><span class="p">,</span>
<span class="linenos">741</span>            <span class="p">)</span>
<span class="linenos">742</span>        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
<span class="linenos">743</span>            <span class="c1"># Fallback for PySwarms 1.3.0 which doesn&#39;t support seed or velocity_clamp</span>
<span class="linenos">744</span>            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">GlobalBestPSO</span><span class="p">(</span>
<span class="linenos">745</span>                <span class="n">n_particles</span><span class="o">=</span><span class="n">n_particles</span><span class="p">,</span>
<span class="linenos">746</span>                <span class="n">dimensions</span><span class="o">=</span><span class="n">expected_dims</span><span class="p">,</span>
<span class="linenos">747</span>                <span class="n">options</span><span class="o">=</span><span class="n">pso_options</span><span class="p">,</span>
<span class="linenos">748</span>                <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
<span class="linenos">749</span>                <span class="n">init_pos</span><span class="o">=</span><span class="n">init_pos</span><span class="p">,</span>
<span class="linenos">750</span>            <span class="p">)</span>
<span class="linenos">751</span>        <span class="c1"># If an inertia weight schedule is provided, perform manual stepping.  A</span>
<span class="linenos">752</span>        <span class="c1"># linearly decreasing inertia weight from 0.9 to 0.4 encourages early</span>
<span class="linenos">753</span>        <span class="c1"># exploration and late exploitation.  The</span>
<span class="linenos">754</span>        <span class="c1"># optimisation loop updates ``optimizer.options[&#39;w&#39;]`` at each step and</span>
<span class="linenos">755</span>        <span class="c1"># records cost and position history.</span>
<span class="linenos">756</span>        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pso_cfg</span><span class="p">,</span> <span class="s2">&quot;w_schedule&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">757</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">758</span>                <span class="n">w_start</span><span class="p">,</span> <span class="n">w_end</span> <span class="o">=</span> <span class="n">pso_cfg</span><span class="o">.</span><span class="n">w_schedule</span>
<span class="linenos">759</span>                <span class="c1"># Generate equally spaced inertia weights over the iteration horizon</span>
<span class="linenos">760</span>                <span class="n">w_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">w_start</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">w_end</span><span class="p">),</span> <span class="n">iters</span><span class="p">)</span>
<span class="linenos">761</span>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">762</span>                <span class="c1"># Fall back to constant inertia if schedule is invalid</span>
<span class="linenos">763</span>                <span class="n">w_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">iters</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">pso_cfg</span><span class="o">.</span><span class="n">w</span><span class="p">))</span>
<span class="linenos">764</span>            <span class="n">cost_hist</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">765</span>            <span class="n">pos_hist</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">766</span>            <span class="k">for</span> <span class="n">w_val</span> <span class="ow">in</span> <span class="n">w_values</span><span class="p">:</span>
<span class="linenos">767</span>                <span class="c1"># Update inertia weight for this iteration</span>
<span class="linenos">768</span>                <span class="n">optimizer</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">w_val</span><span class="p">)</span>
<span class="linenos">769</span>                <span class="c1"># Execute a single PSO step; returns current best cost and position</span>
<span class="linenos">770</span>                <span class="n">step_cost</span><span class="p">,</span> <span class="n">step_pos</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fitness</span><span class="p">)</span>
<span class="linenos">771</span>                <span class="n">cost_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">step_cost</span><span class="p">))</span>
<span class="linenos">772</span>                <span class="n">pos_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">step_pos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
<span class="linenos">773</span>            <span class="c1"># Retrieve final global best values from the swarm</span>
<span class="linenos">774</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">775</span>                <span class="n">final_cost</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">swarm</span><span class="o">.</span><span class="n">best_cost</span><span class="p">)</span>
<span class="linenos">776</span>                <span class="n">final_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">swarm</span><span class="o">.</span><span class="n">best_pos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">777</span>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">778</span>                <span class="c1"># Fallback to the last recorded values</span>
<span class="linenos">779</span>                <span class="n">final_cost</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cost_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="linenos">780</span>                <span class="n">final_pos</span> <span class="o">=</span> <span class="n">pos_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">781</span>            <span class="k">return</span> <span class="p">{</span>
<span class="linenos">782</span>                <span class="s2">&quot;best_cost&quot;</span><span class="p">:</span> <span class="n">final_cost</span><span class="p">,</span>
<span class="linenos">783</span>                <span class="s2">&quot;best_pos&quot;</span><span class="p">:</span> <span class="n">final_pos</span><span class="p">,</span>
<span class="linenos">784</span>                <span class="s2">&quot;history&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos">785</span>                    <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cost_hist</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
<span class="linenos">786</span>                    <span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pos_hist</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
<span class="linenos">787</span>                <span class="p">},</span>
<span class="linenos">788</span>            <span class="p">}</span>
<span class="linenos">789</span>        <span class="c1"># Otherwise run the built-in optimise method using constant inertia.  The</span>
<span class="linenos">790</span>        <span class="c1"># inertia weight ``w`` should typically lie in [0.4, 0.9].</span>
<span class="linenos">791</span>        <span class="n">cost</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fitness</span><span class="p">,</span> <span class="n">iters</span><span class="o">=</span><span class="n">iters</span><span class="p">)</span>
<span class="linenos">792</span>        <span class="k">return</span> <span class="p">{</span>
<span class="linenos">793</span>            <span class="s2">&quot;best_cost&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">cost</span><span class="p">),</span>
<span class="linenos">794</span>            <span class="s2">&quot;best_pos&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span>
<span class="linenos">795</span>            <span class="s2">&quot;history&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="linenos">796</span>                <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">cost_history</span><span class="p">,</span>
<span class="linenos">797</span>                <span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">pos_history</span><span class="p">,</span>
<span class="linenos">798</span>            <span class="p">},</span>
<span class="linenos">799</span>        <span class="p">}</span>
</pre></div>
</div>
</section>
<section id="methods-7">
<h4>Methods (7)<a class="headerlink" href="#methods-7" title="Link to this heading">¶</a></h4>
<section id="init-self-controller-factory-config-seed-rng">
<h5><code class="docutils literal notranslate"><span class="pre">__init__(self,</span> <span class="pre">controller_factory,</span> <span class="pre">config,</span> <span class="pre">seed,</span> <span class="pre">rng)</span></code><a class="headerlink" href="#init-self-controller-factory-config-seed-rng" title="Link to this heading">¶</a></h5>
<p>Initialise the PSOTuner.</p>
<p><a class="reference internal" href="#method-psotuner-__init__"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="iter-perturbed-physics-self">
<h5><code class="docutils literal notranslate"><span class="pre">_iter_perturbed_physics(self)</span></code><a class="headerlink" href="#iter-perturbed-physics-self" title="Link to this heading">¶</a></h5>
<p>Yield perturbed physics parameters for robustness evaluation.</p>
<p><a class="reference internal" href="#method-psotuner-_iter_perturbed_physics"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="compute-cost-from-traj-self-t-x-b-u-b-sigma-b">
<h5><code class="docutils literal notranslate"><span class="pre">_compute_cost_from_traj(self,</span> <span class="pre">t,</span> <span class="pre">x_b,</span> <span class="pre">u_b,</span> <span class="pre">sigma_b)</span></code><a class="headerlink" href="#compute-cost-from-traj-self-t-x-b-u-b-sigma-b" title="Link to this heading">¶</a></h5>
<p>Compute the cost per particle from simulated trajectories.</p>
<p><a class="reference internal" href="#method-psotuner-_compute_cost_from_traj"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="normalise-self-val-denom">
<h5><code class="docutils literal notranslate"><span class="pre">_normalise(self,</span> <span class="pre">val,</span> <span class="pre">denom)</span></code><a class="headerlink" href="#normalise-self-val-denom" title="Link to this heading">¶</a></h5>
<p>Safely normalise an array by a scalar denominator using the instance’s threshold.</p>
<p><a class="reference internal" href="#method-psotuner-_normalise"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="combine-costs-self-costs">
<h5><code class="docutils literal notranslate"><span class="pre">_combine_costs(self,</span> <span class="pre">costs)</span></code><a class="headerlink" href="#combine-costs-self-costs" title="Link to this heading">¶</a></h5>
<p>Aggregate costs across uncertainty draws using the instance’s weights.</p>
<p><a class="reference internal" href="#method-psotuner-_combine_costs"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="fitness-self-particles">
<h5><code class="docutils literal notranslate"><span class="pre">_fitness(self,</span> <span class="pre">particles)</span></code><a class="headerlink" href="#fitness-self-particles" title="Link to this heading">¶</a></h5>
<p>Vectorised fitness function for a swarm of particles.</p>
<p><a class="reference internal" href="#method-psotuner-_fitness"><span class="xref myst">View full source →</span></a></p>
</section>
<section id="optimise-self">
<h5><code class="docutils literal notranslate"><span class="pre">optimise(self)</span></code><a class="headerlink" href="#optimise-self" title="Link to this heading">¶</a></h5>
<p>Run particle swarm optimisation with optional overrides.</p>
<p><a class="reference internal" href="#method-psotuner-optimise"><span class="xref myst">View full source →</span></a></p>
</section>
</section>
</section>
</section>
<hr class="docutils" />
<section id="functions">
<h2>Functions<a class="headerlink" href="#functions" title="Link to this heading">¶</a></h2>
<section id="normalise-val-denom">
<h3><code class="docutils literal notranslate"><span class="pre">_normalise(val,</span> <span class="pre">denom)</span></code><a class="headerlink" href="#normalise-val-denom" title="Link to this heading">¶</a></h3>
<p>Safely normalise an array by a scalar denominator.</p>
<p>When the denominator is very small (≤ NORMALISATION_THRESHOLD) the input
array is returned unchanged.  The division suppresses divide-by-zero
warnings.  See tests for expected behaviour.</p>
</section>
</section>
<section id="parameters">
<h2>Parameters<a class="headerlink" href="#parameters" title="Link to this heading">¶</a></h2>
<p>val : np.ndarray
Array of values to be normalised.
denom : float
Scalar denominator.</p>
</section>
<section id="returns">
<h2>Returns<a class="headerlink" href="#returns" title="Link to this heading">¶</a></h2>
<p>np.ndarray
The normalised array.</p>
<section id="id2">
<h3>Source Code<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">def</span><span class="w"> </span><span class="nf">_normalise</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">denom</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="linenos"> 2</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Safely normalise an array by a scalar denominator.</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="sd">    When the denominator is very small (≤ NORMALISATION_THRESHOLD) the input</span>
<span class="linenos"> 5</span><span class="sd">    array is returned unchanged.  The division suppresses divide-by-zero</span>
<span class="linenos"> 6</span><span class="sd">    warnings.  See tests for expected behaviour.</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="sd">    Parameters</span>
<span class="linenos"> 9</span><span class="sd">    ----------</span>
<span class="linenos">10</span><span class="sd">    val : np.ndarray</span>
<span class="linenos">11</span><span class="sd">        Array of values to be normalised.</span>
<span class="linenos">12</span><span class="sd">    denom : float</span>
<span class="linenos">13</span><span class="sd">        Scalar denominator.</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="sd">    Returns</span>
<span class="linenos">16</span><span class="sd">    -------</span>
<span class="linenos">17</span><span class="sd">    np.ndarray</span>
<span class="linenos">18</span><span class="sd">        The normalised array.</span>
<span class="linenos">19</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">20</span>    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>
<span class="linenos">21</span>        <span class="n">ratio</span> <span class="o">=</span> <span class="n">val</span> <span class="o">/</span> <span class="n">denom</span>
<span class="linenos">22</span>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">denom</span> <span class="o">&gt;</span> <span class="n">NORMALISATION_THRESHOLD</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="seeded-global-numpy-seed">
<h3><code class="docutils literal notranslate"><span class="pre">_seeded_global_numpy(seed)</span></code><a class="headerlink" href="#seeded-global-numpy-seed" title="Link to this heading">¶</a></h3>
<p><strong>Decorators:</strong> <code class="docutils literal notranslate"><span class="pre">&#64;contextmanager</span></code></p>
<p>Context manager to temporarily seed the global NumPy RNG.</p>
<p>This is used only in the optimise method to ensure deterministic
behaviour of the PySwarms optimiser when a fixed seed is provided.  It
saves and restores the global RNG state.</p>
<section id="id3">
<h4>Source Code<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nd">@contextmanager</span>
<span class="linenos"> 2</span><span class="k">def</span><span class="w"> </span><span class="nf">_seeded_global_numpy</span><span class="p">(</span><span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 3</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Context manager to temporarily seed the global NumPy RNG.</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="sd">    This is used only in the optimise method to ensure deterministic</span>
<span class="linenos"> 6</span><span class="sd">    behaviour of the PySwarms optimiser when a fixed seed is provided.  It</span>
<span class="linenos"> 7</span><span class="sd">    saves and restores the global RNG state.</span>
<span class="linenos"> 8</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 9</span>    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">10</span>        <span class="k">yield</span>
<span class="linenos">11</span>        <span class="k">return</span>
<span class="linenos">12</span>    <span class="n">state</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">13</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">14</span>        <span class="n">state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
<span class="linenos">15</span>    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># P2: Handle RNG state access failure</span>
<span class="linenos">16</span>        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not save RNG state: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">17</span>        <span class="n">state</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">18</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">19</span>        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seed</span><span class="p">))</span>
<span class="linenos">20</span>        <span class="k">yield</span>
<span class="linenos">21</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">22</span>        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">23</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">24</span>                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="linenos">25</span>            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># P2: Handle RNG state restoration failure</span>
<span class="linenos">26</span>                <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not restore RNG state: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>
<hr class="docutils" />
<section id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Link to this heading">¶</a></h2>
<p>This module imports:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">__future__</span> <span class="pre">import</span> <span class="pre">annotations</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">logging</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">contextlib</span> <span class="pre">import</span> <span class="pre">contextmanager</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">pathlib</span> <span class="pre">import</span> <span class="pre">Path</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">typing</span> <span class="pre">import</span> <span class="pre">Any,</span> <span class="pre">Callable,</span> <span class="pre">Dict,</span> <span class="pre">Iterable,</span> <span class="pre">Optional,</span> <span class="pre">Union</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">numpy</span> <span class="pre">as</span> <span class="pre">np</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">src.config</span> <span class="pre">import</span> <span class="pre">ConfigSchema,</span> <span class="pre">load_config</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">src.utils.seed</span> <span class="pre">import</span> <span class="pre">create_rng</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">...plant.models.dynamics</span> <span class="pre">import</span> <span class="pre">DIPParams</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">...simulation.engines.vector_sim</span> <span class="pre">import</span> <span class="pre">simulate_system_batch</span></code></p></li>
</ul>
</section>
<section id="id4">
<h2>Usage Examples<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h2>
<section id="multi-objective-pso-optimization">
<h3>Multi-Objective PSO Optimization<a class="headerlink" href="#multi-objective-pso-optimization" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">src.optimization.algorithms.pso_optimizer</span><span class="w"> </span><span class="kn">import</span> <span class="n">PSOTuner</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.controllers.factory</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_smc_for_pso</span><span class="p">,</span> <span class="n">SMCType</span>

<span class="c1"># Define multi-objective cost function</span>
<span class="k">def</span><span class="w"> </span><span class="nf">multi_objective_cost</span><span class="p">(</span><span class="n">gains</span><span class="p">):</span>
    <span class="n">controller</span> <span class="o">=</span> <span class="n">create_smc_for_pso</span><span class="p">(</span><span class="n">SMCType</span><span class="o">.</span><span class="n">HYBRID</span><span class="p">,</span> <span class="n">gains</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">simulate</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>

    <span class="c1"># Combine objectives with weights</span>
    <span class="n">tracking_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">states</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]))</span>  <span class="c1"># Angles</span>
    <span class="n">control_effort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">control</span><span class="p">))</span>
    <span class="n">chattering</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">control</span><span class="p">))</span>

    <span class="k">return</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">tracking_error</span> <span class="o">+</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">control_effort</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">chattering</span>

<span class="c1"># Configure PSO with adaptive parameters</span>
<span class="n">pso</span> <span class="o">=</span> <span class="n">PSOTuner</span><span class="p">(</span>
    <span class="n">controller_factory</span><span class="o">=</span><span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="n">create_smc_for_pso</span><span class="p">(</span><span class="n">SMCType</span><span class="o">.</span><span class="n">HYBRID</span><span class="p">,</span> <span class="n">g</span><span class="p">),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">([</span><span class="mf">1.0</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="p">[</span><span class="mf">50.0</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="p">),</span>  <span class="c1"># Hybrid has 4 gains</span>
    <span class="n">n_particles</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
    <span class="n">max_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">w</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>           <span class="c1"># Inertia weight</span>
    <span class="n">c1</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>          <span class="c1"># Cognitive coefficient</span>
    <span class="n">c2</span><span class="o">=</span><span class="mf">1.5</span>           <span class="c1"># Social coefficient</span>
<span class="p">)</span>

<span class="n">best_gains</span><span class="p">,</span> <span class="n">best_cost</span> <span class="o">=</span> <span class="n">pso</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimal gains: </span><span class="si">{</span><span class="n">best_gains</span><span class="si">}</span><span class="s2">, Cost: </span><span class="si">{</span><span class="n">best_cost</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="convergence-monitoring-analysis">
<h3>Convergence Monitoring &amp; Analysis<a class="headerlink" href="#convergence-monitoring-analysis" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># Track convergence history</span>
<span class="n">convergence_history</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">convergence_callback</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">global_best_cost</span><span class="p">):</span>
    <span class="n">convergence_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">global_best_cost</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">: Best cost = </span><span class="si">{</span><span class="n">global_best_cost</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">pso</span> <span class="o">=</span> <span class="n">PSOTuner</span><span class="p">(</span>
    <span class="n">controller_factory</span><span class="o">=</span><span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="n">create_smc_for_pso</span><span class="p">(</span><span class="n">SMCType</span><span class="o">.</span><span class="n">CLASSICAL</span><span class="p">,</span> <span class="n">g</span><span class="p">),</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">bounds_lower</span><span class="p">,</span> <span class="n">bounds_upper</span><span class="p">),</span>
    <span class="n">callback</span><span class="o">=</span><span class="n">convergence_callback</span>
<span class="p">)</span>

<span class="n">best_gains</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pso</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>

<span class="c1"># Plot convergence</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">convergence_history</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Iteration&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Best Cost&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;PSO Convergence Analysis&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="robustness-focused-optimization">
<h3>Robustness-Focused Optimization<a class="headerlink" href="#robustness-focused-optimization" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># example-metadata:</span>
<span class="c1"># runnable: false</span>

<span class="c1"># Optimize for robustness across parameter uncertainty</span>
<span class="k">def</span><span class="w"> </span><span class="nf">robust_cost</span><span class="p">(</span><span class="n">gains</span><span class="p">):</span>
    <span class="n">controller_factory</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">create_smc_for_pso</span><span class="p">(</span><span class="n">SMCType</span><span class="o">.</span><span class="n">ADAPTIVE</span><span class="p">,</span> <span class="n">gains</span><span class="p">)</span>

    <span class="c1"># Test across multiple scenarios</span>
    <span class="n">costs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mass_variation</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">]:</span>  <span class="c1"># ±20% mass uncertainty</span>
        <span class="n">dynamics</span> <span class="o">=</span> <span class="n">SimplifiedDynamics</span><span class="p">(</span><span class="n">cart_mass</span><span class="o">=</span><span class="n">mass_variation</span> <span class="o">*</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">simulate</span><span class="p">(</span><span class="n">controller_factory</span><span class="p">(),</span> <span class="n">dynamics</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>
        <span class="n">costs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compute_ISE</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">states</span><span class="p">))</span>

    <span class="c1"># Return worst-case cost (robust optimization)</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">costs</span><span class="p">)</span>

<span class="n">pso</span> <span class="o">=</span> <span class="n">PSOTuner</span><span class="p">(</span>
    <span class="n">controller_factory</span><span class="o">=</span><span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Not used, cost computes internally</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">([</span><span class="mf">0.1</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="p">[</span><span class="mf">100.0</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="p">),</span>  <span class="c1"># Adaptive SMC: 5 gains</span>
    <span class="n">fitness_function</span><span class="o">=</span><span class="n">robust_cost</span><span class="p">,</span>
    <span class="n">n_particles</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">max_iter</span><span class="o">=</span><span class="mi">150</span>
<span class="p">)</span>

<span class="n">robust_gains</span><span class="p">,</span> <span class="n">worst_case_cost</span> <span class="o">=</span> <span class="n">pso</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>See:</strong> <span class="xref std std-doc">../../../optimization_workflows/advanced_pso_strategies</span></p>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, Research Team
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            <div class="last-updated">
              Last updated on Oct 08, 2025</div>
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">optimization.algorithms.pso_optimizer</a><ul>
<li><a class="reference internal" href="#module-overview">Module Overview</a></li>
<li><a class="reference internal" href="#advanced-mathematical-theory">Advanced Mathematical Theory</a><ul>
<li><a class="reference internal" href="#pso-optimizer-implementation">PSO Optimizer Implementation</a></li>
<li><a class="reference internal" href="#constraint-handling">Constraint Handling</a></li>
<li><a class="reference internal" href="#convergence-acceleration">Convergence Acceleration</a></li>
<li><a class="reference internal" href="#topology-design">Topology Design</a></li>
<li><a class="reference internal" href="#parameter-tuning">Parameter Tuning</a></li>
</ul>
</li>
<li><a class="reference internal" href="#architecture-diagram">Architecture Diagram</a></li>
<li><a class="reference internal" href="#usage-examples">Usage Examples</a><ul>
<li><a class="reference internal" href="#example-1-basic-initialization">Example 1: Basic Initialization</a></li>
<li><a class="reference internal" href="#example-2-performance-tuning">Example 2: Performance Tuning</a></li>
<li><a class="reference internal" href="#example-3-integration-with-optimization">Example 3: Integration with Optimization</a></li>
<li><a class="reference internal" href="#example-4-edge-case-handling">Example 4: Edge Case Handling</a></li>
<li><a class="reference internal" href="#example-5-performance-analysis">Example 5: Performance Analysis</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id1">Architecture Diagram</a></li>
<li><a class="reference internal" href="#mathematical-foundation">Mathematical Foundation</a><ul>
<li><a class="reference internal" href="#particle-swarm-optimization">Particle Swarm Optimization</a></li>
<li><a class="reference internal" href="#convergence-properties">Convergence Properties</a></li>
</ul>
</li>
<li><a class="reference internal" href="#complete-source-code">Complete Source Code</a></li>
<li><a class="reference internal" href="#classes">Classes</a><ul>
<li><a class="reference internal" href="#psotuner"><code class="docutils literal notranslate"><span class="pre">PSOTuner</span></code></a><ul>
<li><a class="reference internal" href="#source-code">Source Code</a></li>
<li><a class="reference internal" href="#methods-7">Methods (7)</a><ul>
<li><a class="reference internal" href="#init-self-controller-factory-config-seed-rng"><code class="docutils literal notranslate"><span class="pre">__init__(self,</span> <span class="pre">controller_factory,</span> <span class="pre">config,</span> <span class="pre">seed,</span> <span class="pre">rng)</span></code></a></li>
<li><a class="reference internal" href="#iter-perturbed-physics-self"><code class="docutils literal notranslate"><span class="pre">_iter_perturbed_physics(self)</span></code></a></li>
<li><a class="reference internal" href="#compute-cost-from-traj-self-t-x-b-u-b-sigma-b"><code class="docutils literal notranslate"><span class="pre">_compute_cost_from_traj(self,</span> <span class="pre">t,</span> <span class="pre">x_b,</span> <span class="pre">u_b,</span> <span class="pre">sigma_b)</span></code></a></li>
<li><a class="reference internal" href="#normalise-self-val-denom"><code class="docutils literal notranslate"><span class="pre">_normalise(self,</span> <span class="pre">val,</span> <span class="pre">denom)</span></code></a></li>
<li><a class="reference internal" href="#combine-costs-self-costs"><code class="docutils literal notranslate"><span class="pre">_combine_costs(self,</span> <span class="pre">costs)</span></code></a></li>
<li><a class="reference internal" href="#fitness-self-particles"><code class="docutils literal notranslate"><span class="pre">_fitness(self,</span> <span class="pre">particles)</span></code></a></li>
<li><a class="reference internal" href="#optimise-self"><code class="docutils literal notranslate"><span class="pre">optimise(self)</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#functions">Functions</a><ul>
<li><a class="reference internal" href="#normalise-val-denom"><code class="docutils literal notranslate"><span class="pre">_normalise(val,</span> <span class="pre">denom)</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#parameters">Parameters</a></li>
<li><a class="reference internal" href="#returns">Returns</a><ul>
<li><a class="reference internal" href="#id2">Source Code</a></li>
<li><a class="reference internal" href="#seeded-global-numpy-seed"><code class="docutils literal notranslate"><span class="pre">_seeded_global_numpy(seed)</span></code></a><ul>
<li><a class="reference internal" href="#id3">Source Code</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#dependencies">Dependencies</a></li>
<li><a class="reference internal" href="#id4">Usage Examples</a><ul>
<li><a class="reference internal" href="#multi-objective-pso-optimization">Multi-Objective PSO Optimization</a></li>
<li><a class="reference internal" href="#convergence-monitoring-analysis">Convergence Monitoring &amp; Analysis</a></li>
<li><a class="reference internal" href="#robustness-focused-optimization">Robustness-Focused Optimization</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=4ebf8126"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=08e7b316"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>window.MathJax = {"tex": {"tags": "all", "tagSide": "right", "macros": {"vec": ["\\boldsymbol{#1}", 1], "mat": ["\\boldsymbol{#1}", 1], "norm": ["\\left\\|#1\\right\\|", 1], "R": "\\mathbb{R}", "C": "\\mathbb{C}", "N": "\\mathbb{N}", "Z": "\\mathbb{Z}"}}, "options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://unpkg.com/mermaid@10.2.0/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true,theme:'neutral'});</script>
    <script src="../../_static/back-to-top.js?v=840797bb"></script>
    <script src="../../_static/lazy-load.js?v=dc25293c"></script>
    <script src="../../_static/dark-mode.js?v=bf328970"></script>
    </body>
</html>